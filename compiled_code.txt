===================================================== 
3D AI GAME PLATFORM - COMPLETE CODE COMPILATION 
===================================================== 
 
DIRECTORY STRUCTURE: 
===================================================== 
Folder PATH listing for volume OS
Volume serial number is 2A63-1EA9
C:.
|   .cursor.rules
|   compiled_code.txt
|   four_player_setup.html
|   nodejs_installer.msi
|   open_4player_direct.bat
|   package-lock.json
|   package.json
|   README.md
|   server_output.tmp
|   start_game.bat
|   start_server.bat
|   temp_tree.txt
|   update_compiled_code.bat
|   
+---client
|   |   index.html
|   |   
|   +---css
|   |       styles.css
|   |       
|   \---js
|       |   main.js
|       |   
|       +---core
|       |       collision.js
|       |       controls.js
|       |       Entity.js
|       |       EntityFactory.js
|       |       game-engine.js
|       |       main.js
|       |       network-core.js
|       |       NPC.js
|       |       player-ui.js
|       |       Player.js
|       |       rts-view.js
|       |       
|       \---implementations
|           \---default
|                   DefaultPlayer.js
|                   
+---memory bank
|       architecture.md
|       game design document.md
|       RULES.md
|       tech stack.md
|       
|   |   .package-lock.json
|   |   
|   +---.bin
|   |       mime
|   |       mime.cmd
|   |       mime.ps1
|   |       nodemon
|   |       nodemon.cmd
|   |       nodemon.ps1
|   |       nodetouch
|   |       nodetouch.cmd
|   |       nodetouch.ps1
|   |       schema-codegen
|   |       schema-codegen.cmd
|   |       schema-codegen.ps1
|   |       semver
|   |       semver.cmd
|   |       semver.ps1
|   |       which
|   |       which.cmd
|   |       which.ps1
|   |       
|   +---@colyseus
|   |   +---core
|   |   |   |   LICENSE
|   |   |   |   package.json
|   |   |   |   README.md
|   |   |   |   
|   |   |   \---build
|   |   |       |   Debug.d.ts
|   |   |       |   Debug.js
|   |   |       |   Debug.js.map
|   |   |       |   Debug.mjs
|   |   |       |   Debug.mjs.map
|   |   |       |   index.d.ts
|   |   |       |   index.js
|   |   |       |   index.js.map
|   |   |       |   index.mjs
|   |   |       |   index.mjs.map
|   |   |       |   IPC.d.ts
|   |   |       |   IPC.js
|   |   |       |   IPC.js.map
|   |   |       |   IPC.mjs
|   |   |       |   IPC.mjs.map
|   |   |       |   Logger.d.ts
|   |   |       |   Logger.js
|   |   |       |   Logger.js.map
|   |   |       |   Logger.mjs
|   |   |       |   Logger.mjs.map
|   |   |       |   MatchMaker.d.ts
|   |   |       |   MatchMaker.js
|   |   |       |   MatchMaker.js.map
|   |   |       |   MatchMaker.mjs
|   |   |       |   MatchMaker.mjs.map
|   |   |       |   Protocol.d.ts
|   |   |       |   Protocol.js
|   |   |       |   Protocol.js.map
|   |   |       |   Protocol.mjs
|   |   |       |   Protocol.mjs.map
|   |   |       |   Room.d.ts
|   |   |       |   Room.js
|   |   |       |   Room.js.map
|   |   |       |   Room.mjs
|   |   |       |   Room.mjs.map
|   |   |       |   Server.d.ts
|   |   |       |   Server.js
|   |   |       |   Server.js.map
|   |   |       |   Server.mjs
|   |   |       |   Server.mjs.map
|   |   |       |   Transport.d.ts
|   |   |       |   Transport.js
|   |   |       |   Transport.js.map
|   |   |       |   Transport.mjs
|   |   |       |   Transport.mjs.map
|   |   |       |   types.d.ts
|   |   |       |   types.js
|   |   |       |   types.js.map
|   |   |       |   types.mjs
|   |   |       |   types.mjs.map
|   |   |       |   Utils.d.ts
|   |   |       |   Utils.js
|   |   |       |   Utils.js.map
|   |   |       |   Utils.mjs
|   |   |       |   Utils.mjs.map
|   |   |       |   
|   |   |       +---discovery
|   |   |       |       index.d.ts
|   |   |       |       index.js
|   |   |       |       index.js.map
|   |   |       |       index.mjs
|   |   |       |       index.mjs.map
|   |   |       |       
|   |   |       +---errors
|   |   |       |       SeatReservationError.d.ts
|   |   |       |       SeatReservationError.js
|   |   |       |       SeatReservationError.js.map
|   |   |       |       SeatReservationError.mjs
|   |   |       |       SeatReservationError.mjs.map
|   |   |       |       ServerError.d.ts
|   |   |       |       ServerError.js
|   |   |       |       ServerError.js.map
|   |   |       |       ServerError.mjs
|   |   |       |       ServerError.mjs.map
|   |   |       |       
|   |   |       +---matchmaker
|   |   |       |   |   controller.d.ts
|   |   |       |   |   controller.js
|   |   |       |   |   controller.js.map
|   |   |       |   |   controller.mjs
|   |   |       |   |   controller.mjs.map
|   |   |       |   |   Lobby.d.ts
|   |   |       |   |   Lobby.js
|   |   |       |   |   Lobby.js.map
|   |   |       |   |   Lobby.mjs
|   |   |       |   |   Lobby.mjs.map
|   |   |       |   |   RegisteredHandler.d.ts
|   |   |       |   |   RegisteredHandler.js
|   |   |       |   |   RegisteredHandler.js.map
|   |   |       |   |   RegisteredHandler.mjs
|   |   |       |   |   RegisteredHandler.mjs.map
|   |   |       |   |   
|   |   |       |   \---driver
|   |   |       |           index.d.ts
|   |   |       |           index.js
|   |   |       |           index.js.map
|   |   |       |           index.mjs
|   |   |       |           index.mjs.map
|   |   |       |           interfaces.d.ts
|   |   |       |           interfaces.js
|   |   |       |           interfaces.js.map
|   |   |       |           interfaces.mjs
|   |   |       |           interfaces.mjs.map
|   |   |       |           Query.d.ts
|   |   |       |           Query.js
|   |   |       |           Query.js.map
|   |   |       |           Query.mjs
|   |   |       |           Query.mjs.map
|   |   |       |           RoomData.d.ts
|   |   |       |           RoomData.js
|   |   |       |           RoomData.js.map
|   |   |       |           RoomData.mjs
|   |   |       |           RoomData.mjs.map
|   |   |       |           
|   |   |       +---presence
|   |   |       |       LocalPresence.d.ts
|   |   |       |       LocalPresence.js
|   |   |       |       LocalPresence.js.map
|   |   |       |       LocalPresence.mjs
|   |   |       |       LocalPresence.mjs.map
|   |   |       |       Presence.d.ts
|   |   |       |       Presence.js
|   |   |       |       Presence.js.map
|   |   |       |       Presence.mjs
|   |   |       |       Presence.mjs.map
|   |   |       |       
|   |   |       +---rooms
|   |   |       |       LobbyRoom.d.ts
|   |   |       |       LobbyRoom.js
|   |   |       |       LobbyRoom.js.map
|   |   |       |       LobbyRoom.mjs
|   |   |       |       LobbyRoom.mjs.map
|   |   |       |       RelayRoom.d.ts
|   |   |       |       RelayRoom.js
|   |   |       |       RelayRoom.js.map
|   |   |       |       RelayRoom.mjs
|   |   |       |       RelayRoom.mjs.map
|   |   |       |       
|   |   |       +---serializer
|   |   |       |       NoneSerializer.d.ts
|   |   |       |       NoneSerializer.js
|   |   |       |       NoneSerializer.js.map
|   |   |       |       NoneSerializer.mjs
|   |   |       |       NoneSerializer.mjs.map
|   |   |       |       SchemaSerializer.d.ts
|   |   |       |       SchemaSerializer.js
|   |   |       |       SchemaSerializer.js.map
|   |   |       |       SchemaSerializer.mjs
|   |   |       |       SchemaSerializer.mjs.map
|   |   |       |       Serializer.d.ts
|   |   |       |       Serializer.js
|   |   |       |       Serializer.js.map
|   |   |       |       Serializer.mjs
|   |   |       |       Serializer.mjs.map
|   |   |       |       
|   |   |       \---utils
|   |   |               DevMode.d.ts
|   |   |               DevMode.js
|   |   |               DevMode.js.map
|   |   |               DevMode.mjs
|   |   |               DevMode.mjs.map
|   |   |               Utils.d.ts
|   |   |               Utils.js
|   |   |               Utils.js.map
|   |   |               Utils.mjs
|   |   |               Utils.mjs.map
|   |   |               
|   |   +---greeting-banner
|   |   |   |   LICENSE
|   |   |   |   package.json
|   |   |   |   README.md
|   |   |   |   
|   |   |   \---build
|   |   |           index.d.ts
|   |   |           index.js
|   |   |           index.js.map
|   |   |           index.mjs
|   |   |           index.mjs.map
|   |   |           
|   |   +---mongoose-driver
|   |   |   |   LICENSE
|   |   |   |   package.json
|   |   |   |   README.md
|   |   |   |   
|   |   |   \---build
|   |   |       |   index.d.ts
|   |   |       |   index.js
|   |   |       |   index.js.map
|   |   |       |   index.mjs
|   |   |       |   index.mjs.map
|   |   |       |   
|   |   |       |   \---tslib
|   |   |       |           tslib.es6.js
|   |   |       |           tslib.es6.js.map
|   |   |       |           
|   |   |       \---packages
|   |   |           \---drivers
|   |   |               \---mongoose-driver
|   |   |                   \---src
|   |   |                           index.js
|   |   |                           index.js.map
|   |   |                           
|   |   +---redis-presence
|   |   |   |   LICENSE
|   |   |   |   package.json
|   |   |   |   README.md
|   |   |   |   
|   |   |   \---build
|   |   |           index.d.ts
|   |   |           index.js
|   |   |           index.js.map
|   |   |           index.mjs
|   |   |           index.mjs.map
|   |   |           
|   |   +---schema
|   |   |   |   LICENSE
|   |   |   |   package.json
|   |   |   |   README.md
|   |   |   |   
|   |   |   +---bin
|   |   |   |       schema-codegen
|   |   |   |       
|   |   |   +---build
|   |   |   |   +---cjs
|   |   |   |   |       index.js
|   |   |   |   |       index.js.map
|   |   |   |   |       
|   |   |   |   +---esm
|   |   |   |   |       index.mjs
|   |   |   |   |       index.mjs.map
|   |   |   |   |       
|   |   |   |   \---umd
|   |   |   |           index.js
|   |   |   |           
|   |   |   +---lib
|   |   |   |   |   annotations.d.ts
|   |   |   |   |   annotations.js
|   |   |   |   |   annotations.js.map
|   |   |   |   |   index.d.ts
|   |   |   |   |   index.js
|   |   |   |   |   index.js.map
|   |   |   |   |   Reflection.d.ts
|   |   |   |   |   Reflection.js
|   |   |   |   |   Reflection.js.map
|   |   |   |   |   Schema.d.ts
|   |   |   |   |   Schema.js
|   |   |   |   |   Schema.js.map
|   |   |   |   |   spec.d.ts
|   |   |   |   |   spec.js
|   |   |   |   |   spec.js.map
|   |   |   |   |   utils.d.ts
|   |   |   |   |   utils.js
|   |   |   |   |   utils.js.map
|   |   |   |   |   
|   |   |   |   +---changes
|   |   |   |   |       ChangeTree.d.ts
|   |   |   |   |       ChangeTree.js
|   |   |   |   |       ChangeTree.js.map
|   |   |   |   |       ReferenceTracker.d.ts
|   |   |   |   |       ReferenceTracker.js
|   |   |   |   |       ReferenceTracker.js.map
|   |   |   |   |       
|   |   |   |   +---codegen
|   |   |   |   |   |   api.d.ts
|   |   |   |   |   |   api.js
|   |   |   |   |   |   api.js.map
|   |   |   |   |   |   argv.d.ts
|   |   |   |   |   |   argv.js
|   |   |   |   |   |   argv.js.map
|   |   |   |   |   |   cli.d.ts
|   |   |   |   |   |   cli.js
|   |   |   |   |   |   cli.js.map
|   |   |   |   |   |   parser.d.ts
|   |   |   |   |   |   parser.js
|   |   |   |   |   |   parser.js.map
|   |   |   |   |   |   types.d.ts
|   |   |   |   |   |   types.js
|   |   |   |   |   |   types.js.map
|   |   |   |   |   |   
|   |   |   |   |   \---languages
|   |   |   |   |           cpp.d.ts
|   |   |   |   |           cpp.js
|   |   |   |   |           cpp.js.map
|   |   |   |   |           csharp.d.ts
|   |   |   |   |           csharp.js
|   |   |   |   |           csharp.js.map
|   |   |   |   |           haxe.d.ts
|   |   |   |   |           haxe.js
|   |   |   |   |           haxe.js.map
|   |   |   |   |           java.d.ts
|   |   |   |   |           java.js
|   |   |   |   |           java.js.map
|   |   |   |   |           js.d.ts
|   |   |   |   |           js.js
|   |   |   |   |           js.js.map
|   |   |   |   |           lua.d.ts
|   |   |   |   |           lua.js
|   |   |   |   |           lua.js.map
|   |   |   |   |           ts.d.ts
|   |   |   |   |           ts.js
|   |   |   |   |           ts.js.map
|   |   |   |   |           
|   |   |   |   +---encoding
|   |   |   |   |       decode.d.ts
|   |   |   |   |       decode.js
|   |   |   |   |       decode.js.map
|   |   |   |   |       encode.d.ts
|   |   |   |   |       encode.js
|   |   |   |   |       encode.js.map
|   |   |   |   |       
|   |   |   |   +---events
|   |   |   |   |       EventEmitter.d.ts
|   |   |   |   |       EventEmitter.js
|   |   |   |   |       EventEmitter.js.map
|   |   |   |   |       
|   |   |   |   +---filters
|   |   |   |   |       index.d.ts
|   |   |   |   |       index.js
|   |   |   |   |       index.js.map
|   |   |   |   |       
|   |   |   |   \---types
|   |   |   |           ArraySchema.d.ts
|   |   |   |           ArraySchema.js
|   |   |   |           ArraySchema.js.map
|   |   |   |           CollectionSchema.d.ts
|   |   |   |           CollectionSchema.js
|   |   |   |           CollectionSchema.js.map
|   |   |   |           HelperTypes.d.ts
|   |   |   |           HelperTypes.js
|   |   |   |           HelperTypes.js.map
|   |   |   |           index.d.ts
|   |   |   |           index.js
|   |   |   |           index.js.map
|   |   |   |           MapSchema.d.ts
|   |   |   |           MapSchema.js
|   |   |   |           MapSchema.js.map
|   |   |   |           SetSchema.d.ts
|   |   |   |           SetSchema.js
|   |   |   |           SetSchema.js.map
|   |   |   |           typeRegistry.d.ts
|   |   |   |           typeRegistry.js
|   |   |   |           typeRegistry.js.map
|   |   |   |           utils.d.ts
|   |   |   |           utils.js
|   |   |   |           utils.js.map
|   |   |   |           
|   |   |   \---src
|   |   |       |   annotations.ts
|   |   |       |   index.ts
|   |   |       |   Reflection.ts
|   |   |       |   Schema.ts
|   |   |       |   spec.ts
|   |   |       |   utils.ts
|   |   |       |   
|   |   |       +---changes
|   |   |       |       ChangeTree.ts
|   |   |       |       
|   |   |       +---codegen
|   |   |       |   |   api.ts
|   |   |       |   |   argv.ts
|   |   |       |   |   cli.ts
|   |   |       |   |   parser.ts
|   |   |       |   |   types.ts
|   |   |       |   |   
|   |   |       |   \---languages
|   |   |       |           cpp.ts
|   |   |       |           csharp.ts
|   |   |       |           haxe.ts
|   |   |       |           java.ts
|   |   |       |           js.ts
|   |   |       |           lua.ts
|   |   |       |           ts.ts
|   |   |       |           
|   |   |       +---encoding
|   |   |       |       decode.ts
|   |   |       |       encode.ts
|   |   |       |       
|   |   |       +---events
|   |   |       |       EventEmitter.ts
|   |   |       |       
|   |   |       +---filters
|   |   |       |       index.ts
|   |   |       |       
|   |   |       \---types
|   |   |               ArraySchema.ts
|   |   |               CollectionSchema.ts
|   |   |               HelperTypes.ts
|   |   |               index.ts
|   |   |               MapSchema.ts
|   |   |               SetSchema.ts
|   |   |               
|   |   \---ws-transport
|   |       |   package.json
|   |       |   README.md
|   |       |   
|   |       \---build
|   |           |   index.d.ts
|   |           |   index.js
|   |           |   index.js.map
|   |           |   index.mjs
|   |           |   index.mjs.map
|   |           |   WebSocketClient.d.ts
|   |           |   WebSocketClient.js
|   |           |   WebSocketClient.js.map
|   |           |   WebSocketClient.mjs
|   |           |   WebSocketClient.mjs.map
|   |           |   WebSocketTransport.d.ts
|   |           |   WebSocketTransport.js
|   |           |   WebSocketTransport.js.map
|   |           |   WebSocketTransport.mjs
|   |           |   WebSocketTransport.mjs.map
|   |           |   
|   |           |   \---tslib
|   |           |           tslib.es6.js
|   |           |           tslib.es6.js.map
|   |           |           
|   |           \---packages
|   |               \---transport
|   |                   \---ws-transport
|   |                       \---src
|   |                               index.js
|   |                               index.js.map
|   |                               WebSocketClient.js
|   |                               WebSocketClient.js.map
|   |                               WebSocketTransport.js
|   |                               WebSocketTransport.js.map
|   |                               
|   +---@gamestdio
|   |   +---clock
|   |   |   |   .babelrc
|   |   |   |   .npmignore
|   |   |   |   .travis.yml
|   |   |   |   LICENSE
|   |   |   |   package.json
|   |   |   |   README.md
|   |   |   |   tsconfig.json
|   |   |   |   yarn.lock
|   |   |   |   
|   |   |   \---dist
|   |   |           index.d.ts
|   |   |           index.js
|   |   |           
|   |   \---timer
|   |       |   .babelrc
|   |       |   .prettierrc
|   |       |   CHANGELOG.md
|   |       |   LICENSE
|   |       |   package.json
|   |       |   README.md
|   |       |   tsconfig.json
|   |       |   
|   |       \---lib
|   |               ClockTimer.d.ts
|   |               ClockTimer.js
|   |               Delayed.d.ts
|   |               Delayed.js
|   |               index.d.ts
|   |               index.js
|   |               TimerClearedError.d.ts
|   |               TimerClearedError.js
|   |               
|   +---@types
|   |   +---bson
|   |   |       index.d.ts
|   |   |       LICENSE
|   |   |       package.json
|   |   |       README.md
|   |   |       
|   |   +---mongodb
|   |   |       index.d.ts
|   |   |       LICENSE
|   |   |       package.json
|   |   |       README.md
|   |   |       
|   |   +---node
|   |   |   |   assert.d.ts
|   |   |   |   async_hooks.d.ts
|   |   |   |   buffer.buffer.d.ts
|   |   |   |   buffer.d.ts
|   |   |   |   child_process.d.ts
|   |   |   |   cluster.d.ts
|   |   |   |   console.d.ts
|   |   |   |   constants.d.ts
|   |   |   |   crypto.d.ts
|   |   |   |   dgram.d.ts
|   |   |   |   diagnostics_channel.d.ts
|   |   |   |   dns.d.ts
|   |   |   |   dom-events.d.ts
|   |   |   |   domain.d.ts
|   |   |   |   events.d.ts
|   |   |   |   fs.d.ts
|   |   |   |   globals.d.ts
|   |   |   |   globals.typedarray.d.ts
|   |   |   |   http.d.ts
|   |   |   |   http2.d.ts
|   |   |   |   https.d.ts
|   |   |   |   index.d.ts
|   |   |   |   inspector.d.ts
|   |   |   |   LICENSE
|   |   |   |   module.d.ts
|   |   |   |   net.d.ts
|   |   |   |   os.d.ts
|   |   |   |   package.json
|   |   |   |   path.d.ts
|   |   |   |   perf_hooks.d.ts
|   |   |   |   process.d.ts
|   |   |   |   punycode.d.ts
|   |   |   |   querystring.d.ts
|   |   |   |   readline.d.ts
|   |   |   |   README.md
|   |   |   |   repl.d.ts
|   |   |   |   sea.d.ts
|   |   |   |   sqlite.d.ts
|   |   |   |   stream.d.ts
|   |   |   |   string_decoder.d.ts
|   |   |   |   test.d.ts
|   |   |   |   timers.d.ts
|   |   |   |   tls.d.ts
|   |   |   |   trace_events.d.ts
|   |   |   |   tty.d.ts
|   |   |   |   url.d.ts
|   |   |   |   util.d.ts
|   |   |   |   v8.d.ts
|   |   |   |   vm.d.ts
|   |   |   |   wasi.d.ts
|   |   |   |   worker_threads.d.ts
|   |   |   |   zlib.d.ts
|   |   |   |   
|   |   |   +---assert
|   |   |   |       strict.d.ts
|   |   |   |       
|   |   |   +---compatibility
|   |   |   |       disposable.d.ts
|   |   |   |       index.d.ts
|   |   |   |       indexable.d.ts
|   |   |   |       iterators.d.ts
|   |   |   |       
|   |   |   +---dns
|   |   |   |       promises.d.ts
|   |   |   |       
|   |   |   +---fs
|   |   |   |       promises.d.ts
|   |   |   |       
|   |   |   +---readline
|   |   |   |       promises.d.ts
|   |   |   |       
|   |   |   +---stream
|   |   |   |       consumers.d.ts
|   |   |   |       promises.d.ts
|   |   |   |       web.d.ts
|   |   |   |       
|   |   |   +---timers
|   |   |   |       promises.d.ts
|   |   |   |       
|   |   |   \---ts5.6
|   |   |           buffer.buffer.d.ts
|   |   |           globals.typedarray.d.ts
|   |   |           index.d.ts
|   |   |           
|   |   +---redis
|   |   |       index.d.ts
|   |   |       LICENSE
|   |   |       package.json
|   |   |       README.md
|   |   |       
|   |   \---ws
|   |           index.d.ts
|   |           LICENSE
|   |           package.json
|   |           README.md
|   |           
|   +---accepts
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---anymatch
|   |       index.d.ts
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---array-flatten
|   |       array-flatten.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---balanced-match
|   |   |   index.js
|   |   |   LICENSE.md
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |           FUNDING.yml
|   |           
|   +---binary-extensions
|   |       binary-extensions.json
|   |       binary-extensions.json.d.ts
|   |       index.d.ts
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---bl
|   |   |   .jshintrc
|   |   |   .travis.yml
|   |   |   bl.js
|   |   |   LICENSE.md
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---test
|   |           indexOf.js
|   |           test.js
|   |           
|   +---bluebird
|   |   |   changelog.md
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---js
|   |       +---browser
|   |       |       bluebird.core.js
|   |       |       bluebird.core.min.js
|   |       |       bluebird.js
|   |       |       bluebird.min.js
|   |       |       
|   |       \---release
|   |               any.js
|   |               assert.js
|   |               async.js
|   |               bind.js
|   |               bluebird.js
|   |               call_get.js
|   |               cancel.js
|   |               catch_filter.js
|   |               context.js
|   |               debuggability.js
|   |               direct_resolve.js
|   |               each.js
|   |               errors.js
|   |               es5.js
|   |               filter.js
|   |               finally.js
|   |               generators.js
|   |               join.js
|   |               map.js
|   |               method.js
|   |               nodeback.js
|   |               nodeify.js
|   |               promise.js
|   |               promise_array.js
|   |               promisify.js
|   |               props.js
|   |               queue.js
|   |               race.js
|   |               reduce.js
|   |               schedule.js
|   |               settle.js
|   |               some.js
|   |               synchronous_inspection.js
|   |               thenables.js
|   |               timers.js
|   |               using.js
|   |               util.js
|   |               
|   +---body-parser
|   |   |   HISTORY.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   
|   |   +---lib
|   |   |   |   read.js
|   |   |   |   
|   |   |   \---types
|   |   |           json.js
|   |   |           raw.js
|   |   |           text.js
|   |   |           urlencoded.js
|   |   |           
|   |       +---debug
|   |       |   |   .coveralls.yml
|   |       |   |   .eslintrc
|   |       |   |   .npmignore
|   |       |   |   .travis.yml
|   |       |   |   CHANGELOG.md
|   |       |   |   component.json
|   |       |   |   karma.conf.js
|   |       |   |   LICENSE
|   |       |   |   Makefile
|   |       |   |   node.js
|   |       |   |   package.json
|   |       |   |   README.md
|   |       |   |   
|   |       |   \---src
|   |       |           browser.js
|   |       |           debug.js
|   |       |           index.js
|   |       |           inspector-log.js
|   |       |           node.js
|   |       |           
|   |       \---ms
|   |               index.js
|   |               license.md
|   |               package.json
|   |               readme.md
|   |               
|   +---brace-expansion
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---braces
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           compile.js
|   |           constants.js
|   |           expand.js
|   |           parse.js
|   |           stringify.js
|   |           utils.js
|   |           
|   +---bson
|   |   |   bower.json
|   |   |   HISTORY.md
|   |   |   index.js
|   |   |   LICENSE.md
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---browser_build
|   |   |       bson.js
|   |   |       package.json
|   |   |       
|   |   \---lib
|   |       \---bson
|   |           |   binary.js
|   |           |   bson.js
|   |           |   code.js
|   |           |   db_ref.js
|   |           |   decimal128.js
|   |           |   double.js
|   |           |   float_parser.js
|   |           |   int_32.js
|   |           |   long.js
|   |           |   map.js
|   |           |   max_key.js
|   |           |   min_key.js
|   |           |   objectid.js
|   |           |   regexp.js
|   |           |   symbol.js
|   |           |   timestamp.js
|   |           |   
|   |           \---parser
|   |                   calculate_size.js
|   |                   deserializer.js
|   |                   serializer.js
|   |                   utils.js
|   |                   
|   +---bytes
|   |       History.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       Readme.md
|   |       
|   +---call-bind-apply-helpers
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   actualApply.d.ts
|   |   |   actualApply.js
|   |   |   applyBind.d.ts
|   |   |   applyBind.js
|   |   |   CHANGELOG.md
|   |   |   functionApply.d.ts
|   |   |   functionApply.js
|   |   |   functionCall.d.ts
|   |   |   functionCall.js
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   reflectApply.d.ts
|   |   |   reflectApply.js
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---call-bound
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---chokidar
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---lib
|   |   |       constants.js
|   |   |       fsevents-handler.js
|   |   |       nodefs-handler.js
|   |   |       
|   |   \---types
|   |           index.d.ts
|   |           
|   +---colyseus
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---build
|   |           index.d.ts
|   |           index.js
|   |           index.js.map
|   |           index.mjs
|   |           index.mjs.map
|   |           
|   +---concat-map
|   |   |   .travis.yml
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.markdown
|   |   |   
|   |   +---example
|   |   |       map.js
|   |   |       
|   |   \---test
|   |           map.js
|   |           
|   +---content-disposition
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---content-type
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---cookie
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       SECURITY.md
|   |       
|   +---cookie-signature
|   |       .npmignore
|   |       History.md
|   |       index.js
|   |       package.json
|   |       Readme.md
|   |       
|   +---core-util-is
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           util.js
|   |           
|   +---cross-spawn
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---lib
|   |   |   |   enoent.js
|   |   |   |   parse.js
|   |   |   |   
|   |   |   \---util
|   |   |           escape.js
|   |   |           readShebang.js
|   |   |           resolveCommand.js
|   |   |           
|   |       +---.bin
|   |       |       semver
|   |       |       semver.cmd
|   |       |       semver.ps1
|   |       |       
|   |       \---semver
|   |           |   LICENSE
|   |           |   package.json
|   |           |   range.bnf
|   |           |   README.md
|   |           |   semver.js
|   |           |   
|   |           \---bin
|   |                   semver
|   |                   
|   +---debug
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---src
|   |           browser.js
|   |           common.js
|   |           index.js
|   |           node.js
|   |           
|   +---default-gateway
|   |       android.js
|   |       darwin.js
|   |       freebsd.js
|   |       ibmi.js
|   |       index.js
|   |       LICENSE
|   |       linux.js
|   |       openbsd.js
|   |       package.json
|   |       README.md
|   |       sunos.js
|   |       win32.js
|   |       
|   +---denque
|   |       CHANGELOG.md
|   |       index.d.ts
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---depd
|   |   |   History.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   Readme.md
|   |   |   
|   |   \---lib
|   |       \---browser
|   |               index.js
|   |               
|   +---destroy
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---dunder-proto
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   get.d.ts
|   |   |   get.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   set.d.ts
|   |   |   set.js
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           get.js
|   |           index.js
|   |           set.js
|   |           
|   +---ee-first
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---encodeurl
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---end-of-stream
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---es-define-property
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---es-errors
|   |   |   .eslintrc
|   |   |   CHANGELOG.md
|   |   |   eval.d.ts
|   |   |   eval.js
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   range.d.ts
|   |   |   range.js
|   |   |   README.md
|   |   |   ref.d.ts
|   |   |   ref.js
|   |   |   syntax.d.ts
|   |   |   syntax.js
|   |   |   tsconfig.json
|   |   |   type.d.ts
|   |   |   type.js
|   |   |   uri.d.ts
|   |   |   uri.js
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---es-object-atoms
|   |   |   .eslintrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   isObject.d.ts
|   |   |   isObject.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   RequireObjectCoercible.d.ts
|   |   |   RequireObjectCoercible.js
|   |   |   ToObject.d.ts
|   |   |   ToObject.js
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---escape-html
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       Readme.md
|   |       
|   +---etag
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---execa
|   |   |   index.js
|   |   |   license
|   |   |   package.json
|   |   |   readme.md
|   |   |   
|   |   \---lib
|   |           errname.js
|   |           stdio.js
|   |           
|   +---express
|   |   |   History.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   Readme.md
|   |   |   
|   |   +---lib
|   |   |   |   application.js
|   |   |   |   express.js
|   |   |   |   request.js
|   |   |   |   response.js
|   |   |   |   utils.js
|   |   |   |   view.js
|   |   |   |   
|   |   |   +---middleware
|   |   |   |       init.js
|   |   |   |       query.js
|   |   |   |       
|   |   |   \---router
|   |   |           index.js
|   |   |           layer.js
|   |   |           route.js
|   |   |           
|   |       +---debug
|   |       |   |   .coveralls.yml
|   |       |   |   .eslintrc
|   |       |   |   .npmignore
|   |       |   |   .travis.yml
|   |       |   |   CHANGELOG.md
|   |       |   |   component.json
|   |       |   |   karma.conf.js
|   |       |   |   LICENSE
|   |       |   |   Makefile
|   |       |   |   node.js
|   |       |   |   package.json
|   |       |   |   README.md
|   |       |   |   
|   |       |   \---src
|   |       |           browser.js
|   |       |           debug.js
|   |       |           index.js
|   |       |           inspector-log.js
|   |       |           node.js
|   |       |           
|   |       \---ms
|   |               index.js
|   |               license.md
|   |               package.json
|   |               readme.md
|   |               
|   +---fill-range
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---finalhandler
|   |   |   HISTORY.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   
|   |       +---debug
|   |       |   |   .coveralls.yml
|   |       |   |   .eslintrc
|   |       |   |   .npmignore
|   |       |   |   .travis.yml
|   |       |   |   CHANGELOG.md
|   |       |   |   component.json
|   |       |   |   karma.conf.js
|   |       |   |   LICENSE
|   |       |   |   Makefile
|   |       |   |   node.js
|   |       |   |   package.json
|   |       |   |   README.md
|   |       |   |   
|   |       |   \---src
|   |       |           browser.js
|   |       |           debug.js
|   |       |           index.js
|   |       |           inspector-log.js
|   |       |           node.js
|   |       |           
|   |       \---ms
|   |               index.js
|   |               license.md
|   |               package.json
|   |               readme.md
|   |               
|   +---forwarded
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---fresh
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---function-bind
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   implementation.js
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   |       FUNDING.yml
|   |   |       SECURITY.md
|   |   |       
|   |   \---test
|   |           .eslintrc
|   |           index.js
|   |           
|   +---get-intrinsic
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           GetIntrinsic.js
|   |           
|   +---get-proto
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   Object.getPrototypeOf.d.ts
|   |   |   Object.getPrototypeOf.js
|   |   |   package.json
|   |   |   README.md
|   |   |   Reflect.getPrototypeOf.d.ts
|   |   |   Reflect.getPrototypeOf.js
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---get-stream
|   |       buffer-stream.js
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---glob-parent
|   |       CHANGELOG.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---gopd
|   |   |   .eslintrc
|   |   |   CHANGELOG.md
|   |   |   gOPD.d.ts
|   |   |   gOPD.js
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---has-flag
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---has-symbols
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   shams.d.ts
|   |   |   shams.js
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |       |   index.js
|   |       |   tests.js
|   |       |   
|   |       \---shams
|   |               core-js.js
|   |               get-own-property-symbols.js
|   |               
|   +---hasown
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |           FUNDING.yml
|   |           
|   +---http-errors
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---iconv-lite
|   |   |   Changelog.md
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---encodings
|   |   |   |   dbcs-codec.js
|   |   |   |   dbcs-data.js
|   |   |   |   index.js
|   |   |   |   internal.js
|   |   |   |   sbcs-codec.js
|   |   |   |   sbcs-data-generated.js
|   |   |   |   sbcs-data.js
|   |   |   |   utf16.js
|   |   |   |   utf7.js
|   |   |   |   
|   |   |   \---tables
|   |   |           big5-added.json
|   |   |           cp936.json
|   |   |           cp949.json
|   |   |           cp950.json
|   |   |           eucjp.json
|   |   |           gb18030-ranges.json
|   |   |           gbk-added.json
|   |   |           shiftjis.json
|   |   |           
|   |   \---lib
|   |           bom-handling.js
|   |           extend-node.js
|   |           index.d.ts
|   |           index.js
|   |           streams.js
|   |           
|   +---ignore-by-default
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---inherits
|   |       inherits.js
|   |       inherits_browser.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---internal-ip
|   |       index.d.ts
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---ip-regex
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---ipaddr.js
|   |   |   ipaddr.min.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           ipaddr.js
|   |           ipaddr.js.d.ts
|   |           
|   +---is-binary-path
|   |       index.d.ts
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---is-extglob
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---is-glob
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---is-number
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---is-stream
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---isarray
|   |       .npmignore
|   |       .travis.yml
|   |       component.json
|   |       index.js
|   |       Makefile
|   |       package.json
|   |       README.md
|   |       test.js
|   |       
|   +---isexe
|   |   |   .npmignore
|   |   |   index.js
|   |   |   LICENSE
|   |   |   mode.js
|   |   |   package.json
|   |   |   README.md
|   |   |   windows.js
|   |   |   
|   |   \---test
|   |           basic.js
|   |           
|   +---kareem
|   |   |   .travis.yml
|   |   |   CHANGELOG.md
|   |   |   docs.js
|   |   |   gulpfile.js
|   |   |   index.js
|   |   |   LICENSE
|   |   |   Makefile
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---test
|   |           examples.test.js
|   |           misc.test.js
|   |           post.test.js
|   |           pre.test.js
|   |           wrap.test.js
|   |           
|   +---math-intrinsics
|   |   |   .eslintrc
|   |   |   abs.d.ts
|   |   |   abs.js
|   |   |   CHANGELOG.md
|   |   |   floor.d.ts
|   |   |   floor.js
|   |   |   isFinite.d.ts
|   |   |   isFinite.js
|   |   |   isInteger.d.ts
|   |   |   isInteger.js
|   |   |   isNaN.d.ts
|   |   |   isNaN.js
|   |   |   isNegativeZero.d.ts
|   |   |   isNegativeZero.js
|   |   |   LICENSE
|   |   |   max.d.ts
|   |   |   max.js
|   |   |   min.d.ts
|   |   |   min.js
|   |   |   mod.d.ts
|   |   |   mod.js
|   |   |   package.json
|   |   |   pow.d.ts
|   |   |   pow.js
|   |   |   README.md
|   |   |   round.d.ts
|   |   |   round.js
|   |   |   sign.d.ts
|   |   |   sign.js
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   +---constants
|   |   |       maxArrayLength.d.ts
|   |   |       maxArrayLength.js
|   |   |       maxSafeInteger.d.ts
|   |   |       maxSafeInteger.js
|   |   |       maxValue.d.ts
|   |   |       maxValue.js
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---media-typer
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---memory-pager
|   |       .travis.yml
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       test.js
|   |       
|   +---merge-descriptors
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---methods
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---mime
|   |   |   .npmignore
|   |   |   CHANGELOG.md
|   |   |   cli.js
|   |   |   LICENSE
|   |   |   mime.js
|   |   |   package.json
|   |   |   README.md
|   |   |   types.json
|   |   |   
|   |   \---src
|   |           build.js
|   |           test.js
|   |           
|   +---mime-db
|   |       db.json
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---mime-types
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---minimatch
|   |       LICENSE
|   |       minimatch.js
|   |       package.json
|   |       README.md
|   |       
|   +---mongodb
|   |   |   index.js
|   |   |   LICENSE.md
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---lib
|   |   |   |   admin.js
|   |   |   |   aggregation_cursor.js
|   |   |   |   apm.js
|   |   |   |   change_stream.js
|   |   |   |   collection.js
|   |   |   |   command_cursor.js
|   |   |   |   command_utils.js
|   |   |   |   constants.js
|   |   |   |   cursor.js
|   |   |   |   db.js
|   |   |   |   dynamic_loaders.js
|   |   |   |   encrypter.js
|   |   |   |   error.js
|   |   |   |   error_codes.js
|   |   |   |   explain.js
|   |   |   |   mongo_client.js
|   |   |   |   read_concern.js
|   |   |   |   url_parser.js
|   |   |   |   utils.js
|   |   |   |   write_concern.js
|   |   |   |   
|   |   |   +---async
|   |   |   |       .eslintrc
|   |   |   |       async_iterator.js
|   |   |   |       
|   |   |   +---bulk
|   |   |   |       common.js
|   |   |   |       ordered.js
|   |   |   |       unordered.js
|   |   |   |       
|   |   |   +---cmap
|   |   |   |       connection.js
|   |   |   |       connection_pool.js
|   |   |   |       errors.js
|   |   |   |       events.js
|   |   |   |       message_stream.js
|   |   |   |       stream_description.js
|   |   |   |       
|   |   |   +---core
|   |   |   |   |   cursor.js
|   |   |   |   |   error.js
|   |   |   |   |   index.js
|   |   |   |   |   sessions.js
|   |   |   |   |   transactions.js
|   |   |   |   |   uri_parser.js
|   |   |   |   |   utils.js
|   |   |   |   |   
|   |   |   |   +---auth
|   |   |   |   |       auth_provider.js
|   |   |   |   |       defaultAuthProviders.js
|   |   |   |   |       gssapi.js
|   |   |   |   |       mongocr.js
|   |   |   |   |       mongodb_aws.js
|   |   |   |   |       mongo_credentials.js
|   |   |   |   |       plain.js
|   |   |   |   |       scram.js
|   |   |   |   |       x509.js
|   |   |   |   |       
|   |   |   |   +---connection
|   |   |   |   |       apm.js
|   |   |   |   |       commands.js
|   |   |   |   |       command_result.js
|   |   |   |   |       connect.js
|   |   |   |   |       connection.js
|   |   |   |   |       logger.js
|   |   |   |   |       msg.js
|   |   |   |   |       pool.js
|   |   |   |   |       utils.js
|   |   |   |   |       
|   |   |   |   +---sdam
|   |   |   |   |       common.js
|   |   |   |   |       events.js
|   |   |   |   |       monitor.js
|   |   |   |   |       server.js
|   |   |   |   |       server_description.js
|   |   |   |   |       server_selection.js
|   |   |   |   |       srv_polling.js
|   |   |   |   |       topology.js
|   |   |   |   |       topology_description.js
|   |   |   |   |       
|   |   |   |   +---tools
|   |   |   |   |       smoke_plugin.js
|   |   |   |   |       
|   |   |   |   +---topologies
|   |   |   |   |       mongos.js
|   |   |   |   |       read_preference.js
|   |   |   |   |       replset.js
|   |   |   |   |       replset_state.js
|   |   |   |   |       server.js
|   |   |   |   |       shared.js
|   |   |   |   |       
|   |   |   |   \---wireprotocol
|   |   |   |           command.js
|   |   |   |           compression.js
|   |   |   |           constants.js
|   |   |   |           get_more.js
|   |   |   |           index.js
|   |   |   |           kill_cursors.js
|   |   |   |           query.js
|   |   |   |           shared.js
|   |   |   |           write_command.js
|   |   |   |           
|   |   |   +---gridfs
|   |   |   |       chunk.js
|   |   |   |       grid_store.js
|   |   |   |       
|   |   |   +---gridfs-stream
|   |   |   |       download.js
|   |   |   |       index.js
|   |   |   |       upload.js
|   |   |   |       
|   |   |   +---operations
|   |   |   |       add_user.js
|   |   |   |       admin_ops.js
|   |   |   |       aggregate.js
|   |   |   |       bulk_write.js
|   |   |   |       collections.js
|   |   |   |       collection_ops.js
|   |   |   |       command.js
|   |   |   |       command_v2.js
|   |   |   |       common_functions.js
|   |   |   |       connect.js
|   |   |   |       count.js
|   |   |   |       count_documents.js
|   |   |   |       create_collection.js
|   |   |   |       create_indexes.js
|   |   |   |       cursor_ops.js
|   |   |   |       db_ops.js
|   |   |   |       delete_many.js
|   |   |   |       delete_one.js
|   |   |   |       distinct.js
|   |   |   |       drop.js
|   |   |   |       drop_index.js
|   |   |   |       drop_indexes.js
|   |   |   |       estimated_document_count.js
|   |   |   |       execute_db_admin_command.js
|   |   |   |       execute_operation.js
|   |   |   |       find.js
|   |   |   |       find_and_modify.js
|   |   |   |       find_one.js
|   |   |   |       find_one_and_delete.js
|   |   |   |       find_one_and_replace.js
|   |   |   |       find_one_and_update.js
|   |   |   |       geo_haystack_search.js
|   |   |   |       indexes.js
|   |   |   |       index_exists.js
|   |   |   |       index_information.js
|   |   |   |       insert_many.js
|   |   |   |       insert_one.js
|   |   |   |       is_capped.js
|   |   |   |       list_collections.js
|   |   |   |       list_databases.js
|   |   |   |       list_indexes.js
|   |   |   |       map_reduce.js
|   |   |   |       operation.js
|   |   |   |       options_operation.js
|   |   |   |       profiling_level.js
|   |   |   |       remove_user.js
|   |   |   |       rename.js
|   |   |   |       replace_one.js
|   |   |   |       re_index.js
|   |   |   |       run_command.js
|   |   |   |       set_profiling_level.js
|   |   |   |       stats.js
|   |   |   |       update_many.js
|   |   |   |       update_one.js
|   |   |   |       validate_collection.js
|   |   |   |       
|   |   |   \---topologies
|   |   |           mongos.js
|   |   |           native_topology.js
|   |   |           replset.js
|   |   |           server.js
|   |   |           topology_base.js
|   |   |           
|   |       \---optional-require
|   |           |   index.d.ts
|   |           |   index.js
|   |           |   package.json
|   |           |   README.md
|   |           |   
|   |           \---dist
|   |                   index.d.ts
|   |                   index.js
|   |                   index.js.map
|   |                   
|   +---mongoose
|   |   |   browser.js
|   |   |   build-browser.js
|   |   |   History.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE.md
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   
|   |   +---dist
|   |   |       browser.umd.js
|   |   |       
|   |   +---lib
|   |   |   |   aggregate.js
|   |   |   |   browser.js
|   |   |   |   browserDocument.js
|   |   |   |   cast.js
|   |   |   |   collection.js
|   |   |   |   connection.js
|   |   |   |   connectionstate.js
|   |   |   |   document.js
|   |   |   |   document_provider.js
|   |   |   |   driver.js
|   |   |   |   index.js
|   |   |   |   internal.js
|   |   |   |   model.js
|   |   |   |   options.js
|   |   |   |   promise_provider.js
|   |   |   |   query.js
|   |   |   |   queryhelpers.js
|   |   |   |   schema.js
|   |   |   |   schematype.js
|   |   |   |   statemachine.js
|   |   |   |   utils.js
|   |   |   |   validoptions.js
|   |   |   |   virtualtype.js
|   |   |   |   
|   |   |   +---cast
|   |   |   |       boolean.js
|   |   |   |       date.js
|   |   |   |       decimal128.js
|   |   |   |       number.js
|   |   |   |       objectid.js
|   |   |   |       string.js
|   |   |   |       
|   |   |   +---cursor
|   |   |   |       AggregationCursor.js
|   |   |   |       ChangeStream.js
|   |   |   |       QueryCursor.js
|   |   |   |       
|   |   |   +---drivers
|   |   |   |   |   SPEC.md
|   |   |   |   |   
|   |   |   |   +---browser
|   |   |   |   |       binary.js
|   |   |   |   |       decimal128.js
|   |   |   |   |       index.js
|   |   |   |   |       objectid.js
|   |   |   |   |       ReadPreference.js
|   |   |   |   |       
|   |   |   |   \---node-mongodb-native
|   |   |   |           binary.js
|   |   |   |           collection.js
|   |   |   |           connection.js
|   |   |   |           decimal128.js
|   |   |   |           index.js
|   |   |   |           objectid.js
|   |   |   |           ReadPreference.js
|   |   |   |           
|   |   |   +---error
|   |   |   |       browserMissingSchema.js
|   |   |   |       cast.js
|   |   |   |       disconnected.js
|   |   |   |       divergentArray.js
|   |   |   |       index.js
|   |   |   |       messages.js
|   |   |   |       missingSchema.js
|   |   |   |       mongooseError.js
|   |   |   |       notFound.js
|   |   |   |       objectExpected.js
|   |   |   |       objectParameter.js
|   |   |   |       overwriteModel.js
|   |   |   |       parallelSave.js
|   |   |   |       parallelValidate.js
|   |   |   |       serverSelection.js
|   |   |   |       strict.js
|   |   |   |       validation.js
|   |   |   |       validator.js
|   |   |   |       version.js
|   |   |   |       
|   |   |   +---helpers
|   |   |   |   |   arrayDepth.js
|   |   |   |   |   clone.js
|   |   |   |   |   common.js
|   |   |   |   |   each.js
|   |   |   |   |   get.js
|   |   |   |   |   getConstructorName.js
|   |   |   |   |   getDefaultBulkwriteResult.js
|   |   |   |   |   getFunctionName.js
|   |   |   |   |   immediate.js
|   |   |   |   |   isBsonType.js
|   |   |   |   |   isMongooseObject.js
|   |   |   |   |   isObject.js
|   |   |   |   |   isPromise.js
|   |   |   |   |   once.js
|   |   |   |   |   parallelLimit.js
|   |   |   |   |   printJestWarning.js
|   |   |   |   |   promiseOrCallback.js
|   |   |   |   |   setDefaultsOnInsert.js
|   |   |   |   |   specialProperties.js
|   |   |   |   |   symbols.js
|   |   |   |   |   timers.js
|   |   |   |   |   updateValidators.js
|   |   |   |   |   
|   |   |   |   +---aggregate
|   |   |   |   |       stringifyFunctionOperators.js
|   |   |   |   |       
|   |   |   |   +---cursor
|   |   |   |   |       eachAsync.js
|   |   |   |   |       
|   |   |   |   +---discriminator
|   |   |   |   |       areDiscriminatorValuesEqual.js
|   |   |   |   |       checkEmbeddedDiscriminatorKeyProjection.js
|   |   |   |   |       getConstructor.js
|   |   |   |   |       getDiscriminatorByValue.js
|   |   |   |   |       getSchemaDiscriminatorByValue.js
|   |   |   |   |       
|   |   |   |   +---document
|   |   |   |   |       cleanModifiedSubpaths.js
|   |   |   |   |       compile.js
|   |   |   |   |       getEmbeddedDiscriminatorPath.js
|   |   |   |   |       handleSpreadDoc.js
|   |   |   |   |       
|   |   |   |   +---indexes
|   |   |   |   |       isDefaultIdIndex.js
|   |   |   |   |       isIndexEqual.js
|   |   |   |   |       
|   |   |   |   +---model
|   |   |   |   |       applyHooks.js
|   |   |   |   |       applyMethods.js
|   |   |   |   |       applyStaticHooks.js
|   |   |   |   |       applyStatics.js
|   |   |   |   |       castBulkWrite.js
|   |   |   |   |       discriminator.js
|   |   |   |   |       
|   |   |   |   +---path
|   |   |   |   |       parentPaths.js
|   |   |   |   |       setDottedPath.js
|   |   |   |   |       
|   |   |   |   +---populate
|   |   |   |   |       assignRawDocsToIdStructure.js
|   |   |   |   |       assignVals.js
|   |   |   |   |       createPopulateQueryFilter.js
|   |   |   |   |       getModelsMapForPopulate.js
|   |   |   |   |       getSchemaTypes.js
|   |   |   |   |       getVirtual.js
|   |   |   |   |       leanPopulateMap.js
|   |   |   |   |       lookupLocalFields.js
|   |   |   |   |       normalizeRefPath.js
|   |   |   |   |       removeDeselectedForeignField.js
|   |   |   |   |       SkipPopulateValue.js
|   |   |   |   |       validateRef.js
|   |   |   |   |       
|   |   |   |   +---projection
|   |   |   |   |       isDefiningProjection.js
|   |   |   |   |       isExclusive.js
|   |   |   |   |       isInclusive.js
|   |   |   |   |       isPathExcluded.js
|   |   |   |   |       isPathSelectedInclusive.js
|   |   |   |   |       parseProjection.js
|   |   |   |   |       
|   |   |   |   +---query
|   |   |   |   |       applyGlobalMaxTimeMS.js
|   |   |   |   |       applyQueryMiddleware.js
|   |   |   |   |       castFilterPath.js
|   |   |   |   |       castUpdate.js
|   |   |   |   |       completeMany.js
|   |   |   |   |       getEmbeddedDiscriminatorPath.js
|   |   |   |   |       handleImmutable.js
|   |   |   |   |       hasDollarKeys.js
|   |   |   |   |       isOperator.js
|   |   |   |   |       sanitizeProjection.js
|   |   |   |   |       selectPopulatedFields.js
|   |   |   |   |       wrapThunk.js
|   |   |   |   |       
|   |   |   |   +---schema
|   |   |   |   |       addAutoId.js
|   |   |   |   |       applyPlugins.js
|   |   |   |   |       applyWriteConcern.js
|   |   |   |   |       cleanPositionalOperators.js
|   |   |   |   |       getIndexes.js
|   |   |   |   |       getPath.js
|   |   |   |   |       handleIdOption.js
|   |   |   |   |       handleTimestampOption.js
|   |   |   |   |       merge.js
|   |   |   |   |       
|   |   |   |   +---schematype
|   |   |   |   |       handleImmutable.js
|   |   |   |   |       
|   |   |   |   +---timestamps
|   |   |   |   |       setupTimestamps.js
|   |   |   |   |       
|   |   |   |   +---topology
|   |   |   |   |       allServersUnknown.js
|   |   |   |   |       isAtlas.js
|   |   |   |   |       isSSLError.js
|   |   |   |   |       
|   |   |   |   \---update
|   |   |   |           applyTimestampsToChildren.js
|   |   |   |           applyTimestampsToUpdate.js
|   |   |   |           castArrayFilters.js
|   |   |   |           modifiedPaths.js
|   |   |   |           moveImmutableProperties.js
|   |   |   |           removeUnusedArrayFilters.js
|   |   |   |           updatedPathsByArrayFilter.js
|   |   |   |           
|   |   |   +---options
|   |   |   |       PopulateOptions.js
|   |   |   |       propertyOptions.js
|   |   |   |       removeOptions.js
|   |   |   |       saveOptions.js
|   |   |   |       SchemaArrayOptions.js
|   |   |   |       SchemaBufferOptions.js
|   |   |   |       SchemaDateOptions.js
|   |   |   |       SchemaDocumentArrayOptions.js
|   |   |   |       SchemaMapOptions.js
|   |   |   |       SchemaNumberOptions.js
|   |   |   |       SchemaObjectIdOptions.js
|   |   |   |       SchemaSingleNestedOptions.js
|   |   |   |       SchemaStringOptions.js
|   |   |   |       SchemaTypeOptions.js
|   |   |   |       VirtualOptions.js
|   |   |   |       
|   |   |   +---plugins
|   |   |   |       idGetter.js
|   |   |   |       removeSubdocs.js
|   |   |   |       saveSubdocs.js
|   |   |   |       sharding.js
|   |   |   |       trackTransaction.js
|   |   |   |       validateBeforeSave.js
|   |   |   |       
|   |   |   +---schema
|   |   |   |   |   array.js
|   |   |   |   |   boolean.js
|   |   |   |   |   buffer.js
|   |   |   |   |   date.js
|   |   |   |   |   decimal128.js
|   |   |   |   |   documentarray.js
|   |   |   |   |   index.js
|   |   |   |   |   map.js
|   |   |   |   |   mixed.js
|   |   |   |   |   number.js
|   |   |   |   |   objectid.js
|   |   |   |   |   SingleNestedPath.js
|   |   |   |   |   string.js
|   |   |   |   |   symbols.js
|   |   |   |   |   
|   |   |   |   \---operators
|   |   |   |           bitwise.js
|   |   |   |           exists.js
|   |   |   |           geospatial.js
|   |   |   |           helpers.js
|   |   |   |           text.js
|   |   |   |           type.js
|   |   |   |           
|   |   |   \---types
|   |   |           array.js
|   |   |           buffer.js
|   |   |           core_array.js
|   |   |           decimal128.js
|   |   |           documentarray.js
|   |   |           embedded.js
|   |   |           index.js
|   |   |           map.js
|   |   |           objectid.js
|   |   |           subdocument.js
|   |   |           
|   |   |   \---ms
|   |   |           index.js
|   |   |           license.md
|   |   |           package.json
|   |   |           readme.md
|   |   |           
|   |   \---tools
|   |           auth.js
|   |           repl.js
|   |           sharded.js
|   |           
|   +---mongoose-legacy-pluralize
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---mpath
|   |   |   .travis.yml
|   |   |   bench.js
|   |   |   bench.log
|   |   |   bench.out
|   |   |   History.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   Makefile
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   
|   |   +---lib
|   |   |       index.js
|   |   |       stringToParts.js
|   |   |       
|   |   \---test
|   |           .eslintrc.yml
|   |           index.js
|   |           stringToParts.js
|   |           
|   +---mquery
|   |   |   .eslintignore
|   |   |   .travis.yml
|   |   |   History.md
|   |   |   LICENSE
|   |   |   Makefile
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   
|   |   +---lib
|   |   |   |   env.js
|   |   |   |   mquery.js
|   |   |   |   permissions.js
|   |   |   |   utils.js
|   |   |   |   
|   |   |   \---collection
|   |   |           collection.js
|   |   |           index.js
|   |   |           node.js
|   |   |           
|   |   |   +---debug
|   |   |   |   |   .coveralls.yml
|   |   |   |   |   .eslintrc
|   |   |   |   |   .npmignore
|   |   |   |   |   .travis.yml
|   |   |   |   |   CHANGELOG.md
|   |   |   |   |   karma.conf.js
|   |   |   |   |   LICENSE
|   |   |   |   |   Makefile
|   |   |   |   |   node.js
|   |   |   |   |   package.json
|   |   |   |   |   README.md
|   |   |   |   |   
|   |   |   |   \---src
|   |   |   |           browser.js
|   |   |   |           debug.js
|   |   |   |           index.js
|   |   |   |           node.js
|   |   |   |           
|   |   |   +---ms
|   |   |   |       index.js
|   |   |   |       license.md
|   |   |   |       package.json
|   |   |   |       readme.md
|   |   |   |       
|   |   |   \---safe-buffer
|   |   |           index.d.ts
|   |   |           index.js
|   |   |           LICENSE
|   |   |           package.json
|   |   |           README.md
|   |   |           
|   |   \---test
|   |       |   env.js
|   |       |   index.js
|   |       |   utils.test.js
|   |       |   
|   |       \---collection
|   |               browser.js
|   |               mongo.js
|   |               node.js
|   |               
|   +---ms
|   |       index.js
|   |       license.md
|   |       package.json
|   |       readme.md
|   |       
|   +---nanoid
|   |   |   CHANGELOG.md
|   |   |   format.browser.js
|   |   |   format.js
|   |   |   generate.js
|   |   |   index.browser.js
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   random.browser.js
|   |   |   random.js
|   |   |   README.md
|   |   |   url.js
|   |   |   
|   |   +---async
|   |   |       format.browser.js
|   |   |       format.js
|   |   |       generate.js
|   |   |       index.browser.js
|   |   |       index.js
|   |   |       random.browser.js
|   |   |       random.js
|   |   |       random.rn.js
|   |   |       
|   |   \---non-secure
|   |           generate.js
|   |           index.js
|   |           
|   +---negotiator
|   |   |   HISTORY.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           charset.js
|   |           encoding.js
|   |           language.js
|   |           mediaType.js
|   |           
|   +---nice-try
|   |   |   CHANGELOG.md
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---src
|   |           index.js
|   |           
|   +---nodemon
|   |   |   .prettierrc.json
|   |   |   index.d.ts
|   |   |   jsconfig.json
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---bin
|   |   |       nodemon.js
|   |   |       windows-kill.exe
|   |   |       
|   |   +---doc
|   |   |   \---cli
|   |   |           authors.txt
|   |   |           config.txt
|   |   |           help.txt
|   |   |           logo.txt
|   |   |           options.txt
|   |   |           topics.txt
|   |   |           usage.txt
|   |   |           whoami.txt
|   |   |           
|   |   \---lib
|   |       |   index.js
|   |       |   nodemon.js
|   |       |   spawn.js
|   |       |   version.js
|   |       |   
|   |       +---cli
|   |       |       index.js
|   |       |       parse.js
|   |       |       
|   |       +---config
|   |       |       command.js
|   |       |       defaults.js
|   |       |       exec.js
|   |       |       index.js
|   |       |       load.js
|   |       |       
|   |       +---help
|   |       |       index.js
|   |       |       
|   |       +---monitor
|   |       |       index.js
|   |       |       match.js
|   |       |       run.js
|   |       |       signals.js
|   |       |       watch.js
|   |       |       
|   |       +---rules
|   |       |       add.js
|   |       |       index.js
|   |       |       parse.js
|   |       |       
|   |       \---utils
|   |               bus.js
|   |               clone.js
|   |               colour.js
|   |               index.js
|   |               log.js
|   |               merge.js
|   |               
|   +---normalize-path
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---notepack.io
|   |   |   HISTORY.md
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---browser
|   |   |       decode.js
|   |   |       encode.js
|   |   |       
|   |   +---dist
|   |   |       notepack.js
|   |   |       notepack.min.js
|   |   |       
|   |   \---lib
|   |           decode.js
|   |           DecodeKeyCache.js
|   |           encode.js
|   |           index.js
|   |           
|   +---npm-run-path
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---object-inspect
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package-support.json
|   |   |   package.json
|   |   |   readme.markdown
|   |   |   test-core-js.js
|   |   |   util.inspect.js
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   +---example
|   |   |       all.js
|   |   |       circular.js
|   |   |       fn.js
|   |   |       inspect.js
|   |   |       
|   |   \---test
|   |       |   bigint.js
|   |       |   circular.js
|   |       |   deep.js
|   |       |   element.js
|   |       |   err.js
|   |       |   fakes.js
|   |       |   fn.js
|   |       |   global.js
|   |       |   has.js
|   |       |   holes.js
|   |       |   indent-option.js
|   |       |   inspect.js
|   |       |   lowbyte.js
|   |       |   number.js
|   |       |   quoteStyle.js
|   |       |   toStringTag.js
|   |       |   undef.js
|   |       |   values.js
|   |       |   
|   |       \---browser
|   |               dom.js
|   |               
|   +---on-finished
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---once
|   |       LICENSE
|   |       once.js
|   |       package.json
|   |       README.md
|   |       
|   +---optional-require
|   |       index.js
|   |       package.json
|   |       README.md
|   |       
|   +---p-finally
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---parseurl
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---path-key
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---path-to-regexp
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       Readme.md
|   |       
|   +---picomatch
|   |   |   CHANGELOG.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           constants.js
|   |           parse.js
|   |           picomatch.js
|   |           scan.js
|   |           utils.js
|   |           
|   +---process-nextick-args
|   |       index.js
|   |       license.md
|   |       package.json
|   |       readme.md
|   |       
|   +---proxy-addr
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---pstree.remy
|   |   |   .travis.yml
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---lib
|   |   |       index.js
|   |   |       tree.js
|   |   |       utils.js
|   |   |       
|   |   \---tests
|   |       |   index.test.js
|   |       |   
|   |       \---fixtures
|   |               index.js
|   |               out1
|   |               out2
|   |               
|   +---pump
|   |   |   .travis.yml
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   test-browser.js
|   |   |   test-node.js
|   |   |   
|   |           FUNDING.yml
|   |           
|   +---qs
|   |   |   .editorconfig
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   LICENSE.md
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   +---dist
|   |   |       qs.js
|   |   |       
|   |   +---lib
|   |   |       formats.js
|   |   |       index.js
|   |   |       parse.js
|   |   |       stringify.js
|   |   |       utils.js
|   |   |       
|   |   \---test
|   |           empty-keys-cases.js
|   |           parse.js
|   |           stringify.js
|   |           utils.js
|   |           
|   +---range-parser
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---raw-body
|   |       HISTORY.md
|   |       index.d.ts
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       SECURITY.md
|   |       
|   +---readable-stream
|   |   |   .travis.yml
|   |   |   CONTRIBUTING.md
|   |   |   duplex-browser.js
|   |   |   duplex.js
|   |   |   GOVERNANCE.md
|   |   |   LICENSE
|   |   |   package.json
|   |   |   passthrough.js
|   |   |   readable-browser.js
|   |   |   readable.js
|   |   |   README.md
|   |   |   transform.js
|   |   |   writable-browser.js
|   |   |   writable.js
|   |   |   
|   |   +---doc
|   |   |   \---wg-meetings
|   |   |           2015-01-30.md
|   |   |           
|   |   +---lib
|   |   |   |   _stream_duplex.js
|   |   |   |   _stream_passthrough.js
|   |   |   |   _stream_readable.js
|   |   |   |   _stream_transform.js
|   |   |   |   _stream_writable.js
|   |   |   |   
|   |   |   \---internal
|   |   |       \---streams
|   |   |               BufferList.js
|   |   |               destroy.js
|   |   |               stream-browser.js
|   |   |               stream.js
|   |   |               
|   |       \---safe-buffer
|   |               index.d.ts
|   |               index.js
|   |               LICENSE
|   |               package.json
|   |               README.md
|   |               
|   +---readdirp
|   |       index.d.ts
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---redis
|   |   |   CHANGELOG.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           command.js
|   |           commands.js
|   |           createClient.js
|   |           customErrors.js
|   |           debug.js
|   |           extendedApi.js
|   |           individualCommands.js
|   |           multi.js
|   |           utils.js
|   |           
|   +---redis-commands
|   |   |   changelog.md
|   |   |   commands.json
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---tools
|   |           build.js
|   |           
|   +---redis-errors
|   |   |   .npmignore
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           modern.js
|   |           old.js
|   |           
|   +---redis-parser
|   |   |   .npmignore
|   |   |   changelog.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---lib
|   |           parser.js
|   |           
|   +---regexp-clone
|   |   |   .travis.yml
|   |   |   History.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   Makefile
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---test
|   |           index.js
|   |           
|   +---require-at
|   |       create-require.js
|   |       package.json
|   |       README.md
|   |       require-at.js
|   |       
|   +---safe-buffer
|   |       index.d.ts
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---safer-buffer
|   |       dangerous.js
|   |       LICENSE
|   |       package.json
|   |       Porting-Buffer.md
|   |       Readme.md
|   |       safer.js
|   |       tests.js
|   |       
|   +---saslprep
|   |   |   .editorconfig
|   |   |   .travis.yml
|   |   |   CHANGELOG.md
|   |   |   code-points.mem
|   |   |   generate-code-points.js
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   readme.md
|   |   |   
|   |   +---lib
|   |   |       code-points.js
|   |   |       memory-code-points.js
|   |   |       util.js
|   |   |       
|   |   \---test
|   |           index.js
|   |           util.js
|   |           
|   +---semver
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   preload.js
|   |   |   range.bnf
|   |   |   README.md
|   |   |   
|   |   +---bin
|   |   |       semver.js
|   |   |       
|   |   +---classes
|   |   |       comparator.js
|   |   |       index.js
|   |   |       range.js
|   |   |       semver.js
|   |   |       
|   |   +---functions
|   |   |       clean.js
|   |   |       cmp.js
|   |   |       coerce.js
|   |   |       compare-build.js
|   |   |       compare-loose.js
|   |   |       compare.js
|   |   |       diff.js
|   |   |       eq.js
|   |   |       gt.js
|   |   |       gte.js
|   |   |       inc.js
|   |   |       lt.js
|   |   |       lte.js
|   |   |       major.js
|   |   |       minor.js
|   |   |       neq.js
|   |   |       parse.js
|   |   |       patch.js
|   |   |       prerelease.js
|   |   |       rcompare.js
|   |   |       rsort.js
|   |   |       satisfies.js
|   |   |       sort.js
|   |   |       valid.js
|   |   |       
|   |   +---internal
|   |   |       constants.js
|   |   |       debug.js
|   |   |       identifiers.js
|   |   |       lrucache.js
|   |   |       parse-options.js
|   |   |       re.js
|   |   |       
|   |   \---ranges
|   |           gtr.js
|   |           intersects.js
|   |           ltr.js
|   |           max-satisfying.js
|   |           min-satisfying.js
|   |           min-version.js
|   |           outside.js
|   |           simplify.js
|   |           subset.js
|   |           to-comparators.js
|   |           valid.js
|   |           
|   +---send
|   |   |   HISTORY.md
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   SECURITY.md
|   |   |   
|   |       +---debug
|   |       |   |   .coveralls.yml
|   |       |   |   .eslintrc
|   |       |   |   .npmignore
|   |       |   |   .travis.yml
|   |       |   |   CHANGELOG.md
|   |       |   |   component.json
|   |       |   |   karma.conf.js
|   |       |   |   LICENSE
|   |       |   |   Makefile
|   |       |   |   node.js
|   |       |   |   package.json
|   |       |   |   README.md
|   |       |   |   
|   |       |   |   \---ms
|   |       |   |           index.js
|   |       |   |           license.md
|   |       |   |           package.json
|   |       |   |           readme.md
|   |       |   |           
|   |       |   \---src
|   |       |           browser.js
|   |       |           debug.js
|   |       |           index.js
|   |       |           inspector-log.js
|   |       |           node.js
|   |       |           
|   |       \---encodeurl
|   |               HISTORY.md
|   |               index.js
|   |               LICENSE
|   |               package.json
|   |               README.md
|   |               
|   +---serve-static
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---setprototypeof
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---test
|   |           index.js
|   |           
|   +---shebang-command
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---shebang-regex
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---side-channel
|   |   |   .editorconfig
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---side-channel-list
|   |   |   .editorconfig
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   list.d.ts
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---side-channel-map
|   |   |   .editorconfig
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---side-channel-weakmap
|   |   |   .editorconfig
|   |   |   .eslintrc
|   |   |   .nycrc
|   |   |   CHANGELOG.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   tsconfig.json
|   |   |   
|   |   |       FUNDING.yml
|   |   |       
|   |   \---test
|   |           index.js
|   |           
|   +---sift
|   |   |   changelog.md
|   |   |   index.d.ts
|   |   |   index.js
|   |   |   MIT-LICENSE.txt
|   |   |   package.json
|   |   |   README.md
|   |   |   sift.csp.min.js
|   |   |   sift.csp.min.js.map
|   |   |   sift.min.js
|   |   |   sift.min.js.map
|   |   |   
|   |   +---es
|   |   |       index.js
|   |   |       index.js.map
|   |   |       
|   |   +---es5m
|   |   |       index.js
|   |   |       index.js.map
|   |   |       
|   |   \---lib
|   |           core.d.ts
|   |           index.d.ts
|   |           index.js
|   |           index.js.map
|   |           operations.d.ts
|   |           utils.d.ts
|   |           
|   +---signal-exit
|   |       index.js
|   |       LICENSE.txt
|   |       package.json
|   |       README.md
|   |       signals.js
|   |       
|   +---simple-update-notifier
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---build
|   |   |       index.d.ts
|   |   |       index.js
|   |   |       
|   |   \---src
|   |           borderedText.ts
|   |           cache.spec.ts
|   |           cache.ts
|   |           getDistVersion.spec.ts
|   |           getDistVersion.ts
|   |           hasNewVersion.spec.ts
|   |           hasNewVersion.ts
|   |           index.spec.ts
|   |           index.ts
|   |           isNpmOrYarn.ts
|   |           types.ts
|   |           
|   +---sliced
|   |       History.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---sparse-bitfield
|   |       .npmignore
|   |       .travis.yml
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       test.js
|   |       
|   +---statuses
|   |       codes.json
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---string_decoder
|   |   |   .travis.yml
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   +---lib
|   |   |       string_decoder.js
|   |   |       
|   |       \---safe-buffer
|   |               index.d.ts
|   |               index.js
|   |               LICENSE
|   |               package.json
|   |               README.md
|   |               
|   +---strip-eof
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---supports-color
|   |       browser.js
|   |       index.js
|   |       license
|   |       package.json
|   |       readme.md
|   |       
|   +---to-regex-range
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---toidentifier
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---touch
|   |   |   index.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   \---bin
|   |           nodetouch.js
|   |           
|   +---type-is
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---undefsafe
|   |   |   .jscsrc
|   |   |   .jshintrc
|   |   |   .travis.yml
|   |   |   example.js
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   
|   |   |   \---workflows
|   |   |           release.yml
|   |   |           
|   |   \---lib
|   |           undefsafe.js
|   |           
|   +---undici-types
|   |       agent.d.ts
|   |       api.d.ts
|   |       balanced-pool.d.ts
|   |       cache.d.ts
|   |       client.d.ts
|   |       connector.d.ts
|   |       content-type.d.ts
|   |       cookies.d.ts
|   |       diagnostics-channel.d.ts
|   |       dispatcher.d.ts
|   |       env-http-proxy-agent.d.ts
|   |       errors.d.ts
|   |       eventsource.d.ts
|   |       fetch.d.ts
|   |       file.d.ts
|   |       filereader.d.ts
|   |       formdata.d.ts
|   |       global-dispatcher.d.ts
|   |       global-origin.d.ts
|   |       handlers.d.ts
|   |       header.d.ts
|   |       index.d.ts
|   |       interceptors.d.ts
|   |       LICENSE
|   |       mock-agent.d.ts
|   |       mock-client.d.ts
|   |       mock-errors.d.ts
|   |       mock-interceptor.d.ts
|   |       mock-pool.d.ts
|   |       package.json
|   |       patch.d.ts
|   |       pool-stats.d.ts
|   |       pool.d.ts
|   |       proxy-agent.d.ts
|   |       readable.d.ts
|   |       README.md
|   |       retry-agent.d.ts
|   |       retry-handler.d.ts
|   |       util.d.ts
|   |       webidl.d.ts
|   |       websocket.d.ts
|   |       
|   +---unpipe
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---util-deprecate
|   |       browser.js
|   |       History.md
|   |       LICENSE
|   |       node.js
|   |       package.json
|   |       README.md
|   |       
|   +---utils-merge
|   |       .npmignore
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---vary
|   |       HISTORY.md
|   |       index.js
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       
|   +---which
|   |   |   CHANGELOG.md
|   |   |   LICENSE
|   |   |   package.json
|   |   |   README.md
|   |   |   which.js
|   |   |   
|   |   \---bin
|   |           which
|   |           
|   +---wrappy
|   |       LICENSE
|   |       package.json
|   |       README.md
|   |       wrappy.js
|   |       
|   \---ws
|       |   browser.js
|       |   index.js
|       |   LICENSE
|       |   package.json
|       |   README.md
|       |   
|       \---lib
|               buffer-util.js
|               constants.js
|               event-target.js
|               extension.js
|               limiter.js
|               permessage-deflate.js
|               receiver.js
|               sender.js
|               stream.js
|               validation.js
|               websocket-server.js
|               websocket.js
|               
+---public
|       minimal.html
|       
\---server
    +---core
    |   |   BaseRoom.js
    |   |   index.js
    |   |   server.js
    |   |   
    |   \---schemas
    |           BaseEntity.js
    |           DefaultRoom.js
    |           GameConfigSchema.js
    |           GameState.js
    |           ImplementationDataSchema.js
    |           InputState.js
    |           Player.js
    |           Structure.js
    |           
    \---implementations
        \---default
                index.js
                
 
===================================================== 
 
 
===================================================== 
FILE: four_player_setup.html 
===================================================== 
 
<!DOCTYPE html>
<html>
<head>
    <title>3D AI Game - Multi-Player Setup</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .container {
            width: 100vw;
            height: 100vh;
            gap: 2px;
            background-color: #000;
            display: grid;
        }
        /* 2 players: top-bottom split */
        .players-2 {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr 1fr;
        }
        /* 3 players: top left, top right, bottom left */
        .players-3 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        .players-3 iframe:last-of-type {
            grid-column: 1;
            grid-row: 2;
        }
        /* 4 players: 2x2 grid */
        .players-4 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #implementation-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            z-index: 1000;
        }
    </style>
    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            // Get number of players from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const playerCount = parseInt(urlParams.get('players')) || 4;
            
            // Set container class based on player count
            const container = document.querySelector('.container');
            container.className = `container players-${playerCount}`;
            
            // Create iframes based on player count
            container.innerHTML = '';
            for (let i = 0; i < playerCount; i++) {
                const iframe = document.createElement('iframe');
                iframe.src = 'http://localhost:3000';
                container.appendChild(iframe);
            }

            // Fetch implementation info
            try {
                const response = await fetch('http://localhost:3000/api/config');
                if (response.ok) {
                    const config = await response.json();
                    document.title = `3D AI Game - ${playerCount} Players - ${config.activeImplementation}`;
                    
                    const implDisplay = document.createElement('div');
                    implDisplay.id = 'implementation-display';
                    implDisplay.textContent = `Implementation: ${config.activeImplementation}`;
                    document.body.appendChild(implDisplay);
                }
            } catch (error) {
                console.error('Failed to fetch implementation info:', error);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <!-- iframes will be added by JavaScript -->
    </div>
</body>
</html>  
 
===================================================== 
FILE: README.md 
===================================================== 
 
# 3D AI Game Platform

A modular 3D multiplayer browser-based game platform with support for various game implementations.

## Project Structure

The project follows a modular architecture with core components separated from implementation-specific code:

```
/
 client/                 # Client-side code
    css/                # Stylesheets
    js/                 # JavaScript code
       core/           # Core client components
          main.js     # Main entry point
          game-engine.js # Game engine
          controls.js # Input controls
          ...         # Other core modules
       implementations/ # Implementation-specific client code
           ...         # Various game implementations
    index.html          # Main HTML file
 server/                 # Server-side code
    core/               # Core server components
       server.js       # Server entry point
       index.js        # Core server logic
       BaseRoom.js     # Base room implementation
       schemas/        # Core data schemas
    implementations/    # Implementation-specific server code
        ...             # Various game implementations
 package.json            # Node.js package configuration
```

## Getting Started

1. Install dependencies:
```
npm install
```

2. Start the server:
```
npm start
```

3. Open your browser to `http://localhost:3000`

## Core vs. Implementation

The codebase separates core functionality from implementation-specific code:

- **Core** components provide the underlying game platform features.
- **Implementations** build on the core to create specific games.

To create a new implementation, see the existing examples in the implementations directory.

## Modular Design

The platform follows a modular architecture that separates core functionality from game-specific implementations. This allows for:

- **Multiple Game Implementations**: Create different games using the same platform code
- **Code Reuse**: Share common functionality across implementations
- **Clean Separation**: Keep game-specific code isolated from platform code
- **Easy Extension**: Add new implementations without modifying core code

## Current Implementations

### Numberblocks

The first implementation is a mathematical building blocks game inspired by the Numberblocks educational show. Players control Numberblock characters and interact with operators (+, -) in a fun mathematical environment.

- **Features**: Dynamic number blocks, mathematical operators, player interaction
- **Objectives**: Various game modes including target number challenges and elimination

## Tech Stack

- **Front-End**: HTML5, CSS3, JavaScript (ES6+), Three.js
- **Back-End**: Node.js, Colyseus (WebSocket-based multiplayer framework)
- **Development Tools**: Git, Nodemon

## Adding New Implementations

To create a new game implementation:

1. Create a new directory under `/client/js/implementations/`
2. Create a new directory under `/server/implementations/`
3. Extend the core Entity, Player, and NPC classes for your game implementation
4. Create implementation-specific schemas on the server
5. Register your implementation with the entity factories

See the Numberblocks implementation for an example.

## Camera Controls

- **WASD**: Move the player
- **Mouse**: Look around
- **V**: Toggle between first-person, third-person, and free roam views
- **Q/E**: Rotate player in third-person view
 
 
===================================================== 
FILE: package-lock.json 
===================================================== 
 
{
  "name": "3d-ai-game-platform",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "3d-ai-game-platform",
      "version": "1.0.0",
      "license": "ISC",
      "dependencies": {
        "colyseus": "^0.14.13",
        "express": "^4.21.2"
      },
      "devDependencies": {
        "nodemon": "^3.1.9"
      }
    },
    "node_modules/@colyseus/core": {
      "version": "0.14.36",
      "resolved": "https://registry.npmjs.org/@colyseus/core/-/core-0.14.36.tgz",
      "integrity": "sha512-Gy1/3xQV6Fd/NmmmWD3Cgb1aC2w516GGmOELcrKAgEBP0LAEal19hz0DaQRVJuLkUCo/9j5OxqK0ZvED4925YQ==",
      "dependencies": {
        "@colyseus/greeting-banner": "^1.0.0",
        "@colyseus/schema": "^1.0.15",
        "@gamestdio/timer": "^1.3.0",
        "@types/redis": "^2.8.12",
        "debug": "^4.0.1",
        "internal-ip": "^4.3.0",
        "nanoid": "^2.0.0",
        "notepack.io": "^2.2.0"
      },
      "engines": {
        "node": ">= 14.x"
      }
    },
    "node_modules/@colyseus/greeting-banner": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/@colyseus/greeting-banner/-/greeting-banner-1.0.0.tgz",
      "integrity": "sha512-B/gAslDjeIUdelpF/ILycRLVIwisgoNCw70MlzwntOrfYwZ5L6MA9SDd8hGG+ONN6Ic8MkziZpyo8UqApLXLfg=="
    },
    "node_modules/@colyseus/mongoose-driver": {
      "version": "0.14.22",
      "resolved": "https://registry.npmjs.org/@colyseus/mongoose-driver/-/mongoose-driver-0.14.22.tgz",
      "integrity": "sha512-Bqg+1XGHo4t3UUqBxSCDuvxzuuDBObxOWVBH0GjdFmXWzJgrkMgkDFH8YXjo9h/sXaPRJNzJRlXMCV1txbYadw==",
      "dependencies": {
        "@colyseus/core": "^0.14.20",
        "mongoose": "^5.11.3"
      }
    },
    "node_modules/@colyseus/redis-presence": {
      "version": "0.14.22",
      "resolved": "https://registry.npmjs.org/@colyseus/redis-presence/-/redis-presence-0.14.22.tgz",
      "integrity": "sha512-VBdvJccjcEop24elJtcTdknA/kfh8wvg2/a+xnsH9z38GwtjI9Tsa8ZcjubiTMBP0f3Ye+gw/7ocjBZ/yzKwhA==",
      "dependencies": {
        "@colyseus/core": "^0.14.20",
        "redis": "^3.1.1"
      }
    },
    "node_modules/@colyseus/schema": {
      "version": "1.0.46",
      "resolved": "https://registry.npmjs.org/@colyseus/schema/-/schema-1.0.46.tgz",
      "integrity": "sha512-0cgirRomXDuDlppgJPXDLzsWw8/ZHwJEnndgzyX9hOCoFHJyFIyOYoKIV4eVPtKNQm6l6rGax1rE2LId4ujr4g==",
      "bin": {
        "schema-codegen": "bin/schema-codegen"
      }
    },
    "node_modules/@colyseus/ws-transport": {
      "version": "0.14.21",
      "resolved": "https://registry.npmjs.org/@colyseus/ws-transport/-/ws-transport-0.14.21.tgz",
      "integrity": "sha512-lQXqwp5MOAdFLOn6UCuSZh0hqFMRYjAkW0B0qCNqKjaGjhsupF+z6hdEX5erJpLmdMiL4wxipvYaYoG2KjxfwA==",
      "dependencies": {
        "@colyseus/core": "^0.14.20",
        "@colyseus/schema": "^1.0.15",
        "@types/ws": "^7.4.4",
        "ws": "^7.4.5"
      }
    },
    "node_modules/@gamestdio/clock": {
      "version": "1.1.9",
      "resolved": "https://registry.npmjs.org/@gamestdio/clock/-/clock-1.1.9.tgz",
      "integrity": "sha512-O+PG3aRRytgX2BhAPMIhbM2ftq1Q8G4xUrYjEWYM6EmpoKn8oY4lXENGhpgfww6mQxHPbjfWyIAR6Xj3y1+avw=="
    },
    "node_modules/@gamestdio/timer": {
      "version": "1.4.2",
      "resolved": "https://registry.npmjs.org/@gamestdio/timer/-/timer-1.4.2.tgz",
      "integrity": "sha512-WNciVCKSJzY56CM95TCVf+dtWShWNFUdziY1Qc+2gaqNCRbC3Egqzq9zumGRrV92Ym9GL6znkqTzF2AoAdydNw==",
      "dependencies": {
        "@gamestdio/clock": "^1.1.9"
      }
    },
    "node_modules/@types/bson": {
      "version": "4.0.5",
      "resolved": "https://registry.npmjs.org/@types/bson/-/bson-4.0.5.tgz",
      "integrity": "sha512-vVLwMUqhYJSQ/WKcE60eFqcyuWse5fGH+NMAXHuKrUAPoryq3ATxk5o4bgYNtg5aOM4APVg7Hnb3ASqUYG0PKg==",
      "dependencies": {
        "@types/node": "*"
      }
    },
    "node_modules/@types/mongodb": {
      "version": "3.6.20",
      "resolved": "https://registry.npmjs.org/@types/mongodb/-/mongodb-3.6.20.tgz",
      "integrity": "sha512-WcdpPJCakFzcWWD9juKoZbRtQxKIMYF/JIAM4JrNHrMcnJL6/a2NWjXxW7fo9hxboxxkg+icff8d7+WIEvKgYQ==",
      "dependencies": {
        "@types/bson": "*",
        "@types/node": "*"
      }
    },
    "node_modules/@types/node": {
      "version": "22.13.14",
      "resolved": "https://registry.npmjs.org/@types/node/-/node-22.13.14.tgz",
      "integrity": "sha512-Zs/Ollc1SJ8nKUAgc7ivOEdIBM8JAKgrqqUYi2J997JuKO7/tpQC+WCetQ1sypiKCQWHdvdg9wBNpUPEWZae7w==",
      "dependencies": {
        "undici-types": "~6.20.0"
      }
    },
    "node_modules/@types/redis": {
      "version": "2.8.32",
      "resolved": "https://registry.npmjs.org/@types/redis/-/redis-2.8.32.tgz",
      "integrity": "sha512-7jkMKxcGq9p242exlbsVzuJb57KqHRhNl4dHoQu2Y5v9bCAbtIXXH0R3HleSQW4CTOqpHIYUW3t6tpUj4BVQ+w==",
      "dependencies": {
        "@types/node": "*"
      }
    },
    "node_modules/@types/ws": {
      "version": "7.4.7",
      "resolved": "https://registry.npmjs.org/@types/ws/-/ws-7.4.7.tgz",
      "integrity": "sha512-JQbbmxZTZehdc2iszGKs5oC3NFnjeay7mtAWrdt7qNtAVK0g19muApzAy4bm9byz79xa2ZnO/BOBC2R8RC5Lww==",
      "dependencies": {
        "@types/node": "*"
      }
    },
    "node_modules/accepts": {
      "version": "1.3.8",
      "resolved": "https://registry.npmjs.org/accepts/-/accepts-1.3.8.tgz",
      "integrity": "sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==",
      "dependencies": {
        "mime-types": "~2.1.34",
        "negotiator": "0.6.3"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/anymatch": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/anymatch/-/anymatch-3.1.3.tgz",
      "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
      "dev": true,
      "dependencies": {
        "normalize-path": "^3.0.0",
        "picomatch": "^2.0.4"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/array-flatten": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/array-flatten/-/array-flatten-1.1.1.tgz",
      "integrity": "sha512-PCVAQswWemu6UdxsDFFX/+gVeYqKAod3D3UVm91jHwynguOwAvYPhx8nNlM++NqRcK6CxxpUafjmhIdKiHibqg=="
    },
    "node_modules/balanced-match": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
      "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
      "dev": true
    },
    "node_modules/binary-extensions": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/binary-extensions/-/binary-extensions-2.3.0.tgz",
      "integrity": "sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==",
      "dev": true,
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/bl": {
      "version": "2.2.1",
      "resolved": "https://registry.npmjs.org/bl/-/bl-2.2.1.tgz",
      "integrity": "sha512-6Pesp1w0DEX1N550i/uGV/TqucVL4AM/pgThFSN/Qq9si1/DF9aIHs1BxD8V/QU0HoeHO6cQRTAuYnLPKq1e4g==",
      "dependencies": {
        "readable-stream": "^2.3.5",
        "safe-buffer": "^5.1.1"
      }
    },
    "node_modules/bluebird": {
      "version": "3.5.1",
      "resolved": "https://registry.npmjs.org/bluebird/-/bluebird-3.5.1.tgz",
      "integrity": "sha512-MKiLiV+I1AA596t9w1sQJ8jkiSr5+ZKi0WKrYGUn6d1Fx+Ij4tIj+m2WMQSGczs5jZVxV339chE8iwk6F64wjA=="
    },
    "node_modules/body-parser": {
      "version": "1.20.3",
      "resolved": "https://registry.npmjs.org/body-parser/-/body-parser-1.20.3.tgz",
      "integrity": "sha512-7rAxByjUMqQ3/bHJy7D6OGXvx/MMc4IqBn/X0fcM1QUcAItpZrBEYhWGem+tzXH90c+G01ypMcYJBO9Y30203g==",
      "dependencies": {
        "bytes": "3.1.2",
        "content-type": "~1.0.5",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "http-errors": "2.0.0",
        "iconv-lite": "0.4.24",
        "on-finished": "2.4.1",
        "qs": "6.13.0",
        "raw-body": "2.5.2",
        "type-is": "~1.6.18",
        "unpipe": "1.0.0"
      },
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/body-parser/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/body-parser/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A=="
    },
    "node_modules/brace-expansion": {
      "version": "1.1.11",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-1.1.11.tgz",
      "integrity": "sha512-iCuPHDFgrHX7H2vEI/5xpz07zSHB00TpugqhmYtVmMO6518mCuRMoOYFldEBl0g187ufozdaHgWKcYFb61qGiA==",
      "dev": true,
      "dependencies": {
        "balanced-match": "^1.0.0",
        "concat-map": "0.0.1"
      }
    },
    "node_modules/braces": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
      "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
      "dev": true,
      "dependencies": {
        "fill-range": "^7.1.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/bson": {
      "version": "1.1.6",
      "resolved": "https://registry.npmjs.org/bson/-/bson-1.1.6.tgz",
      "integrity": "sha512-EvVNVeGo4tHxwi8L6bPj3y3itEvStdwvvlojVxxbyYfoaxJ6keLgrTuKdyfEAszFK+H3olzBuafE0yoh0D1gdg==",
      "engines": {
        "node": ">=0.6.19"
      }
    },
    "node_modules/bytes": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/bytes/-/bytes-3.1.2.tgz",
      "integrity": "sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/call-bind-apply-helpers": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
      "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
      "dependencies": {
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/call-bound": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/call-bound/-/call-bound-1.0.4.tgz",
      "integrity": "sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "get-intrinsic": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/chokidar": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/chokidar/-/chokidar-3.6.0.tgz",
      "integrity": "sha512-7VT13fmjotKpGipCW9JEQAusEPE+Ei8nl6/g4FBAmIm0GOOLMua9NDDo/DWp0ZAxCr3cPq5ZpBqmPAQgDda2Pw==",
      "dev": true,
      "dependencies": {
        "anymatch": "~3.1.2",
        "braces": "~3.0.2",
        "glob-parent": "~5.1.2",
        "is-binary-path": "~2.1.0",
        "is-glob": "~4.0.1",
        "normalize-path": "~3.0.0",
        "readdirp": "~3.6.0"
      },
      "engines": {
        "node": ">= 8.10.0"
      },
      "funding": {
        "url": "https://paulmillr.com/funding/"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/colyseus": {
      "version": "0.14.24",
      "resolved": "https://registry.npmjs.org/colyseus/-/colyseus-0.14.24.tgz",
      "integrity": "sha512-plKZ2vmxyHDo01ZUaNwmTz5L6uAn1PDJG7gPi8bgsXXVpBIrM6YuiMgw8qNq8lZdqjEuL9uDLxGjgwnXVq6NqQ==",
      "dependencies": {
        "@colyseus/core": "^0.14.33",
        "@colyseus/mongoose-driver": "^0.14.22",
        "@colyseus/redis-presence": "^0.14.21",
        "@colyseus/ws-transport": "^0.14.21"
      },
      "engines": {
        "node": ">= 14.x"
      }
    },
    "node_modules/concat-map": {
      "version": "0.0.1",
      "resolved": "https://registry.npmjs.org/concat-map/-/concat-map-0.0.1.tgz",
      "integrity": "sha512-/Srv4dswyQNBfohGpz9o6Yb3Gz3SrUDqBH5rTuhGR7ahtlbYKnVxw2bCFMRljaA7EXHaXZ8wsHdodFvbkhKmqg==",
      "dev": true
    },
    "node_modules/content-disposition": {
      "version": "0.5.4",
      "resolved": "https://registry.npmjs.org/content-disposition/-/content-disposition-0.5.4.tgz",
      "integrity": "sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==",
      "dependencies": {
        "safe-buffer": "5.2.1"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/content-type": {
      "version": "1.0.5",
      "resolved": "https://registry.npmjs.org/content-type/-/content-type-1.0.5.tgz",
      "integrity": "sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie": {
      "version": "0.7.1",
      "resolved": "https://registry.npmjs.org/cookie/-/cookie-0.7.1.tgz",
      "integrity": "sha512-6DnInpx7SJ2AK3+CTUE/ZM0vWTUboZCegxhC2xiIydHR9jNuTAASBrfEpHhiGOZw/nX51bHt6YQl8jsGo4y/0w==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie-signature": {
      "version": "1.0.6",
      "resolved": "https://registry.npmjs.org/cookie-signature/-/cookie-signature-1.0.6.tgz",
      "integrity": "sha512-QADzlaHc8icV8I7vbaJXJwod9HWYp8uCqf1xa4OfNu1T7JVxQIrUgOWtHdNDtPiywmFbiS12VjotIXLrKM3orQ=="
    },
    "node_modules/core-util-is": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/core-util-is/-/core-util-is-1.0.3.tgz",
      "integrity": "sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ=="
    },
    "node_modules/cross-spawn": {
      "version": "6.0.6",
      "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-6.0.6.tgz",
      "integrity": "sha512-VqCUuhcd1iB+dsv8gxPttb5iZh/D0iubSP21g36KXdEuf6I5JiioesUVjpCdHV9MZRUfVFlvwtIUyPfxo5trtw==",
      "dependencies": {
        "nice-try": "^1.0.4",
        "path-key": "^2.0.1",
        "semver": "^5.5.0",
        "shebang-command": "^1.2.0",
        "which": "^1.2.9"
      },
      "engines": {
        "node": ">=4.8"
      }
    },
    "node_modules/cross-spawn/node_modules/semver": {
      "version": "5.7.2",
      "resolved": "https://registry.npmjs.org/semver/-/semver-5.7.2.tgz",
      "integrity": "sha512-cBznnQ9KjJqU67B52RMC65CMarK2600WFnbkcaiwWq3xy/5haFJlshgnpjovMVJ+Hff49d8GEn0b87C5pDQ10g==",
      "bin": {
        "semver": "bin/semver"
      }
    },
    "node_modules/debug": {
      "version": "4.4.0",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.0.tgz",
      "integrity": "sha512-6WTZ/IxCY/T6BALoZHaE4ctp9xm+Z5kY/pzYaCHRFeyVhojxlrm+46y68HA6hr0TcwEssoxNiDEUJQjfPZ/RYA==",
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/default-gateway": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/default-gateway/-/default-gateway-4.2.0.tgz",
      "integrity": "sha512-h6sMrVB1VMWVrW13mSc6ia/DwYYw5MN6+exNu1OaJeFac5aSAvwM7lZ0NVfTABuSkQelr4h5oebg3KB1XPdjgA==",
      "dependencies": {
        "execa": "^1.0.0",
        "ip-regex": "^2.1.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/denque": {
      "version": "1.5.1",
      "resolved": "https://registry.npmjs.org/denque/-/denque-1.5.1.tgz",
      "integrity": "sha512-XwE+iZ4D6ZUB7mfYRMb5wByE8L74HCn30FBN7sWnXksWc1LO1bPDl67pBR9o/kC4z/xSNAwkMYcGgqDV3BE3Hw==",
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/depd": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/destroy": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/destroy/-/destroy-1.2.0.tgz",
      "integrity": "sha512-2sJGJTaXIIaR1w4iJSNoN0hnMY7Gpc/n8D4qSCJw8QqFWXf7cuAgnEHxBpweaVcPevC2l3KpjYCx3NypQQgaJg==",
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/dunder-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/dunder-proto/-/dunder-proto-1.0.1.tgz",
      "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.1",
        "es-errors": "^1.3.0",
        "gopd": "^1.2.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/ee-first": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/ee-first/-/ee-first-1.1.1.tgz",
      "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow=="
    },
    "node_modules/encodeurl": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/end-of-stream": {
      "version": "1.4.4",
      "resolved": "https://registry.npmjs.org/end-of-stream/-/end-of-stream-1.4.4.tgz",
      "integrity": "sha512-+uw1inIHVPQoaVuHzRyXd21icM+cnt4CzD5rW+NC1wjOUSTOs+Te7FOv7AhN7vS9x/oIyhLP5PR1H+phQAHu5Q==",
      "dependencies": {
        "once": "^1.4.0"
      }
    },
    "node_modules/es-define-property": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/es-define-property/-/es-define-property-1.0.1.tgz",
      "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-errors": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/es-errors/-/es-errors-1.3.0.tgz",
      "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-object-atoms": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
      "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
      "dependencies": {
        "es-errors": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/escape-html": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/escape-html/-/escape-html-1.0.3.tgz",
      "integrity": "sha512-NiSupZ4OeuGwr68lGIeym/ksIZMJodUGOSCZ/FSnTxcrekbvqrgdUxlJOMpijaKZVjAJrWrGs/6Jy8OMuyj9ow=="
    },
    "node_modules/etag": {
      "version": "1.8.1",
      "resolved": "https://registry.npmjs.org/etag/-/etag-1.8.1.tgz",
      "integrity": "sha512-aIL5Fx7mawVa300al2BnEE4iNvo1qETxLrPI/o05L7z6go7fCw1J6EQmbK4FmJ2AS7kgVF/KEZWufBfdClMcPg==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/execa": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/execa/-/execa-1.0.0.tgz",
      "integrity": "sha512-adbxcyWV46qiHyvSp50TKt05tB4tK3HcmF7/nxfAdhnox83seTDbwnaqKO4sXRy7roHAIFqJP/Rw/AuEbX61LA==",
      "dependencies": {
        "cross-spawn": "^6.0.0",
        "get-stream": "^4.0.0",
        "is-stream": "^1.1.0",
        "npm-run-path": "^2.0.0",
        "p-finally": "^1.0.0",
        "signal-exit": "^3.0.0",
        "strip-eof": "^1.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/express": {
      "version": "4.21.2",
      "resolved": "https://registry.npmjs.org/express/-/express-4.21.2.tgz",
      "integrity": "sha512-28HqgMZAmih1Czt9ny7qr6ek2qddF4FclbMzwhCREB6OFfH+rXAnuNCwo1/wFvrtbgsQDb4kSbX9de9lFbrXnA==",
      "dependencies": {
        "accepts": "~1.3.8",
        "array-flatten": "1.1.1",
        "body-parser": "1.20.3",
        "content-disposition": "0.5.4",
        "content-type": "~1.0.4",
        "cookie": "0.7.1",
        "cookie-signature": "1.0.6",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "finalhandler": "1.3.1",
        "fresh": "0.5.2",
        "http-errors": "2.0.0",
        "merge-descriptors": "1.0.3",
        "methods": "~1.1.2",
        "on-finished": "2.4.1",
        "parseurl": "~1.3.3",
        "path-to-regexp": "0.1.12",
        "proxy-addr": "~2.0.7",
        "qs": "6.13.0",
        "range-parser": "~1.2.1",
        "safe-buffer": "5.2.1",
        "send": "0.19.0",
        "serve-static": "1.16.2",
        "setprototypeof": "1.2.0",
        "statuses": "2.0.1",
        "type-is": "~1.6.18",
        "utils-merge": "1.0.1",
        "vary": "~1.1.2"
      },
      "engines": {
        "node": ">= 0.10.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/express/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/express/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A=="
    },
    "node_modules/fill-range": {
      "version": "7.1.1",
      "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
      "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
      "dev": true,
      "dependencies": {
        "to-regex-range": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/finalhandler": {
      "version": "1.3.1",
      "resolved": "https://registry.npmjs.org/finalhandler/-/finalhandler-1.3.1.tgz",
      "integrity": "sha512-6BN9trH7bp3qvnrRyzsBz+g3lZxTNZTbVO2EV1CS0WIcDbawYVdYvGflME/9QP0h0pYlCDBCTjYa9nZzMDpyxQ==",
      "dependencies": {
        "debug": "2.6.9",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "on-finished": "2.4.1",
        "parseurl": "~1.3.3",
        "statuses": "2.0.1",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/finalhandler/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/finalhandler/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A=="
    },
    "node_modules/forwarded": {
      "version": "0.2.0",
      "resolved": "https://registry.npmjs.org/forwarded/-/forwarded-0.2.0.tgz",
      "integrity": "sha512-buRG0fpBtRHSTCOASe6hD258tEubFoRLb4ZNA6NxMVHNw2gOcwHo9wyablzMzOA5z9xA9L1KNjk/Nt6MT9aYow==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/fresh": {
      "version": "0.5.2",
      "resolved": "https://registry.npmjs.org/fresh/-/fresh-0.5.2.tgz",
      "integrity": "sha512-zJ2mQYM18rEFOudeV4GShTGIQ7RbzA7ozbU9I/XBpm7kqgMywgmylMwXHxZJmkVoYkna9d2pVXVXPdYTP9ej8Q==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-intrinsic": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
      "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "function-bind": "^1.1.2",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "math-intrinsics": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz",
      "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/get-stream": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/get-stream/-/get-stream-4.1.0.tgz",
      "integrity": "sha512-GMat4EJ5161kIy2HevLlr4luNjBgvmj413KaQA7jt4V8B4RDsfpHk7WQ9GVqfYyyx8OS/L66Kox+rJRNklLK7w==",
      "dependencies": {
        "pump": "^3.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "dev": true,
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/gopd": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/gopd/-/gopd-1.2.0.tgz",
      "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-flag": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/has-flag/-/has-flag-3.0.0.tgz",
      "integrity": "sha512-sKJf1+ceQBr4SMkvQnBDNDtf4TXpVhVGateu0t918bl30FnbE2m4vNLX+VWe/dpjlb+HugGYzW7uQXH98HPEYw==",
      "dev": true,
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/has-symbols": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/has-symbols/-/has-symbols-1.1.0.tgz",
      "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/http-errors": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.0.tgz",
      "integrity": "sha512-FtwrG/euBzaEjYeRqOgly7G0qviiXoJWnvEH2Z1plBdXgbyjv34pHTSb9zoeHMyDy33+DWy5Wt9Wo+TURtOYSQ==",
      "dependencies": {
        "depd": "2.0.0",
        "inherits": "2.0.4",
        "setprototypeof": "1.2.0",
        "statuses": "2.0.1",
        "toidentifier": "1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/iconv-lite": {
      "version": "0.4.24",
      "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.4.24.tgz",
      "integrity": "sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/ignore-by-default": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/ignore-by-default/-/ignore-by-default-1.0.1.tgz",
      "integrity": "sha512-Ius2VYcGNk7T90CppJqcIkS5ooHUZyIQK+ClZfMfMNFEF9VSE73Fq+906u/CWu92x4gzZMWOwfFYckPObzdEbA==",
      "dev": true
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ=="
    },
    "node_modules/internal-ip": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/internal-ip/-/internal-ip-4.3.0.tgz",
      "integrity": "sha512-S1zBo1D6zcsyuC6PMmY5+55YMILQ9av8lotMx447Bq6SAgo/sDK6y6uUKmuYhW7eacnIhFfsPmCNYdDzsnnDCg==",
      "dependencies": {
        "default-gateway": "^4.2.0",
        "ipaddr.js": "^1.9.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/ip-regex": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/ip-regex/-/ip-regex-2.1.0.tgz",
      "integrity": "sha512-58yWmlHpp7VYfcdTwMTvwMmqx/Elfxjd9RXTDyMsbL7lLWmhMylLEqiYVLKuLzOZqVgiWXD9MfR62Vv89VRxkw==",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/ipaddr.js": {
      "version": "1.9.1",
      "resolved": "https://registry.npmjs.org/ipaddr.js/-/ipaddr.js-1.9.1.tgz",
      "integrity": "sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==",
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/is-binary-path": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/is-binary-path/-/is-binary-path-2.1.0.tgz",
      "integrity": "sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==",
      "dev": true,
      "dependencies": {
        "binary-extensions": "^2.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-extglob": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
      "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-glob": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
      "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
      "dev": true,
      "dependencies": {
        "is-extglob": "^2.1.1"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-number": {
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
      "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
      "dev": true,
      "engines": {
        "node": ">=0.12.0"
      }
    },
    "node_modules/is-stream": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/is-stream/-/is-stream-1.1.0.tgz",
      "integrity": "sha512-uQPm8kcs47jx38atAcWTVxyltQYoPT68y9aWYdV6yWXSyW8mzSat0TL6CiWdZeCdF3KrAvpVtnHbTv4RN+rqdQ==",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/isarray": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/isarray/-/isarray-1.0.0.tgz",
      "integrity": "sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ=="
    },
    "node_modules/isexe": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/isexe/-/isexe-2.0.0.tgz",
      "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw=="
    },
    "node_modules/kareem": {
      "version": "2.3.2",
      "resolved": "https://registry.npmjs.org/kareem/-/kareem-2.3.2.tgz",
      "integrity": "sha512-STHz9P7X2L4Kwn72fA4rGyqyXdmrMSdxqHx9IXon/FXluXieaFA6KJ2upcHAHxQPQ0LeM/OjLrhFxifHewOALQ=="
    },
    "node_modules/math-intrinsics": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
      "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/media-typer": {
      "version": "0.3.0",
      "resolved": "https://registry.npmjs.org/media-typer/-/media-typer-0.3.0.tgz",
      "integrity": "sha512-dq+qelQ9akHpcOl/gUVRTxVIOkAJ1wR3QAvb4RsVjS8oVoFjDGTc679wJYmUmknUF5HwMLOgb5O+a3KxfWapPQ==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/memory-pager": {
      "version": "1.5.0",
      "resolved": "https://registry.npmjs.org/memory-pager/-/memory-pager-1.5.0.tgz",
      "integrity": "sha512-ZS4Bp4r/Zoeq6+NLJpP+0Zzm0pR8whtGPf1XExKLJBAczGMnSi3It14OiNCStjQjM6NU1okjQGSxgEZN8eBYKg==",
      "optional": true
    },
    "node_modules/merge-descriptors": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-1.0.3.tgz",
      "integrity": "sha512-gaNvAS7TZ897/rVaZ0nMtAyxNyi/pdbjbAwUpFQpN70GqnVfOiXpeUUMKRBmzXaSQ8DdTX4/0ms62r2K+hE6mQ==",
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/methods": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/methods/-/methods-1.1.2.tgz",
      "integrity": "sha512-iclAHeNqNm68zFtnZ0e+1L2yUIdvzNoauKU4WBA3VvH/vPFieF7qfRlwUZU+DA9P9bPXIS90ulxoUoCH23sV2w==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/mime/-/mime-1.6.0.tgz",
      "integrity": "sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==",
      "bin": {
        "mime": "cli.js"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/mime-db": {
      "version": "1.52.0",
      "resolved": "https://registry.npmjs.org/mime-db/-/mime-db-1.52.0.tgz",
      "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime-types": {
      "version": "2.1.35",
      "resolved": "https://registry.npmjs.org/mime-types/-/mime-types-2.1.35.tgz",
      "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
      "dependencies": {
        "mime-db": "1.52.0"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/minimatch": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-3.1.2.tgz",
      "integrity": "sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==",
      "dev": true,
      "dependencies": {
        "brace-expansion": "^1.1.7"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/mongodb": {
      "version": "3.7.4",
      "resolved": "https://registry.npmjs.org/mongodb/-/mongodb-3.7.4.tgz",
      "integrity": "sha512-K5q8aBqEXMwWdVNh94UQTwZ6BejVbFhh1uB6c5FKtPE9eUMZPUO3sRZdgIEcHSrAWmxzpG/FeODDKL388sqRmw==",
      "dependencies": {
        "bl": "^2.2.1",
        "bson": "^1.1.4",
        "denque": "^1.4.1",
        "optional-require": "^1.1.8",
        "safe-buffer": "^5.1.2"
      },
      "engines": {
        "node": ">=4"
      },
      "optionalDependencies": {
        "saslprep": "^1.0.0"
      },
      "peerDependenciesMeta": {
        "aws4": {
          "optional": true
        },
        "bson-ext": {
          "optional": true
        },
        "kerberos": {
          "optional": true
        },
        "mongodb-client-encryption": {
          "optional": true
        },
        "mongodb-extjson": {
          "optional": true
        },
        "snappy": {
          "optional": true
        }
      }
    },
    "node_modules/mongodb/node_modules/optional-require": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/optional-require/-/optional-require-1.1.8.tgz",
      "integrity": "sha512-jq83qaUb0wNg9Krv1c5OQ+58EK+vHde6aBPzLvPPqJm89UQWsvSuFy9X/OSNJnFeSOKo7btE0n8Nl2+nE+z5nA==",
      "dependencies": {
        "require-at": "^1.0.6"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/mongoose": {
      "version": "5.13.23",
      "resolved": "https://registry.npmjs.org/mongoose/-/mongoose-5.13.23.tgz",
      "integrity": "sha512-Q5bo1yYOcH2wbBPP4tGmcY5VKsFkQcjUDh66YjrbneAFB3vNKQwLvteRFLuLiU17rA5SDl3UMcMJLD9VS8ng2Q==",
      "dependencies": {
        "@types/bson": "1.x || 4.0.x",
        "@types/mongodb": "^3.5.27",
        "bson": "^1.1.4",
        "kareem": "2.3.2",
        "mongodb": "3.7.4",
        "mongoose-legacy-pluralize": "1.0.2",
        "mpath": "0.8.4",
        "mquery": "3.2.5",
        "ms": "2.1.2",
        "optional-require": "1.0.x",
        "regexp-clone": "1.0.0",
        "safe-buffer": "5.2.1",
        "sift": "13.5.2",
        "sliced": "1.0.1"
      },
      "engines": {
        "node": ">=4.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/mongoose"
      }
    },
    "node_modules/mongoose-legacy-pluralize": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/mongoose-legacy-pluralize/-/mongoose-legacy-pluralize-1.0.2.tgz",
      "integrity": "sha512-Yo/7qQU4/EyIS8YDFSeenIvXxZN+ld7YdV9LqFVQJzTLye8unujAWPZ4NWKfFA+RNjh+wvTWKY9Z3E5XM6ZZiQ==",
      "peerDependencies": {
        "mongoose": "*"
      }
    },
    "node_modules/mongoose/node_modules/ms": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.2.tgz",
      "integrity": "sha512-sGkPx+VjMtmA6MX27oA4FBFELFCZZ4S4XqeGOXCv68tT+jb3vk/RyaKWP0PTKyWtmLSM0b+adUTEvbs1PEaH2w=="
    },
    "node_modules/mpath": {
      "version": "0.8.4",
      "resolved": "https://registry.npmjs.org/mpath/-/mpath-0.8.4.tgz",
      "integrity": "sha512-DTxNZomBcTWlrMW76jy1wvV37X/cNNxPW1y2Jzd4DZkAaC5ZGsm8bfGfNOthcDuRJujXLqiuS6o3Tpy0JEoh7g==",
      "engines": {
        "node": ">=4.0.0"
      }
    },
    "node_modules/mquery": {
      "version": "3.2.5",
      "resolved": "https://registry.npmjs.org/mquery/-/mquery-3.2.5.tgz",
      "integrity": "sha512-VjOKHHgU84wij7IUoZzFRU07IAxd5kWJaDmyUzQlbjHjyoeK5TNeeo8ZsFDtTYnSgpW6n/nMNIHvE3u8Lbrf4A==",
      "dependencies": {
        "bluebird": "3.5.1",
        "debug": "3.1.0",
        "regexp-clone": "^1.0.0",
        "safe-buffer": "5.1.2",
        "sliced": "1.0.1"
      },
      "engines": {
        "node": ">=4.0.0"
      }
    },
    "node_modules/mquery/node_modules/debug": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/debug/-/debug-3.1.0.tgz",
      "integrity": "sha512-OX8XqP7/1a9cqkxYw2yXss15f26NKWBpDXQd0/uK/KPqdQhxbPa994hnzjcE2VqQpDslf55723cKPUOGSmMY3g==",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/mquery/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A=="
    },
    "node_modules/mquery/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g=="
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA=="
    },
    "node_modules/nanoid": {
      "version": "2.1.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-2.1.11.tgz",
      "integrity": "sha512-s/snB+WGm6uwi0WjsZdaVcuf3KJXlfGl2LcxgwkEwJF0D/BWzVWAZW/XY4bFaiR7s0Jk3FPvlnepg1H1b1UwlA=="
    },
    "node_modules/negotiator": {
      "version": "0.6.3",
      "resolved": "https://registry.npmjs.org/negotiator/-/negotiator-0.6.3.tgz",
      "integrity": "sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/nice-try": {
      "version": "1.0.5",
      "resolved": "https://registry.npmjs.org/nice-try/-/nice-try-1.0.5.tgz",
      "integrity": "sha512-1nh45deeb5olNY7eX82BkPO7SSxR5SSYJiPTrTdFUVYwAl8CKMA5N9PjTYkHiRjisVcxcQ1HXdLhx2qxxJzLNQ=="
    },
    "node_modules/nodemon": {
      "version": "3.1.9",
      "resolved": "https://registry.npmjs.org/nodemon/-/nodemon-3.1.9.tgz",
      "integrity": "sha512-hdr1oIb2p6ZSxu3PB2JWWYS7ZQ0qvaZsc3hK8DR8f02kRzc8rjYmxAIvdz+aYC+8F2IjNaB7HMcSDg8nQpJxyg==",
      "dev": true,
      "dependencies": {
        "chokidar": "^3.5.2",
        "debug": "^4",
        "ignore-by-default": "^1.0.1",
        "minimatch": "^3.1.2",
        "pstree.remy": "^1.1.8",
        "semver": "^7.5.3",
        "simple-update-notifier": "^2.0.0",
        "supports-color": "^5.5.0",
        "touch": "^3.1.0",
        "undefsafe": "^2.0.5"
      },
      "bin": {
        "nodemon": "bin/nodemon.js"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/nodemon"
      }
    },
    "node_modules/normalize-path": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/normalize-path/-/normalize-path-3.0.0.tgz",
      "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
      "dev": true,
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/notepack.io": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/notepack.io/-/notepack.io-2.3.0.tgz",
      "integrity": "sha512-9RiFDxeydHsWOqdthRUck2Kd4UW2NzVd2xxOulZiQ9mvge6ElsHXLpwD3HEJyql6sFEnEn/eMO7HSdS0M5mWkA=="
    },
    "node_modules/npm-run-path": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/npm-run-path/-/npm-run-path-2.0.2.tgz",
      "integrity": "sha512-lJxZYlT4DW/bRUtFh1MQIWqmLwQfAxnqWG4HhEdjMlkrJYnJn0Jrr2u3mgxqaWsdiBc76TYkTG/mhrnYTuzfHw==",
      "dependencies": {
        "path-key": "^2.0.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/object-inspect": {
      "version": "1.13.4",
      "resolved": "https://registry.npmjs.org/object-inspect/-/object-inspect-1.13.4.tgz",
      "integrity": "sha512-W67iLl4J2EXEGTbfeHCffrjDfitvLANg0UlX3wFUUSTx92KXRFegMHUVgSqE+wvhAbi4WqjGg9czysTV2Epbew==",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/on-finished": {
      "version": "2.4.1",
      "resolved": "https://registry.npmjs.org/on-finished/-/on-finished-2.4.1.tgz",
      "integrity": "sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==",
      "dependencies": {
        "ee-first": "1.1.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/once": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/once/-/once-1.4.0.tgz",
      "integrity": "sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==",
      "dependencies": {
        "wrappy": "1"
      }
    },
    "node_modules/optional-require": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/optional-require/-/optional-require-1.0.3.tgz",
      "integrity": "sha512-RV2Zp2MY2aeYK5G+B/Sps8lW5NHAzE5QClbFP15j+PWmP+T9PxlJXBOOLoSAdgwFvS4t0aMR4vpedMkbHfh0nA==",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/p-finally": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/p-finally/-/p-finally-1.0.0.tgz",
      "integrity": "sha512-LICb2p9CB7FS+0eR1oqWnHhp0FljGLZCWBE9aix0Uye9W8LTQPwMTYVGWQWIw9RdQiDg4+epXQODwIYJtSJaow==",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/parseurl": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/parseurl/-/parseurl-1.3.3.tgz",
      "integrity": "sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/path-key": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-2.0.1.tgz",
      "integrity": "sha512-fEHGKCSmUSDPv4uoj8AlD+joPlq3peND+HRYyxFz4KPw4z926S/b8rIuFs2FYJg3BwsxJf6A9/3eIdLaYC+9Dw==",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/path-to-regexp": {
      "version": "0.1.12",
      "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
      "integrity": "sha512-RA1GjUVMnvYFxuqovrEqZoxxW5NUZqbwKtYz/Tt7nXerk0LbLblQmrsgdeOxV5SFHf0UDggjS/bSeOZwt1pmEQ=="
    },
    "node_modules/picomatch": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
      "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
      "dev": true,
      "engines": {
        "node": ">=8.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/process-nextick-args": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/process-nextick-args/-/process-nextick-args-2.0.1.tgz",
      "integrity": "sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag=="
    },
    "node_modules/proxy-addr": {
      "version": "2.0.7",
      "resolved": "https://registry.npmjs.org/proxy-addr/-/proxy-addr-2.0.7.tgz",
      "integrity": "sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==",
      "dependencies": {
        "forwarded": "0.2.0",
        "ipaddr.js": "1.9.1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/pstree.remy": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/pstree.remy/-/pstree.remy-1.1.8.tgz",
      "integrity": "sha512-77DZwxQmxKnu3aR542U+X8FypNzbfJ+C5XQDk3uWjWxn6151aIMGthWYRXTqT1E5oJvg+ljaa2OJi+VfvCOQ8w==",
      "dev": true
    },
    "node_modules/pump": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/pump/-/pump-3.0.2.tgz",
      "integrity": "sha512-tUPXtzlGM8FE3P0ZL6DVs/3P58k9nk8/jZeQCurTJylQA8qFYzHFfhBJkuqyE0FifOsQ0uKWekiZ5g8wtr28cw==",
      "dependencies": {
        "end-of-stream": "^1.1.0",
        "once": "^1.3.1"
      }
    },
    "node_modules/qs": {
      "version": "6.13.0",
      "resolved": "https://registry.npmjs.org/qs/-/qs-6.13.0.tgz",
      "integrity": "sha512-+38qI9SOr8tfZ4QmJNplMUxqjbe7LKvvZgWdExBOmd+egZTtjLB67Gu0HRX3u/XOq7UU2Nx6nsjvS16Z9uwfpg==",
      "dependencies": {
        "side-channel": "^1.0.6"
      },
      "engines": {
        "node": ">=0.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/range-parser": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/range-parser/-/range-parser-1.2.1.tgz",
      "integrity": "sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/raw-body": {
      "version": "2.5.2",
      "resolved": "https://registry.npmjs.org/raw-body/-/raw-body-2.5.2.tgz",
      "integrity": "sha512-8zGqypfENjCIqGhgXToC8aB2r7YrBX+AQAfIPs/Mlk+BtPTztOvTS01NRW/3Eh60J+a48lt8qsCzirQ6loCVfA==",
      "dependencies": {
        "bytes": "3.1.2",
        "http-errors": "2.0.0",
        "iconv-lite": "0.4.24",
        "unpipe": "1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/readable-stream": {
      "version": "2.3.8",
      "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-2.3.8.tgz",
      "integrity": "sha512-8p0AUk4XODgIewSi0l8Epjs+EVnWiK7NoDIEGU0HhE7+ZyY8D1IMY7odu5lRrFXGg71L15KG8QrPmum45RTtdA==",
      "dependencies": {
        "core-util-is": "~1.0.0",
        "inherits": "~2.0.3",
        "isarray": "~1.0.0",
        "process-nextick-args": "~2.0.0",
        "safe-buffer": "~5.1.1",
        "string_decoder": "~1.1.1",
        "util-deprecate": "~1.0.1"
      }
    },
    "node_modules/readable-stream/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g=="
    },
    "node_modules/readdirp": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/readdirp/-/readdirp-3.6.0.tgz",
      "integrity": "sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==",
      "dev": true,
      "dependencies": {
        "picomatch": "^2.2.1"
      },
      "engines": {
        "node": ">=8.10.0"
      }
    },
    "node_modules/redis": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/redis/-/redis-3.1.2.tgz",
      "integrity": "sha512-grn5KoZLr/qrRQVwoSkmzdbw6pwF+/rwODtrOr6vuBRiR/f3rjSTGupbF90Zpqm2oenix8Do6RV7pYEkGwlKkw==",
      "dependencies": {
        "denque": "^1.5.0",
        "redis-commands": "^1.7.0",
        "redis-errors": "^1.2.0",
        "redis-parser": "^3.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/node-redis"
      }
    },
    "node_modules/redis-commands": {
      "version": "1.7.0",
      "resolved": "https://registry.npmjs.org/redis-commands/-/redis-commands-1.7.0.tgz",
      "integrity": "sha512-nJWqw3bTFy21hX/CPKHth6sfhZbdiHP6bTawSgQBlKOVRG7EZkfHbbHwQJnrE4vsQf0CMNE+3gJ4Fmm16vdVlQ=="
    },
    "node_modules/redis-errors": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/redis-errors/-/redis-errors-1.2.0.tgz",
      "integrity": "sha512-1qny3OExCf0UvUV/5wpYKf2YwPcOqXzkwKKSmKHiE6ZMQs5heeE/c8eXK+PNllPvmjgAbfnsbpkGZWy8cBpn9w==",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/redis-parser": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/redis-parser/-/redis-parser-3.0.0.tgz",
      "integrity": "sha512-DJnGAeenTdpMEH6uAJRK/uiyEIH9WVsUmoLwzudwGJUwZPp80PDBWPHXSAGNPwNvIXAbe7MSUB1zQFugFml66A==",
      "dependencies": {
        "redis-errors": "^1.0.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/regexp-clone": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/regexp-clone/-/regexp-clone-1.0.0.tgz",
      "integrity": "sha512-TuAasHQNamyyJ2hb97IuBEif4qBHGjPHBS64sZwytpLEqtBQ1gPJTnOaQ6qmpET16cK14kkjbazl6+p0RRv0yw=="
    },
    "node_modules/require-at": {
      "version": "1.0.6",
      "resolved": "https://registry.npmjs.org/require-at/-/require-at-1.0.6.tgz",
      "integrity": "sha512-7i1auJbMUrXEAZCOQ0VNJgmcT2VOKPRl2YGJwgpHpC9CE91Mv4/4UYIUm4chGJaI381ZDq1JUicFii64Hapd8g==",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ]
    },
    "node_modules/safer-buffer": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/safer-buffer/-/safer-buffer-2.1.2.tgz",
      "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg=="
    },
    "node_modules/saslprep": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/saslprep/-/saslprep-1.0.3.tgz",
      "integrity": "sha512-/MY/PEMbk2SuY5sScONwhUDsV2p77Znkb/q3nSVstq/yQzYJOH/Azh29p9oJLsl3LnQwSvZDKagDGBsBwSooag==",
      "optional": true,
      "dependencies": {
        "sparse-bitfield": "^3.0.3"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/semver": {
      "version": "7.7.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-7.7.1.tgz",
      "integrity": "sha512-hlq8tAfn0m/61p4BVRcPzIGr6LKiMwo4VM6dGi6pt4qcRkmNzTcWq6eCEjEh+qXjkMDvPlOFFSGwQjoEa6gyMA==",
      "dev": true,
      "bin": {
        "semver": "bin/semver.js"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/send": {
      "version": "0.19.0",
      "resolved": "https://registry.npmjs.org/send/-/send-0.19.0.tgz",
      "integrity": "sha512-dW41u5VfLXu8SJh5bwRmyYUbAoSB3c9uQh6L8h/KtsFREPWpbX1lrljJo186Jc4nmci/sGUZ9a0a0J2zgfq2hw==",
      "dependencies": {
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "encodeurl": "~1.0.2",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "fresh": "0.5.2",
        "http-errors": "2.0.0",
        "mime": "1.6.0",
        "ms": "2.1.3",
        "on-finished": "2.4.1",
        "range-parser": "~1.2.1",
        "statuses": "2.0.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/send/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/send/node_modules/debug/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A=="
    },
    "node_modules/send/node_modules/encodeurl": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-1.0.2.tgz",
      "integrity": "sha512-TPJXq8JqFaVYm2CWmPvnP2Iyo4ZSM7/QKcSmuMLDObfpH5fi7RUGmd/rTDf+rut/saiDiQEeVTNgAmJEdAOx0w==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/serve-static": {
      "version": "1.16.2",
      "resolved": "https://registry.npmjs.org/serve-static/-/serve-static-1.16.2.tgz",
      "integrity": "sha512-VqpjJZKadQB/PEbEwvFdO43Ax5dFBZ2UECszz8bQ7pi7wt//PWe1P6MN7eCnjsatYtBT6EuiClbjSWP2WrIoTw==",
      "dependencies": {
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "parseurl": "~1.3.3",
        "send": "0.19.0"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw=="
    },
    "node_modules/shebang-command": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/shebang-command/-/shebang-command-1.2.0.tgz",
      "integrity": "sha512-EV3L1+UQWGor21OmnvojK36mhg+TyIKDh3iFBKBohr5xeXIhNBcx8oWdgkTEEQ+BEFFYdLRuqMfd5L84N1V5Vg==",
      "dependencies": {
        "shebang-regex": "^1.0.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/shebang-regex": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/shebang-regex/-/shebang-regex-1.0.0.tgz",
      "integrity": "sha512-wpoSFAxys6b2a2wHZ1XpDSgD7N9iVjg29Ph9uV/uaP9Ex/KXlkTZTeddxDPSYQpgvzKLGJke2UU0AzoGCjNIvQ==",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/side-channel": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/side-channel/-/side-channel-1.1.0.tgz",
      "integrity": "sha512-ZX99e6tRweoUXqR+VBrslhda51Nh5MTQwou5tnUDgbtyM0dBgmhEDtWGP/xbKn6hqfPRHujUNwz5fy/wbbhnpw==",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3",
        "side-channel-list": "^1.0.0",
        "side-channel-map": "^1.0.1",
        "side-channel-weakmap": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-list": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/side-channel-list/-/side-channel-list-1.0.0.tgz",
      "integrity": "sha512-FCLHtRD/gnpCiCHEiJLOwdmFP+wzCmDEkc9y7NsYxeF4u7Btsn1ZuwgwJGxImImHicJArLP4R0yX4c2KCrMrTA==",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-map": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/side-channel-map/-/side-channel-map-1.0.1.tgz",
      "integrity": "sha512-VCjCNfgMsby3tTdo02nbjtM/ewra6jPHmpThenkTYh8pG9ucZ/1P8So4u4FGBek/BjpOVsDCMoLA/iuBKIFXRA==",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-weakmap": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/side-channel-weakmap/-/side-channel-weakmap-1.0.2.tgz",
      "integrity": "sha512-WPS/HvHQTYnHisLo9McqBHOJk2FkHO/tlpvldyrnem4aeQp4hai3gythswg6p01oSoTl58rcpiFAjF2br2Ak2A==",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3",
        "side-channel-map": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/sift": {
      "version": "13.5.2",
      "resolved": "https://registry.npmjs.org/sift/-/sift-13.5.2.tgz",
      "integrity": "sha512-+gxdEOMA2J+AI+fVsCqeNn7Tgx3M9ZN9jdi95939l1IJ8cZsqS8sqpJyOkic2SJk+1+98Uwryt/gL6XDaV+UZA=="
    },
    "node_modules/signal-exit": {
      "version": "3.0.7",
      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-3.0.7.tgz",
      "integrity": "sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ=="
    },
    "node_modules/simple-update-notifier": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/simple-update-notifier/-/simple-update-notifier-2.0.0.tgz",
      "integrity": "sha512-a2B9Y0KlNXl9u/vsW6sTIu9vGEpfKu2wRV6l1H3XEas/0gUIzGzBoP/IouTcUQbm9JWZLH3COxyn03TYlFax6w==",
      "dev": true,
      "dependencies": {
        "semver": "^7.5.3"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/sliced": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/sliced/-/sliced-1.0.1.tgz",
      "integrity": "sha512-VZBmZP8WU3sMOZm1bdgTadsQbcscK0UM8oKxKVBs4XAhUo2Xxzm/OFMGBkPusxw9xL3Uy8LrzEqGqJhclsr0yA=="
    },
    "node_modules/sparse-bitfield": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/sparse-bitfield/-/sparse-bitfield-3.0.3.tgz",
      "integrity": "sha512-kvzhi7vqKTfkh0PZU+2D2PIllw2ymqJKujUcyPMd9Y75Nv4nPbGJZXNhxsgdQab2BmlDct1YnfQCguEvHr7VsQ==",
      "optional": true,
      "dependencies": {
        "memory-pager": "^1.0.2"
      }
    },
    "node_modules/statuses": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-2.0.1.tgz",
      "integrity": "sha512-RwNA9Z/7PrK06rYLIzFMlaF+l73iwpzsqRIFgbMLbTcLD6cOao82TaWefPXQvB2fOC4AjuYSEndS7N/mTCbkdQ==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/string_decoder": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/string_decoder/-/string_decoder-1.1.1.tgz",
      "integrity": "sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==",
      "dependencies": {
        "safe-buffer": "~5.1.0"
      }
    },
    "node_modules/string_decoder/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g=="
    },
    "node_modules/strip-eof": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/strip-eof/-/strip-eof-1.0.0.tgz",
      "integrity": "sha512-7FCwGGmx8mD5xQd3RPUvnSpUXHM3BWuzjtpD4TXsfcZ9EL4azvVVUscFYwD9nx8Kh+uCBC00XBtAykoMHwTh8Q==",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/supports-color": {
      "version": "5.5.0",
      "resolved": "https://registry.npmjs.org/supports-color/-/supports-color-5.5.0.tgz",
      "integrity": "sha512-QjVjwdXIt408MIiAqCX4oUKsgU2EqAGzs2Ppkm4aQYbjm+ZEWEcW4SfFNTr4uMNZma0ey4f5lgLrkB0aX0QMow==",
      "dev": true,
      "dependencies": {
        "has-flag": "^3.0.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/to-regex-range": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
      "dev": true,
      "dependencies": {
        "is-number": "^7.0.0"
      },
      "engines": {
        "node": ">=8.0"
      }
    },
    "node_modules/toidentifier": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/touch": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/touch/-/touch-3.1.1.tgz",
      "integrity": "sha512-r0eojU4bI8MnHr8c5bNo7lJDdI2qXlWWJk6a9EAFG7vbhTjElYhBVS3/miuE0uOuoLdb8Mc/rVfsmm6eo5o9GA==",
      "dev": true,
      "bin": {
        "nodetouch": "bin/nodetouch.js"
      }
    },
    "node_modules/type-is": {
      "version": "1.6.18",
      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
      "dependencies": {
        "media-typer": "0.3.0",
        "mime-types": "~2.1.24"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/undefsafe": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/undefsafe/-/undefsafe-2.0.5.tgz",
      "integrity": "sha512-WxONCrssBM8TSPRqN5EmsjVrsv4A8X12J4ArBiiayv3DyyG3ZlIg6yysuuSYdZsVz3TKcTg2fd//Ujd4CHV1iA==",
      "dev": true
    },
    "node_modules/undici-types": {
      "version": "6.20.0",
      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-6.20.0.tgz",
      "integrity": "sha512-Ny6QZ2Nju20vw1SRHe3d9jVu6gJ+4e3+MMpqu7pqE5HT6WsTSlce++GQmK5UXS8mzV8DSYHrQH+Xrf2jVcuKNg=="
    },
    "node_modules/unpipe": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw=="
    },
    "node_modules/utils-merge": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/vary": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/which": {
      "version": "1.3.1",
      "resolved": "https://registry.npmjs.org/which/-/which-1.3.1.tgz",
      "integrity": "sha512-HxJdYWq1MTIQbJ3nw0cqssHoTNU267KlrDuGZ1WYlxDStUtKUhOaJmh112/TZmHxxUfuJqPXSOm7tDyas0OSIQ==",
      "dependencies": {
        "isexe": "^2.0.0"
      },
      "bin": {
        "which": "bin/which"
      }
    },
    "node_modules/wrappy": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
      "integrity": "sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ=="
    },
    "node_modules/ws": {
      "version": "7.5.10",
      "resolved": "https://registry.npmjs.org/ws/-/ws-7.5.10.tgz",
      "integrity": "sha512-+dbF1tHwZpXcbOJdVOkzLDxZP1ailvSxM6ZweXTegylPny803bFhA+vqBYw4s31NSAk4S2Qz+AKXK9a4wkdjcQ==",
      "engines": {
        "node": ">=8.3.0"
      },
      "peerDependencies": {
        "bufferutil": "^4.0.1",
        "utf-8-validate": "^5.0.2"
      },
      "peerDependenciesMeta": {
        "bufferutil": {
          "optional": true
        },
        "utf-8-validate": {
          "optional": true
        }
      }
    }
  }
}
 
 
===================================================== 
FILE: package.json 
===================================================== 
 
{
  "name": "3d-ai-game-platform",
  "version": "1.0.0",
  "description": "A modular 3D multiplayer browser-based game platform with support for various game implementations.",
  "main": "server/core/server.js",
  "scripts": {
    "start": "node server/core/server.js",
    "dev": "nodemon server/core/server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [
    "3d",
    "game",
    "platform",
    "multiplayer",
    "modular",
    "threejs",
    "colyseus"
  ],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "colyseus": "^0.14.13",
    "express": "^4.21.2"
  },
  "devDependencies": {
    "nodemon": "^3.1.9"
  }
}
 
 
===================================================== 
FILE: open_4player_direct.bat 
===================================================== 
 
@echo off
echo Opening 3D AI Game - Single Window 4-Player Setup

REM Check if Chrome exists in both possible locations
set "CHROME_PATH=C:\Program Files\Google\Chrome\Application\chrome.exe"
if not exist "%CHROME_PATH%" (
    set "CHROME_PATH=C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
)

if not exist "%CHROME_PATH%" (
    echo ERROR: Could not find Chrome browser.
    echo Please make sure Chrome is installed or update this script with the correct path.
    pause
    exit /b 1
)

REM Get the full path to the four_player_setup.html file
set "SETUP_FILE=%~dp0four_player_setup.html"

echo Opening 4-player game window...
start "" "%CHROME_PATH%" --app="file:///%SETUP_FILE:\=/%"

echo.
echo Setup complete!
echo Press F11 in the browser for fullscreen mode.
echo.
echo Make sure your game server is running at http://localhost:3000  
 
===================================================== 
FILE: start_game.bat 
===================================================== 
 
@echo off
setlocal enabledelayedexpansion

REM Kill any existing Node.js processes
echo Killing any existing Node.js processes...
taskkill /F /IM node.exe 2>nul
timeout /t 2 /nobreak >nul

REM Start the server with the default implementation
echo Starting server with default implementation...
start "3D AI Game Server" /B cmd /c "set GAME_IMPLEMENTATION=default && start_server.bat > server_output.tmp 2>&1"

REM Wait for server to initialize
echo Waiting for server to initialize...
timeout /t 5 /nobreak >nul

:PLAYER_COUNT
cls
echo ===== 3D AI Game Platform =====
echo Choose number of players (1-4):
echo 1 - Single player (fullscreen)
echo 2 - Two players (split screen)
echo 3 - Three players
echo 4 - Four players
echo.
set /p PLAYER_COUNT="Enter number of players (1-4): "

REM Validate input
if !PLAYER_COUNT! LSS 1 goto PLAYER_COUNT
if !PLAYER_COUNT! GTR 4 goto PLAYER_COUNT

REM Check if Chrome exists in both possible locations
set "CHROME_PATH=C:\Program Files\Google\Chrome\Application\chrome.exe"
if not exist "%CHROME_PATH%" (
    set "CHROME_PATH=C:\Program Files (x86)\Google\Chrome\Application\chrome.exe"
)

if not exist "%CHROME_PATH%" (
    echo ERROR: Could not find Chrome browser.
    echo Please make sure Chrome is installed or update this script with the correct path.
    pause
    exit /b 1
)

REM Get the full path to the HTML files
set "SETUP_FILE=%~dp0four_player_setup.html"
set "SINGLE_FILE=%~dp0client/index.html"

REM Launch appropriate number of clients
if !PLAYER_COUNT!==1 (
    echo Opening single player mode...
    start "" "%CHROME_PATH%" --app="http://localhost:3000"
) else (
    echo Opening !PLAYER_COUNT!-player setup...
    start "" "%CHROME_PATH%" --app="file:///%SETUP_FILE:\=/%?players=!PLAYER_COUNT!"
)

echo.
echo Game launched! 
echo Press F11 in the browser for fullscreen mode.
echo.
echo Server is running at http://localhost:3000
echo To quit, close all windows and press Ctrl+C in the server window.

REM Clean up temporary file
REM Commented out to prevent file access error as server is still using it
REM if exist server_output.tmp del server_output.tmp

pause  
 
===================================================== 
FILE: start_server.bat 
===================================================== 
 
@echo off
echo Starting 3D AI Game Server

REM Kill any existing Node.js processes
taskkill /F /IM node.exe >nul 2>&1

REM Start the game server
cd /d "%~dp0server"
echo Server starting - press Ctrl+C to stop
npm start  
 
===================================================== 
FILE: update_compiled_code.bat 
===================================================== 
 
@echo off
setlocal enabledelayedexpansion

echo Creating updated compiled_code.txt file...

:: Delete the old file if it exists
if exist compiled_code.txt del compiled_code.txt

:: Create the new file with a header
echo ===================================================== > compiled_code.txt
echo 3D AI GAME PLATFORM - COMPLETE CODE COMPILATION >> compiled_code.txt
echo ===================================================== >> compiled_code.txt
echo. >> compiled_code.txt

:: Add directory structure (excluding node_modules and .git)
echo DIRECTORY STRUCTURE: >> compiled_code.txt
echo ===================================================== >> compiled_code.txt
echo Generating directory tree (excluding node_modules and .git)...
:: Use a temporary tree file to filter out node_modules and .git
tree /f /a > temp_tree.txt
:: Filter out node_modules and .git from the tree output
type temp_tree.txt | findstr /v "node_modules .git" >> compiled_code.txt
:: Clean up
del temp_tree.txt
echo. >> compiled_code.txt
echo ===================================================== >> compiled_code.txt
echo. >> compiled_code.txt
echo. >> compiled_code.txt

set /a totalFiles=0

:: Process root directory files
for %%F in (*.js, *.ts, *.jsx, *.tsx, *.html, *.css, *.scss, *.md, *.json, *.bat, *.txt, *.yaml, *.yml, *.xml, *.env*, *.config*) do (
    if /i not "%%F"=="compiled_code.txt" (
        if /i not "%%F"=="temp_tree.txt" (
            if /i not "%%F"=="server_output.tmp" (
                echo Processing %%F...
                echo ===================================================== >> compiled_code.txt
                echo FILE: %%F >> compiled_code.txt
                echo ===================================================== >> compiled_code.txt
                echo. >> compiled_code.txt
                type "%%F" >> compiled_code.txt
                echo. >> compiled_code.txt
                echo. >> compiled_code.txt
                set /a totalFiles=totalFiles+1
            )
        )
    )
)

:: Process client directory
for /R "client" %%F in (*.js, *.ts, *.jsx, *.tsx, *.html, *.css, *.scss, *.md, *.json, *.bat, *.txt, *.yaml, *.yml, *.xml, *.env*, *.config*) do (
    echo Processing %%F...
    echo ===================================================== >> compiled_code.txt
    echo FILE: %%F >> compiled_code.txt
    echo ===================================================== >> compiled_code.txt
    echo. >> compiled_code.txt
    type "%%F" >> compiled_code.txt
    echo. >> compiled_code.txt
    echo. >> compiled_code.txt
    set /a totalFiles=totalFiles+1
)

:: Process server directory
for /R "server" %%F in (*.js, *.ts, *.jsx, *.tsx, *.html, *.css, *.scss, *.md, *.json, *.bat, *.txt, *.yaml, *.yml, *.xml, *.env*, *.config*) do (
    echo Processing %%F...
    echo ===================================================== >> compiled_code.txt
    echo FILE: %%F >> compiled_code.txt
    echo ===================================================== >> compiled_code.txt
    echo. >> compiled_code.txt
    type "%%F" >> compiled_code.txt
    echo. >> compiled_code.txt
    echo. >> compiled_code.txt
    set /a totalFiles=totalFiles+1
)

:: Process memory bank directory
for /R "memory bank" %%F in (*.js, *.ts, *.jsx, *.tsx, *.html, *.css, *.scss, *.md, *.json, *.bat, *.txt, *.yaml, *.yml, *.xml, *.env*, *.config*) do (
    echo Processing %%F...
    echo ===================================================== >> compiled_code.txt
    echo FILE: %%F >> compiled_code.txt
    echo ===================================================== >> compiled_code.txt
    echo. >> compiled_code.txt
    type "%%F" >> compiled_code.txt
    echo. >> compiled_code.txt
    echo. >> compiled_code.txt
    set /a totalFiles=totalFiles+1
)

echo.
echo Compilation complete! Processed !totalFiles! files.
echo The updated compiled_code.txt file now contains all code from the project.
echo Directory structure and file contents have been saved to compiled_code.txt
echo.

pause
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\index.html 
===================================================== 
 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D AI Game Platform</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
        }
        #lock-instructions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: pointer;
            z-index: 10;
        }
        #player-list-container {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            width: 200px;
            max-height: 300px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 100;
        }
        #player-list-header {
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.5);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #player-list {
            margin-top: 5px;
            max-height: 150px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: height 0.3s ease;
        }
        .player-entry {
            padding: 3px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            font-size: 11px;
            background-color: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        .player-color {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .player-info {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #collapse-icon {
            transition: transform 0.3s ease;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }
        #loading-status {
            margin-top: 20px;
            font-size: 16px;
        }
        .spinner {
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 5px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hide-cursor, .hide-cursor * {
            cursor: none !important;
        }
        #building-menu button {
            cursor: pointer !important;
        }
    </style>
    <script>
        // Fetch the current implementation information and update the page title
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    // Update the page title with the active implementation
                    document.title = `3D AI Game - ${config.activeImplementation}`;
                    
                    // Also add a small indicator in the corner
                    const implIndicator = document.createElement('div');
                    implIndicator.style.position = 'absolute';
                    implIndicator.style.top = '5px';
                    implIndicator.style.right = '10px';
                    implIndicator.style.background = 'rgba(0,0,0,0.5)';
                    implIndicator.style.color = 'white';
                    implIndicator.style.padding = '5px 10px';
                    implIndicator.style.borderRadius = '3px';
                    implIndicator.style.fontSize = '12px';
                    implIndicator.style.zIndex = '1000';
                    implIndicator.textContent = `Implementation: ${config.activeImplementation}`;
                    document.body.appendChild(implIndicator);
                }
            } catch (error) {
                console.error('Failed to fetch implementation info:', error);
            }
        });
    </script>
</head>
<body>
    <canvas id="game-canvas"></canvas>
    
    <div id="lock-instructions">
        Click to play<br>
        WASD to move, Mouse to look<br>
        V to toggle camera views<br>
        Right-click + Mouse to orbit in third-person view
    </div>
    
    <!-- Multiplayer panel - Players List -->
    <div id="player-list-container">
        <div id="player-list-header">
            <span id="collapse-icon"></span> Players <span id="player-count">(0)</span>
        </div>
        <div id="player-list"></div>
    </div>
    
    <!-- Game HUD -->
    <div id="game-hud"></div>
    
    <!-- Loading Screen -->
    <div id="loading-screen">
        <h2>3D Game Platform</h2>
        <div class="spinner"></div>
        <div id="loading-status">Loading game engine...</div>
        <div style="margin-top: 10px; font-size: 14px;">Connecting to server...</div>
    </div>
    
    <!-- Three.js library via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/CSS2DRenderer.js"></script>
    
    <!-- Colyseus client library -->
    <script src="https://unpkg.com/colyseus.js@^0.14.13/dist/colyseus.js"></script>
    
    <!-- Main loader script -->
    <script src="js/core/main.js"></script>
    
    <!-- Simple Building Mode Script -->
    <script>
    // Wait for the game to load
    window.addEventListener('DOMContentLoaded', function() {
        console.log("Simple building mode script loaded");
        
        // Global flag to track if user has interacted with the game
        window.hasInteracted = false;
        
        // Add listener to set interacted flag
        document.addEventListener('click', function() {
            window.hasInteracted = true;
        }, { once: true });
        
        // Wait a bit for the game to fully initialize
        setTimeout(function() {
            // Create the building mode indicator
            const buildingModeIndicator = document.createElement('div');
            buildingModeIndicator.id = 'building-mode-indicator';
            buildingModeIndicator.style.position = 'fixed';
            buildingModeIndicator.style.bottom = '50px';
            buildingModeIndicator.style.right = '20px';
            buildingModeIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            buildingModeIndicator.style.color = 'white';
            buildingModeIndicator.style.padding = '5px 10px';
            buildingModeIndicator.style.borderRadius = '5px';
            buildingModeIndicator.style.fontFamily = 'Arial, sans-serif';
            buildingModeIndicator.style.fontSize = '14px';
            buildingModeIndicator.style.zIndex = '1000';
            buildingModeIndicator.style.display = 'none';
            buildingModeIndicator.textContent = 'Building Mode';
            document.body.appendChild(buildingModeIndicator);
            
            // Create the building menu with higher z-index
            const buildingMenu = document.createElement('div');
            buildingMenu.id = 'building-menu';
            buildingMenu.style.position = 'fixed';
            buildingMenu.style.bottom = '10px';
            buildingMenu.style.left = '50%';
            buildingMenu.style.transform = 'translateX(-50%)';
            buildingMenu.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            buildingMenu.style.color = 'white';
            buildingMenu.style.padding = '8px';
            buildingMenu.style.borderRadius = '5px';
            buildingMenu.style.display = 'none';
            buildingMenu.style.zIndex = '2000'; // Much higher z-index
            buildingMenu.style.textAlign = 'center';
            buildingMenu.style.pointerEvents = 'auto'; // Ensure clicks work
            document.body.appendChild(buildingMenu);
            
            // Create placement preview smaller and more visible
            const placementPreview = document.createElement('div');
            placementPreview.id = 'placement-preview';
            placementPreview.style.position = 'fixed';
            placementPreview.style.width = '16px';
            placementPreview.style.height = '16px';
            placementPreview.style.backgroundColor = 'rgba(0, 255, 0, 0.7)';
            placementPreview.style.border = '2px solid white';
            placementPreview.style.borderRadius = '50%';
            placementPreview.style.pointerEvents = 'none'; // Don't interfere with clicks
            placementPreview.style.transform = 'translate(-50%, -50%)';
            placementPreview.style.zIndex = '1001';
            placementPreview.style.display = 'none';
            placementPreview.style.boxShadow = '0 0 5px rgba(0, 0, 0, 0.5)'; // Add shadow for visibility
            document.body.appendChild(placementPreview);
            
            // Add structure buttons
            const structureTypes = [
                { id: 'building', name: 'Building' },
                { id: 'wall', name: 'Wall' }
            ];
            
            // Create structure buttons
            structureTypes.forEach(type => {
                const button = document.createElement('button');
                button.textContent = type.name;
                button.style.margin = '0 5px';
                button.style.padding = '5px 10px';
                button.style.backgroundColor = '#555';
                button.style.color = 'white';
                button.style.border = 'none';
                button.style.borderRadius = '3px';
                button.style.cursor = 'pointer';
                button.style.position = 'relative';
                button.style.zIndex = '1002';
                button.style.pointerEvents = 'auto';
                
                // Add button click handler with special handling
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    selectStructureType(type.id);
                    
                    // Keep controls unlocked
                    if (window.controls && window.controls.isLocked) {
                        window.controls.unlock();
                    }
                });
                
                buildingMenu.appendChild(button);
            });
            
            // Add rotate button
            const rotateButton = document.createElement('button');
            rotateButton.textContent = 'Rotate (Q/E)';
            rotateButton.title = 'Hold Q or E to rotate smoothly in 15 increments';
            rotateButton.style.margin = '0 5px';
            rotateButton.style.padding = '5px 10px';
            rotateButton.style.backgroundColor = '#555';
            rotateButton.style.color = 'white';
            rotateButton.style.border = 'none';
            rotateButton.style.borderRadius = '3px';
            rotateButton.style.cursor = 'pointer';
            rotateButton.style.position = 'relative';
            rotateButton.style.zIndex = '1002';
            rotateButton.style.pointerEvents = 'auto';
            
            rotateButton.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                rotateStructure();
                
                // Keep controls unlocked
                if (window.controls && window.controls.isLocked) {
                    window.controls.unlock();
                }
            });
            
            buildingMenu.appendChild(rotateButton);
            
            // Global building mode state
            window.buildingMode = {
                active: false,
                currentStructure: null,
                rotation: 0,
                toggle: function() {
                    this.active = !this.active;
                    
                    // Update prevention flag
                    window.preventPointerLock = this.active;
                    
                    // Show/hide UI elements
                    buildingModeIndicator.style.display = this.active ? 'block' : 'none';
                    buildingMenu.style.display = this.active ? 'block' : 'none';
                    placementPreview.style.display = this.active ? 'block' : 'none';
                    
                    // Always hide lock instructions in building mode, but only show
                    // when exiting if user hasn't interacted yet
                    const lockInstructions = document.getElementById('lock-instructions');
                    if (lockInstructions) {
                        if (this.active) {
                            lockInstructions.style.display = 'none';
                        } else if (!window.hasInteracted) {
                            // Only show instructions if user hasn't interacted yet
                            lockInstructions.style.display = 'flex';
                        }
                    }
                    
                    // Initialize 3D preview if needed
                    if (this.active && !window.buildingPreview && window.scene) {
                        createPreviewModels();
                    }
                    
                    // Show/hide 3D preview and grid
                    if (window.buildingPreview) {
                        window.buildingPreview.group.visible = this.active;
                        window.buildingPreview.grid.visible = this.active;
                        
                        // Set current type if activating
                        if (this.active && this.currentStructure) {
                            window.buildingPreview.currentType = this.currentStructure;
                        }
                    }
                    
                    // Unlock/lock pointer
                    if (this.active) {
                        // Unlock the pointer to show cursor
                        if (window.controls && window.controls.isLocked) {
                            window.controls.unlock();
                        }
                        
                        // Most aggressive approach - add class to html element
                        document.documentElement.classList.add('hide-cursor');
                        
                        // Create and use a completely transparent cursor as fallback
                        const transparentCursor = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
                        document.body.style.cursor = `url(${transparentCursor}), none`;
                        document.documentElement.style.cursor = `url(${transparentCursor}), none`;
                        
                        if (window.renderer && window.renderer.domElement) {
                            window.renderer.domElement.style.cursor = `url(${transparentCursor}), none`;
                        }
                        
                        // Disable pointer lock controls to prevent auto-locking
                        if (window.controls) {
                            window.controls.enabled = false;
                        }
                        
                        // Add a click interceptor div to prevent clicks from triggering pointer lock
                        const clickInterceptor = document.createElement('div');
                        clickInterceptor.id = 'build-click-interceptor';
                        clickInterceptor.style.position = 'fixed';
                        clickInterceptor.style.top = '0';
                        clickInterceptor.style.left = '0';
                        clickInterceptor.style.width = '100%';
                        clickInterceptor.style.height = '100%';
                        clickInterceptor.style.zIndex = '900'; // Below our UI but above everything else
                        clickInterceptor.style.pointerEvents = 'all';

                        // Completely rewrite the click handling for reliability - SIMPLIFIED VERSION
                        clickInterceptor.addEventListener('mousedown', function(event) {
                            // Only handle LEFT CLICKS (button 0)
                            if (event.button !== 0) return;
                            
                            // Skip if clicking on UI
                            if (event.target.closest('#building-menu')) return;
                            
                            event.preventDefault();
                            event.stopPropagation();
                            
                            // Get world position
                            const worldPos = screenToWorld(event.clientX, event.clientY);
                            if (!worldPos) return;
                            
                            // Check if valid placement
                            if (!window.buildingPreview || !window.buildingPreview.isValid) return;
                            
                            // Send structure placement request to server - SIMPLE VERSION
                            if (window.room) {
                                window.room.send("placeStructure", {
                                    structureType: window.buildingMode.currentStructure,
                                    x: Math.round(worldPos.x),
                                    y: Math.round(worldPos.y) || 0,
                                    z: Math.round(worldPos.z),
                                    rotation: window.buildingMode.rotation * (Math.PI / 180)
                                });
                                
                                // Important: Force refresh preview position after building
                                setTimeout(() => {
                                    // Force cursor update with current mouse position
                                    if (event) updateCursorPosition(event);
                                }, 50);
                            }
                        });

                        // Add response handler for structure placement
                        if (window.room) {
                            window.room.onMessage("structurePlaced", (response) => {
                                console.log("Server responded to structure placement:", response);
                                
                                if (response.success) {
                                    console.log("Structure placed successfully, id:", response.id);
                                    
                                    // Force update the preview to show it's ready for the next build
                                    setTimeout(() => {
                                        if (window.lastMouseEvent) {
                                            // Re-trigger cursor update to refresh preview
                                            updateCursorPosition(window.lastMouseEvent);
                                        }
                                    }, 200);
                                } else {
                                    console.error("Server rejected structure placement:", response.error);
                                }
                            });
                        }

                        document.body.appendChild(clickInterceptor);
                        
                        // Position cursor at center initially
                        updateCursorPosition({
                            clientX: window.innerWidth / 2,
                            clientY: window.innerHeight / 2
                        });
                        
                        // Start tracking mouse movement for placement preview
                        document.addEventListener('mousemove', updateCursorPosition);
                        
                        // Modify building menu button styles to ensure they're clickable
                        const allButtons = buildingMenu.querySelectorAll('button');
                        allButtons.forEach(button => {
                            button.style.zIndex = '1002'; // Higher than placement preview
                            button.style.position = 'relative'; // Ensure proper stacking
                            button.style.pointerEvents = 'auto'; // Force clickable
                        });
                    } else {
                        // Remove cursor-hiding class
                        document.documentElement.classList.remove('hide-cursor');
                        
                        // Stop tracking mouse movement
                        document.removeEventListener('mousemove', updateCursorPosition);
                        
                        // Restore cursor style
                        document.body.style.cursor = 'default';
                        document.documentElement.style.cursor = 'default';
                        
                        if (window.renderer && window.renderer.domElement) {
                            window.renderer.domElement.style.cursor = 'default';
                        }
                        
                        // Re-enable controls
                        if (window.controls) {
                            window.controls.enabled = true;
                        }
                        
                        // Remove click interceptor
                        const clickInterceptor = document.getElementById('build-click-interceptor');
                        if (clickInterceptor) {
                            clickInterceptor.remove();
                        }
                    }
                    
                    console.log("Building mode " + (this.active ? "activated" : "deactivated"));
                    
                    // Select default structure if activating
                    if (this.active && !this.currentStructure) {
                        selectStructureType('building');
                    }

                    // Ensure lock instructions stay hidden after exiting building mode
                    if (!this.active) {
                        const lockInstructions = document.getElementById('lock-instructions');
                        if (lockInstructions) {
                            lockInstructions.style.display = 'none';
                        }
                    }
                }
            };
            
            // Function to update cursor position for placement preview
            function updateCursorPosition(event) {
                // Update 2D cursor preview position
                placementPreview.style.left = event.clientX + 'px';
                placementPreview.style.top = event.clientY + 'px';
                
                // Get 3D world position from screen position
                const worldPos = screenToWorld(event.clientX, event.clientY);
                
                if (worldPos && window.buildingMode.active) {
                    // Check if placement is valid
                    window.buildingPreview.isValid = checkPlacementValidity(worldPos);
                    
                    // Update 3D preview position
                    window.updatePreviewPosition(worldPos);
                }
            }
            
            // Check if placement is valid at a position
            function checkPlacementValidity(position) {
                // If we don't have a room or structures, assume valid
                if (!window.room || !window.room.state || !window.room.state.structures) {
                    return true;
                }
                
                const structureType = window.buildingMode.currentStructure;
                const rotationDegrees = window.buildingMode.rotation;
                const rotationRadians = rotationDegrees * (Math.PI / 180);
                
                // Get base dimensions based on type
                let width = 4, depth = 4;
                if (structureType === 'wall') {
                    width = 4;
                    depth = 0.5;
                    
                    // For continuous rotation, calculate the actual footprint using trigonometry
                    // This handles any arbitrary rotation angle, not just 90-degree increments
                    const absRotation = rotationDegrees % 180; // Only need to consider 0-180 due to symmetry
                    const normalizedRotation = absRotation > 90 ? 180 - absRotation : absRotation;
                    const radians = normalizedRotation * (Math.PI / 180);
                    
                    // Calculate effective width and depth after rotation
                    const effectiveWidth = Math.abs(width * Math.cos(radians)) + Math.abs(depth * Math.sin(radians));
                    const effectiveDepth = Math.abs(width * Math.sin(radians)) + Math.abs(depth * Math.cos(radians));
                    
                    width = effectiveWidth;
                    depth = effectiveDepth;
                }
                
                // Create bounding box for new structure
                const halfWidth = width / 2;
                const halfDepth = depth / 2;
                
                const newMin = { 
                    x: position.x - halfWidth, 
                    z: position.z - halfDepth 
                };
                const newMax = { 
                    x: position.x + halfWidth, 
                    z: position.z + halfDepth 
                };
                
                // Check for collisions with existing structures
                let isValid = true;
                
                window.room.state.structures.forEach(structure => {
                    if (!isValid) return; // Skip if already invalid
                    
                    // Get structure dimensions
                    let otherWidth = structure.width;
                    let otherDepth = structure.depth;
                    
                    // Create bounding box for existing structure
                    const otherHalfWidth = otherWidth / 2;
                    const otherHalfDepth = otherDepth / 2;
                    
                    const otherMin = { 
                        x: structure.x - otherHalfWidth, 
                        z: structure.z - otherHalfDepth 
                    };
                    const otherMax = { 
                        x: structure.x + otherHalfWidth, 
                        z: structure.z + otherHalfDepth 
                    };
                    
                    // Check for overlap
                    if (newMin.x <= otherMax.x && newMax.x >= otherMin.x &&
                        newMin.z <= otherMax.z && newMax.z >= otherMin.z) {
                        isValid = false;
                    }
                });
                
                return isValid;
            }
            
            // Function to select structure type
            function selectStructureType(typeId) {
                window.buildingMode.currentStructure = typeId;
                console.log("Selected structure type:", typeId);
                
                // Update 3D preview type
                if (window.buildingPreview) {
                    window.buildingPreview.currentType = typeId;
                    
                    // Update preview position based on last mouse position
                    if (window.lastMousePosition) {
                        window.updatePreviewPosition(window.lastMousePosition);
                    }
                }
                
                // Update button styling
                const buttons = buildingMenu.querySelectorAll('button');
                buttons.forEach(button => {
                    if (button.textContent === structureTypes.find(t => t.id === typeId)?.name) {
                        button.style.backgroundColor = 'blue';
                    } else if (['Rotate (Q/E)'].indexOf(button.textContent) === -1) {
                        button.style.backgroundColor = '#555';
                    }
                });
            }
            
            // Setup rotation key holding - make it global by adding to window
            window.rotationInterval = null;
            const rotationSpeed = 15; // degrees per interval
            const rotationIntervalMs = 100; // milliseconds between rotations

            // Add continuous rotation on key hold
            document.addEventListener('keydown', function(event) {
                // Skip if interval already exists
                if (window.rotationInterval) return;
                
                // Only handle in building mode
                if (!window.buildingMode || !window.buildingMode.active) return;
                
                if (event.key === 'q' || event.key === 'Q') {
                    // Start continuous counter-clockwise rotation
                    window.rotationInterval = setInterval(() => {
                        window.buildingMode.rotation = (window.buildingMode.rotation - rotationSpeed) % 360;
                        if (window.buildingMode.rotation < 0) window.buildingMode.rotation += 360;
                        
                        // Update preview
                        if (window.lastMousePosition) {
                            window.updatePreviewPosition(window.lastMousePosition);
                        }
                    }, rotationIntervalMs);
                } 
                else if (event.key === 'e' || event.key === 'E') {
                    // Start continuous clockwise rotation
                    window.rotationInterval = setInterval(() => {
                        window.buildingMode.rotation = (window.buildingMode.rotation + rotationSpeed) % 360;
                        
                        // Update preview
                        if (window.lastMousePosition) {
                            window.updatePreviewPosition(window.lastMousePosition);
                        }
                    }, rotationIntervalMs);
                }
            });

            // Add keyup event to stop rotation
            document.addEventListener('keyup', function(event) {
                if ((event.key === 'q' || event.key === 'Q' || event.key === 'e' || event.key === 'E') && window.rotationInterval) {
                    clearInterval(window.rotationInterval);
                    window.rotationInterval = null;
                }
            });
            
            // Set up mouse motion tracking to ensure preview updates properly
            document.addEventListener('mousemove', function(event) {
                if (window.buildingMode && window.buildingMode.active) {
                    updateCursorPosition(event);
                }
            });
            
            // Function to rotate structure
            function rotateStructure() {
                window.buildingMode.rotation = (window.buildingMode.rotation + 90) % 360;
                console.log("Rotating structure to", window.buildingMode.rotation, "degrees");
            }
            
            // Convert screen position to world position using raycasting
            function screenToWorld(screenX, screenY) {
                // Need to normalize coordinates for raycaster
                const normalizedX = (screenX / window.innerWidth) * 2 - 1;
                const normalizedY = -(screenY / window.innerHeight) * 2 + 1;
                
                if (!window.camera || !window.scene) {
                    console.error("Camera or scene not available for raycasting");
                    return null;
                }
                
                // Create raycaster
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(normalizedX, normalizedY), window.camera);
                
                // Create a ground plane at y=0
                const groundPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
                const intersection = new THREE.Vector3();
                
                if (raycaster.ray.intersectPlane(groundPlane, intersection)) {
                    // Round coordinates to grid
                    intersection.x = Math.round(intersection.x);
                    intersection.y = 0; // Structures always start at ground level
                    intersection.z = Math.round(intersection.z);
                    
                    return intersection;
                }
                
                return null;
            }
            
            // Set up listeners for structure state changes from server
            if (window.room) {
                // Add structure handlers to the room
                window.room.state.structures.onAdd = (structure, key) => {
                    console.log("Server confirmed structure placement:", key, structure);
                    // Only now that the server confirmed it, create the actual structure in the world
                    createStructureInWorld(structure, key);
                };
                
                window.room.state.structures.onChange = (structure, key) => {
                    console.log("Server updated structure:", key, structure);
                    // Update structure based on server state
                    updateStructureInWorld(structure, key);
                };
                
                window.room.state.structures.onRemove = (structure, key) => {
                    console.log("Server removed structure:", key);
                    // Remove structure based on server command
                    removeStructureFromWorld(key);
                };
            }
            
            // Global collection of structure meshes
            window.worldStructures = new Map();
            
            // Create a structure in the 3D world
            function createStructureInWorld(structure, key) {
                console.log("Creating structure in world:", key, structure);
                
                // Skip if structure already exists
                if (window.worldStructures && window.worldStructures.has(key)) {
                    console.log("Structure already exists, skipping creation:", key);
                    return;
                }
                
                if (!window.scene) {
                    console.error("Scene not available to create structure");
                    return;
                }
                
                // Validate structure data
                if (!structure || !structure.structureType) {
                    console.error("Invalid structure data:", structure);
                    return;
                }
                
                console.log("Building structure:", structure.structureType, "at", structure.x, structure.y, structure.z);
                
                // Generate a basic mesh based on structure type
                let mesh;
                
                try {
                    switch (structure.structureType) {
                        case "building":
                            const buildingGeometry = new THREE.BoxGeometry(structure.width, structure.height, structure.depth);
                            const buildingMaterial = new THREE.MeshLambertMaterial({ color: 0x888888 });
                            mesh = new THREE.Mesh(buildingGeometry, buildingMaterial);
                            break;
                            
                        case "wall":
                            const wallGeometry = new THREE.BoxGeometry(structure.width, structure.height, structure.depth);
                            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0x555555 });
                            mesh = new THREE.Mesh(wallGeometry, wallMaterial);
                            break;
                            
                        default:
                            console.log("Unknown structure type, using default:", structure.structureType);
                            const defaultGeometry = new THREE.BoxGeometry(1, 1, 1);
                            const defaultMaterial = new THREE.MeshLambertMaterial({ color: 0xffff00 });
                            mesh = new THREE.Mesh(defaultGeometry, defaultMaterial);
                    }
                    
                    // Set position and rotation
                    mesh.position.set(structure.x, structure.y + structure.height/2, structure.z);
                    mesh.rotation.y = structure.rotationY || 0;
                    
                    // Add to scene
                    window.scene.add(mesh);
                    
                    // Initialize worldStructures map if needed
                    if (!window.worldStructures) {
                        window.worldStructures = new Map();
                    }
                    
                    // Store reference to mesh
                    window.worldStructures.set(key, mesh);
                    console.log("Structure created successfully:", key);
                } catch (error) {
                    console.error("Error creating structure:", error);
                }
            }
            
            // Update a structure in the 3D world
            function updateStructureInWorld(structure, key) {
                const mesh = window.worldStructures.get(key);
                
                if (mesh) {
                    // Update position and rotation
                    mesh.position.set(structure.x, structure.y + structure.height/2, structure.z);
                    mesh.rotation.y = structure.rotationY || 0;
                } else {
                    // If mesh doesn't exist, create it
                    createStructureInWorld(structure, key);
                }
            }
            
            // Remove a structure from the 3D world
            function removeStructureFromWorld(key) {
                const mesh = window.worldStructures.get(key);
                
                if (mesh && window.scene) {
                    window.scene.remove(mesh);
                    window.worldStructures.delete(key);
                }
            }
            
            // Create preview models for building preview
            function createPreviewModels() {
                if (!window.scene) return;
                
                // Create materials
                const validMaterial = new THREE.MeshBasicMaterial({
                    color: 0x00ff00,
                    transparent: true,
                    opacity: 0.5
                });
                
                const invalidMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.5
                });
                
                // Building preview mesh
                const buildingGeometry = new THREE.BoxGeometry(4, 3, 4);
                const buildingMesh = new THREE.Mesh(buildingGeometry, validMaterial.clone());
                
                // Wall preview mesh
                const wallGeometry = new THREE.BoxGeometry(4, 2, 0.5);
                const wallMesh = new THREE.Mesh(wallGeometry, validMaterial.clone());
                
                // Create preview container
                const previewGroup = new THREE.Group();
                previewGroup.visible = false;
                window.scene.add(previewGroup);
                
                // Create grid helper
                const grid = new THREE.GridHelper(50, 50, 0x444444, 0x888888);
                grid.position.y = 0.01; // Slightly above ground
                grid.visible = false;
                window.scene.add(grid);
                
                // Store references
                window.buildingPreview = {
                    group: previewGroup,
                    grid: grid,
                    models: {
                        building: buildingMesh,
                        wall: wallMesh
                    },
                    materials: {
                        valid: validMaterial,
                        invalid: invalidMaterial
                    },
                    currentType: null,
                    isValid: true
                };
                
                console.log("Created 3D preview models");
            }
            
            // Function to update preview position and visibility - make it globally accessible
            window.updatePreviewPosition = function(worldPos) {
                if (!window.buildingPreview || !window.buildingPreview.group) return;
                
                // Get preview data
                const preview = window.buildingPreview;
                
                // Clear current preview
                while (preview.group.children.length > 0) {
                    preview.group.remove(preview.group.children[0]);
                }
                
                // If no world position or no selected type, hide preview
                if (!worldPos || !preview.currentType) {
                    preview.group.visible = false;
                    return;
                }
                
                // Get appropriate model
                const model = preview.models[preview.currentType].clone();
                
                // Apply appropriate material
                model.material = preview.isValid ? 
                    preview.materials.valid.clone() : 
                    preview.materials.invalid.clone();
                
                // Position model in group
                model.position.y = model.geometry.parameters.height / 2;
                
                // Position group in world
                preview.group.position.set(worldPos.x, worldPos.y, worldPos.z);
                
                // Apply rotation
                preview.group.rotation.y = window.buildingMode.rotation * (Math.PI / 180);
                
                // Add model to group and show
                preview.group.add(model);
                preview.group.visible = true;
            }
            
            console.log("Building mode setup complete - press B to toggle");

            // Global flag to prevent pointer lock while building
            window.preventPointerLock = false;

            // Modify any existing pointer lock controls to check this flag
            const originalPointerLockInit = window.initPointerLock || function(){};
            window.initPointerLock = function() {
                if (window.preventPointerLock) {
                    console.log("Pointer lock prevented - building mode active");
                    return false;
                }
                return originalPointerLockInit.apply(this, arguments);
            };

            // Add a listener to prevent pointer lock even if another system tries to request it
            document.addEventListener('pointerlockchange', function() {
                if (window.preventPointerLock && document.pointerLockElement) {
                    // If pointer lock was activated while it should be prevented, exit it immediately
                    document.exitPointerLock();
                    console.log("Forced exit of pointer lock - building mode active");
                }
            }, false);

            // Also listen for the pointer lock error event to avoid console errors
            document.addEventListener('pointerlockerror', function(event) {
                if (window.preventPointerLock) {
                    // Prevent the error from propagating when we're in building mode
                    event.preventDefault();
                    console.log("Prevented pointer lock error while in building mode");
                }
            }, false);
        }, 2000);
    });
    </script>
    
    <!-- Add main keyboard controls -->
    <script>
    document.addEventListener('keydown', function(event) {
        // B key toggles building mode
        if (event.key === 'b' || event.key === 'B') {
            window.buildingMode.toggle();
        }
        
        // Only handle these keys if in building mode
        if (window.buildingMode && window.buildingMode.active) {
            // Single key presses for rotation (handled separately from continuous rotation)
            if ((event.key === 'q' || event.key === 'Q') && !window.rotationInterval) {
                window.buildingMode.rotation = (window.buildingMode.rotation - 15) % 360;
                if (window.buildingMode.rotation < 0) window.buildingMode.rotation += 360;
                console.log("Rotating structure to", window.buildingMode.rotation, "degrees");
                
                // Update preview position with new rotation
                if (window.lastMousePosition) {
                    window.updatePreviewPosition(window.lastMousePosition);
                }
            }
            
            if ((event.key === 'e' || event.key === 'E') && !window.rotationInterval) {
                window.buildingMode.rotation = (window.buildingMode.rotation + 15) % 360;
                console.log("Rotating structure to", window.buildingMode.rotation, "degrees");
                
                // Update preview position with new rotation
                if (window.lastMousePosition) {
                    window.updatePreviewPosition(window.lastMousePosition);
                }
            }
            
            // Escape key - exit building mode
            if (event.key === 'Escape') {
                window.buildingMode.toggle();
            }
        }
    });
    </script>
    
    <!-- Wait for room connection to be established and set up listeners -->
    <script>
    function setupRoomListeners() {
        if (!window.room) {
            console.log("Waiting for room connection...");
            setTimeout(setupRoomListeners, 1000);
            return;
        }
        
        console.log("Setting up structure listeners for room", window.room.id || "unknown");
        
        // Wait for state to be available
        if (!window.room.state) {
            console.log("Room state not yet available, retrying...");
            setTimeout(setupRoomListeners, 500);
            return;
        }
        
        // Listen for when structures schema is added to state
        const setupStructureHandlers = () => {
            console.log("Setting up structure handlers");
            
            // Add structure handlers to the room
            window.room.state.structures.onAdd = (structure, key) => {
                console.log("Server confirmed structure placement:", key, structure);
                // Only now that the server confirmed it, create the actual structure in the world
                createStructureInWorld(structure, key);
            };
            
            window.room.state.structures.onChange = (structure, key) => {
                console.log("Server updated structure:", key, structure);
                // Update structure based on server state
                updateStructureInWorld(structure, key);
            };
            
            window.room.state.structures.onRemove = (structure, key) => {
                console.log("Server removed structure:", key);
                // Remove structure based on server command
                removeStructureFromWorld(key);
            };
            
            // Check for existing structures that may have been missed
            window.room.state.structures.forEach((structure, key) => {
                console.log("Processing existing structure:", key);
                createStructureInWorld(structure, key);
            });
            
            console.log("Structure listeners set up successfully");
        };
        
        // If structures schema is already available, set up handlers immediately
        if (window.room.state.structures) {
            setupStructureHandlers();
        } else {
            // If not, add a schema listener to detect when it becomes available
            console.log("Structures schema not found, adding state listener");
            
            // Use Colyseus state change listener to detect when structures are added
            window.room.onStateChange((state) => {
                if (state.structures && !window.structureListenersSetup) {
                    console.log("Structures schema detected in state change");
                    window.structureListenersSetup = true;
                    setupStructureHandlers();
                }
            });
            
            // Also set a timeout just in case
            setTimeout(() => {
                if (!window.structureListenersSetup && window.room.state.structures) {
                    console.log("Structures schema detected in timeout check");
                    window.structureListenersSetup = true;
                    setupStructureHandlers();
                }
            }, 3000);
        }
    }

    // Start setting up room listeners
    setupRoomListeners();
    </script>
    
    <!-- Add connection monitoring -->
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        console.log("Setting up room connection monitoring");
        
        // Check room connection every second
        const connectionChecker = setInterval(() => {
            if (window.room) {
                console.log("Room connection detected:", window.room.id);
                clearInterval(connectionChecker);
                
                // Add debug event listeners for room state
                window.room.onStateChange((state) => {
                    console.log("State update received, structures count:", 
                        state.structures ? state.structures.size : "no structures schema");
                    
                    // Log all structures when state changes
                    if (state.structures && state.structures.size > 0) {
                        console.log("Current structures:");
                        state.structures.forEach((structure, key) => {
                            console.log(`- ${key}: ${structure.structureType} at (${structure.x}, ${structure.y}, ${structure.z})`);
                        });
                    }
                });
                
                // Listen for errors
                window.room.onError((err) => {
                    console.error("Room error:", err);
                });
                
                // Detect when room is ready
                if (window.room.state) {
                    console.log("Room state is already available");
                    console.log("Initial structures count:", 
                        window.room.state.structures ? window.room.state.structures.size : "no structures schema");
                }
            }
        }, 1000);
        
        // After 30 seconds, stop checking to avoid memory leaks
        setTimeout(() => {
            clearInterval(connectionChecker);
        }, 30000);
    });
    </script>
    
    <!-- Add basic structure functions for client-side rendering -->
    <script>
    // Global map to store structure meshes
    window.worldStructuresMap = new Map();
    
    // Create a structure in the 3D world based on server data
    function createStructureInWorld(structure, key) {
        console.log("Creating structure in world:", key, structure);
        
        // Skip if structure already exists
        if (window.worldStructuresMap.has(key)) {
            console.log("Structure already exists, updating instead:", key);
            return updateStructureInWorld(structure, key);
        }
        
        if (!window.scene) {
            console.error("Scene not available to create structure");
            return null;
        }
        
        // Validate structure data
        if (!structure || !structure.structureType) {
            console.error("Invalid structure data:", structure);
            return null;
        }
        
        console.log("Building structure:", structure.structureType, "at", structure.x, structure.y, structure.z);
        
        // Generate mesh based on structure type
        let mesh;
        let geometry, material;
        
        switch (structure.structureType) {
            case "building":
                // Create a building with roof
                const buildingHeight = structure.height || 3;
                const buildingWidth = structure.width || 4;
                const buildingDepth = structure.depth || 4;
                
                // Main building
                geometry = new THREE.BoxGeometry(buildingWidth, buildingHeight, buildingDepth);
                material = new THREE.MeshLambertMaterial({ color: 0x8B4513 }); // Brown
                mesh = new THREE.Mesh(geometry, material);
                
                // Add a roof
                const roofGeometry = new THREE.ConeGeometry(buildingWidth * 0.7, buildingHeight * 0.5, 4);
                const roofMaterial = new THREE.MeshLambertMaterial({ color: 0xA52A2A }); // Dark red
                const roof = new THREE.Mesh(roofGeometry, roofMaterial);
                roof.position.y = buildingHeight/2 + buildingHeight*0.25/2;
                roof.rotation.y = Math.PI/4; // 45 degrees
                mesh.add(roof);
                break;
                
            case "wall":
                geometry = new THREE.BoxGeometry(structure.width || 4, structure.height || 2, structure.depth || 0.5);
                material = new THREE.MeshLambertMaterial({ color: 0x808080 }); // Gray
                mesh = new THREE.Mesh(geometry, material);
                break;
                
            default:
                console.log("Unknown structure type, using default:", structure.structureType);
                geometry = new THREE.BoxGeometry(1, 1, 1);
                material = new THREE.MeshLambertMaterial({ color: 0xffff00 });
                mesh = new THREE.Mesh(geometry, material);
        }
        
        // Position the structure (center Y position based on height)
        mesh.position.set(
            structure.x, 
            structure.y + (structure.height || 1) / 2, 
            structure.z
        );
        mesh.rotation.y = structure.rotationY || 0;
        
        // Add to scene
        window.scene.add(mesh);
        
        // Store reference to mesh
        window.worldStructuresMap.set(key, mesh);
        console.log("Structure created successfully:", key);
        
        return mesh;
    }
    
    // Update a structure in the 3D world
    function updateStructureInWorld(structure, key) {
        const mesh = window.worldStructuresMap.get(key);
        
        if (mesh) {
            // Update position and rotation
            mesh.position.set(structure.x, structure.y + (structure.height || 1)/2, structure.z);
            mesh.rotation.y = structure.rotationY || 0;
            return mesh;
        } else {
            // If mesh doesn't exist, create it
            return createStructureInWorld(structure, key);
        }
    }
    
    // Remove a structure from the 3D world
    function removeStructureFromWorld(key) {
        const mesh = window.worldStructuresMap.get(key);
        
        if (mesh && window.scene) {
            window.scene.remove(mesh);
            window.worldStructuresMap.delete(key);
            
            // Cleanup resources
            if (mesh.geometry) mesh.geometry.dispose();
            if (mesh.material) {
                if (Array.isArray(mesh.material)) {
                    mesh.material.forEach(m => m.dispose());
                } else {
                    mesh.material.dispose();
                }
            }
            
            return true;
        }
        return false;
    }
    </script>
    
    <!-- Add structure listeners for server updates -->
    <script>
    // Set up structure listeners when the room is available
    function setupStructureListeners() {
        console.log("Setting up structure listeners");
        
        // Wait for room and state to be available
        if (!window.room || !window.room.state) {
            console.log("Room or state not ready, waiting...");
            setTimeout(setupStructureListeners, 500);
            return;
        }
        
        // Wait for structures schema to be available
        if (!window.room.state.structures) {
            console.log("Structures not available in state, waiting...");
            setTimeout(setupStructureListeners, 500);
            return;
        }
        
        console.log("Setting up structure listeners for room:", window.room.id);
        
        // Handler for new structures added by the server
        window.room.state.structures.onAdd = (structure, key) => {
            console.log("New structure from server:", key, structure);
            createStructureInWorld(structure, key);
        };
        
        // Handler for structures removed from the server
        window.room.state.structures.onRemove = (structure, key) => {
            console.log("Server removed structure:", key);
            removeStructureFromWorld(key);
        };
        
        // Handler for structures modified on the server
        window.room.state.structures.onChange = (structure, key) => {
            console.log("Server updated structure:", key, structure);
            updateStructureInWorld(structure, key);
        };
        
        // Check for existing structures
        if (window.room.state.structures.size > 0) {
            console.log("Processing existing structures:", window.room.state.structures.size);
            window.room.state.structures.forEach((structure, key) => {
                console.log("Processing existing structure:", key);
                createStructureInWorld(structure, key);
            });
        }
        
        console.log("Structure listeners setup complete");
    }
    
    // Start the listener setup when the page loads
    window.addEventListener('DOMContentLoaded', function() {
        setTimeout(setupStructureListeners, 1000);
    });
    </script>
    
    <!-- Remove older or duplicate setup code -->
    <script>
    // Clean up any existing setup
    window.addEventListener('DOMContentLoaded', function() {
        console.log("Cleaning up any existing structure handling");
        
        // Override any previous global structure related functions 
        // with our new simplified ones
        window.createStructureInWorld = createStructureInWorld;
        window.updateStructureInWorld = updateStructureInWorld;
        window.removeStructureFromWorld = removeStructureFromWorld;
        
        // Clear any previous listeners when setting up new ones
        setTimeout(() => {
            if (window.room && window.room.state && window.room.state.structures) {
                console.log("Clearing any existing structure listeners before setup");
                
                // Attempt to remove existing listeners (if possible)
                if (window.room.state.structures._callbacks) {
                    window.room.state.structures._callbacks = {};
                }
            }
        }, 500);
    });
    </script>
    
    <!-- Add simple debug tool -->
    <script>
    // Press Shift+S to show structure info
    document.addEventListener('keydown', function(event) {
        if (event.key === 'S' && event.shiftKey) {
            console.log("=== STRUCTURE DEBUG INFO ===");
            
            // Check if we have structures in memory
            if (window.worldStructuresMap) {
                console.log(`Total structures in memory: ${window.worldStructuresMap.size}`);
                
                // List all structures
                if (window.worldStructuresMap.size > 0) {
                    let i = 1;
                    window.worldStructuresMap.forEach((mesh, key) => {
                        console.log(`${i}. ${key} at (${Math.round(mesh.position.x)}, ${Math.round(mesh.position.z)})`);
                        i++;
                    });
                }
            } else {
                console.log("No worldStructuresMap found");
            }
            
            // Check server structures
            if (window.room && window.room.state && window.room.state.structures) {
                console.log(`Total structures on server: ${window.room.state.structures.size}`);
                
                // List all server structures
                if (window.room.state.structures.size > 0) {
                    let i = 1;
                    window.room.state.structures.forEach((structure, key) => {
                        console.log(`${i}. ${key} - ${structure.structureType} at (${structure.x}, ${structure.z})`);
                        i++;
                    });
                }
            } else {
                console.log("No server structures available");
            }
            
            console.log("===========================");
        }
        
        // Press Shift+R to resync structures
        if (event.key === 'R' && event.shiftKey) {
            console.log("Force resyncing structures from server");
            
            // Clear and rebuild all structures
            if (window.worldStructuresMap) {
                // Remove all structures from scene
                window.worldStructuresMap.forEach((mesh, key) => {
                    removeStructureFromWorld(key);
                });
                
                // Recreate from server
                if (window.room && window.room.state && window.room.state.structures) {
                    console.log(`Recreating ${window.room.state.structures.size} structures from server`);
                    window.room.state.structures.forEach((structure, key) => {
                        createStructureInWorld(structure, key);
                    });
                }
            }
        }
    });
    </script>
</body>
</html>
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\css\styles.css 
===================================================== 
 
/* Reset default margins and padding */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    overflow: hidden;
}

body, html {
    width: 100%;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
    background-color: #000;
}

/* Make the canvas fill the entire screen */
#game-canvas {
    display: block;
    width: 100%;
    height: 100%;
}

/* Fix for horizontal bar issue - ensuring no elements create unwanted artifacts */
canvas {
    position: fixed;
    top: 0;
    left: 0;
    outline: none;
}

/* Controls info overlay */
.overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    z-index: 100;
}

.overlay h2 {
    margin-bottom: 10px;
}

.overlay p {
    margin-bottom: 15px;
}

.overlay ul {
    list-style-type: none;
    text-align: left;
    margin: 0 auto;
    display: inline-block;
}

.overlay ul li {
    margin-bottom: 5px;
}

/* Game HUD */
.hud {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10;
    color: white;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 2px 2px 2px rgba(0, 0, 0, 0.8);
    background-color: rgba(0, 0, 0, 0.5);
    padding: 10px 15px;
    border-radius: 8px;
    pointer-events: none; /* Allow clicking through the HUD */
}

#player-number-display {
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

#player-value {
    margin-left: 5px;
    font-size: 32px;
}

/* Ensure no overflow elements */
body, html, canvas {
    overflow: hidden;
}
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\main.js 
===================================================== 
 
// 3D Game Platform - Main Entry Point

// Game configuration
const gameConfig = {
    debug: false,                 // Debug mode
    sceneSettings: {
        groundSize: 100,          // Size of the ground plane
        skyColor: 0x87CEEB,       // Sky color
        groundColor: 0x228B22     // Ground color
    },
    playerSettings: {
        startPosition: {
            x: 0,
            y: 1,
            z: 0
        },
        viewMode: 'firstPerson'   // 'firstPerson', 'thirdPerson', or 'freeRoam'
    },
    networkSettings: {
        serverUrl: window.location.hostname.includes('localhost') 
            ? `ws://${window.location.hostname}:3000` // Local development
            : `wss://${window.location.hostname}`,    // Production
        roomName: 'default'       // Default room name
    }
};

// Store config globally for access by other modules
window.gameConfig = gameConfig;

// Main game initialization
function initGame() {
    console.log('Initializing 3D Game Platform...');
    
    // Load core modules
    loadCoreModules()
        .then(() => {
            // Initialize the game engine
            initGameEngine();
        })
        .catch(error => {
            console.error('Error initializing game:', error);
        });
}

// Load core platform modules
function loadCoreModules() {
    return new Promise((resolve, reject) => {
        try {
            console.log('Loading core modules...');
            
            // Create core module paths
            const corePath = 'js/core/';
            const coreModules = [
                'Entity.js',
                'Player.js',
                'NPC.js',
                'EntityFactory.js',
                'collision.js',
                'player-ui.js',
                'network-core.js',
                'controls.js'
            ];
            
            // Load each module in sequence
            let loadPromise = Promise.resolve();
            
            coreModules.forEach(module => {
                loadPromise = loadPromise.then(() => {
                    return loadScript(corePath + module);
                });
            });
            
            // Resolve when all core modules are loaded
            loadPromise.then(() => {
                console.log('Core modules loaded successfully');
                resolve();
            }).catch(error => {
                reject(error);
            });
        } catch (error) {
            reject(error);
        }
    });
}

// Initialize the main game engine
function initGameEngine() {
    console.log('Initializing game engine...');
    
    // Initialize default player factory first
    window.createPlayerEntity = function(scene, value = 1) {
        // Create a simple player with a box
        const player = new window.Player({
            id: 'player',
            isLocalPlayer: true,
            color: 0xFFFF00
        });
        
        if (scene && player.mesh) {
            scene.add(player.mesh);
        }
        
        return player;
    };
    
    // Load default implementation
    loadScript('js/implementations/default/DefaultPlayer.js')
        .then(() => {
            // Load the game engine
            return loadScript('js/core/game-engine.js');
        })
        .then(() => {
            console.log('Game engine loaded');
            // Remove the loading screen once everything is loaded
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // Set isFirstPerson based on viewMode
            window.isFirstPerson = gameConfig.playerSettings.viewMode === 'firstPerson';
            window.viewMode = gameConfig.playerSettings.viewMode;
        })
        .catch(error => {
            console.error('Error loading game engine:', error);
        });
}

// Helper function to load a script asynchronously
function loadScript(src) {
    return new Promise((resolve, reject) => {
        // Check if this script has already been loaded
        if (document.querySelector(`script[src="${src}"]`)) {
            console.log(`Script already loaded: ${src}`);
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = (error) => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(script);
    });
}

// Start the game when the document is ready
document.addEventListener('DOMContentLoaded', initGame);  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\collision.js 
===================================================== 
 
/**
 * 3D AI Game Platform - AABB Collision System
 * Uses Axis-Aligned Bounding Boxes for efficient collision detection
 */

class CollisionSystem {
    constructor() {
        // Collection of collidable objects
        this.collidableObjects = [];
        this.debugMode = false; // Set to true to see debug logging
    }

    // Initialize collision system and collect collidable objects from the scene
    init(scene) {
        console.log("Initializing collision system...");
        this.collidableObjects = [];
        
        // Traverse the scene to find all collidable objects
        scene.traverse((object) => {
            if (object.isMesh && object.userData && object.userData.collidable === true) {
                this.collidableObjects.push(object);
                if (this.debugMode) console.log(`Added collidable object: ${object.name || 'unnamed object'}`);
            }
        });
        
        console.log(`Collision system initialized with ${this.collidableObjects.length} collidable objects`);
        return this.collidableObjects.length;
    }

    // Add a single object to the collidable objects list
    addCollidableObject(object) {
        if (!object || !(object.isMesh || object.isGroup)) return;
        
        // Mark the object as collidable
        object.userData = object.userData || {};
        object.userData.collidable = true;
        
        // Add a name if it doesn't have one for easier debugging
        if (!object.name) {
            object.name = `collidable_${this.collidableObjects.length}`;
        }
        
        // Only add if not already in the list
        if (!this.collidableObjects.includes(object)) {
            this.collidableObjects.push(object);
            if (this.debugMode) console.log(`Added collidable object: ${object.name}`);
            
            // If it's a group, also make all children collidable
            if (object.isGroup && object.children) {
                object.children.forEach(child => {
                    if (child.isMesh) {
                        child.userData = child.userData || {};
                        child.userData.collidable = true;
                        this.collidableObjects.push(child);
                        if (this.debugMode) console.log(`Added child collidable object: ${child.name || 'unnamed child'}`);
                    }
                });
            }
        }
    }

    // Create or update a bounding box for a mesh
    updateAABB(mesh) {
        if (!mesh) return null;
        
        // Use Three.js Box3 to create a bounding box from the mesh
        const box = new THREE.Box3().setFromObject(mesh);
        return box;
    }

    // Check if two bounding boxes intersect
    checkCollision(boxA, boxB) {
        if (!boxA || !boxB) return false;
        return boxA.intersectsBox(boxB);
    }

    // Get the minimum translation vector to resolve a collision
    getCollisionResponse(boxA, boxB) {
        // Create a box that represents the intersection
        const intersection = new THREE.Box3();
        intersection.copy(boxA).intersect(boxB);
        
        // Get the size of the intersection
        const size = intersection.getSize(new THREE.Vector3());
        
        // Find the minimum penetration axis (x, y, or z)
        let axis, minSize;
        
        if (size.x <= size.y && size.x <= size.z) {
            axis = 'x';
            minSize = size.x;
        } else if (size.y <= size.x && size.y <= size.z) {
            axis = 'y';
            minSize = size.y;
        } else {
            axis = 'z';
            minSize = size.z;
        }
        
        // Return the direction and amount to move
        const response = {
            axis: axis,
            depth: minSize,
            direction: new THREE.Vector3()
        };
        
        // Calculate the direction to move (away from the obstacle)
        const centerA = boxA.getCenter(new THREE.Vector3());
        const centerB = boxB.getCenter(new THREE.Vector3());
        
        if (axis === 'x') {
            response.direction.x = centerA.x < centerB.x ? -1 : 1;
        } else if (axis === 'y') {
            response.direction.y = centerA.y < centerB.y ? -1 : 1;
        } else {
            response.direction.z = centerA.z < centerB.z ? -1 : 1;
        }
        
        return response;
    }

    // Check collisions for the player against all collidable objects
    checkPlayerCollisions(playerMesh, controlsObject) {
        if (!playerMesh || !controlsObject || this.collidableObjects.length === 0) {
            return { collision: false, grounded: false };
        }
        
        // Update player bounding box
        const playerBox = this.updateAABB(playerMesh);
        let hasCollision = false;
        let isGrounded = false;
        
        // Check against all collidable objects
        for (const obstacle of this.collidableObjects) {
            // Skip player's own mesh
            if (obstacle === playerMesh) continue;
            
            const obstacleBox = this.updateAABB(obstacle);
            if (this.checkCollision(playerBox, obstacleBox)) {
                hasCollision = true;
                if (this.debugMode) console.log(`Collision detected with ${obstacle.name || 'unnamed object'}`);
                
                // Handle the collision and check if we're standing on something
                const collisionResult = this.handleCollision(playerBox, obstacleBox, controlsObject);
                if (collisionResult.landedOnTop) {
                    isGrounded = true;
                }
            }
        }
        
        return { collision: hasCollision, grounded: isGrounded };
    }

    // Apply collision response and return collision info
    handleCollision(playerBox, obstacleBox, controlsObject) {
        const response = this.getCollisionResponse(playerBox, obstacleBox);
        
        // Apply a small buffer to prevent getting stuck
        const buffer = 0.1;
        let landedOnTop = false;
        
        // Apply the collision response to the controls object
        if (response.axis === 'x') {
            controlsObject.position.x += (response.depth + buffer) * response.direction.x;
        } else if (response.axis === 'y') {
            // For Y-axis collisions, we need to determine if we landed on top
            if (response.direction.y > 0) {
                // We hit the bottom of something
                controlsObject.position.y += (response.depth + buffer) * response.direction.y;
            } else {
                // We landed on top of something
                controlsObject.position.y += (response.depth + buffer) * response.direction.y;
                landedOnTop = true;
                
                // Stop any downward velocity if we're using physics
                if (controlsObject.userData && controlsObject.userData.velocity) {
                    controlsObject.userData.velocity.y = 0;
                }
            }
        } else {
            controlsObject.position.z += (response.depth + buffer) * response.direction.z;
        }
        
        return { landedOnTop };
    }

    // Mark objects in the scene as collidable
    markAllObjectsAsCollidable(scene) {
        scene.traverse(object => {
            // Skip the player, camera, lights, and ground
            if (object.name === 'ground' || 
                object.name === 'player' || 
                object.isLight || 
                object.isCamera) {
                return;
            }
            
            // Mark all meshes that aren't the player, lights, or ground as collidable
            if (object.isMesh) {
                object.userData = object.userData || {};
                object.userData.collidable = true;
                
                // Add it to our collidable objects array if not already there
                if (!this.collidableObjects.includes(object)) {
                    this.collidableObjects.push(object);
                    if (this.debugMode) console.log(`Auto-marked as collidable: ${object.name || 'unnamed mesh'}`);
                }
            }
        });
        
        console.log(`Total collidable objects after auto-marking: ${this.collidableObjects.length}`);
    }

    // Set debug mode
    setDebugMode(debug) {
        this.debugMode = debug;
    }
}

// Create and export a singleton instance
const collisionSystem = new CollisionSystem();

// Export for use in other modules
if (typeof window !== 'undefined') {
    window.CollisionSystem = CollisionSystem;
    window.collisionSystem = collisionSystem;
}

if (typeof module !== 'undefined') {
    module.exports = { CollisionSystem, collisionSystem };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\controls.js 
===================================================== 
 
// Global variables
window.moveForward = false;
window.moveBackward = false;
window.moveLeft = false;
window.moveRight = false;
window.turnLeft = false;    // For diagonal movement forward-left
window.turnRight = false;   // For diagonal movement forward-right
window.canJump = false;
// isFirstPerson is a global variable attached to the window object in game-engine.js
window.prevTime = performance.now();
window.velocity = new THREE.Vector3();
window.direction = new THREE.Vector3();

// Add input state object for server-based movement
window.inputState = {
  keys: { w: false, a: false, s: false, d: false, space: false, q: false, e: false, shift: false },
  mouseDelta: { x: 0, y: 0 }
};

// Add variable for right mouse button state tracking
window.rightMouseDown = false;
window.middleMouseDown = false;

// Player settings
window.playerHeight = 2.0;             // Height of camera from ground
window.moveSpeed = 50.0;                // Units per second
window.turnSpeed = 2.0;                // Rotation speed for Q/E turning
window.jumpHeight = 2.0;               // Jump height in units
window.jumpPressed = false;            // Track jump button press

// Third-person camera settings
window.thirdPersonCameraDistance = 5;  // Distance for the third person camera
window.thirdPersonCameraMinDistance = 2; // Minimum zoom distance
window.thirdPersonCameraMaxDistance = 10; // Maximum zoom distance
window.thirdPersonCameraZoomSpeed = 0.5; // Zoom speed multiplier
window.thirdPersonCameraOrbitSpeed = 0.003; // Orbit speed multiplier
window.thirdPersonCameraHeight = 3.0; // Height of camera above player 
window.thirdPersonCameraOrbitX = 0; // Horizontal orbit angle (left/right)
window.thirdPersonCameraOrbitY = 0.5; // Vertical orbit angle (up/down) 
window.thirdPersonCameraMinY = -0.3; // Minimum vertical orbit angle
window.thirdPersonCameraMaxY = 1.0; // Maximum vertical orbit angle

// Add variables for free camera mode
window.freeCameraSpeed = 0.3;         // Speed for free camera movement
window.freeCameraRotationSpeed = 0.003; // Rotation speed for free camera
window.freeCameraPitch = 0;          // Vertical rotation of free camera
window.freeCameraYaw = 0;            // Horizontal rotation of free camera

// Add variables for RTS view mode
window.rtsCameraHeight = 30.0;        // Fixed height for RTS camera
window.rtsCameraMinHeight = 10.0;     // Minimum height for RTS camera (zoom in)
window.rtsCameraMaxHeight = 60.0;     // Maximum height for RTS camera (zoom out)
window.rtsCameraZoomSpeed = 30.0;     // Speed for RTS camera zoom (keeping as requested)
window.rtsCameraPanSpeed = 0.5;       // Speed for RTS camera panning (reduced from 2.0)
window.isRTSMode = false;             // Flag for RTS mode
window.rtsSelectedUnit = null;        // Currently selected unit in RTS mode
window.rtsSelectedUnits = [];         // Array for multiple unit selection

// Mouse sensitivity settings
window.mouseSensitivity = {
  firstPerson: 1.0,    // Sensitivity multiplier in first-person
  thirdPerson: 0.7,    // Sensitivity multiplier in third-person (slightly lower for smoother movement)
  freeCamera: 1.0,     // Sensitivity for free camera
  rtsView: 0.5,        // Sensitivity for RTS view (lower as it's more tactical)
  current: 1.0         // Current sensitivity based on view mode
};

// Add a global viewMode state variable
window.viewMode = 'firstPerson'; // Values: 'firstPerson', 'thirdPerson', 'freeCamera', 'rtsView'

// Initialize controls for the camera
window.initControls = function(camera, domElement) {
    console.log("Initializing PointerLockControls properly...");

    const controls = new THREE.PointerLockControls(camera, domElement);
    
    // We don't need a click listener here anymore - it's handled in game-engine.js

    controls.addEventListener('lock', () => {
        const instructions = document.getElementById('lock-instructions');
        if (instructions) {
            instructions.style.display = 'none';
        }
        
        // Update mouse sensitivity based on current view mode
        updateMouseSensitivity();
    });
    
    controls.addEventListener('unlock', () => {
        const instructions = document.getElementById('lock-instructions');
        if (instructions) {
            instructions.style.display = 'block';
        }
        
        if (window.isFirstPerson) {
            const controlsInfo = document.getElementById('controls-info');
            if (controlsInfo) {
                controlsInfo.style.display = 'block';
            }
        }
        // Always show cursor when unlocked, regardless of view mode
        document.body.style.cursor = 'auto';
    });

    // Keyboard listeners for movement remain as-is
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);
    
    // Mouse button handlers for classic third-person orbital controls
    document.addEventListener('mousedown', (event) => {
        if (event.button === 2) { // Right mouse button
            window.rightMouseDown = true;
        } else if (event.button === 1) { // Middle mouse button (scroll wheel click)
            window.middleMouseDown = true;
        }
    });
    
    document.addEventListener('mouseup', (event) => {
        if (event.button === 2) { // Right mouse button
            window.rightMouseDown = false;
        } else if (event.button === 1) { // Middle mouse button
            window.middleMouseDown = false;
        }
    });
    
    // Prevent context menu from appearing on right-click
    document.addEventListener('contextmenu', (event) => {
        event.preventDefault();
    });

    // Add mouse movement tracking with sensitivity adjustment and fix inversion
    document.addEventListener('mousemove', (event) => {
        if (document.pointerLockElement) {
            // Apply sensitivity adjustment to mouse movements
            const sensitivity = window.mouseSensitivity.current;
            
            if (window.isFirstPerson && !window.isFreeCameraMode) {
                // First-person: Standard FPS mouse look - rotate with mouse movement
                // Store movement for server synchronization
                window.inputState.mouseDelta.x += event.movementX * sensitivity;
                window.inputState.mouseDelta.y -= event.movementY * sensitivity;
                
                // Apply rotation locally for immediate response
                const rotationX = event.movementY * 0.002 * sensitivity; // Vertical rotation (pitch)
                const rotationY = event.movementX * 0.002 * sensitivity; // Horizontal rotation (yaw)
                
                // Update local camera rotation immediately
                if (window.camera) {
                    // Update the camera's pitch (looking up/down)
                    window.firstPersonCameraPitch = window.firstPersonCameraPitch || 0;
                    window.firstPersonCameraPitch -= rotationX;
                    
                    // Clamp the pitch to prevent looking too far up or down
                    window.firstPersonCameraPitch = THREE.MathUtils.clamp(
                        window.firstPersonCameraPitch,
                        -Math.PI/2 + 0.1,  // Slightly less than straight down
                        Math.PI/2 - 0.1    // Slightly less than straight up
                    );
                    
                    // Update the player's rotation around Y axis
                    window.playerRotationY = window.playerRotationY || 0;
                    window.playerRotationY -= rotationY;
                    
                    // Apply the rotations to the camera
                    window.camera.quaternion.setFromEuler(new THREE.Euler(
                        window.firstPersonCameraPitch,
                        window.playerRotationY,
                        0,
                        'YXZ'  // Important for proper FPS controls
                    ));
                    
                    // Also update player mesh rotation immediately for seamless transition to third-person
                    if (window.playerEntity && window.playerEntity.mesh) {
                        window.playerEntity.mesh.rotation.y = window.playerRotationY;
                    }
                }
            } else if (!window.isFirstPerson && !window.isFreeCameraMode) {
                // Third-person: Only rotate camera when right mouse button is held (classic behavior)
                if (window.rightMouseDown || window.middleMouseDown) {
                    // X movement orbits camera horizontally around player
                    window.thirdPersonCameraOrbitX += event.movementX * window.thirdPersonCameraOrbitSpeed;
                    
                    // Y movement changes camera height/angle (with limits to prevent flipping)
                    window.thirdPersonCameraOrbitY -= event.movementY * window.thirdPersonCameraOrbitSpeed;
                    window.thirdPersonCameraOrbitY = THREE.MathUtils.clamp(
                        window.thirdPersonCameraOrbitY,
                        window.thirdPersonCameraMinY,
                        window.thirdPersonCameraMaxY
                    );
                }
            } else if (window.isFreeCameraMode) {
                // Free camera mode: Standard FPS-style look with mouse
                window.freeCameraYaw -= event.movementX * window.freeCameraRotationSpeed;
                window.freeCameraPitch -= event.movementY * window.freeCameraRotationSpeed;
                
                // Limit pitch to avoid flipping
                window.freeCameraPitch = THREE.MathUtils.clamp(
                    window.freeCameraPitch,
                    -Math.PI / 2 + 0.1,  // Avoid looking straight down
                    Math.PI / 2 - 0.1    // Avoid looking straight up
                );
                
                // Apply rotation to camera using quaternions for proper rotation
                window.camera.quaternion.setFromEuler(new THREE.Euler(
                    window.freeCameraPitch,
                    window.freeCameraYaw,
                    0,
                    'YXZ'  // Important for proper FPS controls
                ));
            }
        }
    });
    
    // Add mouse wheel zoom for third-person view
    document.addEventListener('wheel', (event) => {
        // Only handle zoom in third-person mode and not affect the server state
        if (!window.isFirstPerson) {
            // Normalize wheel delta across browsers (positive = zoom in, negative = zoom out)
            const zoomAmount = -Math.sign(event.deltaY) * window.thirdPersonCameraZoomSpeed;
            
            // Apply zoom to the camera distance
            window.thirdPersonCameraDistance = THREE.MathUtils.clamp(
                window.thirdPersonCameraDistance - zoomAmount,
                window.thirdPersonCameraMinDistance,
                window.thirdPersonCameraMaxDistance
            );
            
            console.log(`Third-person camera zoom: ${window.thirdPersonCameraDistance.toFixed(1)}`);
        }
    });

    return controls;
}

// Update mouse sensitivity based on current view mode
function updateMouseSensitivity() {
    if (window.viewMode === 'firstPerson') {
        window.mouseSensitivity.current = window.mouseSensitivity.firstPerson;
    } else if (window.viewMode === 'thirdPerson') {
        window.mouseSensitivity.current = window.mouseSensitivity.thirdPerson;
    } else if (window.viewMode === 'freeCamera') {
        window.mouseSensitivity.current = window.mouseSensitivity.freeCamera;
    } else if (window.viewMode === 'rtsView') {
        window.mouseSensitivity.current = window.mouseSensitivity.rtsView;
    }
    console.log(`Updated mouse sensitivity to ${window.mouseSensitivity.current} (${window.viewMode} mode)`);
}

// Function to get the forward direction based on camera orientation in third-person mode
window.getThirdPersonForwardDirection = function() {
    const angle = window.thirdPersonCameraOrbitX;
    return new THREE.Vector3(-Math.sin(angle), 0, -Math.cos(angle));
}

// Key down event handler
function onKeyDown(event) {
    // Skip if we're in an input field or textarea
    if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
        return;
    }
    
    // Map key code to action
    switch (event.code) {
        case 'ArrowUp':
        case 'KeyW':
            window.moveForward = true;
            window.inputState.keys.w = true;
            break;
            
        case 'ArrowLeft':
        case 'KeyA':
            window.moveLeft = true;
            window.inputState.keys.a = true;
            break;
            
        case 'ArrowDown':
        case 'KeyS':
            window.moveBackward = true;
            window.inputState.keys.s = true;
            break;
            
        case 'ArrowRight':
        case 'KeyD':
            window.moveRight = true;
            window.inputState.keys.d = true;
            break;
            
        case 'KeyQ':
            window.turnLeft = true;
            window.inputState.keys.q = true;
            break;
            
        case 'KeyE':
            window.turnRight = true;
            window.inputState.keys.e = true;
            break;
            
        case 'Space':
            window.canJump = false; // Reset jump ability until ground collision
            window.inputState.keys.space = true;
            // Client-side jump for prediction - server will override with authority
            if (window.velocity) {
                window.velocity.y = Math.sqrt(window.jumpHeight * 2 * 9.8);
            }
            break;

        case 'KeyV':
            window.toggleCameraView(); // Call the global toggleCameraView function
            break;
        case 'ShiftLeft':
        case 'ShiftRight':
            window.shiftPressed = true;
            window.inputState.keys.shift = true;
            break;
    }
    
    // Force an immediate input update to minimize latency
    if (window.sendInputUpdate && 
        (event.code === 'KeyW' || event.code === 'KeyA' || 
         event.code === 'KeyS' || event.code === 'KeyD' || 
         event.code === 'KeyQ' || event.code === 'KeyE' || 
         event.code === 'Space')) {
        window.sendInputUpdate();
    }
}

// Key up event handler
function onKeyUp(event) {
    switch (event.code) {
        case 'ArrowUp':
        case 'KeyW':
            window.moveForward = false;
            window.inputState.keys.w = false;
            break;
            
        case 'ArrowLeft':
        case 'KeyA':
            window.moveLeft = false;
            window.inputState.keys.a = false;
            break;
            
        case 'ArrowDown':
        case 'KeyS':
            window.moveBackward = false;
            window.inputState.keys.s = false;
            break;
            
        case 'ArrowRight':
        case 'KeyD':
            window.moveRight = false;
            window.inputState.keys.d = false;
            break;
            
        case 'KeyQ':
            window.turnLeft = false;
            window.inputState.keys.q = false;
            break;
            
        case 'KeyE':
            window.turnRight = false;
            window.inputState.keys.e = false;
            break;
            
        case 'Space':
            window.inputState.keys.space = false;
            break;
        case 'ShiftLeft':
        case 'ShiftRight':
            window.shiftPressed = false;
            window.inputState.keys.shift = false;
            break;
    }
    
    // Force an immediate input update to minimize latency
    if (window.sendInputUpdate && 
        (event.code === 'KeyW' || event.code === 'KeyA' || 
         event.code === 'KeyS' || event.code === 'KeyD' || 
         event.code === 'KeyQ' || event.code === 'KeyE' || 
         event.code === 'Space')) {
        window.sendInputUpdate();
    }
}

// Update controls - call this in the animation loop
window.updateControls = function(controls, delta) {
    // Special handling for RTS mode - don't require pointer lock
    if (window.isRTSMode) {
        updateRTSCameraMovement(delta);
        return;
    }

    // For other modes, require pointer lock
    if (!controls.isLocked) return;
    
    // If we're in free camera mode, handle movement without updating the server
    if (window.isFreeCameraMode) {
        updateFreeCameraMovement(delta);
        return;
    }

    // Only perform client-side movement prediction 
    // Actual position updates will be driven by the server
    
    // Handle directional movement - scaled by delta for consistent speed
    if (window.moveForward) controls.moveForward(window.moveSpeed * delta);
    if (window.moveBackward) controls.moveForward(-window.moveSpeed * delta);
    if (window.moveLeft) controls.moveRight(-window.moveSpeed * delta);
    if (window.moveRight) controls.moveRight(window.moveSpeed * delta);
    
    // Handle Q/E keys for diagonal movement (forward + turning)
    if (window.turnLeft) {
        // Move diagonally forward-left
        const diagonalSpeed = window.moveSpeed * 0.7 * delta; // Scale down for diagonal
        controls.moveForward(diagonalSpeed);
        controls.moveRight(-diagonalSpeed);
    }
    if (window.turnRight) {
        // Move diagonally forward-right
        const diagonalSpeed = window.moveSpeed * 0.7 * delta; // Scale down for diagonal
        controls.moveForward(diagonalSpeed);
        controls.moveRight(diagonalSpeed);
    }

    // Apply gravity
    window.velocity.y -= 9.8 * delta;
    controls.getObject().position.y += window.velocity.y * delta;

    // Ground collision
    if (controls.getObject().position.y < window.playerHeight) {
        window.velocity.y = 0;
        controls.getObject().position.y = window.playerHeight;
        window.canJump = true;
    }
}

// Handle free camera movement independent of player
function updateFreeCameraMovement(delta) {
    // Calculate movement speed with delta time for consistent speed
    const moveSpeed = window.freeCameraSpeed * delta * 60; // Base speed adjusted for frame rate
    
    // Create movement vectors using quaternion-based direction
    // This ensures movement always follows the camera's view direction
    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(window.camera.quaternion).normalize();
    const right = new THREE.Vector3(1, 0, 0).applyQuaternion(window.camera.quaternion).normalize();
    
    // Remove any Y component to keep movement horizontal (along XZ plane) for WASD
    forward.y = 0;
    forward.normalize();
    right.y = 0;
    right.normalize();
    
    // Apply movement based on keys
    if (window.moveForward) {
        window.camera.position.addScaledVector(forward, moveSpeed);
    }
    if (window.moveBackward) {
        window.camera.position.addScaledVector(forward, -moveSpeed);
    }
    if (window.moveLeft) {
        window.camera.position.addScaledVector(right, -moveSpeed);
    }
    if (window.moveRight) {
        window.camera.position.addScaledVector(right, moveSpeed);
    }
    
    // Handle vertical movement (space and shift)
    const up = new THREE.Vector3(0, 1, 0);
    if (window.inputState.keys.space) {
        window.camera.position.addScaledVector(up, moveSpeed);
    }
    if (window.shiftPressed) { 
        window.camera.position.addScaledVector(up, -moveSpeed);
    }
}

// Handle RTS camera movement (WASD for panning, Q/E for zoom)
function updateRTSCameraMovement(delta) {
    if (!window.isRTSMode) return;
    
    // In RTS view, we directly manipulate the camera position
    // Use a slightly higher multiplier for consistent speed with delta adjustment
    const panSpeed = window.rtsCameraPanSpeed * delta * 60; // Adjusted calculation with lower base panSpeed
    
    // Apply camera movements based on WASD keys
    if (window.inputState.keys.w) {
        window.camera.position.z -= panSpeed;
    }
    if (window.inputState.keys.s) {
        window.camera.position.z += panSpeed;
    }
    if (window.inputState.keys.a) {
        window.camera.position.x -= panSpeed;
    }
    if (window.inputState.keys.d) {
        window.camera.position.x += panSpeed;
    }
    
    // Handle zoom with Q/E keys (changes camera height)
    const zoomSpeed = window.rtsCameraZoomSpeed * delta;
    
    if (window.inputState.keys.q) { // Q key - zoom in (lower height)
        window.rtsCameraHeight = Math.max(
            window.rtsCameraMinHeight, 
            window.rtsCameraHeight - zoomSpeed
        );
        window.camera.position.y = window.rtsCameraHeight;
    }
    if (window.inputState.keys.e) { // E key - zoom out (increase height)
        window.rtsCameraHeight = Math.min(
            window.rtsCameraMaxHeight, 
            window.rtsCameraHeight + zoomSpeed
        );
        window.camera.position.y = window.rtsCameraHeight;
    }
    
    // Ensure camera always looks straight down
    window.camera.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2, 0, 0, 'YXZ'));
}

// Function to toggle between camera views
window.toggleCameraView = function() {
    if (window.viewMode === 'firstPerson') {
        window.viewMode = 'thirdPerson';
        window.isFirstPerson = false;
        window.isFreeCameraMode = false;
        window.isRTSMode = false;
        if (typeof window.switchToThirdPersonView === 'function') {
            window.switchToThirdPersonView();
        }
        console.log("[DEBUG] Switched to third-person view");
    } else if (window.viewMode === 'thirdPerson') {
        window.viewMode = 'freeCamera';
        window.isFirstPerson = false;
        window.isFreeCameraMode = true;
        window.isRTSMode = false;
        // Save player position for free camera starting point
        if (window.playerEntity && window.playerEntity.mesh) {
            const pos = window.playerEntity.mesh.position.clone();
            pos.y += 3; // Start slightly above the player
            window.camera.position.copy(pos);
        }
        if (typeof window.switchToFreeCameraView === 'function') {
            window.switchToFreeCameraView();
        }
        console.log("[DEBUG] Switched to free camera view");
    } else if (window.viewMode === 'freeCamera') {
        window.viewMode = 'rtsView';
        window.isFirstPerson = false;
        window.isFreeCameraMode = false;
        window.isRTSMode = true;
        if (typeof window.switchToRTSView === 'function') {
            window.switchToRTSView();
        }
        console.log("[DEBUG] Switched to RTS view");
    } else {
        window.viewMode = 'firstPerson';
        window.isFirstPerson = true;
        window.isFreeCameraMode = false;
        window.isRTSMode = false;
        if (typeof window.switchToFirstPersonView === 'function') {
            window.switchToFirstPersonView();
        }
        console.log("[DEBUG] Switched back to first-person view");
    }
    
    // Update mouse sensitivity for the new view mode
    updateMouseSensitivity();
    
    // Update UI for new view mode
    updateViewModeUI();
    
    // Update view toggle button with current mode
    const viewToggleBtn = document.getElementById('view-toggle');
    if (viewToggleBtn) {
        if (window.viewMode === 'firstPerson') {
            viewToggleBtn.textContent = 'First-Person View';
        } else if (window.viewMode === 'thirdPerson') {
            viewToggleBtn.textContent = 'Third-Person View';
        } else if (window.viewMode === 'freeCamera') {
            viewToggleBtn.textContent = 'Free Camera View';
        } else {
            viewToggleBtn.textContent = 'RTS View';
        }
    }
    
    // Return to prevent recursion
    return window.viewMode;
};

// Function to update the UI based on view mode
function updateViewModeUI() {
    // Do NOT show click instructions/overlay when switching views
    const instructions = document.getElementById('lock-instructions');
    if (instructions) {
        instructions.style.display = 'none';
    }
}
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\Entity.js 
===================================================== 
 
// 3D AI Game Platform - Base Entity class for all game entities

class Entity {
    constructor({id, name, value, color, x, y, z, rotationY, type}) {
        this.id = id;
        this.name = name || id;
        this.value = value || 1;
        this.color = color; 
        this.type = type; // Type of visual representation
        this.x = x || 0;
        this.y = y || 1;
        this.z = z || 0;
        this.rotationY = rotationY || 0;
        
        // Create the mesh - this should be implemented by subclasses
        this.mesh = this.createMesh();
        if (this.mesh) {
            this.mesh.position.set(this.x, this.y, this.z);
            this.mesh.rotation.y = this.rotationY;
            
            // Store a reference to this entity in the mesh's userData
            this.mesh.userData.entity = this;
        }
    }

    // Create the visual representation (mesh) for this entity
    // This is a base method that should be overridden by implementation-specific subclasses
    createMesh() {
        console.warn("createMesh() method not implemented in Entity base class");
        return null;
    }

    // Update the entity's position and rotation
    updatePosition(pos) {
        if (!pos) {
            console.warn("updatePosition called with undefined position!");
            return;
        }
    
        const { x, y, z, rotationY } = pos;
    
        if (x !== undefined) {
            this.x = x;
            this.mesh.position.x = x;
        }
        if (y !== undefined) {
            this.y = y;
            this.mesh.position.y = y;
        }
        if (z !== undefined) {
            this.z = z;
            this.mesh.position.z = z;
        }
        if (rotationY !== undefined) {
            this.rotationY = rotationY;
            this.mesh.rotation.y = rotationY;
        }
    }
    
    // Update the entity's value
    // This is a base method that implementations can override
    updateValue(newValue) {
        if (this.value === newValue) return;
        this.value = newValue;
    }

    // Update the entity's color
    // This is a base method that implementations can override
    updateColor(newColor) {
        this.color = newColor;
    }

    // Generic update method called once per frame
    // This should be overridden by subclasses that need frame-by-frame updates
    update(deltaTime) {
        // Base implementation does nothing
    }

    // Remove entity from scene when destroyed
    destroy() {
        if (this.mesh && this.mesh.parent) {
            this.mesh.parent.remove(this.mesh);
        }
    }
}

// Export the Entity class
if (typeof window !== 'undefined') {
    window.Entity = Entity;
}

if (typeof module !== 'undefined') {
    module.exports = { Entity };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\EntityFactory.js 
===================================================== 
 
// 3D AI Game Platform - Entity Factory for creating game entities

class EntityFactory {
    constructor() {
        // Registry for entity types and their constructors
        this.registry = {
            // Base types
            entity: Entity,
            player: Player,
            npc: NPC
        };
        
        // Implementation-specific registry - will be populated by implementations
        this.implementationRegistry = {};
    }
    
    // Register a new entity type
    registerType(type, constructor) {
        if (this.registry[type] || this.implementationRegistry[type]) {
            console.warn(`Entity type '${type}' is already registered. Overwriting.`);
        }
        
        // Determine if this is a core type or implementation-specific
        if (constructor.prototype instanceof Entity ||
            constructor === Entity ||
            constructor.prototype instanceof Player ||
            constructor === Player ||
            constructor.prototype instanceof NPC ||
            constructor === NPC) {
            this.registry[type] = constructor;
        } else {
            this.implementationRegistry[type] = constructor;
        }
    }
    
    // Register implementation-specific entity types
    registerImplementation(implementationName, entityTypes) {
        for (const [type, constructor] of Object.entries(entityTypes)) {
            const fullType = `${implementationName}.${type}`;
            this.registerType(fullType, constructor);
        }
    }
    
    // Create an entity based on type and parameters
    createEntity(type, params) {
        // Check if this is an implementation-specific type
        if (type.includes('.')) {
            const [implementationName, specificType] = type.split('.');
            const constructor = this.implementationRegistry[type];
            
            if (constructor) {
                return new constructor(params);
            } else {
                console.error(`Implementation-specific entity type '${type}' not found.`);
                return null;
            }
        }
        
        // Check core registry
        const Constructor = this.registry[type];
        if (Constructor) {
            return new Constructor(params);
        }
        
        // If no match found, log error and return null
        console.error(`Entity type '${type}' not found in registry.`);
        return null;
    }
    
    // Create a player entity
    createPlayer(params) {
        const type = params.type || 'player';
        params.isPlayer = true;
        
        return this.createEntity(type, params);
    }
    
    // Create an NPC entity
    createNPC(params) {
        const type = params.type || 'npc';
        
        return this.createEntity(type, params);
    }
}

// Create and export a singleton instance
const entityFactory = new EntityFactory();

// Export for use in other modules
if (typeof window !== 'undefined') {
    window.EntityFactory = EntityFactory;
    window.entityFactory = entityFactory;
}

if (typeof module !== 'undefined') {
    module.exports = { EntityFactory, entityFactory };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\game-engine.js 
===================================================== 
 
// 3D Game Platform - Game Engine
// Handles 3D scene, rendering, game loop, and core gameplay

// Debug support
const DEBUG = false; // Set to false to disable debug messages

function debug(message, isError = false) {
    if (!DEBUG) return;
    
    // Log to console only when debug is enabled
    if (isError) {
        console.error(`[ERROR] ${message}`);
    } else {
        console.log(`[DEBUG] ${message}`);
    }
}

// Game variables
let scene, camera, renderer, controls;
let player;  // Player object
let playerValue = 1;

// Add operator tracking without redeclaring variables
let heldOperator = null;
let lastOperatorSpawn = 0;

// Rotation variables for Q/E keys
let rotationQuaternion = new THREE.Quaternion();
let worldUp = new THREE.Vector3(0, 1, 0);
let rotationAxis = new THREE.Vector3();

// Global view mode tracking
window.isFirstPerson = true;  // Start in first-person view
window.isFreeCameraMode = false; // Not in free camera mode initially
window.playerPosition = null; // Store player position for returning from free camera mode

// HUD elements
const gameHUD = document.getElementById('game-hud');

// Global variables and UI elements
let viewToggleBtn = null; // Global reference for the view toggle button

// Initialize networking variables
let lastSentPosition = new THREE.Vector3();
let lastSentRotation = 0;
let positionUpdateInterval = 100; // ms between position updates
let lastPositionUpdate = 0;
let inputUpdateInterval = 1000 / 30; // 30Hz input updates
let lastInputUpdate = 0;

// Add variables for input throttling
window.inputThrottleMs = 16; // Send inputs roughly every frame (60fps = 16.67ms)
window.lastInputTime = 0;

// Array to store animation callbacks
window.animationCallbacks = [];

// Function to register callbacks to be executed during the animation loop
window.registerAnimationCallback = function(callback) {
    if (typeof callback === 'function' && !window.animationCallbacks.includes(callback)) {
        window.animationCallbacks.push(callback);
        console.log("Registered animation callback:", callback.name || "anonymous");
        return true;
    }
    return false;
};

// Function to unregister a callback from the animation loop
window.unregisterAnimationCallback = function(callback) {
    const index = window.animationCallbacks.indexOf(callback);
    if (index !== -1) {
        window.animationCallbacks.splice(index, 1);
        console.log("Unregistered animation callback:", callback.name || "anonymous");
        return true;
    }
    return false;
};

// Initialize physics variables and flags
function initPhysics() {
    try {
        debug('Initializing physics');
        
        // Basic physics setup
        window.velocity = new THREE.Vector3(0, 0, 0);
        window.direction = new THREE.Vector3(0, 0, 0);
        window.canJump = false;
        
        // Setup movement flags
        window.moveForward = false;
        window.moveBackward = false;
        window.moveLeft = false;
        window.moveRight = false;
        window.turnLeft = false;
        window.turnRight = false;
        
        // Setup rotation utilities
        window.worldUp = new THREE.Vector3(0, 1, 0);
        window.rotationAxis = new THREE.Vector3();
        window.rotationQuaternion = new THREE.Quaternion();
        
        debug('Physics initialized successfully');
    } catch (error) {
        debug(`Error initializing physics: ${error.message}`, true);
    }
}

// Initialize the floor
function initFloor() {
    try {
        debug('Creating floor');
        
        // Create a larger green floor with darker color
        const floorGeometry = new THREE.PlaneGeometry(100, 100);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x114411,
            roughness: 0.8, 
            metalness: 0.2 
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        
        // Rotate and position the floor
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = 0;
        floor.receiveShadow = true;
        scene.add(floor);
        
        // Add a grid helper for visual reference
        const gridHelper = new THREE.GridHelper(100, 100, 0x000000, 0x444444);
        scene.add(gridHelper);
        
        debug('Floor created successfully');
    } catch (error) {
        debug(`Error creating floor: ${error.message}`, true);
    }
}

// Initialize the game
window.onload = function() {
    debug('Window loaded, initializing game...');
    
    // Add view toggle button
    addViewToggleButton();
    
    // Create a dummy OperatorManager if not defined (for default implementation)
    if (typeof OperatorManager === 'undefined') {
        window.OperatorManager = class OperatorManager {
            constructor() {
                this.operators = {};
            }
            
            createOperator() { return null; }
            updateOperator() {}
            removeOperator() {}
            createOperatorFromServer() { return { group: new THREE.Group() }; }
            updateOperatorFromServer() {}
            removeOperatorByServerId() {}
        };
    }
    
    // Initialize with window.viewMode and window.isFirstPerson set to first-person
    window.viewMode = 'firstPerson';
    window.isFirstPerson = true;
    window.isFreeCameraMode = false;
    window.playerLoaded = false; // Track if player has been created
    
    // Note: The 'v' keypress listener has been removed as it's handled in controls.js
    
    init();
};

// Add view toggle button to switch between first and third person
function addViewToggleButton() {
    try {
        // Create button if it doesn't exist
        viewToggleBtn = document.getElementById('view-toggle');
        
        if (!viewToggleBtn) {
            viewToggleBtn = document.createElement('button');
            viewToggleBtn.id = 'view-toggle';
            viewToggleBtn.textContent = 'First-Person View';  // Default view mode
            viewToggleBtn.style.position = 'absolute';
            viewToggleBtn.style.bottom = '20px';
            viewToggleBtn.style.right = '20px';
            viewToggleBtn.style.zIndex = '100';
            viewToggleBtn.style.padding = '8px 12px';
            viewToggleBtn.style.backgroundColor = 'rgba(0,0,0,0.6)';
            viewToggleBtn.style.color = 'white';
            viewToggleBtn.style.border = 'none';
            viewToggleBtn.style.borderRadius = '4px';
            viewToggleBtn.style.cursor = 'pointer';
            document.body.appendChild(viewToggleBtn);
        }
        
        // Add click event listener to use the function from controls.js
        viewToggleBtn.addEventListener('click', window.toggleCameraView);
        
        debug('View toggle button added');
    } catch (error) {
        debug(`Error adding view toggle button: ${error.message}`, true);
    }
}

// Toggle between first-person, third-person and free camera view functions have been moved to controls.js

// First-person setup
window.switchToFirstPersonView = function() {
    // Hide player's mesh in first-person
    if (window.playerEntity && window.playerEntity.mesh) {
        window.playerEntity.mesh.visible = false;
    }
    
    // Hide selection rings in first-person view
    if (window.rtsSelectionRings) {
        window.rtsSelectionRings.forEach(ring => {
            if (ring) ring.visible = false;
        });
    }
    
    // Reset free camera variables
    window.freeCameraYaw = 0;
    window.freeCameraPitch = 0;
    
    // Hide RTS cursor when switching to first-person view
    if (document.getElementById('rts-cursor')) {
        document.getElementById('rts-cursor').style.display = 'none';
    }
    
    // Reset cursor styles that might have been set in RTS mode
    document.body.style.cursor = 'default';
    document.documentElement.style.cursor = 'default';
    renderer.domElement.style.cursor = 'default';
    
    // Then relock pointer for first-person view
    if (controls && !controls.isLocked) {
        controls.lock();
    }
    
    // Set camera position based on the available player information
    // Try multiple sources to ensure we always have a position
    let playerX = 0, playerY = 0, playerZ = 0, rotationY = 0, pitch = 0;
    
    // First check server state if available
    if (window.room && window.room.state && window.room.state.players) {
        const playerState = window.room.state.players.get(window.room.sessionId);
        if (playerState) {
            playerX = playerState.x;
            playerY = playerState.y;
            playerZ = playerState.z;
            rotationY = playerState.rotationY || 0;
            pitch = playerState.pitch || 0;
        }
    }
    // Fallback to local player object if server state not available
    else if (window.playerEntity && window.playerEntity.mesh) {
        playerX = window.playerEntity.mesh.position.x;
        playerY = window.playerEntity.mesh.position.y;
        playerZ = window.playerEntity.mesh.position.z;
        rotationY = window.playerEntity.mesh.rotation.y || 0;
    }
    
    // Position camera at player's head
    if (window.camera) {
        window.camera.position.set(
            playerX,
            playerY + (window.playerHeight || 2.0),
            playerZ
        );
        
        // Set camera rotation using quaternions to prevent gimbal lock
        window.camera.quaternion.setFromEuler(new THREE.Euler(
            pitch,
            rotationY + Math.PI,
            0,
            'YXZ'  // Important for proper FPS controls
        ));
        
        // Update controls position if available
        if (controls) {
            controls.getObject().position.copy(window.camera.position);
        }
        
        // Force an immediate render to show the new view
        if (window.renderer && window.scene) {
            window.renderer.render(window.scene, window.camera);
        }
    }
    
    // If we were in free camera mode, tell the server we're back
    if (window.isFreeCameraMode) {
        window.isFreeCameraMode = false;
        if (window.sendInputUpdate) {
            window.sendInputUpdate();
        }
    }
    
    console.log("Switched to first-person view. Camera at:", window.camera.position);
};

// Third-person setup
window.switchToThirdPersonView = function() {
    // Show player's mesh in third-person
    if (window.playerEntity && window.playerEntity.mesh) {
        window.playerEntity.mesh.visible = true;
    }
    
    // Hide selection rings in third-person view
    if (window.rtsSelectionRings) {
        window.rtsSelectionRings.forEach(ring => {
            if (ring) ring.visible = false;
        });
    }
    
    // Hide RTS cursor when switching to third-person view
    if (document.getElementById('rts-cursor')) {
        document.getElementById('rts-cursor').style.display = 'none';
    }
    
    // Reset cursor styles that might have been set in RTS mode
    document.body.style.cursor = 'default';
    document.documentElement.style.cursor = 'default';
    renderer.domElement.style.cursor = 'default';
    
    // Relock pointer for third-person view
    if (controls && !controls.isLocked) {
        controls.lock();
    }
    
    // Reset orbit angles if they don't exist
    window.thirdPersonCameraOrbitX = window.thirdPersonCameraOrbitX || 0;
    window.thirdPersonCameraOrbitY = window.thirdPersonCameraOrbitY || 0.5;
    
    // Make sure player state exists
    if (window.room && window.room.state && window.room.state.players) {
        const playerState = window.room.state.players.get(window.room.sessionId);
        if (playerState) {
            // Position camera based on player's current position/rotation
            const offsetX = window.thirdPersonCameraDistance * Math.sin(playerState.rotationY) * Math.cos(window.thirdPersonCameraOrbitY);
            const offsetZ = window.thirdPersonCameraDistance * Math.cos(playerState.rotationY) * Math.cos(window.thirdPersonCameraOrbitY);
            const offsetY = window.thirdPersonCameraDistance * Math.sin(window.thirdPersonCameraOrbitY);
            
            // Immediately position camera with offset for immediate visual feedback
            window.camera.position.set(
                playerState.x + offsetX,
                playerState.y + window.thirdPersonCameraHeight + offsetY,
                playerState.z + offsetZ
            );
            
            // Set camera to look at player
            const lookTarget = new THREE.Vector3(
                playerState.x, 
                playerState.y + window.thirdPersonCameraHeight * 0.8, // Look at upper body
                playerState.z
            );
            
            // Create look direction and rotation
            const direction = new THREE.Vector3().subVectors(lookTarget, window.camera.position).normalize();
            const quaternion = new THREE.Quaternion().setFromUnitVectors(
                new THREE.Vector3(0, 0, -1),
                direction
            );
            
            // Apply rotation to camera immediately
            window.camera.quaternion.copy(quaternion);
            
            // Force an immediate render to update the view
            if (window.renderer && window.scene) {
                window.renderer.render(window.scene, window.camera);
            }
        }
    }
    
    console.log("Switched to third-person view. Camera at:", window.camera.position);
};

// Free camera setup
window.switchToFreeCameraView = function() {
    // Store current camera position for when we return
    window.playerPosition = camera.position.clone();
    window.isFreeCameraMode = true;
    
    // Show player mesh since we're viewing from outside
    if (window.playerEntity && window.playerEntity.mesh) {
        window.playerEntity.mesh.visible = true;
    }
    
    // Hide selection rings in free camera view
    if (window.rtsSelectionRings) {
        window.rtsSelectionRings.forEach(ring => {
            if (ring) ring.visible = false;
        });
    }
    
    // Hide RTS cursor when switching to free camera view
    if (document.getElementById('rts-cursor')) {
        document.getElementById('rts-cursor').style.display = 'none';
    }
    
    // Reset cursor styles that might have been set in RTS mode
    document.body.style.cursor = 'default';
    document.documentElement.style.cursor = 'default';
    renderer.domElement.style.cursor = 'default';
    
    // Relock pointer for free camera view
    if (controls && !controls.isLocked) {
        controls.lock();
    }
    
    // Keep pointer lock active but disable normal controls
    controls.enabled = false;
    
    // Initialize free camera movement speed
    window.freeCameraSpeed = 0.5;
    
    console.log("Switched to free camera view");
};

// RTS view setup
window.switchToRTSView = function() {
    // Show player mesh since we're viewing from above
    if (window.playerEntity && window.playerEntity.mesh) {
        window.playerEntity.mesh.visible = true;
    }
    
    // Show selection rings in RTS view if there are selected units
    if (window.rtsSelectionRings) {
        window.rtsSelectionRings.forEach(ring => {
            if (ring) ring.visible = true;
        });
    }
    
    // For RTS view, we need to see the cursor and keep it unlocked
    if (controls && controls.isLocked) {
        controls.unlock();
    }
    controls.enabled = false;
    
    // Set a timeout to ensure we stay unlocked if the browser is slow to respond
    setTimeout(() => {
        // Double check that we're still in RTS mode
        if (window.isRTSMode && controls && controls.isLocked) {
            controls.unlock();
        }
    }, 100);
    
    // Initialize RTS selection box variables
    window.rtsSelectionBoxActive = false;
    window.rtsSelectionStartX = 0;
    window.rtsSelectionStartY = 0;
    window.rtsSelectionEndX = 0;
    window.rtsSelectionEndY = 0;
    
    // Create selection box element if it doesn't exist
    if (!document.getElementById('rts-selection-box')) {
        const selectionBox = document.createElement('div');
        selectionBox.id = 'rts-selection-box';
        selectionBox.style.position = 'fixed';
        selectionBox.style.border = '2px solid #00ff00';
        selectionBox.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
        selectionBox.style.pointerEvents = 'none';
        selectionBox.style.display = 'none';
        selectionBox.style.zIndex = '9998'; // Just below cursor
        document.body.appendChild(selectionBox);
    }
    
    // Add specific RTS mode keyboard listener
    if (!window.rtsKeyboardListenerAdded) {
        document.addEventListener('keydown', function rtsKeyboardHandler(event) {
            if (!window.isRTSMode) return;
            
            // Log key presses in RTS mode for debugging
            console.log("RTS Mode Key Pressed:", event.code);
            
            switch (event.code) {
                case 'KeyW':
                    window.inputState.keys.w = true;
                    console.log("W key pressed in RTS mode");
                    break;
                case 'KeyA':
                    window.inputState.keys.a = true;
                    console.log("A key pressed in RTS mode");
                    break;
                case 'KeyS':
                    window.inputState.keys.s = true;
                    console.log("S key pressed in RTS mode");
                    break;
                case 'KeyD':
                    window.inputState.keys.d = true;
                    console.log("D key pressed in RTS mode");
                    break;
                case 'KeyQ':
                    window.inputState.keys.q = true;
                    console.log("Q key pressed in RTS mode");
                    break;
                case 'KeyE':
                    window.inputState.keys.e = true;
                    console.log("E key pressed in RTS mode");
                    break;
            }
        });
        
        document.addEventListener('keyup', function rtsKeyboardHandler(event) {
            if (!window.isRTSMode) return;
            
            switch (event.code) {
                case 'KeyW':
                    window.inputState.keys.w = false;
                    break;
                case 'KeyA':
                    window.inputState.keys.a = false;
                    break;
                case 'KeyS':
                    window.inputState.keys.s = false;
                    break;
                case 'KeyD':
                    window.inputState.keys.d = false;
                    break;
                case 'KeyQ':
                    window.inputState.keys.q = false;
                    break;
                case 'KeyE':
                    window.inputState.keys.e = false;
                    break;
            }
        });
        
        window.rtsKeyboardListenerAdded = true;
    }
    
    // Set initial camera position - start above the player
    let playerX = 0, playerZ = 0;
    
    // Try to get player position from server or local object
    if (window.room && window.room.state && window.room.state.players) {
        const playerState = window.room.state.players.get(window.room.sessionId);
        if (playerState) {
            playerX = playerState.x;
            playerZ = playerState.z;
        }
    }
    // Fallback to local player object
    else if (window.playerEntity && window.playerEntity.mesh) {
        playerX = window.playerEntity.mesh.position.x;
        playerZ = window.playerEntity.mesh.position.z;
    }
    
    // Position camera above player
    window.camera.position.set(playerX, window.rtsCameraHeight, playerZ);
    
    // Set camera to look straight down
    window.camera.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2, 0, 0, 'YXZ'));
    
    // Force an immediate render to update the view
    if (window.renderer && window.scene) {
        window.renderer.render(window.scene, window.camera);
    }
    
    // Add RTS cursor unless it already exists
    if (!document.getElementById('rts-cursor')) {
        createRTSCursor();
    }
    
    // Show our custom RTS cursor and hide system cursor
    const rtsCursor = document.getElementById('rts-cursor');
    rtsCursor.style.display = 'block';
    rtsCursor.style.transform = 'translate(-50%, -50%)';
    
    // Get current mouse position from system
    const mouseX = window.lastMouseX || window.innerWidth / 2;
    const mouseY = window.lastMouseY || window.innerHeight / 2;
    
    // Position cursor at current mouse position
    rtsCursor.style.left = mouseX + 'px';
    rtsCursor.style.top = mouseY + 'px';
    
    // Apply cursor hiding to all relevant elements
    document.body.style.cursor = 'none';
    document.documentElement.style.cursor = 'none';
    renderer.domElement.style.cursor = 'none';
    
    // Hide pointer lock instructions if they're visible
    const instructions = document.getElementById('lock-instructions');
    if (instructions) {
        instructions.style.display = 'none';
    }
    
    console.log("Switched to RTS view");
};

// Handle mouse movement for free camera
function onMouseMove(event) {
    // In RTS mode, handle selection box if active
    if (window.isRTSMode) {
        if (window.rtsSelectionBoxActive) {
            window.rtsSelectionEndX = event.clientX;
            window.rtsSelectionEndY = event.clientY;
            updateSelectionBox();
        }
        
        // Ensure pointer lock is off and just update our custom cursor
        if (controls && controls.isLocked) {
            controls.unlock();
        }
        
        // Update our custom cursor position
        if (document.getElementById('rts-cursor')) {
            updateRTSCursorPosition(event);
        }
        return;
    }
    
    if (!window.controls || !window.controls.isLocked) return;
    
    // Store mouse movement for input state
    window.inputState.mouseDelta.x += event.movementX;
    window.inputState.mouseDelta.y += event.movementY;
    
    if (window.isFreeCameraMode) {
        // Initialize Euler angles if they don't exist
        if (!window.freeCameraEuler) {
            window.freeCameraEuler = new THREE.Euler(0, 0, 0, 'YXZ');
        }
        
        // Update rotation with mouse movement
        const rotationSpeed = 0.002;
        
        // Update yaw (left/right) and pitch (up/down)
        window.freeCameraEuler.y -= event.movementX * rotationSpeed;
        window.freeCameraEuler.x = Math.max(
            -Math.PI/2,
            Math.min(Math.PI/2,
                window.freeCameraEuler.x - event.movementY * rotationSpeed
            )
        );
        
        // Keep roll (z-axis) at 0 to prevent tilting
        window.freeCameraEuler.z = 0;
        
        // Apply rotation to camera, maintaining upright orientation
        camera.quaternion.setFromEuler(window.freeCameraEuler);
    }
    
    // In RTS mode, camera rotation with mouse is disabled
    // as the camera always looks straight down
}

// Handle keyboard movement for free camera
function updateFreeCameraMovement() {
    if (!window.isFreeCameraMode) return;
    
    const speed = window.freeCameraSpeed;
    const moveVector = new THREE.Vector3();
    
    // Get camera's forward and right vectors
    const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
    const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
    
    // WASD movement
    if (window.inputState.keys.w) moveVector.add(forward.multiplyScalar(speed));
    if (window.inputState.keys.s) moveVector.sub(forward);
    if (window.inputState.keys.a) moveVector.sub(right);
    if (window.inputState.keys.d) moveVector.add(right);
    
    // Up/Down movement with Q/E
    if (window.inputState.keys.q) moveVector.y += speed;
    if (window.inputState.keys.e) moveVector.y -= speed;
    
    // Apply movement
    camera.position.add(moveVector.multiplyScalar(speed));
}

// Position camera behind player for third-person view - more responsive
window.updateThirdPersonCamera = function() {
    if (!window.room || !window.room.state || !window.room.state.players) return;
    
    const playerState = window.room.state.players.get(window.room.sessionId);
    if (!playerState) return;
    
    // Calculate offset based on orbit angles
    const offsetX = window.thirdPersonCameraDistance * Math.sin(window.thirdPersonCameraOrbitX) * Math.cos(window.thirdPersonCameraOrbitY);
    const offsetZ = window.thirdPersonCameraDistance * Math.cos(window.thirdPersonCameraOrbitX) * Math.cos(window.thirdPersonCameraOrbitY);
    const offsetY = window.thirdPersonCameraDistance * Math.sin(window.thirdPersonCameraOrbitY);
    
    // Calculate target camera position
    const targetX = playerState.x + offsetX;
    const targetY = playerState.y + window.thirdPersonCameraHeight + offsetY;
    const targetZ = playerState.z + offsetZ;
    
    // Use faster lerp for more responsive camera movement
    const lerpFactor = 0.3; // Higher = more responsive
    
    // Apply smooth but responsive camera movement
    window.camera.position.x = THREE.MathUtils.lerp(window.camera.position.x, targetX, lerpFactor);
    window.camera.position.y = THREE.MathUtils.lerp(window.camera.position.y, targetY, lerpFactor);
    window.camera.position.z = THREE.MathUtils.lerp(window.camera.position.z, targetZ, lerpFactor);
    
    // Instant position correction if too far away (prevents extreme lag)
    const distSq = Math.pow(window.camera.position.x - targetX, 2) +
                   Math.pow(window.camera.position.y - targetY, 2) +
                   Math.pow(window.camera.position.z - targetZ, 2);
                   
    if (distSq > 25) { // About 5 units away - immediately snap to correct position
        window.camera.position.set(targetX, targetY, targetZ);
    }
    
    // Point camera at player
    const lookTarget = new THREE.Vector3(
        playerState.x, 
        playerState.y + window.thirdPersonCameraHeight * 0.8, // Look at upper body
        playerState.z
    );
    
    // Create look direction and rotation
    const direction = new THREE.Vector3().subVectors(lookTarget, window.camera.position).normalize();
    const quaternion = new THREE.Quaternion().setFromUnitVectors(
        new THREE.Vector3(0, 0, -1),
        direction
    );
    
    // Apply rotation to camera immediately for responsive look
    window.camera.quaternion.copy(quaternion);
    
    // Ensure player mesh is visible in third-person view
    if (window.playerEntity && window.playerEntity.mesh) {
        window.playerEntity.mesh.visible = true;
    }
};

// Main initialization function
function init() {
    try {
        debug('Initializing game');
        
        // Create the scene first
        initScene();
        
        // Initialize physics variables and flags
        initPhysics();
        
        // Create the camera
        debug('Creating camera');
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        // Only initialize with temporary position - actual position will be set when player is created
        camera.position.set(0, 0, 0);
        window.camera = camera; // Make globally available
        
        // Setup renderer
        debug('Setting up renderer');
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.gammaFactor = 2.2;
        
        // Add renderer to document
        document.body.appendChild(renderer.domElement);
        window.renderer = renderer;
        
        // Initialize the floor
        initFloor();

        // Explicitly set camera mode before initializing controls
        window.isFirstPerson = true;  

        // Setup controls for player movement
        setupPointerLockControls();
        
        // Player will be created after clicking "Click to play"
        
        // Add resize event listener
        window.addEventListener('resize', onWindowResize, false);
        
        // Make key handlers available for player movement
        document.addEventListener('keydown', onKeyDown, false);
        document.addEventListener('keyup', onKeyUp, false);
        
        // Add mouse event listeners
        document.addEventListener('mousedown', onMouseDown, false);
        document.addEventListener('mouseup', onMouseUp, false);
        document.addEventListener('mousemove', onMouseMove, false);
        
        // Handle page visibility changes to reset input state when tab is not active
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Reset input state when tab loses focus
                window.moveForward = false;
                window.moveBackward = false;
                window.moveLeft = false;
                window.moveRight = false;
                window.turnLeft = false;
                window.turnRight = false;
                window.inputState.keys = { 
                    w: false, a: false, s: false, d: false, 
                    space: false, q: false, e: false, shift: false 
                };
                // Force an immediate input update
                if (window.sendInputUpdate) {
                    window.sendInputUpdate();
                }
            }
        });
        
        // Make sure global variables are properly declared
        window.scene = scene;
        window.camera = camera;
        window.renderer = renderer;
        window.controls = controls;
        
        // Expose sendInputUpdate to window for access from other modules
        window.sendInputUpdate = sendInputUpdate;
        
        // Start the animation loop
        requestAnimationFrame(animate);
        
        debug('Game successfully initialized');
    } catch (error) {
        debug(`Full initialization error: ${error.message}`, true);
        console.error('Full initialization error:', error);
    }
}


// Initialize the scene
function initScene() {
    try {
        debug('Creating scene');
        
        // Create the scene
        scene = new THREE.Scene();
        
        // Make scene globally available
        window.scene = scene;
        
        // Set background color
        scene.background = new THREE.Color(0x87CEEB); // Sky blue
        
        // Add fog for depth perception - COMMENTED OUT client-side terrain setting
        // scene.fog = new THREE.Fog(0x87CEEB, 10, 100);
        
        // Add proper lighting with reduced intensity
        // Ambient light - provides overall illumination to the scene
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4); // Reduced from 0.8
        scene.add(ambientLight);
        
        // Directional light - mimics sunlight
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6); // Reduced from 1.0
        directionalLight.position.set(10, 20, 10);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        scene.add(directionalLight);
        
        // Hemisphere light - for natural outdoor lighting (sky/ground gradient)
        const hemisphereLight = new THREE.HemisphereLight(0xddeeff, 0x3e2200, 0.4); // Reduced from 0.7
        scene.add(hemisphereLight);
        
        // Initialize operator manager and make it globally available
        operatorManager = new OperatorManager(scene);
        window.operatorManager = operatorManager;
        
        debug('Scene created successfully');
    } catch (error) {
        debug(`Error creating scene: ${error.message}`, true);
    }
}

// Setup PointerLock controls
function setupPointerLockControls() {
    debug('Setting up PointerLock controls');
    
    try {
        controls = window.initControls(camera, renderer.domElement);
        
        let instructions = document.getElementById('lock-instructions');
        
        if (!instructions) {
            console.warn('Lock instructions element not found, creating one');
            instructions = document.createElement('div');
            instructions.id = 'lock-instructions';
            instructions.style.position = 'absolute';
            instructions.style.width = '100%';
            instructions.style.height = '100%';
            instructions.style.top = '0';
            instructions.style.left = '0';
            instructions.style.display = 'flex';
            instructions.style.flexDirection = 'column';
            instructions.style.justifyContent = 'center';
            instructions.style.alignItems = 'center';
            instructions.style.color = '#ffffff';
            instructions.style.textAlign = 'center';
            instructions.style.backgroundColor = 'rgba(0,0,0,0.5)';
            instructions.style.cursor = 'pointer';
            instructions.style.zIndex = '1000';
            instructions.innerHTML = '<p>Click to play</p>';
            document.body.appendChild(instructions);
        }

        // Add click event to the entire document
        document.addEventListener('click', () => {
            // Don't lock pointer if in RTS mode
            if (window.isRTSMode) {
                return;
            }
            controls.lock();
        }, false);

        // Handle pointer lock change explicitly
        function onPointerLockChange() {
            if (document.pointerLockElement === renderer.domElement || 
                document.mozPointerLockElement === renderer.domElement ||
                document.webkitPointerLockElement === renderer.domElement) {
                
                debug('Pointer is now locked');
                instructions.style.display = 'none';
                document.body.classList.add('controls-enabled');
                window.canJump = true;
                window.isControlsEnabled = true;
                
                // Create the player's entity if not already created
                if (!window.playerLoaded) {
                    debug('Creating player entity after click to play');
                    // Initialize the player
                    window.playerEntity = window.createPlayerEntity(scene);
                    window.player = window.playerEntity;
                    window.playerLoaded = true;
                    
                    // Make sure player mesh is invisible in first-person view
                    if (window.playerEntity && window.playerEntity.mesh) {
                        window.playerEntity.mesh.visible = false;
                    }
                    
                    // Initialize networking if not already done
                    if (!window.room) {
                        window.initNetworking().then((roomInstance) => {
                            window.gameRoom = roomInstance;
                            window.room = roomInstance;
                            
                            // Start getting updates from the server
                            setInterval(sendInputUpdate, 1000 / 30);
                            
                            // Apply the first-person view once the room is joined
                            if (window.switchToFirstPersonView) {
                                window.switchToFirstPersonView();
                            }
                        }).catch((error) => {
                            debug(`Networking error: ${error.message}`, true);
                        });
                    } else {
                        // Apply the first-person view if we already have a room
                        if (window.switchToFirstPersonView) {
                            window.switchToFirstPersonView();
                        }
                    }
                }

                if (!window.isAnimating) {
                    window.isAnimating = true;
                    animate();
                }
            } else {
                // If we were in RTS mode, don't show instructions on unlock
                if (window.isRTSMode) {
                    instructions.style.display = 'none';
                    
                    // Make sure RTS cursor is still visible
                    if (document.getElementById('rts-cursor')) {
                        document.getElementById('rts-cursor').style.display = 'block';
                    }
                } else {
                    // Only show instructions if we're not in free camera mode AND not already playing
                    if (!window.isFreeCameraMode && !window.playerLoaded) {
                        instructions.style.display = 'block';
                    } else {
                        instructions.style.display = 'none';
                    }
                }
                debug('Pointer is unlocked');
            }
        }

        // Attach pointer lock event listeners clearly to the document
        document.addEventListener('pointerlockchange', onPointerLockChange, false);
        document.addEventListener('mozpointerlockchange', onPointerLockChange, false);
        document.addEventListener('webkitpointerlockchange', onPointerLockChange, false);

        scene.add(controls.getObject());
        window.isFirstPerson = true;

        debug('PointerLock controls setup complete');
    } catch (error) {
        debug(`Error setting up PointerLock controls: ${error.message}`, true);
    }
}

// Update player movement physics with more responsive server sync
function updatePlayerPhysics(delta) {
    if (!controls || !scene || !controls.isLocked) return;
    
    const controlsObject = controls.getObject();
    
    // Get current player state from server if available
    if (window.room && window.room.state && window.room.state.players) {
        const player = window.room.state.players.get(window.room.sessionId);
        if (player) {
            // Update the player's position based on the server position
            // Higher lerpFactor means more responsive but potentially less smooth
            const lerpFactor = 0.3; // Increased for more responsive movement
            
            // Smoothly interpolate to the server position
            controlsObject.position.x = THREE.MathUtils.lerp(
                controlsObject.position.x, 
                player.x, 
                lerpFactor
            );
            
            controlsObject.position.z = THREE.MathUtils.lerp(
                controlsObject.position.z, 
                player.z, 
                lerpFactor
            );
            
            // Use server Y position for jumping/falling
            controlsObject.position.y = THREE.MathUtils.lerp(
                controlsObject.position.y, 
                player.y, 
                lerpFactor * 2  // Faster vertical correction
            );
            
            // If there's a significant desync, instantly correct position
            const distanceSquared = 
                Math.pow(controlsObject.position.x - player.x, 2) + 
                Math.pow(controlsObject.position.z - player.z, 2);
                
            if (distanceSquared > 5) { // Lowered threshold for quicker corrections
                controlsObject.position.x = player.x;
                controlsObject.position.z = player.z;
                controlsObject.position.y = player.y;
                console.log("Position correction applied");
            }
            
            // Update the player's velocity
            window.velocity.y = player.velocityY;
            
            // Update player entity position and scale to match player value
            if (typeof updatePlayerEntity === 'function') {
                updatePlayerEntity(player.value);
            }
            
            // Update player info in UI if available
            if (window.playerUI && typeof window.playerUI.updatePlayerListUI === 'function') {
                window.playerUI.updatePlayerListUI();
            }
            
            // Force camera to update based on view mode for immediate feedback
            if (window.isFirstPerson && !window.isFreeCameraMode) {
                window.updateFirstPersonCamera();
            } else if (!window.isFreeCameraMode) {
                window.updateThirdPersonCamera();
            }
        }
    } else {
        // Use client-side physics for prediction if server data not available
        // Apply gravity
        window.velocity.y -= 9.8 * delta;
        controlsObject.position.y += window.velocity.y * delta;
        
        // Basic ground collision
        if (controlsObject.position.y < 1) {
            window.velocity.y = 0;
            controlsObject.position.y = 1;
            window.canJump = true;
        }
    }
}

// initialize your global visuals safely if not done already
window.visuals = window.visuals || { players: {}, operators: {}, staticEntities: {} };

// Animation loop
function animate(currentTime) {
    requestAnimationFrame(animate);
    
    if (!window.prevTime) window.prevTime = performance.now();
    if (!currentTime) currentTime = performance.now();
    
    const delta = Math.min((currentTime - window.prevTime) / 1000, 0.1);
    window.prevTime = currentTime;
    
    // Handle different camera modes
    if (window.isFreeCameraMode) {
        // Update free camera movement
        updateFreeCameraMovement();
    } else if (window.isRTSMode) {
        // Update RTS camera movement - call directly instead of through updateControls
        updateRTSCameraMovement(delta);
    } else if (controls && controls.isLocked) {
        // Normal controls update for first/third person
        window.updateControls(controls, delta);
        updatePlayerPhysics(delta);
    }
    
    // Update player state from server
    if (window.room && window.room.state && window.room.state.players) {
        const playerState = window.room.state.players.get(window.room.sessionId);
        if (playerState) {
            // Update player mesh
            if (window.playerEntity && window.playerEntity.mesh) {
                window.playerEntity.mesh.position.set(playerState.x, playerState.y, playerState.z);
                window.playerEntity.mesh.rotation.y = playerState.rotationY;
                window.playerEntity.mesh.visible = window.isFreeCameraMode || window.isRTSMode || !window.isFirstPerson;
            }
            
            // Only update camera for first/third person modes
            if (!window.isFreeCameraMode && !window.isRTSMode) {
                if (window.isFirstPerson) {
                    window.updateFirstPersonCamera();
                } else {
                    window.updateThirdPersonCamera();
                }
            }
        }
    }
    
    // Execute all registered animation callbacks
    if (window.animationCallbacks && window.animationCallbacks.length > 0) {
        for (let i = 0; i < window.animationCallbacks.length; i++) {
            try {
                window.animationCallbacks[i](delta);
            } catch (error) {
                console.error("Error in animation callback:", error);
            }
        }
    }
    
    // Explicitly call updateRemotePlayers to ensure other players are always rendered
    if (typeof window.updateRemotePlayers === 'function') {
        window.updateRemotePlayers();
    }
    
    renderer.render(scene, camera);
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function sendInputUpdate() {
    // Don't send updates if we're in free camera mode or RTS mode or if player isn't loaded yet
    if (window.isFreeCameraMode || window.isRTSMode || !window.playerLoaded) {
        return;
    }
    
    if (window.room) {
        const now = performance.now();
        if ((now - window.lastInputTime) > window.inputThrottleMs) {
            window.lastInputTime = now;
            
            // Make sure all key states are properly set before sending
            const keyStates = {
                w: window.moveForward,
                a: window.moveLeft, 
                s: window.moveBackward,
                d: window.moveRight,
                space: window.inputState.keys.space || false,
                q: window.turnLeft || window.inputState.keys.q || false,
                e: window.turnRight || window.inputState.keys.e || false,
                shift: window.shiftPressed || false
            };
            
            // Update the global input state to ensure everything is in sync
            window.inputState.keys = keyStates;
            
            // Send the updated input state to server
            window.room.send("updateInput", {
                keys: keyStates,
                mouseDelta: {
                    x: window.isFirstPerson ? window.inputState.mouseDelta.x : 0,
                    y: window.isFirstPerson ? window.inputState.mouseDelta.y : 0
                },
                viewMode: window.isFirstPerson ? "first-person" : "third-person",
                thirdPersonCameraAngle: window.thirdPersonCameraOrbitX,
                // Send direct rotation values for immediate application on server
                clientRotation: {
                    rotationY: window.playerRotationY || 0,
                    pitch: window.firstPersonCameraPitch || 0
                }
            });
            
            // Reset mouse delta after sending
            window.inputState.mouseDelta.x = 0;
            window.inputState.mouseDelta.y = 0;
            
            // Debug output to confirm inputs are sent
            if (keyStates.w || keyStates.a || keyStates.s || keyStates.d || keyStates.q || keyStates.e) {
                console.log("Sending input to server:", keyStates);
            }
        }
    }
}

setInterval(sendInputUpdate, 1000 / 30);

window.thirdPersonCameraDistance = 5;
window.thirdPersonCameraOrbitX = 0;
window.thirdPersonCameraOrbitY = 0;

// Update third-person camera position based on orbit angles
function updateThirdPersonCameraPosition() {
    if (!window.room || !window.room.state || !window.room.state.players) return;
    const playerState = window.room.state.players.get(window.room.sessionId);
    if (!playerState) return;
    
    // Get camera reference
    const camera = window.camera;
    
    // Calculate theta (horizontal orbit angle) and phi (vertical orbit angle)
    const theta = window.thirdPersonCameraOrbitX;
    const phi = window.thirdPersonCameraOrbitY;
    
    // Calculate camera position based on spherical coordinates
    const distance = window.thirdPersonCameraDistance;
    const offsetX = distance * Math.sin(theta) * Math.cos(phi);
    const offsetY = distance * Math.sin(phi);
    const offsetZ = distance * Math.cos(theta) * Math.cos(phi);
    
    // Calculate camera position relative to player
    const cameraPosition = new THREE.Vector3(
        playerState.x + offsetX,
        playerState.y + window.playerHeight / 2 + offsetY,
        playerState.z + offsetZ
    );
    
    // Set camera position
    camera.position.copy(cameraPosition);
    
    // Use our helper function to fix orientation
    setThirdPersonCameraOrientation(
        camera,
        cameraPosition,
        new THREE.Vector3(playerState.x, playerState.y, playerState.z)
    );
}

// Make updateFirstPersonCamera globally accessible
window.updateFirstPersonCamera = function() {
    if (!window.room || !window.room.state || !window.room.state.players) return;
    
    const playerState = window.room.state.players.get(window.room.sessionId);
    if (!playerState) return;
    
    // Update camera position to be exactly at player's position (with head height)
    if (window.camera && controls) {
        // Position camera exactly at player position with head height
        window.camera.position.set(
            playerState.x,
            playerState.y + (window.playerHeight || 2.0),
            playerState.z
        );
        
        // Apply proper rotation using player's server-side rotation values
        // and any local camera pitch changes for immediate feedback
        const pitch = typeof window.firstPersonCameraPitch !== 'undefined' 
            ? window.firstPersonCameraPitch 
            : (playerState.pitch || 0);
            
        const rotationY = typeof window.playerRotationY !== 'undefined'
            ? window.playerRotationY
            : (playerState.rotationY || 0);
            
        window.camera.quaternion.setFromEuler(new THREE.Euler(
            pitch,
            rotationY,
            0,
            'YXZ' // Important for proper FPS rotation order
        ));
        
        // Update the controls object to match camera position
        if (controls.getObject) {
            controls.getObject().position.copy(window.camera.position);
        }
        
        // Make sure the player mesh is invisible in first-person
        if (window.playerEntity && window.playerEntity.mesh) {
            window.playerEntity.mesh.visible = false;
        }
    }
};

// Handle view-specific camera updates
function updateThirdPersonCamera() {
    // Get player state
    const playerState = window.room.state.players.get(window.room.sessionId);
    if (!playerState) return;
    
    // Third-person: Position camera behind player with smooth follow
    
    // First, update the camera orbit angle to match the player's rotation
    // This makes the camera follow behind the player when they rotate with Q and E
    window.thirdPersonCameraOrbitX = playerState.rotationY;
    
    // Calculate ideal camera position based on orbit angles
    const theta = window.thirdPersonCameraOrbitX;
    const phi = window.thirdPersonCameraOrbitY;
    
    // Calculate camera position based on spherical coordinates
    const distance = window.thirdPersonCameraDistance;
    const offsetX = distance * Math.sin(theta) * Math.cos(phi);
    const offsetY = distance * Math.sin(phi);
    const offsetZ = distance * Math.cos(theta) * Math.cos(phi);
    
    // Target position (slightly above player's head)
    const lookAtPosition = new THREE.Vector3(
        playerState.x,
        playerState.y + window.playerHeight * 0.7, // Look at player's upper body
        playerState.z
    );
    
    // Set camera position
    const targetCameraPos = new THREE.Vector3(
        playerState.x + offsetX,
        playerState.y + offsetY + window.playerHeight * 0.5,
        playerState.z + offsetZ
    );
    
    // Smooth camera movement
    camera.position.lerp(targetCameraPos, 0.2);
    
    // Fix camera orientation
    setThirdPersonCameraOrientation(camera, lookAtPosition, playerState);
    
    // Show player mesh in third-person and make sure it's updated
    if (window.playerEntity && window.playerEntity.mesh) {
        window.playerEntity.mesh.visible = true;
        
        // Update position
        window.playerEntity.mesh.position.set(playerState.x, playerState.y, playerState.z);
        
        // Smooth rotation
        const currentRot = window.playerEntity.mesh.rotation.y;
        const targetRot = playerState.rotationY;
        
        // Find the shortest rotation path
        let rotDiff = targetRot - currentRot;
        if (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
        if (rotDiff < -Math.PI) rotDiff += Math.PI * 2;
        
        // Apply smooth rotation
        window.playerEntity.mesh.rotation.y += rotDiff * 0.1;
    }
}

// Mouse down event handler
function onMouseDown(event) {
    // For RTS mode, handle without pointer lock
    if (window.isRTSMode) {
        // Left button: start selection box or select unit
        if (event.button === 0) {
            // Start selection box
            window.rtsSelectionBoxActive = true;
            window.rtsSelectionStartX = event.clientX;
            window.rtsSelectionStartY = event.clientY;
            window.rtsSelectionEndX = event.clientX;
            window.rtsSelectionEndY = event.clientY;
            
            // Show selection box
            updateSelectionBox();
        }
        // Right button: move selected unit(s)
        else if (event.button === 2) {
            moveSelectedUnits();
        }
        return;
    }
    
    // Original behavior for other modes (which require pointer lock)
    if (!document.pointerLockElement) return;
    
    // Left button: 0, Middle: 1, Right: 2
    if (event.button === 2) {
        window.rightMouseDown = true;
    } else if (event.button === 1) {
        window.middleMouseDown = true;
    }
}

// Mouse up event handler
function onMouseUp(event) {
    // For RTS mode, handle specially
    if (window.isRTSMode) {
        // Left button: complete selection box
        if (event.button === 0 && window.rtsSelectionBoxActive) {
            window.rtsSelectionBoxActive = false;
            
            // Hide selection box
            const selectionBox = document.getElementById('rts-selection-box');
            if (selectionBox) {
                selectionBox.style.display = 'none';
            }
            
            // Get final selection area
            window.rtsSelectionEndX = event.clientX;
            window.rtsSelectionEndY = event.clientY;
            
            // If selection area is very small, treat as a single click
            const selectionWidth = Math.abs(window.rtsSelectionEndX - window.rtsSelectionStartX);
            const selectionHeight = Math.abs(window.rtsSelectionEndY - window.rtsSelectionStartY);
            
            if (selectionWidth < 5 && selectionHeight < 5) {
                // Single click - select individual unit
                selectUnitInRTSMode();
            } else {
                // Box selection - select all units in box
                selectUnitsInBoxRTSMode();
            }
        }
        
        // Just ensure cursor is still visible
        if (document.getElementById('rts-cursor')) {
            document.getElementById('rts-cursor').style.display = 'block';
            
            // Update cursor position for consistency
            updateRTSCursorPosition({
                clientX: event.clientX,
                clientY: event.clientY
            });
        }
        return;
    }
    
    // Standard handling for other modes
    if (event.button === 2) {
        window.rightMouseDown = false;
    } else if (event.button === 1) {
        window.middleMouseDown = false;
    }
}

// Mouse move event handler for RTS mode selection box
function onMouseMove(event) {
    // In RTS mode, handle selection box if active
    if (window.isRTSMode) {
        if (window.rtsSelectionBoxActive) {
            window.rtsSelectionEndX = event.clientX;
            window.rtsSelectionEndY = event.clientY;
            updateSelectionBox();
        }
        
        // Ensure pointer lock is off and just update our custom cursor
        if (controls && controls.isLocked) {
            controls.unlock();
        }
        
        // Update our custom cursor position
        if (document.getElementById('rts-cursor')) {
            updateRTSCursorPosition(event);
        }
        return;
    }
    
    if (!window.controls || !window.controls.isLocked) return;
    
    // Store mouse movement for input state
    window.inputState.mouseDelta.x += event.movementX;
    window.inputState.mouseDelta.y += event.movementY;
    
    if (window.isFreeCameraMode) {
        // Initialize Euler angles if they don't exist
        if (!window.freeCameraEuler) {
            window.freeCameraEuler = new THREE.Euler(0, 0, 0, 'YXZ');
        }
        
        // Update rotation with mouse movement
        const rotationSpeed = 0.002;
        
        // Update yaw (left/right) and pitch (up/down)
        window.freeCameraEuler.y -= event.movementX * rotationSpeed;
        window.freeCameraEuler.x = Math.max(
            -Math.PI/2,
            Math.min(Math.PI/2,
                window.freeCameraEuler.x - event.movementY * rotationSpeed
            )
        );
        
        // Keep roll (z-axis) at 0 to prevent tilting
        window.freeCameraEuler.z = 0;
        
        // Apply rotation to camera, maintaining upright orientation
        camera.quaternion.setFromEuler(window.freeCameraEuler);
    }
    
    // In RTS mode, camera rotation with mouse is disabled
    // as the camera always looks straight down
}

// Perform unit selection in RTS mode using raycasting
function selectUnitInRTSMode() {
    if (!window.isRTSMode) return;
    
    // Ensure pointer is unlocked in RTS mode
    if (controls && controls.isLocked) {
        controls.unlock();
    }
    
    // Get the current mouse position
    const cursor = document.getElementById('rts-cursor');
    if (!cursor) return;
    
    // Get cursor position and renderer bounds
    const rect = renderer.domElement.getBoundingClientRect();
    const cursorX = parseInt(cursor.style.left);
    const cursorY = parseInt(cursor.style.top);
    
    // Create a raycaster for the cursor position
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    
    // Calculate mouse position in normalized device coordinates
    // Use the cursor's center point for more accurate picking
    mouse.x = ((cursorX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((cursorY - rect.top) / rect.height) * 2 + 1;
    
    // Update the raycaster with the camera and mouse position
    raycaster.setFromCamera(mouse, window.camera);
    
    // Get all objects that could be selected
    const selectableObjects = [];
    
    // Add the player's mesh
    if (window.playerEntity && window.playerEntity.mesh) {
        selectableObjects.push(window.playerEntity.mesh);
    }
    
    // Add other selectable units if any
    // For future: Add enemy units, resources, buildings, etc.
    
    // Perform the raycast
    const intersects = raycaster.intersectObjects(selectableObjects, true);
    
    // Clear previous selections
    clearAllSelections();
    
    // If an object was hit, select it
    if (intersects.length > 0) {
        let selectedMesh = intersects[0].object;
        
        // Find the top-level mesh (for models with nested meshes)
        while (selectedMesh.parent && selectedMesh.parent !== scene) {
            selectedMesh = selectedMesh.parent;
        }
        
        // Determine which entity this belongs to
        let selectedEntity = null;
        
        // Check if it's the player
        if (window.playerEntity && (window.playerEntity.mesh === selectedMesh || 
            window.playerEntity.mesh.id === selectedMesh.id)) {
            selectedEntity = window.playerEntity;
        }
        
        // If we found a valid entity, select it
        if (selectedEntity) {
            // Add to the selected units array
            window.rtsSelectedUnits.push(selectedEntity);
            
            // Also maintain backward compatibility with single-selection
            window.rtsSelectedUnit = selectedEntity;
            
            // Apply visual highlight
            highlightSelectedUnit(selectedEntity);
            
            console.log("[RTS] Selected unit:", selectedEntity);
        }
    } else {
        console.log("[RTS] No unit selected");
    }
    
    // Ensure cursor is up to date after selection
    // This prevents cursor from "freezing" after clicking
    requestAnimationFrame(() => {
        updateRTSCursorPosition({
            clientX: window.lastMouseX || window.innerWidth / 2,
            clientY: window.lastMouseY || window.innerHeight / 2
        });
    });
}

// Create a selection ring for a specific unit
function createSelectionRingForUnit(unit) {
    if (!unit || !unit.mesh) return;
    
    // Create a ring geometry
    const radius = 1.2; // Slightly larger than the unit
    const innerRadius = radius * 0.8;
    const segments = 32;
    
    const ringGeometry = new THREE.RingGeometry(innerRadius, radius, segments);
    const ringMaterial = new THREE.MeshBasicMaterial({
        color: 0x00ff00,
        side: THREE.DoubleSide,
        transparent: true,
        opacity: 0.7
    });
    
    // Create the ring mesh
    const ring = new THREE.Mesh(ringGeometry, ringMaterial);
    
    // Position it flat on the ground but slightly above to avoid z-fighting
    ring.rotation.x = -Math.PI / 2;
    ring.position.y = 0.02;
    ring.position.x = unit.mesh.position.x;
    ring.position.z = unit.mesh.position.z;
    
    // Add the ring to the scene
    scene.add(ring);
    
    // Save reference to the unit this ring belongs to
    ring.userData.unitId = unit.id || unit.mesh.id;
    
    // Add to the ring array for management
    if (!window.rtsSelectionRings) {
        window.rtsSelectionRings = [];
    }
    window.rtsSelectionRings.push(ring);
    
    // Register animation callback for the ring if it doesn't exist
    if (!window.rtsRingAnimationAdded) {
        window.registerAnimationCallback(animateSelectionRings);
        window.rtsRingAnimationAdded = true;
    }
}

// Animate all selection rings
function animateSelectionRings(delta) {
    // Skip if no rings
    if (!window.rtsSelectionRings || window.rtsSelectionRings.length === 0) return;
    
    // Animation time
    const time = performance.now() * 0.001;
    
    // Update all rings
    window.rtsSelectionRings.forEach(ring => {
        // Skip if ring was deleted
        if (!ring || !ring.material) return;
        
        // Find the unit this ring belongs to
        const unitId = ring.userData.unitId;
        let unitMesh = null;
        
        // Check if it's player's
        if (window.playerEntity && window.playerEntity.mesh && 
            (window.playerEntity.id === unitId || window.playerEntity.mesh.id === unitId)) {
            unitMesh = window.playerEntity.mesh;
        }
        
        // Future: Check other units
        
        // Update ring position to follow unit
        if (unitMesh) {
            ring.position.x = unitMesh.position.x;
            ring.position.z = unitMesh.position.z;
        }
        
        // Rotate and pulse opacity for effect
        ring.rotation.z += delta * 0.5;
        ring.material.opacity = 0.5 + 0.3 * Math.sin(time * 2);
    });
}

// Move selected units to clicked position in RTS mode
function moveSelectedUnits() {
    if (!window.isRTSMode) return;
    
    // Ensure pointer is unlocked in RTS mode
    if (controls && controls.isLocked) {
        controls.unlock();
    }
    
    // Only proceed if we have selected units
    if (!window.rtsSelectedUnits || window.rtsSelectedUnits.length === 0) {
        console.log("[RTS] No units selected to move");
        return;
    }
    
    // Get the current mouse position
    const cursor = document.getElementById('rts-cursor');
    if (!cursor) return;
    
    // Get cursor position and renderer bounds
    const rect = renderer.domElement.getBoundingClientRect();
    const cursorX = parseInt(cursor.style.left);
    const cursorY = parseInt(cursor.style.top);
    
    // Create a raycaster for the cursor position
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    
    // Calculate mouse position in normalized device coordinates
    mouse.x = ((cursorX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((cursorY - rect.top) / rect.height) * 2 + 1;
    
    // Update the raycaster
    raycaster.setFromCamera(mouse, window.camera);
    
    // Get all objects we can move onto (usually just the floor)
    const floor = scene.children.find(child => 
        child instanceof THREE.Mesh && 
        child.rotation.x === -Math.PI / 2
    );
    
    const moveTargets = [floor];
    
    // Perform the raycast
    const intersects = raycaster.intersectObjects(moveTargets, false);
    
    // If we hit the floor, move the selected units there
    if (intersects.length > 0) {
        const targetPosition = intersects[0].point;
        
        // Create a move command and send it to the server
        if (window.room) {
            // Send move command for each selected unit
            window.rtsSelectedUnits.forEach(unit => {
                window.room.send("moveCommand", {
                    x: targetPosition.x,
                    z: targetPosition.z,
                    unitId: unit.id || unit.mesh.id // Include unit ID if we have multiple units
                });
            });
            
            // Visual feedback - create a temporary marker at the clicked position
            createMoveMarker(targetPosition);
            
            console.log("[RTS] Moving units to:", targetPosition);
        }
    }
    
    // Ensure cursor is up to date after move command
    requestAnimationFrame(() => {
        updateRTSCursorPosition({
            clientX: window.lastMouseX || window.innerWidth / 2,
            clientY: window.lastMouseY || window.innerHeight / 2
        });
    });
}

// Create a visual marker for move commands
function createMoveMarker(position) {
    // Create a simple circular marker
    const markerGeometry = new THREE.CircleGeometry(0.5, 16);
    const markerMaterial = new THREE.MeshBasicMaterial({ 
        color: 0x00ff00,
        transparent: true,
        opacity: 0.7,
        side: THREE.DoubleSide
    });
    
    const marker = new THREE.Mesh(markerGeometry, markerMaterial);
    
    // Position slightly above the ground to prevent z-fighting
    marker.position.set(position.x, 0.01, position.z);
    marker.rotation.x = -Math.PI / 2; // Rotate to be flat on the ground
    
    scene.add(marker);
    
    // Add a slight pulsing animation
    let pulseTime = 0;
    
    function animateMarker(delta) {
        pulseTime += delta;
        
        // Pulse the opacity
        marker.material.opacity = 0.7 * (0.5 + 0.5 * Math.sin(pulseTime * 5));
        
        // Scale down over time
        const scale = Math.max(0.1, 1 - pulseTime);
        marker.scale.set(scale, scale, scale);
        
        // Remove when animation completes
        if (pulseTime > 1) {
            window.unregisterAnimationCallback(animateMarker);
            scene.remove(marker);
            marker.geometry.dispose();
            marker.material.dispose();
        }
    }
    
    // Register the animation
    window.registerAnimationCallback(animateMarker);
}

// Create a custom cursor for RTS mode
function createRTSCursor() {
    // Create a div element for our custom cursor
    const cursor = document.createElement('div');
    cursor.id = 'rts-cursor';
    
    // Set style for the cursor
    cursor.style.position = 'fixed';
    cursor.style.width = '32px';
    cursor.style.height = '32px';
    cursor.style.pointerEvents = 'none'; // Prevent the cursor from intercepting clicks
    cursor.style.zIndex = '9999'; // Ensure cursor is on top of everything
    // SVG with crosshair cursor design - exact center is the intersection point
    cursor.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'32\' height=\'32\' viewBox=\'0 0 32 32\'><circle cx=\'16\' cy=\'16\' r=\'14\' fill=\'none\' stroke=\'white\' stroke-width=\'2\'/><circle cx=\'16\' cy=\'16\' r=\'2\' fill=\'white\'/><path d=\'M16 8 L16 2\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M16 30 L16 24\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M8 16 L2 16\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M30 16 L24 16\' stroke=\'white\' stroke-width=\'2\'/></svg>")';
    cursor.style.backgroundSize = 'contain';
    cursor.style.display = 'none'; // Initially hidden
    
    // Position the cursor so its center is at the mouse position
    cursor.style.left = '0';
    cursor.style.top = '0';
    cursor.style.transform = 'translate(-50%, -50%)';
    
    // Add cursor element to the document
    document.body.appendChild(cursor);
    
    // Initialize cursor at center of screen
    updateRTSCursorPosition({
        clientX: window.innerWidth / 2,
        clientY: window.innerHeight / 2
    });
    
    // Add mousemove listener to update custom cursor position
    document.addEventListener('mousemove', updateRTSCursorPosition);
    
    return cursor;
}

// Update the RTS cursor position
function updateRTSCursorPosition(event) {
    // Store last mouse position for reference
    window.lastMouseX = event.clientX;
    window.lastMouseY = event.clientY;
    
    const cursor = document.getElementById('rts-cursor');
    if (!cursor) return;
    
    // Only update cursor position if it's visible (RTS mode)
    if (cursor.style.display === 'none') return;
    
    // Update cursor position to follow mouse exactly
    // Position is set so the center of the cursor is at the mouse position
    cursor.style.left = event.clientX + 'px';
    cursor.style.top = event.clientY + 'px';
    
    // Make sure transform is applied for centering
    cursor.style.transform = 'translate(-50%, -50%)';
    
    // When in RTS mode, update ray cast for hover effects
    if (window.isRTSMode) {
        updateRTSHoverEffects(event);
    }
}

// Update hover effects for RTS mode
function updateRTSHoverEffects(event) {
    // Create a raycaster for mouse position
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const rect = renderer.domElement.getBoundingClientRect();
    
    // Calculate mouse position in normalized device coordinates
    // (-1 to +1) for both components
    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
    
    // Update the raycaster with the camera and mouse position
    raycaster.setFromCamera(mouse, window.camera);
    
    // Get all selectable objects
    const selectableObjects = [];
    
    // Add the player's mesh
    if (window.playerEntity && window.playerEntity.mesh) {
        selectableObjects.push(window.playerEntity.mesh);
    }
    
    // For future: Add other selectable units, buildings, etc.
    
    // Perform the raycast
    const intersects = raycaster.intersectObjects(selectableObjects, true);
    
    const cursor = document.getElementById('rts-cursor');
    
    // If hovering over a selectable object, change cursor
    if (intersects.length > 0) {
        // Change cursor to selection cursor (green highlight)
        cursor.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'32\' height=\'32\' viewBox=\'0 0 32 32\'><circle cx=\'16\' cy=\'16\' r=\'14\' fill=\'none\' stroke=\'%2300ff00\' stroke-width=\'2\'/><circle cx=\'16\' cy=\'16\' r=\'2\' fill=\'%2300ff00\'/><path d=\'M16 8 L16 2\' stroke=\'%2300ff00\' stroke-width=\'2\'/><path d=\'M16 30 L16 24\' stroke=\'%2300ff00\' stroke-width=\'2\'/><path d=\'M8 16 L2 16\' stroke=\'%2300ff00\' stroke-width=\'2\'/><path d=\'M30 16 L24 16\' stroke=\'%2300ff00\' stroke-width=\'2\'/></svg>")';
    } else {
        // Reset to default cursor (white)
        cursor.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'32\' height=\'32\' viewBox=\'0 0 32 32\'><circle cx=\'16\' cy=\'16\' r=\'14\' fill=\'none\' stroke=\'white\' stroke-width=\'2\'/><circle cx=\'16\' cy=\'16\' r=\'2\' fill=\'white\'/><path d=\'M16 8 L16 2\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M16 30 L16 24\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M8 16 L2 16\' stroke=\'white\' stroke-width=\'2\'/><path d=\'M30 16 L24 16\' stroke=\'white\' stroke-width=\'2\'/></svg>")';
    }
}

// Update the display of the selection box
function updateSelectionBox() {
    const selectionBox = document.getElementById('rts-selection-box');
    if (!selectionBox) return;
    
    // Calculate box coordinates
    const left = Math.min(window.rtsSelectionStartX, window.rtsSelectionEndX);
    const top = Math.min(window.rtsSelectionStartY, window.rtsSelectionEndY);
    const width = Math.abs(window.rtsSelectionEndX - window.rtsSelectionStartX);
    const height = Math.abs(window.rtsSelectionEndY - window.rtsSelectionStartY);
    
    // Update box position and size
    selectionBox.style.left = left + 'px';
    selectionBox.style.top = top + 'px';
    selectionBox.style.width = width + 'px';
    selectionBox.style.height = height + 'px';
    
    // Show the box
    selectionBox.style.display = 'block';
}

// Select all units within the selection box
function selectUnitsInBoxRTSMode() {
    // Get the renderer bounds for coordinate conversion
    const rect = renderer.domElement.getBoundingClientRect();
    
    // Convert box coordinates to normalized device coordinates (-1 to 1)
    const left = Math.min(window.rtsSelectionStartX, window.rtsSelectionEndX);
    const right = Math.max(window.rtsSelectionStartX, window.rtsSelectionEndX);
    const top = Math.min(window.rtsSelectionStartY, window.rtsSelectionEndY);
    const bottom = Math.max(window.rtsSelectionStartY, window.rtsSelectionEndY);
    
    // Get an array of all selectable units in the scene
    const selectableUnits = [];
    
    // Add the player's unit
    if (window.playerEntity && window.playerEntity.mesh) {
        selectableUnits.push(window.playerEntity);
    }
    
    // TODO: Add other selectable units (allied units) when they're implemented
    
    // Clear previous selections
    clearAllSelections();
    
    // Check each unit to see if it's in the selection box
    selectableUnits.forEach(unit => {
        if (!unit.mesh) return;
        
        // Project unit position to screen coordinates
        const position = new THREE.Vector3();
        position.copy(unit.mesh.position);
        
        // Convert 3D position to screen position
        position.project(window.camera);
        
        // Convert to pixel coordinates
        const screenX = ((position.x + 1) / 2) * rect.width + rect.left;
        const screenY = ((-position.y + 1) / 2) * rect.height + rect.top;
        
        // Check if the unit is inside the selection box
        if (screenX >= left && screenX <= right && screenY >= top && screenY <= bottom) {
            // Add to selection
            window.rtsSelectedUnits.push(unit);
            
            // Apply visual selection to the unit
            highlightSelectedUnit(unit);
            
            console.log("[RTS] Added unit to selection:", unit);
        }
    });
    
    console.log("[RTS] Total units selected:", window.rtsSelectedUnits.length);
}

// Clear all current selections
function clearAllSelections() {
    // Clear the single selected unit reference
    window.rtsSelectedUnit = null;
    
    // Remove highlights from all previously selected units
    if (window.rtsSelectedUnits && window.rtsSelectedUnits.length > 0) {
        window.rtsSelectedUnits.forEach(unit => {
            // Restore original material if saved
            if (unit.rtsMaterial && unit.mesh) {
                unit.mesh.material = unit.rtsMaterial;
            }
        });
    }
    
    // Clear the selection array
    window.rtsSelectedUnits = [];
    
    // Remove any selection rings
    if (window.rtsSelectionRing) {
        scene.remove(window.rtsSelectionRing);
        if (window.rtsSelectionRing.geometry) window.rtsSelectionRing.geometry.dispose();
        if (window.rtsSelectionRing.material) window.rtsSelectionRing.material.dispose();
    }
    
    // Remove all selection rings from the ring array
    if (window.rtsSelectionRings && window.rtsSelectionRings.length > 0) {
        window.rtsSelectionRings.forEach(ring => {
            scene.remove(ring);
            if (ring.geometry) ring.geometry.dispose();
            if (ring.material) ring.material.dispose();
        });
    }
    
    // Initialize the selection rings array if it doesn't exist
    window.rtsSelectionRings = [];
}

// Apply visual highlight to a selected unit
function highlightSelectedUnit(unit) {
    if (!unit || !unit.mesh) return;
    
    // Save original material for later restoration
    if (!unit.rtsMaterial) {
        unit.rtsMaterial = unit.mesh.material.clone();
    }
    
    // Create highlight material
    const highlightMaterial = unit.mesh.material.clone();
    highlightMaterial.emissive = new THREE.Color(0x333333);
    highlightMaterial.emissiveIntensity = 0.5;
    
    // Apply highlight to indicate selection
    unit.mesh.material = highlightMaterial;
    
    // Create a selection ring for this unit
    createSelectionRingForUnit(unit);
}
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\main.js 
===================================================== 
 
// 3D Game Platform - Main Entry Point

// Parse URL parameters for customization
function getUrlParams() {
    const params = {};
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    
    // Get custom player name if provided
    if (urlParams.has('playerName')) {
        params.playerName = urlParams.get('playerName');
    }
    
    // Get custom player color if provided
    if (urlParams.has('playerColor')) {
        // Convert hex string to number
        const colorStr = urlParams.get('playerColor');
        params.playerColor = parseInt(colorStr, 16);
    }
    
    return params;
}

// Get URL parameters
const urlParams = getUrlParams();

// Game configuration
const gameConfig = {
    debug: false,                 // Debug mode
    sceneSettings: {
        groundSize: 100,          // Size of the ground plane
        skyColor: 0x87CEEB,       // Sky color
        groundColor: 0x228B22     // Ground color
    },
    playerSettings: {
        startPosition: {
            x: 0,
            y: 1,
            z: 0
        },
        viewMode: 'firstPerson',   // 'firstPerson', 'thirdPerson', or 'freeRoam'
        // Use custom player name if provided in URL, otherwise generate random name
        playerName: urlParams.playerName || `Player_${Math.floor(Math.random() * 1000)}`,
        // Use custom player color if provided in URL
        playerColor: urlParams.playerColor || 0xFFFF00 // Default to yellow
    },
    networkSettings: {
        serverUrl: window.location.hostname.includes('localhost') 
            ? `ws://${window.location.hostname}:3000` // Local development
            : `wss://${window.location.hostname}`,    // Production
        roomName: 'active'       // Default active room
    }
};

// Store config globally for access by other modules
window.gameConfig = gameConfig;

// Main game initialization
function initGame() {
    console.log('Initializing 3D Game Platform...');
    
    // Display player name in loading screen if custom name provided
    if (urlParams.playerName) {
        const loadingStatus = document.getElementById('loading-status');
        loadingStatus.textContent = `Loading game engine for ${urlParams.playerName}...`;
    }
    
    // Load core modules
    loadCoreModules()
        .then(() => {
            // Initialize the game engine
            initGameEngine();
        })
        .catch(error => {
            console.error('Error initializing game:', error);
        });
}

// Load core platform modules
function loadCoreModules() {
    return new Promise((resolve, reject) => {
        try {
            console.log('Loading core modules...');
            
            // Create core module paths
            const corePath = 'js/core/';
            const coreModules = [
                'Entity.js',
                'Player.js',
                'NPC.js',
                'EntityFactory.js',
                'collision.js',
                'player-ui.js',
                'network-core.js',
                'controls.js'
            ];
            
            // Load each module in sequence
            let loadPromise = Promise.resolve();
            
            coreModules.forEach(module => {
                loadPromise = loadPromise.then(() => {
                    return loadScript(corePath + module);
                });
            });
            
            // Resolve when all core modules are loaded
            loadPromise.then(() => {
                console.log('Core modules loaded successfully');
                resolve();
            }).catch(error => {
                reject(error);
            });
        } catch (error) {
            reject(error);
        }
    });
}

// Initialize the main game engine
function initGameEngine() {
    console.log('Initializing game engine...');
    
    // Initialize default player factory first
    window.createPlayerEntity = function(scene, value = 1) {
        // Create a player with color from gameConfig
        const player = new window.Player({
            id: 'player',
            isLocalPlayer: true,
            color: gameConfig.playerSettings.playerColor
        });
        
        if (scene && player.mesh) {
            scene.add(player.mesh);
        }
        
        return player;
    };
    
    // Load default implementation
    loadScript('js/implementations/default/DefaultPlayer.js')
        .then(() => {
            // Load the game engine
            return loadScript('js/core/game-engine.js');
        })
        .then(() => {
            console.log('Game engine loaded');
            // Remove the loading screen once everything is loaded
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // Set isFirstPerson based on viewMode
            window.isFirstPerson = gameConfig.playerSettings.viewMode === 'firstPerson';
            window.viewMode = gameConfig.playerSettings.viewMode;
        })
        .catch(error => {
            console.error('Error loading game engine:', error);
        });
}

// Helper function to load a script asynchronously
function loadScript(src) {
    return new Promise((resolve, reject) => {
        // Check if this script has already been loaded
        if (document.querySelector(`script[src="${src}"]`)) {
            console.log(`Script already loaded: ${src}`);
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = (error) => reject(new Error(`Failed to load script: ${src}`));
        document.head.appendChild(script);
    });
}

// Start the game when the document is ready
document.addEventListener('DOMContentLoaded', initGame);  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\network-core.js 
===================================================== 
 
// Handles connection to the server and basic network setup

// Network configuration
const endpoint = 'ws://localhost:3000';
let client = null;
let room = null;

// Helper function to generate random colors
function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

// Import CSS2D renderer for player names if not already defined
let CSS2DObject;
let CSS2DRenderer;
try {
    // First check if THREE.CSS2D is available (Three.js r137+)
    if (THREE.CSS2D) {
        console.log("Using THREE.CSS2D namespace");
        CSS2DObject = THREE.CSS2D.CSS2DObject;
        CSS2DRenderer = THREE.CSS2D.CSS2DRenderer;
    } 
    // For older Three.js versions
    else if (THREE.CSS2DObject && THREE.CSS2DRenderer) {
        console.log("Using THREE.CSS2DObject directly");
        CSS2DObject = THREE.CSS2DObject;
        CSS2DRenderer = THREE.CSS2DRenderer;
    } 
    else {
        throw new Error("CSS2D modules not found in THREE");
    }
} catch (error) {
    console.warn("CSS2DObject not available, player name labels will not be shown:", error.message);
    
    // Create dummy versions that do nothing to prevent errors
    CSS2DObject = class DummyCSS2DObject {
        constructor(element) {
            this.element = element;
            this.position = new THREE.Vector3();
            this.rotation = new THREE.Euler();
            this.scale = new THREE.Vector3(1, 1, 1);
            this.visible = true;
        }
    };
    
    CSS2DRenderer = class DummyCSS2DRenderer {
        constructor() {
            this.domElement = document.createElement('div');
        }
        setSize() {}
        render() {}
    };
}

// Global tracking of all visuals
const visuals = {
    players: {},
    operators: {},
    staticEntities: {},
    trees: {},
    rocks: {}
};

// Visual tracking containers
const visualTracking = {
    players: {},
    operators: {},
    staticEntities: {},
};

// Function to get color based on entity value
function getColorForValue(value) {
    // Default colors for values 1-10
    const colors = [
        '#FF0000', // 1 - Red
        '#FF7F00', // 2 - Orange
        '#FFFF00', // 3 - Yellow
        '#00FF00', // 4 - Green
        '#0000FF', // 5 - Blue
        '#4B0082', // 6 - Indigo
        '#8B00FF', // 7 - Violet
        '#964B00', // 8 - Brown
        '#808080', // 9 - Gray
        '#800080'  // 10 - Purple
    ];
    
    // Use value as index (adjusted for zero-based array)
    if (value >= 1 && value <= colors.length) {
        return colors[value - 1];
    }
    
    // Fall back to random color for higher values
    return getRandomColor();
}

// Setup automatic reconnection
function setupReconnection(room, client) {
    if (!room) return;
    
    // Handle WebSocket connection error
    room.onError((error) => {
        console.error("Connection error:", error);
        showErrorMessage("Connection error. Trying to reconnect...");
        addReconnectButton();
    });
    
    // Handle WebSocket disconnection
    room.onLeave((code) => {
        console.log(`Client left the room with code: ${code}`);
        showErrorMessage("Connection lost. Trying to reconnect...");
        
        // Attempt to reconnect automatically
        setTimeout(() => {
            console.log("Attempting to reconnect...");
            
            // Call initNetworking again
            initNetworking()
                .then(() => {
                    console.log("Reconnected successfully!");
                    showInfoMessage("Reconnected successfully!");
                    
                    // Remove reconnect button if it exists
                    const reconnectBtn = document.getElementById('reconnect-button');
                    if (reconnectBtn) {
                        reconnectBtn.remove();
                    }
                })
                .catch((e) => {
                    console.error("Failed to reconnect:", e);
                    showErrorMessage("Failed to reconnect. Please try again later.");
                });
        }, 2000);
    });
}

// Show error message
function showErrorMessage(message) {
    // Check if error message container exists
    let errorContainer = document.getElementById('error-message');
    
    // Create error container if it doesn't exist
    if (!errorContainer) {
        errorContainer = document.createElement('div');
        errorContainer.id = 'error-message';
        errorContainer.style.position = 'fixed';
        errorContainer.style.top = '10px';
        errorContainer.style.left = '50%';
        errorContainer.style.transform = 'translateX(-50%)';
        errorContainer.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
        errorContainer.style.color = 'white';
        errorContainer.style.padding = '10px';
        errorContainer.style.borderRadius = '5px';
        errorContainer.style.zIndex = '1000';
        errorContainer.style.transition = 'opacity 0.5s';
        document.body.appendChild(errorContainer);
    }
    
    // Set message
    errorContainer.textContent = message;
    errorContainer.style.opacity = '1';
    
    // Hide message after 5 seconds
    setTimeout(() => {
        errorContainer.style.opacity = '0';
    }, 5000);
}

// Show info message
function showInfoMessage(message) {
    // Check if info message container exists
    let infoContainer = document.getElementById('info-message');
    
    // Create info container if it doesn't exist
    if (!infoContainer) {
        infoContainer = document.createElement('div');
        infoContainer.id = 'info-message';
        infoContainer.style.position = 'fixed';
        infoContainer.style.top = '10px';
        infoContainer.style.left = '50%';
        infoContainer.style.transform = 'translateX(-50%)';
        infoContainer.style.backgroundColor = 'rgba(0, 128, 0, 0.8)';
        infoContainer.style.color = 'white';
        infoContainer.style.padding = '10px';
        infoContainer.style.borderRadius = '5px';
        infoContainer.style.zIndex = '1000';
        infoContainer.style.transition = 'opacity 0.5s';
        document.body.appendChild(infoContainer);
    }
    
    // Set message
    infoContainer.textContent = message;
    infoContainer.style.opacity = '1';
    
    // Hide message after 3 seconds
    setTimeout(() => {
        infoContainer.style.opacity = '0';
    }, 3000);
}

// Add reconnect button
function addReconnectButton() {
    // Check if reconnect button already exists
    if (document.getElementById('reconnect-button')) {
        return;
    }
    
    // Create button
    const reconnectBtn = document.createElement('button');
    reconnectBtn.id = 'reconnect-button';
    reconnectBtn.textContent = 'Reconnect to Server';
    reconnectBtn.style.position = 'fixed';
    reconnectBtn.style.top = '50%';
    reconnectBtn.style.left = '50%';
    reconnectBtn.style.transform = 'translate(-50%, -50%)';
    reconnectBtn.style.padding = '10px 20px';
    reconnectBtn.style.backgroundColor = '#4CAF50';
    reconnectBtn.style.color = 'white';
    reconnectBtn.style.border = 'none';
    reconnectBtn.style.borderRadius = '5px';
    reconnectBtn.style.cursor = 'pointer';
    reconnectBtn.style.zIndex = '1000';
    reconnectBtn.style.fontSize = '16px';
    
    // Add hover effect
    reconnectBtn.onmouseover = function() {
        this.style.backgroundColor = '#45a049';
    };
    
    reconnectBtn.onmouseout = function() {
        this.style.backgroundColor = '#4CAF50';
    };
    
    // Add click handler
    reconnectBtn.onclick = function() {
        console.log("Reconnect button clicked");
        this.textContent = 'Connecting...';
        this.disabled = true;
        
        // Try to reconnect
        initNetworking()
            .then(() => {
                console.log("Reconnected successfully!");
                this.remove();
            })
            .catch((e) => {
                console.error("Failed to reconnect:", e);
                this.textContent = 'Reconnect to Server';
                this.disabled = false;
                showErrorMessage("Failed to reconnect. Please try again.");
            });
    };
    
    // Add to body
    document.body.appendChild(reconnectBtn);
}

// Function to initialize networking for multiplayer
async function initNetworking() {
    // Get endpoint from gameConfig if available, or use default
    const endpoint = window.gameConfig?.networkSettings?.serverUrl || "ws://localhost:3000";
    // Get room name from gameConfig if available, or use default
    const roomName = window.gameConfig?.networkSettings?.roomName || "default";
    
    console.log("Initializing networking system...");
    
    try {
        console.log(`Connecting to Colyseus server at: ${endpoint}`);
        
        // Create client if needed
        if (!client) {
            try {
                // Check which client constructor is available (handles both 0.14.x and 0.16.x versions)
                if (typeof Colyseus !== 'undefined') {
                    if (typeof Colyseus.Client === 'function') {
                        client = new Colyseus.Client(endpoint);
                    } else if (typeof colyseus !== 'undefined' && typeof colyseus.Client === 'function') {
                        client = new colyseus.Client(endpoint);
                    } else {
                        // Direct instantiation for older versions
                        client = new Client(endpoint);
                    }
                } else if (typeof Client === 'function') {
                    client = new Client(endpoint);
                } else {
                    throw new Error("Colyseus client library not found");
                }
                console.log("Colyseus client created successfully");
            } catch (clientError) {
                console.error("Failed to create Colyseus client:", clientError);
                throw new Error(`Failed to create client: ${clientError.message}`);
            }
        }
        
        // Try to join the room
        try {
            console.log(`Attempting to join room: ${roomName}`);
            room = await client.joinOrCreate(roomName, {
                name: `Player_${Math.floor(Math.random() * 1000)}`,
                color: getRandomColor()
            });
            console.log(`Joined room successfully: ${room.name}`);
            
            // Store room in global scope
            window.room = room;
            
            // Initialize object collections - use a single source of truth
            window.otherPlayers = {};
            window.operators = {};
            window.staticEntities = {};
            window.trees = {};
            window.rocks = {};
            
            // Setup message handlers
            setupMessageHandlers();
            
            // Setup automatic reconnection
            setupReconnection(room, client);
            
            // Wait for the initial state before setting up listeners
            room.onStateChange.once((state) => {
                console.log("Initial state received:", state);
                setupRoomListeners(room);
                setupRoomPlayerListeners(room);
                
                // Register updateRemotePlayers with the animation loop
                if (typeof window.registerAnimationCallback === 'function') {
                    window.registerAnimationCallback(window.updateRemotePlayers);
                    console.log("Registered updateRemotePlayers with animation loop");
                } else {
                    // Set up a fallback timer if animation callback registration is not available
                    console.log("Setting up fallback timer for remote player updates");
                    window.playerUpdateInterval = setInterval(window.updateRemotePlayers, 1000/60); // 60fps
                }
                
                // Explicitly create local player object
                window.myPlayer = new Player({ 
                    id: window.room.sessionId, 
                    isLocalPlayer: true,
                    value: 1, 
                    color: "#FFFF00"
                });
                console.log("Local player created and linked to existing entity mesh:", window.myPlayer);
                
                if (typeof animate === 'function') {
                    animate();
                }
                window.dispatchEvent(new CustomEvent('avatarReady'));
            });
            
            return room;
        } catch (roomError) {
            console.error("Error joining room:", roomError);
            throw roomError;
        }
    } catch (error) {
        console.error("Error connecting to server:", error);
        throw error;
    }
}

// Setup message handlers
function setupMessageHandlers() {
    if (!room) return;
    
    // Listen for custom messages from the server
    room.onMessage("player-collision", (message) => {
        console.log("Collision message received:", message);
        
        // Update player value if needed
        if (window.player && window.player.value !== undefined && message.newValue) {
            window.player.value = message.newValue;
            
            // Update HUD
            if (window.updateHUD) {
                window.updateHUD();
            }
        }
    });
    
    room.onMessage("server-event", (message) => {
        console.log("Server event received:", message);
        // Process server events if needed
    });
}

// Send player collision message
function sendPlayerCollision(targetId) {
    if (!room) return;
    
    room.send("player-collision", { targetId: targetId });
}

// Player joined callback
function onPlayerJoin(player) {
    console.log(`Player joined! ID: ${player.sessionId}`);
    
    // If it's our own join, update the interface
    if (player.sessionId === room.sessionId) {
        console.log("This is us joining!");
        
        // Set initial player values on the server
        player.name = window.playerName || "Player";
        player.color = window.playerColor || "#3366cc";
        
        // Show multiplayer notification
        showInfoMessage("Connected to multiplayer server!");
    } else {
        console.log(`Other player joined: ${player.name || "Unnamed player"}`);
        
        // Create a new entity for this player
        createRemotePlayerObject(player);
    }
    
    // Update the player list in the UI
    updatePlayerListUI();
}

// Create 3D object for remote player
function createRemotePlayerObject(player) {
    // Validate that the player object and sessionId exist
    if (!player || !player.sessionId) {
        console.error("Invalid player data received - missing sessionId:", player);
        return null;
    }
    
    if (!window.scene) {
        console.error("Scene not available to create remote player object");
        return null;
    }
    
    console.log("Creating remote player:", player);
    
    try {
        // Create a player object for the remote player
        // Use DefaultPlayer if available, otherwise fallback to base Player
        const PlayerClass = window.DefaultPlayer || window.Player;
        const remotePlayer = new PlayerClass({
            id: player.sessionId,  // Use the sessionId as the id
            isLocalPlayer: false,
            color: player.color || 0x3366CC,
            value: player.value || 1
        });
        
        // Set position and rotation
        remotePlayer.mesh.position.set(player.x || 0, player.y || 0, player.z || 0);
        remotePlayer.mesh.rotation.y = player.rotationY || 0;
        
        // Add to scene
        window.scene.add(remotePlayer.mesh);
        
        // Store in global collections - use otherPlayers as the single source of truth
        window.otherPlayers = window.otherPlayers || {};
        window.otherPlayers[player.sessionId] = remotePlayer;
        
        // Also store in visuals collection
        window.visuals = window.visuals || {};
        window.visuals.players = window.visuals.players || {};
        window.visuals.players[player.sessionId] = remotePlayer;
        
        console.log(`Created remote player object for ${player.sessionId}`);
        return remotePlayer;
    } catch (error) {
        console.error("Failed to create remote player:", error);
        return null;
    }
}

// Player left callback
function onPlayerLeave(player) {
    // Validate player data
    if (!player || !player.sessionId) {
        console.error("Invalid player in onPlayerLeave:", player);
        return;
    }
    
    console.log(`Player left: ${player.sessionId}`);
    
    try {
        // Remove player from the scene - check multiple collections
        // Check otherPlayers collection
        if (window.otherPlayers && window.otherPlayers[player.sessionId]) {
            console.log(`Removing player from otherPlayers: ${player.sessionId}`);
            
            // Remove mesh from scene
            if (window.scene && window.otherPlayers[player.sessionId].mesh) {
                window.scene.remove(window.otherPlayers[player.sessionId].mesh);
            }
            
            // Delete player object
            delete window.otherPlayers[player.sessionId];
        }
        
        // Also check visuals.players collection
        if (window.visuals && window.visuals.players && window.visuals.players[player.sessionId]) {
            console.log(`Removing player from visuals: ${player.sessionId}`);
            
            // Remove mesh from scene if not already removed
            if (window.scene && window.visuals.players[player.sessionId].mesh) {
                window.scene.remove(window.visuals.players[player.sessionId].mesh);
            }
            
            // Delete from visuals
            delete window.visuals.players[player.sessionId];
        }
        
        // Update the player list in the UI
        if (window.playerUI && typeof window.playerUI.updatePlayerListUI === 'function') {
            window.playerUI.updatePlayerListUI();
        } else {
            updatePlayerListUI();
        }
    } catch (error) {
        console.error("Error removing player:", error);
    }
}

// Update player list UI
window.updatePlayerListUI = function() {
    const playerListElement = document.getElementById('player-list');
    if (!playerListElement) return;
    
    // Clear current list
    playerListElement.innerHTML = '';
    
    // Ensure room and state are available
    if (!window.room || !window.room.state) {
        playerListElement.innerHTML = '<li>Not connected to server</li>';
        return;
    }
    
    // Add each player to the list
    window.room.state.players.forEach((player, key) => {
        const playerElement = document.createElement('li');
        
        // Highlight current player
        if (key === window.room.sessionId) {
            playerElement.classList.add('current-player');
        }
        
        // Show player info
        playerElement.innerHTML = `
            <span class="player-name">${player.name || 'Unnamed'}</span>
            <span class="player-value">${player.value || 1}</span>
        `;
        
        // Add to list
        playerListElement.appendChild(playerElement);
    });
};

// Update remote players in the scene - this runs in the animation loop
window.updateRemotePlayers = function() {
    if (!window.room || !window.room.state || !window.scene) {
        return;
    }
    
    // Debug log periodically to confirm this is running
    if (Math.random() < 0.001) {
        console.log("updateRemotePlayers running, player count:", window.room.state.players.size);
    }
    
    // First, collect all valid sessionIds from the server
    const serverPlayerIds = new Set();
    window.room.state.players.forEach((player, sessionId) => {
        if (sessionId && sessionId !== window.room.sessionId) {
            serverPlayerIds.add(sessionId);
        }
    });
    
    // Now process each player from the server
    window.room.state.players.forEach((player, sessionId) => {
        // Skip local player and invalid sessionIds
        if (!sessionId || sessionId === window.room.sessionId) return;
        
        // Create remote player object if it doesn't exist
        if (!window.otherPlayers || !window.otherPlayers[sessionId]) {
            console.log(`Creating missing remote player: ${sessionId}`);
            // Ensure we pass the sessionId in the player object
            const playerWithId = {
                ...player,
                sessionId: sessionId  // Explicitly set the sessionId
            };
            createRemotePlayerObject(playerWithId);
            return;
        }
        
        // Update remote player position and rotation using otherPlayers collection
        const remotePlayer = window.otherPlayers[sessionId];
        if (remotePlayer && remotePlayer.mesh) {
            // Update position with smooth lerping
            const lerpFactor = 0.3; // Smoothing factor for remote player movement
            
            remotePlayer.mesh.position.x = THREE.MathUtils.lerp(
                remotePlayer.mesh.position.x, 
                player.x, 
                lerpFactor
            );
            
            remotePlayer.mesh.position.y = THREE.MathUtils.lerp(
                remotePlayer.mesh.position.y, 
                player.y, 
                lerpFactor
            );
            
            remotePlayer.mesh.position.z = THREE.MathUtils.lerp(
                remotePlayer.mesh.position.z, 
                player.z, 
                lerpFactor
            );
            
            // Update rotation
            remotePlayer.mesh.rotation.y = player.rotationY;
            
            
            if (remotePlayer.value !== player.value) {
                try {
                    // Remove old mesh
                    if (remotePlayer.mesh.parent) {
                        remotePlayer.mesh.parent.remove(remotePlayer.mesh);
                    }
                    
                    // Create new entity with updated value
                    const newPlayerEntity = new PlayerEntity(player.value);
                    newPlayerEntity.id = sessionId;
                    newPlayerEntity.mesh.position.copy(remotePlayer.mesh.position);
                    newPlayerEntity.mesh.rotation.y = remotePlayer.mesh.rotation.y;
                    
                    // Add to scene
                    window.scene.add(newPlayerEntity.mesh);
                    
                    // Update reference in otherPlayers collection
                    window.otherPlayers[sessionId] = newPlayerEntity;
                    // Also update in visuals collection
                    if (window.visuals && window.visuals.players) {
                        window.visuals.players[sessionId] = newPlayerEntity;
                    }
                } catch (error) {
                    console.error("Error updating player value:", error);
                }
            }
        }
    });
    
    // Check for players in otherPlayers that no longer exist in the server state
    if (window.otherPlayers) {
        for (const sessionId in window.otherPlayers) {
            // Validate sessionId to avoid issues with undefined
            if (!sessionId || sessionId === "undefined") {
                console.error("Invalid sessionId in otherPlayers:", sessionId);
                delete window.otherPlayers[sessionId];
                continue;
            }
            
            // Check if this player still exists on the server
            if (!serverPlayerIds.has(sessionId)) {
                console.log(`Removing stale player: ${sessionId}`);
                onPlayerLeave({ sessionId: sessionId });
            }
        }
    }
};

// Setup room-level listeners specifically for Players
function setupRoomPlayerListeners(room) {
    if (!room || !room.state) {
        console.warn('[setupRoomPlayerListeners] Room or state not available yet.');
        return;
    }

    console.log('[setupRoomPlayerListeners] Setting up player listeners...');
    console.log('[setupRoomPlayerListeners] Current state structure:', Object.keys(room.state));
    console.log('[setupRoomPlayerListeners] Players collection exists:', !!room.state.players);
    
    if (room.state.players) {
        console.log('[setupRoomPlayerListeners] Current player count:', room.state.players.size);
        
        // Process existing players
        console.log('[setupRoomPlayerListeners] Processing existing players');
        room.state.players.forEach((player, sessionId) => {
            // Skip players without valid sessionId or local player
            if (!sessionId || sessionId === room.sessionId) return;
            
            console.log(`Setting up existing player: ${sessionId}`, player);
            
            // Create remote player for other players
            createRemotePlayerObject({...player, sessionId: sessionId});
        });
        
        // Update UI immediately to show all players
        if (window.playerUI && typeof window.playerUI.updatePlayerListUI === 'function') {
            window.playerUI.updatePlayerListUI();
        } else {
            updatePlayerListUI();
        }
        
        // Listen for player added events
        room.state.players.onAdd = (player, sessionId) => {
            // Skip invalid sessionIds or local player
            if (!sessionId || sessionId === room.sessionId) return;
            
            console.log(`Player added: ${sessionId}`, player);
            
            // Ensure the player object has a sessionId field
            const playerWithId = {...player, sessionId: sessionId};
            
            // Create remote player object
            createRemotePlayerObject(playerWithId);
            
            // Update UI
            if (window.playerUI && typeof window.playerUI.updatePlayerListUI === 'function') {
                window.playerUI.updatePlayerListUI();
            } else {
                updatePlayerListUI();
            }
        };
        
        // Listen for player removed events
        room.state.players.onRemove = (player, sessionId) => {
            // Skip invalid sessionIds or local player
            if (!sessionId || sessionId === room.sessionId) return;
            
            console.log(`Player removed: ${sessionId}`);
            
            // Remove player
            onPlayerLeave({ sessionId: sessionId });
            
            // Update UI
            if (window.playerUI && typeof window.playerUI.updatePlayerListUI === 'function') {
                window.playerUI.updatePlayerListUI();
            } else {
                updatePlayerListUI();
            }
        };
        
        // Listen for player changes
        room.state.players.onChange = (player, sessionId) => {
            // Skip invalid sessionIds or local player
            if (!sessionId || sessionId === room.sessionId) return;
            
            // For debugging
            if (Math.random() < 0.01) {
                console.log(`Player changed: ${sessionId}, pos: (${player.x.toFixed(2)}, ${player.y.toFixed(2)}, ${player.z.toFixed(2)})`);
            }
            
            // Update remote player - using otherPlayers consistently
            if (window.otherPlayers && window.otherPlayers[sessionId]) {
                // Update position with lerping for smooth movement
                const remotePlayer = window.otherPlayers[sessionId];
                const lerpFactor = 0.3; // Adjust for smoother/faster movement
                
                if (remotePlayer && remotePlayer.mesh) {
                    // Update position with lerping
                    remotePlayer.mesh.position.x = THREE.MathUtils.lerp(
                        remotePlayer.mesh.position.x,
                        player.x,
                        lerpFactor
                    );
                    
                    remotePlayer.mesh.position.y = THREE.MathUtils.lerp(
                        remotePlayer.mesh.position.y,
                        player.y,
                        lerpFactor
                    );
                    
                    remotePlayer.mesh.position.z = THREE.MathUtils.lerp(
                        remotePlayer.mesh.position.z,
                        player.z,
                        lerpFactor
                    );
                    
                    // Update rotation (no lerping for simplicity)
                    remotePlayer.mesh.rotation.y = player.rotationY;
                    
                    // Update player info in UI periodically
                    if (Math.random() < 0.01) { // Only update UI occasionally to save performance
                        if (window.playerUI && typeof window.playerUI.updatePlayerListUI === 'function') {
                            window.playerUI.updatePlayerListUI();
                        } else {
                            updatePlayerListUI();
                        }
                    }
                }
            } else {
                // If player exists in server state but not in otherPlayers, create it
                console.log(`Creating missing player from onChange: ${sessionId}`);
                createRemotePlayerObject({...player, sessionId: sessionId});
            }
        };
    } else {
        console.error('[setupRoomPlayerListeners] state.players not found!');
    }
    
    console.log('[setupRoomPlayerListeners] Room player listeners setup complete');
}

// Setup entity listeners for the room
function setupRoomListeners(room) {
    if (!room || !room.state) {
        console.error('[setupRoomListeners] Room or state not available');
        return;
    }
    
    console.log('[setupRoomListeners] Setting up entity listeners');
    
    // Ensure visuals collections exist
    window.visuals = window.visuals || {};
    window.visuals.operators = window.visuals.operators || {};
    window.visuals.staticEntities = window.visuals.staticEntities || {};
    
    // Check for entities collection
    if (room.state.entities) {
        console.log('[setupRoomListeners] Processing entities:', room.state.entities.size);
        
        // Process existing entities
        room.state.entities.forEach((entity, entityId) => {
            console.log(`Processing entity: ${entityId}, type: ${entity.type}`);
            
            // Handle different entity types
            if (entity.type === 'operator') {
                if (typeof window.createOperatorVisual === 'function') {
                    window.createOperatorVisual(entity, entityId);
                }
            } else if (entity.type === 'staticValueEntity') {
                if (typeof window.createStaticEntityVisual === 'function') {
                    window.createStaticEntityVisual(entity, entityId);
                }
            }
        });
        
        // Listen for entity added events
        if (typeof room.state.entities.onAdd === 'function') {
            room.state.entities.onAdd = (entity, entityId) => {
                console.log(`Entity added: ${entityId}, type: ${entity.type}`);
                
                // Handle different entity types
                if (entity.type === 'operator') {
                    if (typeof window.createOperatorVisual === 'function') {
                        window.createOperatorVisual(entity, entityId);
                    }
                } else if (entity.type === 'staticValueEntity') {
                    if (typeof window.createStaticEntityVisual === 'function') {
                        window.createStaticEntityVisual(entity, entityId);
                    }
                }
            };
        }
        
        // Listen for entity removed events
        if (typeof room.state.entities.onRemove === 'function') {
            room.state.entities.onRemove = (entity, entityId) => {
                console.log(`Entity removed: ${entityId}, type: ${entity.type}`);
                
                // Handle different entity types
                if (entity.type === 'operator') {
                    if (typeof window.removeOperatorVisual === 'function') {
                        window.removeOperatorVisual(entityId);
                    }
                } else if (entity.type === 'staticValueEntity') {
                    if (typeof window.removeStaticEntityVisual === 'function') {
                        window.removeStaticEntityVisual(entityId);
                    }
                }
            };
        }
    } else {
        console.log('[setupRoomListeners] No entities collection found');
    }
    
    console.log('[setupRoomListeners] Entity listeners setup complete');
}

// Clean up network resources when leaving
window.cleanupNetworking = function() {
    console.log("Cleaning up network resources");
    
    // Clear the player update interval if it exists
    if (window.playerUpdateInterval) {
        clearInterval(window.playerUpdateInterval);
        window.playerUpdateInterval = null;
    }
    
    // Unregister updateRemotePlayers if it was registered with the animation loop
    if (typeof window.unregisterAnimationCallback === 'function' && 
        typeof window.updateRemotePlayers === 'function') {
        window.unregisterAnimationCallback(window.updateRemotePlayers);
    }
    
    // Clean up other players
    if (window.otherPlayers) {
        for (const sessionId in window.otherPlayers) {
            if (sessionId) {  // Skip undefined keys
                try {
                    if (window.scene && window.otherPlayers[sessionId] && window.otherPlayers[sessionId].mesh) {
                        window.scene.remove(window.otherPlayers[sessionId].mesh);
                    }
                } catch (error) {
                    console.error(`Error removing player ${sessionId} from scene:`, error);
                }
            }
        }
        window.otherPlayers = {};
    }
    
    // Clean up visuals
    if (window.visuals && window.visuals.players) {
        window.visuals.players = {};
    }
    
    // Leave the room if connected
    if (window.room) {
        try {
            window.room.leave();
        } catch (error) {
            console.error("Error leaving room:", error);
        }
        window.room = null;
    }
    
    // Reset client
    client = null;
    room = null;
    
    console.log("Network resources cleaned up successfully");
};

// Make functions available globally
window.initNetworking = initNetworking;
window.setupMessageHandlers = setupMessageHandlers;
window.sendPlayerCollision = sendPlayerCollision;
window.getRandomColor = getRandomColor;
window.getColorForValue = getColorForValue;
window.CSS2DObject = CSS2DObject;
window.CSS2DRenderer = CSS2DRenderer;
window.onPlayerJoin = onPlayerJoin;
window.onPlayerLeave = onPlayerLeave;
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\NPC.js 
===================================================== 
 
// 3D AI Game Platform - Core NPC entity class

class NPC extends Entity {
    constructor(params) {
        super(params);
        
        // NPC-specific properties
        this.isStatic = params.isStatic || false;
        this.behaviorType = params.behaviorType || 'static';
        this.target = params.target || null;
        
        // Animation properties - base implementation
        this.animationState = {
            floating: {
                enabled: !this.isStatic,
                height: 0.5,
                speed: 1.0,
                time: Math.random() * Math.PI * 2 // Random start phase
            },
            rotating: {
                enabled: false,
                speed: 0.5
            }
        };
        
        // Set initial animation state
        this.setupAnimation();
    }
    
    setupAnimation() {
        // Only set up animation for non-static NPCs
        if (this.isStatic) {
            this.animationState.floating.enabled = false;
            this.animationState.rotating.enabled = false;
        }
    }
    
    // Base animation method - can be extended by implementations
    animate(deltaTime) {
        if (!this.mesh) return;
        
        // Handle floating animation
        if (this.animationState.floating.enabled) {
            this.animationState.floating.time += deltaTime * this.animationState.floating.speed;
            const floatHeight = Math.sin(this.animationState.floating.time) * this.animationState.floating.height;
            
            // Apply floating motion
            this.mesh.position.y = this.y + floatHeight;
        }
        
        // Handle rotation animation (if enabled)
        if (this.animationState.rotating.enabled) {
            this.mesh.rotation.y += this.animationState.rotating.speed * deltaTime;
        }
    }
    
    // Update position and also handle any animations
    updatePosition(position) {
        super.updatePosition(position);
        
        // Re-enable animations if needed
        this.setupAnimation();
    }
    
    // Base createMesh method - should be overridden by implementation-specific NPC classes
    createMesh() {
        console.warn("createMesh() method not implemented in NPC base class");
        
        // Create a simple placeholder mesh
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshStandardMaterial({ color: this.color || 0xFFFFFF });
        return new THREE.Mesh(geometry, material);
    }

    // Base methods for updating value and color - to be overridden by implementations
    updateValue(newValue) {
        super.updateValue(newValue);
    }

    updateColor(newColor) {
        super.updateColor(newColor);
    }
    
    // NPCs can have behavior in their update method
    update(deltaTime) {
        // Implement different behaviors
        switch (this.behaviorType) {
            case 'idle':
                // Do nothing
                break;
                
            case 'wander':
                // Random movement could be implemented by subclasses
                break;
                
            case 'follow':
                // Follow logic could be implemented by subclasses
                break;
        }
        
        // Animate the NPC
        this.animate(deltaTime);
    }
}

// Export the NPC class
if (typeof window !== 'undefined') {
    window.NPC = NPC;
}

if (typeof module !== 'undefined') {
    module.exports = { NPC };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\player-ui.js 
===================================================== 
 
// 3D AI Game Platform - Player UI module
// Handles player list UI and related functionality

class PlayerUI {
    constructor() {
        this.initialized = false;
    }
    
    // Initialize the player UI
    init() {
        if (this.initialized) return;
        
        this.initPlayerListState();
        this.setupPlayerListKeyControls();
        this.initialized = true;
    }
    
    // Update player list in UI
    updatePlayerListUI() {
        // Get player list container
        const playerList = document.getElementById('player-list');
        if (!playerList) {
            console.warn("Player list element not found");
            this.createPlayerListUI(); // Create if missing
            return;
        }
        
        try {
            // Clear current list
            playerList.innerHTML = '';
            
            let playerCount = 0;
            
            // Add myself first if available
            if (window.room && window.room.state && window.room.state.players) {
                try {
                    const mySessionId = window.room.sessionId;
                    let myPlayer = null;
                    
                    // Try different methods to get the player data
                    if (typeof window.room.state.players.get === 'function') {
                        myPlayer = window.room.state.players.get(mySessionId);
                    } else if (window.room.state.players[mySessionId]) {
                        myPlayer = window.room.state.players[mySessionId];
                    }
                    
                    if (myPlayer) {
                        this.addPlayerToList(myPlayer, mySessionId, true);
                        playerCount++;
                    } else if (window.playerEntity) {
                        // Show connected player UI
                        this.updatePlayerUI({
                            value: window.playerEntity.value || 1,
                            color: window.playerEntity.color || "#FFFF00"
                        });
                        playerCount++;
                    }
                    
                    // Log for debugging
                    console.log("Added local player to list. Players map size:", window.room.state.players.size);
                    
                    // Add other players - directly iterate over the Schema MapSchema
                    window.room.state.players.forEach((player, sessionId) => {
                        if (sessionId !== mySessionId) {
                            this.addPlayerToList(player, sessionId, false);
                            playerCount++;
                            console.log("Added remote player to list:", sessionId, player);
                        }
                    });
                } catch (e) {
                    console.error("Error iterating through players:", e);
                }
            }
            
            // Update player count in UI
            const playerCountElement = document.getElementById('player-count');
            if (playerCountElement) {
                playerCountElement.textContent = `(${playerCount})`;
            }
        } catch (error) {
            console.error("Error updating player list UI:", error);
        }
    }

    // Helper function to add a player to the list UI
    addPlayerToList(player, sessionId, isCurrentPlayer) {
        if (!player) return;
        
        try {
            // Get player list element
            const playerList = document.getElementById('player-list');
            if (!playerList) return;
            
            // Create player entry
            const playerEntry = document.createElement('div');
            playerEntry.className = 'player-entry';
            playerEntry.id = `player-${sessionId}`;
            
            // Add highlighting for current player
            if (isCurrentPlayer) {
                playerEntry.style.fontWeight = 'bold';
                playerEntry.style.backgroundColor = 'rgba(255,255,255,0.2)';
            }
            
            // Create color indicator
            const colorIndicator = document.createElement('div');
            colorIndicator.className = 'player-color';
            colorIndicator.style.backgroundColor = player.color || '#FFFFFF';
            
            // Create player info
            const playerInfo = document.createElement('div');
            playerInfo.className = 'player-info';
            
            // Format player name with value
            const playerName = player.name || `Player ${sessionId.substring(0, 4)}`;
            const playerValue = player.value || 1;
            playerInfo.textContent = `${playerName} (${playerValue})`;
            
            // Build entry
            playerEntry.appendChild(colorIndicator);
            playerEntry.appendChild(playerInfo);
            playerList.appendChild(playerEntry);
        } catch (error) {
            console.error("Error adding player to UI list:", error);
        }
    }

    // Set up key event listeners for player list toggle
    setupPlayerListKeyControls() {
        // Toggle player list on 'Tab' key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Tab') {
                event.preventDefault(); // Prevent default tab behavior
                this.togglePlayerList();
            }
        });
        
        // Set up click listener for header
        const playerListHeader = document.getElementById('player-list-header');
        if (playerListHeader) {
            playerListHeader.addEventListener('click', () => this.togglePlayerList());
        }
    }

    // Function to toggle player list visibility
    togglePlayerList() {
        const playerList = document.getElementById('player-list');
        const collapseIcon = document.getElementById('collapse-icon');
        
        if (!playerList || !collapseIcon) return;
        
        // Check current state
        const isCollapsed = playerList.style.display === 'none';
        
        // Toggle display
        playerList.style.display = isCollapsed ? 'block' : 'none';
        
        // Update icon
        collapseIcon.textContent = isCollapsed ? '' : '';
        
        // Save state in localStorage
        localStorage.setItem('playerListCollapsed', !isCollapsed);
    }

    // Initialize player list state from saved preference
    initPlayerListState() {
        try {
            // Get saved state
            const isCollapsed = localStorage.getItem('playerListCollapsed') === 'true';
            
            // Get elements
            const playerList = document.getElementById('player-list');
            const collapseIcon = document.getElementById('collapse-icon');
            
            if (playerList && collapseIcon) {
                // Set initial state
                playerList.style.display = isCollapsed ? 'none' : 'block';
                collapseIcon.textContent = isCollapsed ? '' : '';
            }
        } catch (error) {
            console.warn("Error initializing player list state:", error);
        }
    }
    
    // Create the player list UI elements if they don't exist
    createPlayerListUI() {
        // Check if player list UI already exists
        if (document.getElementById('player-list-container')) {
            return;
        }
        
        // Create container
        const container = document.createElement('div');
        container.id = 'player-list-container';
        container.className = 'ui-panel';
        
        // Create header
        const header = document.createElement('div');
        header.id = 'player-list-header';
        header.className = 'ui-panel-header';
        header.innerHTML = '<span id="collapse-icon"></span> Players <span id="player-count">(0)</span>';
        
        // Create list
        const list = document.createElement('div');
        list.id = 'player-list';
        list.className = 'ui-panel-content';
        
        // Build UI
        container.appendChild(header);
        container.appendChild(list);
        
        // Add to document
        document.body.appendChild(container);
        
        // Initialize state
        this.initPlayerListState();
    }
}

// Create and export a singleton instance
const playerUI = new PlayerUI();

// Export for use in other modules
if (typeof window !== 'undefined') {
    window.PlayerUI = PlayerUI;
    window.playerUI = playerUI;
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        playerUI.init();
    });
}

if (typeof module !== 'undefined') {
    module.exports = { PlayerUI, playerUI };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\Player.js 
===================================================== 
 
// 3D AI Game Platform - Core Player entity class

class Player extends Entity {
    constructor(params) {
        super(params);
        this.isPlayer = true;
        this.isLocalPlayer = params.isLocalPlayer || false;
        
        // Player-specific properties
        this.moveSpeed = params.moveSpeed || 5.0;
        this.jumpHeight = params.jumpHeight || 5.0;
        this.isJumping = false;
        this.isColliding = false;
        this.controls = null;
        
        // Create the player mesh if not already created
        if (!this.mesh && window.createPlayerEntity && window.scene) {
            this.value = params.value || 1;
            this.color = params.color || "#FFFF00";
            
            // Use createPlayerEntity function if available
            const playerEntity = window.createPlayerEntity(window.scene, this.value);
            if (playerEntity) {
                this.mesh = playerEntity.mesh;
                this.group = playerEntity.group;
            }
            
            // Apply color if specified
            if (playerEntity && playerEntity.updateColor && this.color) {
                playerEntity.updateColor(this.color);
            }
        }
        
        // This will be overridden in implementation-specific player classes
        if (this.isLocalPlayer && this.initLocalPlayer) {
            this.initLocalPlayer();
        }
    }
    
    // For local player, position is controlled by PointerLockControls
    // For remote players, position is updated via network
    updatePosition(position) {
        // Only update remote players via network updates
        if (!this.isLocalPlayer && this.mesh) {
            super.updatePosition(position);
        }
    }
    
    // Base method for creating player camera - to be implemented by subclasses
    createPlayerCamera() {
        if (this.isLocalPlayer) {
            console.warn("createPlayerCamera() method not implemented in Player base class");
        }
    }
    
    // Base method for handling player input - to be implemented by subclasses
    handleInput(inputState) {
        if (this.isLocalPlayer) {
            console.warn("handleInput() method not implemented in Player base class");
        }
    }
    
    // Base createMesh method - should be overridden by implementation-specific player classes
    createMesh() {
        // Create a simple box player
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshStandardMaterial({ 
            color: this.color || 0xFFFF00,
            roughness: 0.7,
            metalness: 0.2
        });
        
        const mesh = new THREE.Mesh(geometry, material);
        // Add shadow casting
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        
        return mesh;
    }

    // Base methods for updating value and color - to be overridden by implementations
    updateValue(newValue) {
        super.updateValue(newValue);
    }

    updateColor(newColor) {
        super.updateColor(newColor);
    }
}

// Make available globally
window.Player = Player;

// Export for use in other modules
if (typeof module !== 'undefined') {
    module.exports = { Player };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\core\rts-view.js 
===================================================== 
 
// RTS View Manager
// Handles 2D top-down real-time strategy view

// Global RTS mode state
window.isRTSViewActive = false;
window.rtsViewLastMode = 'firstperson';
window.rtsCameraHeight = 100; // Much higher camera height for zoomed out view
window.rtsSelectedUnit = null;
window.rtsViewPanSpeed = 0.5;
window.rtsMoveTarget = null;
window.rtsMapSize = 500; // Increased map size (10x larger)

// Initialize RTS view
window.initRTSView = function() {
    console.log("Initializing RTS view");
    
    // Set up event listeners for RTS controls
    document.addEventListener('mousemove', handleRTSMouseMove);
    document.addEventListener('mousedown', handleRTSMouseDown);
    
    // Create minimap
    createRTSMinimap();
    
    // Set initial camera settings
    window.rtsCameraHeight = 100;
    
    // Add event listeners for RTS mode
    document.addEventListener('mousedown', onRTSMouseDown);
    document.addEventListener('contextmenu', function(event) {
        // Prevent context menu in RTS mode
        if (window.isRTSViewActive) {
            event.preventDefault();
        }
    });
    
    console.log("RTS view initialized");
};

// Toggle RTS view mode
window.toggleRTSView = function() {
    if (!window.scene || !window.camera) {
        console.error("Cannot toggle RTS view, scene or camera not available");
        return;
    }
    
    window.isRTSViewActive = !window.isRTSViewActive;
    
    if (window.isRTSViewActive) {
        // Store current view mode to return to later
        window.rtsViewLastMode = window.viewMode;
        
        // Enter RTS view
        console.log("Entering RTS view");
        document.body.style.cursor = 'default'; // Show cursor
        
        // Release pointer lock if active
        if (document.pointerLockElement) {
            document.exitPointerLock();
        }
        
        // Position camera for top-down view
        if (window.playerEntity && window.playerEntity.mesh) {
            const playerPos = window.playerEntity.mesh.position.clone();
            window.camera.position.set(playerPos.x, playerPos.y + window.rtsCameraHeight, playerPos.z);
            window.camera.lookAt(playerPos.x, playerPos.y, playerPos.z);
            window.camera.up.set(0, 0, -1); // Make camera look properly down
        } else {
            window.camera.position.set(0, window.rtsCameraHeight, 0);
            window.camera.lookAt(0, 0, 0);
            window.camera.up.set(0, 0, -1);
        }
        
        // Update camera to orthographic for RTS view - much more zoomed out
        const aspect = window.innerWidth / window.innerHeight;
        const viewSize = 100; // Much larger value for zoomed out view
        window.rtsOrthographicCamera = new THREE.OrthographicCamera(
            -viewSize * aspect, viewSize * aspect, viewSize, -viewSize, 1, 1000
        );
        
        // Copy position and rotation
        window.rtsOrthographicCamera.position.copy(window.camera.position);
        window.rtsOrthographicCamera.rotation.copy(window.camera.rotation);
        window.rtsOrthographicCamera.up.copy(window.camera.up);
        
        // Store perspective camera for later
        window.rtsPerspectiveCamera = window.camera;
        
        // Switch to orthographic camera
        window.camera = window.rtsOrthographicCamera;
        
        // Show the RTS UI elements
        showRTSUI();
        
        // Update RTS toggle button
        const rtsToggleBtn = document.getElementById('rts-toggle');
        if (rtsToggleBtn) {
            rtsToggleBtn.textContent = 'Exit RTS View (R)';
        }
        
        // Ensure controls don't re-lock the pointer in RTS mode
        if (window.controls && typeof window.controls.unlock === 'function') {
            window.controls.unlock();
        }
        
        // Disable pointer lock in RTS mode
        if (document.exitPointerLock) {
            document.exitPointerLock();
        }
    } else {
        // Exit RTS view
        console.log("Exiting RTS view, returning to " + window.rtsViewLastMode);
        
        // Switch back to perspective camera
        if (window.rtsPerspectiveCamera) {
            window.camera = window.rtsPerspectiveCamera;
        }
        
        // Return to previous view mode
        switch (window.rtsViewLastMode) {
            case 'firstPerson':
                if (typeof window.switchToFirstPersonView === 'function') {
                    window.switchToFirstPersonView();
                }
                break;
            case 'thirdPerson':
                if (typeof window.switchToThirdPersonView === 'function') {
                    window.switchToThirdPersonView();
                }
                break;
            case 'freeCamera':
                if (typeof window.switchToFreeCameraView === 'function') {
                    window.switchToFreeCameraView();
                }
                break;
            default:
                if (typeof window.switchToFirstPersonView === 'function') {
                    window.switchToFirstPersonView();
                }
        }
        
        // Hide the RTS UI elements
        hideRTSUI();
        
        // Update RTS toggle button
        const rtsToggleBtn = document.getElementById('rts-toggle');
        if (rtsToggleBtn) {
            rtsToggleBtn.textContent = 'RTS View (R)';
        }
    }
    
    // Force a render to update the view immediately
    if (window.renderer && window.scene) {
        window.renderer.render(window.scene, window.camera);
    }
};

// Handle RTS mouse movements
function handleRTSMouseMove(event) {
    if (!window.isRTSViewActive) return;
    
    // Store mouse position for raycasting
    window.rtsMouse = {
        x: (event.clientX / window.innerWidth) * 2 - 1,
        y: -(event.clientY / window.innerHeight) * 2 + 1
    };
}

// Handle RTS mouse clicks
function handleRTSMouseDown(event) {
    if (!window.isRTSViewActive || !window.scene || !window.camera) return;
    
    // Left click - unit selection
    if (event.button === 0) {
        selectUnitUnderMouse();
    }
    // Right click - movement command
    else if (event.button === 2) {
        moveSelectedUnitToTarget();
    }
}

// Select unit under mouse
function selectUnitUnderMouse() {
    if (!window.isRTSViewActive || !window.rtsMouse) return;
    
    // Raycasting for unit selection
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(window.rtsMouse, window.camera);
    
    // Get all unit meshes
    const selectableUnits = [];
    
    // Add player entities
    if (window.room && window.room.state && window.room.state.players) {
        window.room.state.players.forEach(player => {
            if (player.id && window.visuals && window.visuals.players[player.id] && 
                window.visuals.players[player.id].mesh) {
                selectableUnits.push(window.visuals.players[player.id].mesh);
            }
        });
    }
    
    // Check for intersections
    const intersects = raycaster.intersectObjects(selectableUnits, true);
    
    if (intersects.length > 0) {
        // Find the player that owns this mesh
        if (window.room && window.room.state && window.room.state.players) {
            window.room.state.players.forEach(player => {
                if (player.id && window.visuals && window.visuals.players[player.id] && 
                    window.visuals.players[player.id].mesh === intersects[0].object ||
                    window.visuals.players[player.id].mesh.children.includes(intersects[0].object)) {
                    
                    // Select this unit
                    window.rtsSelectedUnit = player.id;
                    console.log("Selected unit:", player.id);
                    
                    // Visual feedback for selection
                    highlightSelectedUnit();
                }
            });
        }
    } else {
        // Deselect if clicking empty space
        window.rtsSelectedUnit = null;
        clearUnitHighlights();
    }
}

// Highlight the currently selected unit
function highlightSelectedUnit() {
    // Clear previous highlights
    clearUnitHighlights();
    
    // Add highlight to selected unit
    if (window.rtsSelectedUnit && window.visuals && window.visuals.players[window.rtsSelectedUnit]) {
        const selectedMesh = window.visuals.players[window.rtsSelectedUnit].mesh;
        
        // Create selection box
        const boxSize = 2.5; // Slightly larger than the unit
        const geometry = new THREE.BoxGeometry(boxSize, boxSize, boxSize);
        
        // Create wireframe material
        const material = new THREE.MeshBasicMaterial({
            color: 0xffffff,
            wireframe: true,
            transparent: true,
            opacity: 0.8
        });
        
        const highlight = new THREE.Mesh(geometry, material);
        highlight.name = 'selection-highlight';
        
        // Position at same height as unit
        highlight.position.y = 0;
        
        selectedMesh.add(highlight);
        
        console.log("Added highlight to unit:", window.rtsSelectedUnit);
    }
}

// Clear all unit highlights
function clearUnitHighlights() {
    if (window.visuals) {
        Object.values(window.visuals.players).forEach(player => {
            if (player.mesh) {
                const highlight = player.mesh.getObjectByName('selection-highlight');
                if (highlight) {
                    player.mesh.remove(highlight);
                }
            }
        });
    }
}

// Move selected unit to target position
function moveSelectedUnitToTarget() {
    if (!window.isRTSViewActive || !window.rtsSelectedUnit || !window.rtsMouse) return;
    
    // Only the local player can be moved
    if (window.rtsSelectedUnit !== window.room.sessionId) {
        console.log("Cannot move other players' units");
        return;
    }
    
    // Raycasting to find target position on ground
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(window.rtsMouse, window.camera);
    
    // Find intersection with ground plane
    const groundPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
    const targetPoint = new THREE.Vector3();
    raycaster.ray.intersectPlane(groundPlane, targetPoint);
    
    // Set move target
    window.rtsMoveTarget = targetPoint;
    
    // Store the target position for rendering a marker
    showMoveTargetMarker(targetPoint);
    
    // Send movement command to server
    if (window.room) {
        window.room.send("playerMove", {
            x: targetPoint.x,
            y: targetPoint.y,
            z: targetPoint.z
        });
    }
    
    console.log("Moving to:", targetPoint);
}

// Show visual marker at move target position
function showMoveTargetMarker(position) {
    // Remove any existing marker
    const existingMarker = window.scene.getObjectByName('move-target-marker');
    if (existingMarker) {
        window.scene.remove(existingMarker);
    }
    
    // Create a new marker
    const geometry = new THREE.RingGeometry(0.8, 1, 32);
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x00ffff,
        side: THREE.DoubleSide,
        transparent: true,
        opacity: 0.6
    });
    
    const marker = new THREE.Mesh(geometry, material);
    marker.position.copy(position);
    marker.position.y = 0.1; // Slightly above ground
    marker.rotation.x = -Math.PI / 2; // Lay flat
    marker.name = 'move-target-marker';
    
    // Add to scene
    window.scene.add(marker);
    
    // Set up automatic removal after 2 seconds
    setTimeout(() => {
        const marker = window.scene.getObjectByName('move-target-marker');
        if (marker) {
            window.scene.remove(marker);
        }
    }, 2000);
}

// Handle camera panning in RTS view with WASD keys
window.updateRTSView = function(delta) {
    if (!window.isRTSViewActive) return;
    
    // Handle camera panning with WASD
    handleRTSCameraPanning(delta);
    
    // Update minimap
    updateRTSMinimap();
};

// Handle camera panning in RTS view
function handleRTSCameraPanning(delta) {
    if (!window.isRTSViewActive || !window.camera) return;
    
    // Calculate pan speed based on delta time and map size
    const panSpeed = 25 * delta; // Increased for larger map
    
    // Pan based on WASD keys
    if (window.inputState.keys.w) {
        window.camera.position.z -= panSpeed;
    }
    if (window.inputState.keys.s) {
        window.camera.position.z += panSpeed;
    }
    if (window.inputState.keys.a) {
        window.camera.position.x -= panSpeed;
    }
    if (window.inputState.keys.d) {
        window.camera.position.x += panSpeed;
    }
}

// Create 2D icons for entities in RTS mode
function createRTSIcons() {
    // Create simple sprite materials for different entities
    window.rtsIcons = {
        player: new THREE.SpriteMaterial({
            color: 0x00ff00,
            map: createIconTexture('P', 64, 64, 0x00ff00)
        }),
        otherPlayer: new THREE.SpriteMaterial({
            color: 0x0000ff,
            map: createIconTexture('P', 64, 64, 0x0000ff)
        }),
        npc: new THREE.SpriteMaterial({
            color: 0xffff00,
            map: createIconTexture('N', 64, 64, 0xffff00)
        }),
        object: new THREE.SpriteMaterial({
            color: 0xaaaaaa,
            map: createIconTexture('O', 64, 64, 0xaaaaaa)
        })
    };
    
    // Create selection indicator
    window.rtsIcons.selection = new THREE.SpriteMaterial({
        color: 0xffffff,
        map: createSelectionTexture(128, 128)
    });
}

// Create a texture with text for icons
function createIconTexture(text, width, height, color) {
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const context = canvas.getContext('2d');
    
    // Fill background as circle
    context.beginPath();
    context.arc(width/2, height/2, width/2 - 4, 0, 2 * Math.PI);
    context.fillStyle = 'white';
    context.fill();
    
    // Add border
    context.lineWidth = 2;
    context.strokeStyle = '#000000';
    context.stroke();
    
    // Add text
    context.font = 'bold ' + Math.floor(width/2) + 'px Arial';
    context.textAlign = 'center';
    context.textBaseline = 'middle';
    context.fillStyle = '#000000';
    context.fillText(text, width/2, height/2);
    
    const texture = new THREE.Texture(canvas);
    texture.needsUpdate = true;
    return texture;
}

// Create a texture for selection indicator
function createSelectionTexture(width, height) {
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const context = canvas.getContext('2d');
    
    // Draw selection circle
    context.beginPath();
    context.arc(width/2, height/2, width/2 - 4, 0, 2 * Math.PI);
    context.lineWidth = 4;
    context.strokeStyle = 'rgba(255, 255, 255, 0.8)';
    context.stroke();
    
    // Add animated dots around circle (for static texture, we'll show them fixed)
    const dotCount = 8;
    const radius = width/2 - 2;
    context.fillStyle = 'white';
    for (let i = 0; i < dotCount; i++) {
        const angle = (i / dotCount) * Math.PI * 2;
        const x = width/2 + Math.cos(angle) * radius;
        const y = height/2 + Math.sin(angle) * radius;
        context.beginPath();
        context.arc(x, y, 4, 0, 2 * Math.PI);
        context.fill();
    }
    
    const texture = new THREE.Texture(canvas);
    texture.needsUpdate = true;
    return texture;
}

// Create minimap for RTS view
function createRTSMinimap() {
    // Create minimap canvas
    const canvas = document.createElement('canvas');
    canvas.id = 'rts-minimap';
    canvas.width = 200;
    canvas.height = 200;
    canvas.style.position = 'absolute';
    canvas.style.bottom = '20px';
    canvas.style.left = '20px';
    canvas.style.border = '2px solid white';
    canvas.style.borderRadius = '5px';
    canvas.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    canvas.style.zIndex = '1000';
    canvas.style.display = 'none'; // Hidden by default, shown when RTS mode is active
    
    // Add canvas to document
    document.body.appendChild(canvas);
    
    // Store canvas and context for later use
    window.rtsMinimap = {
        canvas: canvas,
        context: canvas.getContext('2d')
    };
    
    console.log("RTS minimap created");
}

// Update the RTS minimap
function updateRTSMinimap() {
    if (!window.rtsMinimap || !window.rtsMinimap.context || !window.rtsMinimap.canvas) {
        createRTSMinimap();
    }
    
    if (!window.rtsMinimap || !window.isRTSViewActive) return;
    
    const { canvas, context } = window.rtsMinimap;
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear previous frame
    context.clearRect(0, 0, width, height);
    
    // Draw background
    context.fillStyle = '#0a1a2a';
    context.fillRect(0, 0, width, height);
    
    // Draw border
    context.strokeStyle = '#3a9bda';
    context.lineWidth = 2;
    context.strokeRect(2, 2, width-4, height-4);
    
    // Calculate scale - how much minimap space represents one unit in the game
    // Adjust for larger map size
    const mapSize = window.rtsMapSize || 500;
    const scale = width / (mapSize * 2); // Scale to fit entire map
    
    // Center of minimap
    const centerX = width / 2;
    const centerY = height / 2;
    
    // Draw all players
    if (window.room && window.room.state && window.room.state.players) {
        window.room.state.players.forEach(player => {
            // Draw dot on minimap
            const minimapX = centerX + player.x * scale;
            const minimapY = centerY + player.z * scale;
            
            // Different color for local player vs other players
            if (player.id === window.room.sessionId) {
                context.fillStyle = '#00ff00'; // Green for local player
            } else {
                context.fillStyle = '#0088ff'; // Blue for other players
            }
            
            // Draw player dot
            context.beginPath();
            context.arc(minimapX, minimapY, 3, 0, 2 * Math.PI);
            context.fill();
        });
    }
    
    // Draw camera view area
    if (window.camera) {
        drawCameraFrustum(centerX, centerY, scale);
    }
}

// Draw a dot on the minimap
function drawMinimapDot(x, y, size, color) {
    const { context } = window.rtsMinimap;
    context.beginPath();
    context.arc(x, y, size, 0, 2 * Math.PI);
    context.fillStyle = color;
    context.fill();
    context.lineWidth = 1;
    context.strokeStyle = '#ffffff';
    context.stroke();
}

// Draw camera frustum/view direction on minimap
function drawCameraFrustum(centerX, centerY, scale) {
    if (!window.camera || !window.rtsMinimap) return;
    
    const { context } = window.rtsMinimap;
    
    // Get player position
    let x = 0, z = 0;
    if (window.playerEntity && window.playerEntity.mesh) {
        x = window.playerEntity.mesh.position.x;
        z = window.playerEntity.mesh.position.z;
    } else if (window.camera) {
        x = window.camera.position.x;
        z = window.camera.position.z;
    }
    
    // Draw player position indicator (simple dot)
    const viewX = centerX + x * scale;
    const viewZ = centerY + z * scale;
    
    context.beginPath();
    context.arc(viewX, viewZ, 4, 0, 2 * Math.PI);
    context.fillStyle = '#ffffff';
    context.fill();
}

// Show RTS UI elements
function showRTSUI() {
    // Show minimap
    if (window.rtsMinimap && window.rtsMinimap.canvas) {
        window.rtsMinimap.canvas.style.display = 'block';
    } else {
        // Create minimap if it doesn't exist
        createRTSMinimap();
        if (window.rtsMinimap && window.rtsMinimap.canvas) {
            window.rtsMinimap.canvas.style.display = 'block';
        }
    }
    
    // Add RTS mode indicator
    let rtsModeIndicator = document.getElementById('rts-mode-indicator');
    if (!rtsModeIndicator) {
        rtsModeIndicator = document.createElement('div');
        rtsModeIndicator.id = 'rts-mode-indicator';
        rtsModeIndicator.style.position = 'absolute';
        rtsModeIndicator.style.top = '20px';
        rtsModeIndicator.style.left = '20px';
        rtsModeIndicator.style.color = 'white';
        rtsModeIndicator.style.fontSize = '16px';
        rtsModeIndicator.style.fontWeight = 'bold';
        rtsModeIndicator.style.textShadow = '1px 1px 2px black';
        rtsModeIndicator.style.zIndex = '1000';
        document.body.appendChild(rtsModeIndicator);
    }
    rtsModeIndicator.textContent = 'RTS MODE - Use WASD to pan camera';
    rtsModeIndicator.style.display = 'block';
}

// Hide RTS UI elements
function hideRTSUI() {
    // Hide minimap
    if (window.rtsMinimap && window.rtsMinimap.canvas) {
        window.rtsMinimap.canvas.style.display = 'none';
    }
    
    // Hide RTS mode indicator
    const rtsModeIndicator = document.getElementById('rts-mode-indicator');
    if (rtsModeIndicator) {
        rtsModeIndicator.style.display = 'none';
    }
}

// RTS mouse handlers
function onRTSMouseDown(event) {
    if (!window.isRTSViewActive) return;
    
    if (event.button === 0) { // Left mouse button
        // Select units
        selectUnitsAtPosition(event.clientX, event.clientY);
    } else if (event.button === 2) { // Right mouse button
        // Move selected units
        moveSelectedUnits(event.clientX, event.clientY);
    }
}

function onRTSMouseUp(event) {
    if (!window.isRTSViewActive) return;
    
    // Handle any mouse up events specific to RTS mode
}

function onRTSMouseMove(event) {
    if (!window.isRTSViewActive) return;
    
    // Handle mouse move events for RTS mode
    // For example, show hover effects or update selection box
}

function onRTSMouseWheel(event) {
    if (!window.isRTSViewActive) return;
    
    // Handle mouse wheel for zooming in RTS mode
    event.preventDefault();
    
    // Adjust orthographic camera zoom
    if (window.camera && window.camera.isOrthographicCamera) {
        // Determine zoom direction
        const zoomFactor = event.deltaY > 0 ? 1.1 : 0.9;
        
        // Apply zoom to orthographic camera
        window.camera.left *= zoomFactor;
        window.camera.right *= zoomFactor;
        window.camera.top *= zoomFactor;
        window.camera.bottom *= zoomFactor;
        window.camera.updateProjectionMatrix();
        
        // Adjust RTS view zoom
        window.rtsViewZoom *= (event.deltaY > 0 ? 0.9 : 1.1);
        window.rtsViewZoom = THREE.MathUtils.clamp(window.rtsViewZoom, 0.5, 3.0);
        
        console.log("RTS zoom level:", window.rtsViewZoom.toFixed(2));
    }
}

// Select units at a screen position
function selectUnitsAtPosition(x, y) {
    if (!window.isRTSViewActive) return;
    
    // Clear previous selection
    window.rtsSelectedUnits = [];
    
    // Cast a ray to find clickable objects
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    
    // Convert mouse position to normalized device coordinates
    mouse.x = (x / window.innerWidth) * 2 - 1;
    mouse.y = -(y / window.innerHeight) * 2 + 1;
    
    // Update the raycaster
    raycaster.setFromCamera(mouse, window.camera);
    
    // Find intersections with selectable objects
    const selectableObjects = [];
    
    // Add the player entity if it exists
    if (window.playerEntity && window.playerEntity.mesh) {
        selectableObjects.push(window.playerEntity.mesh);
    }
    
    // Add other players if available
    if (window.otherPlayers) {
        Object.values(window.otherPlayers).forEach(player => {
            if (player.mesh) {
                selectableObjects.push(player.mesh);
            }
        });
    }
    
    const intersects = raycaster.intersectObjects(selectableObjects, true);
    
    if (intersects.length > 0) {
        // Get the first intersection
        const selectedObject = intersects[0].object;
        
        // Add to selected units
        window.rtsSelectedUnits.push(selectedObject);
        
        // Add selection indicator
        addSelectionIndicator(selectedObject);
        
        console.log("Selected unit:", selectedObject);
    }
}

// Add selection indicator to a selected unit
function addSelectionIndicator(object) {
    // Remove existing selection indicators
    removeSelectionIndicators();
    
    // Create a new selection indicator
    if (window.rtsIcons && window.rtsIcons.selection) {
        const selectionIndicator = new THREE.Sprite(window.rtsIcons.selection);
        selectionIndicator.scale.set(5, 5, 1); // Make it larger than the unit
        
        // Position it slightly below the unit to avoid z-fighting
        selectionIndicator.position.copy(object.position);
        selectionIndicator.position.y = 0.1;
        
        // Mark it as a selection indicator
        selectionIndicator.userData.isSelectionIndicator = true;
        
        // Add to scene
        window.scene.add(selectionIndicator);
    }
}

// Remove all selection indicators from the scene
function removeSelectionIndicators() {
    if (!window.scene) return;
    
    const indicatorsToRemove = [];
    
    // Find all selection indicators
    window.scene.traverse(object => {
        if (object.userData && object.userData.isSelectionIndicator) {
            indicatorsToRemove.push(object);
        }
    });
    
    // Remove them from the scene
    indicatorsToRemove.forEach(indicator => {
        window.scene.remove(indicator);
    });
}

// Move selected units to a position
function moveSelectedUnits(x, y) {
    if (!window.isRTSViewActive || window.rtsSelectedUnits.length === 0) return;
    
    // Cast a ray to find the target position on the ground
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    
    // Convert mouse position to normalized device coordinates
    mouse.x = (x / window.innerWidth) * 2 - 1;
    mouse.y = -(y / window.innerHeight) * 2 + 1;
    
    // Update the raycaster
    raycaster.setFromCamera(mouse, window.camera);
    
    // Create a virtual ground plane if needed
    const groundY = 0; // Assume ground is at Y=0
    const groundPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -groundY);
    
    // Find intersection with ground plane
    const targetPosition = new THREE.Vector3();
    raycaster.ray.intersectPlane(groundPlane, targetPosition);
    
    // If got a valid target position
    if (targetPosition) {
        console.log("Moving selected units to:", targetPosition);
        
        // Send a move command for the player if they're selected
        if (window.playerEntity && window.rtsSelectedUnits.includes(window.playerEntity.mesh)) {
            // Send movement command to server
            if (window.room) {
                window.room.send("moveToPosition", {
                    x: targetPosition.x,
                    y: targetPosition.y,
                    z: targetPosition.z
                });
            }
            
            // Show click indicator
            showClickIndicator(targetPosition);
        }
    }
}

// Show click indicator at the target position
function showClickIndicator(position) {
    // Create a simple click indicator
    const geometry = new THREE.RingGeometry(0.5, 0.7, 16);
    const material = new THREE.MeshBasicMaterial({ 
        color: 0x00ff00,
        transparent: true,
        opacity: 0.7,
        side: THREE.DoubleSide
    });
    
    const indicator = new THREE.Mesh(geometry, material);
    indicator.rotation.x = -Math.PI / 2; // Lay flat on the ground
    indicator.position.copy(position);
    indicator.position.y = 0.1; // Slightly above ground
    
    // Add to scene
    window.scene.add(indicator);
    
    // Animate and remove after a short time
    const startTime = Date.now();
    const duration = 1000; // 1 second
    
    function animateIndicator() {
        const elapsed = Date.now() - startTime;
        const progress = elapsed / duration;
        
        if (progress >= 1) {
            // Remove indicator when animation is complete
            window.scene.remove(indicator);
            return;
        }
        
        // Scale up over time
        const scale = 1 + progress * 2;
        indicator.scale.set(scale, scale, scale);
        
        // Fade out
        material.opacity = 0.7 * (1 - progress);
        
        // Continue animation
        requestAnimationFrame(animateIndicator);
    }
    
    // Start animation
    animateIndicator();
}

// Register RTS view update function
if (typeof window.registerAnimationCallback === 'function') {
    window.registerAnimationCallback(window.updateRTSView);
}
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\client\js\implementations\default\DefaultPlayer.js 
===================================================== 
 
// Default Implementation - Player class
// Simple player with a box representation

class DefaultPlayer extends Player {
    constructor(params) {
        super(params);
        
        // Use color from params, gameConfig, or fallback to default blue
        this.color = params.color || 
                     (window.gameConfig && window.gameConfig.playerSettings.playerColor) || 
                     0x3366CC;
    }
    
    // Create a simple box mesh
    createMesh() {
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshStandardMaterial({ 
            color: this.color,
            roughness: 0.7,
            metalness: 0.2
        });
        
        const mesh = new THREE.Mesh(geometry, material);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        
        return mesh;
    }
    
    // Override update function for any player-specific logic
    update(deltaTime) {
        // Any default player-specific update logic goes here
        
        // Always call the parent update function
        super.update(deltaTime);
    }
}

// Register this class with the entity factory if available
if (window.entityFactory) {
    window.entityFactory.registerType('defaultPlayer', DefaultPlayer);
}

// Make available globally
if (typeof window !== 'undefined') {
    window.DefaultPlayer = DefaultPlayer;
}

if (typeof module !== 'undefined') {
    module.exports = { DefaultPlayer };
}  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\BaseRoom.js 
===================================================== 
 
const { Room } = require("colyseus");
const { GameState } = require("./schemas/GameState");
const { Player, MoveTarget } = require("./schemas/Player");
const { BaseEntity } = require("./schemas/BaseEntity");
const { Structure } = require("./schemas/Structure");

/**
 * Base room class for all game implementations
 * Provides common functionality for all game rooms
 */
class BaseRoom extends Room {
    /**
     * Called when room is created
     * @param {Object} options Room creation options
     */
    onCreate(options) {
        console.log("BaseRoom created!", options);
        
        // Initialize room state with a new GameState
        this.setState(new GameState());
        
        // Set maximum number of clients
        this.maxClients = 10;
        
        // Set frequency of patches to send
        this.setPatchRate(1000 / 30); // 30 fps
        
        // Set simulation interval for server-side logic
        this.setSimulationInterval(() => this.update());
        
        // Initialize spawn system
        this.initializeSpawnSystem();
        
        // Initialize implementation - to be implemented by subclasses
        this.initializeImplementation(options);
        
        // Listen for input updates
        this.onMessage("updateInput", (client, message) => {
            this.handleInputUpdate(client, message);
        });
        
        // Listen for entity interaction messages
        this.onMessage("entityInteraction", (client, message) => {
            this.handleEntityInteraction(client, message);
        });
        
        // Listen for RTS move commands
        this.onMessage("moveCommand", (client, message) => {
            this.handleMoveCommand(client, message);
        });
        
        // Listen for structure placement
        this.onMessage("placeStructure", (client, message) => {
            this.handlePlaceStructure(client, message);
        });
        
        // Listen for structure demolish
        this.onMessage("demolishStructure", (client, message) => {
            this.handleDemolishStructure(client, message);
        });
    }
    
    /**
     * Initialize entity spawn system
     * Provides base functionality for spawning entities periodically
     */
    initializeSpawnSystem() {
        // Base spawn system properties
        this.spawnTimer = 0;
        this.spawnInterval = 10; // Default 10 seconds
        this.maxEntities = 20;   // Default maximum entities
        this.spawnEnabled = false; // Disabled by default
    }
    
    /**
     * Initialize implementation-specific functionality
     * To be overridden by subclasses
     * @param {Object} options Room creation options
     */
    initializeImplementation(options) {
        // Base implementation does nothing
        console.log("Base implementation initialized");
    }
    
    /**
     * Handle input update message from client
     * @param {Client} client The client that sent the message
     * @param {Object} message The message sent by the client
     */
    handleInputUpdate(client, message) {
        const player = this.state.players.get(client.sessionId);
        if (!player) return;
        
        // Update individual keys instead of replacing the entire keys object
        if (message.keys) {
            player.input.keys.w = !!message.keys.w;
            player.input.keys.a = !!message.keys.a;
            player.input.keys.s = !!message.keys.s;
            player.input.keys.d = !!message.keys.d;
            player.input.keys.space = !!message.keys.space;
            player.input.keys.q = !!message.keys.q;
            player.input.keys.e = !!message.keys.e;
            player.input.keys.shift = !!message.keys.shift;
        }
        
        // Fix mouseDelta assignment - update properties instead of replacing the object
        if (message.mouseDelta) {
            player.input.mouseDelta.x = message.mouseDelta.x || 0;
            player.input.mouseDelta.y = message.mouseDelta.y || 0;
        } else {
            player.input.mouseDelta.x = 0;
            player.input.mouseDelta.y = 0;
        }
        
        player.input.viewMode = message.viewMode || "third-person";
        player.input.thirdPersonCameraAngle = message.thirdPersonCameraAngle || 0;
        
        // Apply direct client rotation if provided (for immediate, responsive feel)
        if (message.clientRotation) {
            player.rotationY = message.clientRotation.rotationY;
            player.pitch = message.clientRotation.pitch;
        }
    }
    
    /**
     * Handle entity interaction message from client
     * Base implementation for entity interactions like collecting or triggering entities
     * @param {Client} client The client that sent the message
     * @param {Object} message The message containing entityId and interaction type
     */
    handleEntityInteraction(client, message) {
        const player = this.state.players.get(client.sessionId);
        const entity = this.state.entities.get(message.entityId);
        
        if (!player || !entity) return;
        
        // Call implementation-specific entity interaction handler
        this.onEntityInteraction(player, entity, message.interactionType);
    }
    
    /**
     * Handle move command from RTS view
     * Sets target destination for player movement
     * @param {Client} client The client that sent the message
     * @param {Object} message The message containing x and z coordinates
     */
    handleMoveCommand(client, message) {
        const player = this.state.players.get(client.sessionId);
        if (!player) return;
        
        // Store target destination
        player.moveTarget.x = message.x;
        player.moveTarget.z = message.z;
        
        // Set a flag indicating the player is being controlled by RTS commands
        player.isRTSControlled = true;
        
        console.log(`RTS move command: Player ${client.sessionId} moving to (${message.x}, ${message.z})`);
    }
    
    /**
     * Implementation-specific entity interaction handler
     * To be overridden by subclasses
     * @param {Player} player The player that interacted
     * @param {BaseEntity} entity The entity that was interacted with
     * @param {string} interactionType The type of interaction
     */
    onEntityInteraction(player, entity, interactionType) {
        // Base implementation does nothing
        console.log(`Player ${player.id} interacted with entity ${entity.id} (${interactionType})`);
    }
    
    /**
     * Update game state - called once per simulation interval
     * Base implementation handles player movement and physics
     */
    update() {
        // Calculate delta time (assuming 30fps)
        const deltaTime = 1/30;
        
        // Process player inputs and update positions
        this.state.players.forEach((player, sessionId) => {
            // Skip if no input data
            if (!player.input) return;
            
            // Handle player movement based on input state
            this.updatePlayerFromInput(sessionId, player, player.input, deltaTime);
        });
        
        // Handle entity spawning if enabled
        if (this.spawnEnabled) {
            this.updateEntitySpawning(deltaTime);
        }
        
        // Call implementation-specific update
        this.implementationUpdate(deltaTime);
    }
    
    /**
     * Update entity spawning system
     * @param {number} deltaTime Time since last update
     */
    updateEntitySpawning(deltaTime) {
        this.spawnTimer += deltaTime;
        if (this.spawnTimer >= this.spawnInterval) {
            // Count current spawned entities
            let entityCount = 0;
            this.state.entities.forEach(entity => {
                if (entity.isSpawned) {
                    entityCount++;
                }
            });
            
            // Spawn entity if below maximum
            if (entityCount < this.maxEntities) {
                this.spawnEntity();
            }
            
            this.spawnTimer = 0;
            this.spawnInterval = this.getSpawnInterval();
        }
    }
    
    /**
     * Get spawn interval - can be overridden for random intervals
     * @returns {number} Spawn interval in seconds
     */
    getSpawnInterval() {
        return this.spawnInterval; // Default implementation returns fixed interval
    }
    
    /**
     * Spawn a new entity - to be implemented by subclasses
     */
    spawnEntity() {
        // Base implementation does nothing - to be overridden
        console.log("spawnEntity called but not implemented");
    }
    
    /**
     * Create and add entity to the game state
     * @param {string} id Entity ID
     * @param {BaseEntity} entity Entity instance
     * @param {Object} position Position {x, y, z}
     * @param {Object} rotation Rotation {x, y, z}
     * @returns {BaseEntity} The created entity
     */
    createEntity(id, entity, position, rotation) {
        // Set entity properties
        entity.id = id;
        
        // Set position
        if (position) {
            entity.x = position.x || 0;
            entity.y = position.y || 0;
            entity.z = position.z || 0;
        }
        
        // Set rotation if provided
        if (rotation) {
            entity.rotationX = rotation.x || 0;
            entity.rotationY = rotation.y || 0; 
            entity.rotationZ = rotation.z || 0;
        }
        
        // Add to state
        this.state.entities.set(id, entity);
        console.log(`Created entity ${id} at (${entity.x}, ${entity.y}, ${entity.z})`);
        
        return entity;
    }
    
    /**
     * Delete an entity from the game state
     * @param {string} id Entity ID
     * @returns {boolean} Whether entity was found and deleted
     */
    deleteEntity(id) {
        if (this.state.entities.has(id)) {
            this.state.entities.delete(id);
            console.log(`Deleted entity ${id}`);
            return true;
        }
        return false;
    }
    
    /**
     * Implementation-specific update logic
     * To be overridden by subclasses
     * @param {number} deltaTime Time since last update
     */
    implementationUpdate(deltaTime) {
        // Base implementation does nothing
    }
    
    /**
     * Update player position based on input state
     * @param {string} playerSessionId Player session ID
     * @param {Player} player Player object
     * @param {InputState} input Input state
     * @param {number} delta Time since last update
     */
    updatePlayerFromInput(playerSessionId, player, input, delta) {
        // Check if player is being controlled via RTS commands
        if (player.isRTSControlled && player.moveTarget) {
            // Calculate direction to target
            const dx = player.moveTarget.x - player.x;
            const dz = player.moveTarget.z - player.z;
            
            // Calculate distance to target
            const distanceSquared = dx * dx + dz * dz;
            
            // If we're close enough to the target, stop moving
            if (distanceSquared < 0.1) {
                player.isRTSControlled = false;
                return;
            }
            
            // Calculate normalized direction vector
            const distance = Math.sqrt(distanceSquared);
            const normalizedDx = dx / distance;
            const normalizedDz = dz / distance;
            
            // Move towards target at a fixed speed
            const speed = 0.2;
            player.x += normalizedDx * speed;
            player.z += normalizedDz * speed;
            
            // Calculate rotation to face movement direction
            player.rotationY = Math.atan2(normalizedDx, normalizedDz);
            
            return;
        }
        
        // Standard input-based movement (from keyboard controls)
        // Increase speed to make movement more noticeable
        const speed = 0.2;
        
        // Calculate movement based on the current player rotation or camera angle
        let dx = 0, dz = 0;
        
        // Determine which angle to use based on view mode
        const moveAngle = input.viewMode === "third-person" 
            ? input.thirdPersonCameraAngle // For third-person, move relative to camera angle
            : player.rotationY;            // For first-person, move relative to player facing
        
        // Check each movement key and apply appropriate movement
        if (input.keys && typeof input.keys === 'object') {
            // Remove verbose key logging
            
            if (input.keys.w) {
                // Forward movement: Move in the direction the player/camera is facing
                dx -= Math.sin(moveAngle) * speed;
                dz -= Math.cos(moveAngle) * speed;
            }
            
            if (input.keys.s) {
                // Backward movement: Move in the opposite direction
                dx += Math.sin(moveAngle) * speed;
                dz += Math.cos(moveAngle) * speed;
            }
            
            if (input.keys.a) {
                // Strafe left: Move perpendicular to the facing direction
                dx -= Math.sin(moveAngle + Math.PI/2) * speed;
                dz -= Math.cos(moveAngle + Math.PI/2) * speed;
            }
            
            if (input.keys.d) {
                // Strafe right: Move perpendicular to the facing direction
                dx += Math.sin(moveAngle + Math.PI/2) * speed;
                dz += Math.cos(moveAngle + Math.PI/2) * speed;
            }
            
            // Handle Q and E for rotating the player in third-person mode
            const rotationSpeed = 0.1;  // Increased rotation speed
            
            if (input.keys.q) {
                // Rotate player left (counter-clockwise)
                player.rotationY += rotationSpeed;
                // Normalize rotation
                player.rotationY = player.rotationY % (Math.PI * 2);
                if (player.rotationY < 0) player.rotationY += Math.PI * 2;
            }
            
            if (input.keys.e) {
                // Rotate player right (clockwise)
                player.rotationY -= rotationSpeed;
                // Normalize rotation
                player.rotationY = player.rotationY % (Math.PI * 2);
                if (player.rotationY < 0) player.rotationY += Math.PI * 2;
            }
            
            // Apply diagonal movement speed correction for all movement
            if ((input.keys.w || input.keys.s) && 
                (input.keys.a || input.keys.d)) {
                // Normalize diagonal movement speed
                const magnitude = Math.sqrt(dx * dx + dz * dz);
                if (magnitude > 0) {
                    dx = (dx / magnitude) * speed;
                    dz = (dz / magnitude) * speed;
                }
            }
        }
        
        // Update player position
        player.x += dx;
        player.z += dz;
        
        // Handle physics - gravity
        player.velocityY -= 0.01; // gravity
        player.y += player.velocityY;
        if (player.y < 1) {
            player.y = 1;
            player.velocityY = 0;
        }
        
        // Handle jumps
        if (input.keys && input.keys.space && player.y <= 1) {
            player.velocityY = 0.2; // Jump velocity
        }
        
        // Handle mouse movement (rotation) for players not sending direct rotation
        if (input.mouseDelta && input.mouseDelta.x !== 0 && input.mouseDelta.y !== 0) {
            // Apply mouse X movement to player rotation (horizontal looking)
            player.rotationY += input.mouseDelta.x * 0.002;
            
            // Normalize rotation to keep it within 0 to 2 range
            player.rotationY = player.rotationY % (Math.PI * 2);
            if (player.rotationY < 0) player.rotationY += Math.PI * 2;
            
            // Apply mouse Y movement to pitch (vertical looking, with limits)
            player.pitch += input.mouseDelta.y * 0.002;
            
            // Clamp pitch to prevent over-rotation
            player.pitch = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, player.pitch));
            
            // Reset mouseDelta after applying
            input.mouseDelta.x = 0;
            input.mouseDelta.y = 0;
        }
    }
    
    /**
     * Called when a client joins the room
     * @param {Client} client The client that joined
     * @param {Object} options Join options
     */
    onJoin(client, options) {
        console.log(`Client joined: ${client.sessionId}`);
        
        // Create a new player instance
        const player = new Player();
        
        // Set initial player position
        player.x = 0;
        player.y = 1;
        player.z = 0;
        
        // Set session ID as player ID
        player.id = client.sessionId;
        
        // Allow subclasses to modify player setup
        this.setupPlayer(player, client, options);
        
        // Add player to the game state
        this.state.players.set(client.sessionId, player);
    }
    
    /**
     * Player setup - to be implemented by subclasses
     * @param {Player} player The player object
     * @param {Client} client The client that joined
     * @param {Object} options Join options
     * @returns {Player} The modified player object
     */
    setupPlayer(player, client, options) {
        // Base implementation just returns the player
        return player;
    }
    
    /**
     * Called when a client leaves the room
     * @param {Client} client The client that left
     * @param {boolean} consented Whether the client consented to leaving
     */
    onLeave(client, consented) {
        console.log(`Client left: ${client.sessionId}`);
        
        // Remove player from the game state
        this.state.players.delete(client.sessionId);
    }
    
    /**
     * Generate a random position within the map
     * @param {number} minHeight Minimum height (y-coordinate)
     * @returns {Object} Position object {x, y, z}
     */
    generateRandomPosition(minHeight = 0) {
        const mapSize = this.state.gameConfig.mapSize;
        return {
            x: (Math.random() * mapSize) - (mapSize / 2),
            y: minHeight,
            z: (Math.random() * mapSize) - (mapSize / 2)
        };
    }
    
    /**
     * Handle structure placement message from client
     * @param {Client} client The client that sent the message
     * @param {Object} message The message containing structure details
     */
    handlePlaceStructure(client, message) {
        console.log(`Handling structure placement from ${client.sessionId}:`, message);
        
        // Validate player
        const player = this.state.players.get(client.sessionId);
        if (!player) { 
            console.log("Player not found for structure placement");
            return; 
        }
        
        // Extract data
        const { structureType, x, y, z, rotation = 0 } = message;
        
        // Validate data
        if (!structureType || typeof x !== 'number' || typeof z !== 'number') {
            console.log("Invalid structure data:", message);
            return;
        }
        
        // Optional: Check if placement is valid
        if (!this.isStructurePlacementValid(structureType, x, y, z, rotation)) {
            console.log("Structure placement invalid - collision detected");
            return;
        }
        
        // Create a new structure entry with unique ID
        const id = "structure_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
        const structure = new Structure();
        structure.id = id;
        structure.structureType = structureType;
        structure.x = x;
        structure.y = y || 0;
        structure.z = z;
        structure.rotationY = rotation;
        structure.ownerId = client.sessionId;
        
        // Set dimensions based on structure type
        this.setStructureDimensions(structure);
        
        // Add to state - this automatically broadcasts to all clients
        this.state.structures.set(id, structure);
        
        console.log(`Structure ${id} placed at (${x}, ${y}, ${z})`);
        
        // Optional: Send confirmation to the client who placed it
        client.send("structurePlaced", { 
            success: true, 
            id: id,
            data: message
        });
    }
    
    /**
     * Handle structure demolition message from client
     * @param {Client} client The client that sent the message
     * @param {Object} message The message containing structure id
     */
    handleDemolishStructure(client, message) {
        const { structureId } = message;
        const structure = this.state.structures.get(structureId);
        
        // Only allow owner to demolish their structures
        if (structure && structure.ownerId === client.sessionId) {
            this.state.structures.delete(structureId);
            console.log(`Structure ${structureId} demolished by ${client.sessionId}`);
        }
    }
    
    /**
     * Check if a structure placement is valid
     * @param {string} structureType Type of structure
     * @param {number} x X position
     * @param {number} y Y position
     * @param {number} z Z position
     * @param {number} rotation Rotation in radians
     * @returns {boolean} Whether placement is valid
     */
    isStructurePlacementValid(structureType, x, y, z, rotation) {
        // Get dimensions based on type
        let width = 1, depth = 1;
        
        switch (structureType) {
            case "building":
                width = 4;
                depth = 4;
                break;
            case "wall":
                width = 4;
                depth = 0.5;
                // Adjust for rotation
                if (Math.abs(rotation % Math.PI) > 0.1) {
                    [width, depth] = [depth, width];
                }
                break;
        }
        
        // Check for collisions with other structures
        let isValid = true;
        
        // Create bounding box for new structure
        const halfWidth = width / 2;
        const halfDepth = depth / 2;
        const newMin = { x: x - halfWidth, z: z - halfDepth };
        const newMax = { x: x + halfWidth, z: z + halfDepth };
        
        // Check against all other structures
        this.state.structures.forEach((structure) => {
            // Skip if already invalid
            if (!isValid) return;
            
            const otherHalfWidth = structure.width / 2;
            const otherHalfDepth = structure.depth / 2;
            
            const otherMin = {
                x: structure.x - otherHalfWidth,
                z: structure.z - otherHalfDepth
            };
            const otherMax = {
                x: structure.x + otherHalfWidth,
                z: structure.z + otherHalfDepth
            };
            
            // Check if bounding boxes overlap
            if (newMin.x <= otherMax.x && newMax.x >= otherMin.x &&
                newMin.z <= otherMax.z && newMax.z >= otherMin.z) {
                isValid = false;
            }
        });
        
        return isValid;
    }
    
    /**
     * Set dimensions for a structure
     * @param {Structure} structure The structure to set dimensions for
     */
    setStructureDimensions(structure) {
        switch (structure.structureType) {
            case "building":
                structure.width = 4;
                structure.height = 3;
                structure.depth = 4;
                break;
            case "wall":
                structure.width = 4;
                structure.height = 2;
                structure.depth = 0.5;
                break;
            default:
                structure.width = 1;
                structure.height = 1;
                structure.depth = 1;
        }
    }
}

module.exports = { BaseRoom };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\index.js 
===================================================== 
 
/**
 * 3D AI Game Platform - Server
 * Main entry point for the server
 */

const http = require('http');
const express = require('express');
const { Server } = require('colyseus');
const path = require('path');

// Import default implementation
const DefaultImpl = require('../implementations/default');

// Server-side configuration
const serverConfig = {
    activeImplementation: "default",
    port: process.env.PORT || 3000
};

/**
 * Main server class
 */
class GameServer {
    constructor() {
        // Create Express app and HTTP server
        this.app = express();
        this.server = http.createServer(this.app);
        
        // Configure app
        this.configureApp();
        
        // Create Colyseus server with correct configuration
        this.gameServer = new Server({
            server: this.server
        });
        
        // Register rooms
        this.registerRooms();
    }
    
    /**
     * Configure Express app
     */
    configureApp() {
        // Set up CORS headers for all requests
        this.app.use((req, res, next) => {
            res.header("Access-Control-Allow-Origin", "*");
            res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
            next();
        });
        
        // Set up static file serving
        this.app.use(express.static(path.join(__dirname, '../..', 'client')));
        
        // Serve the main index.html
        this.app.get('/', (req, res) => {
            res.sendFile(path.join(__dirname, '../..', 'client', 'index.html'));
        });
        
        // API endpoint to get current active implementation
        this.app.get('/api/config', (req, res) => {
            res.json({ 
                activeImplementation: serverConfig.activeImplementation,
                availableImplementations: ["default"]
            });
        });
    }
    
    /**
     * Register room handlers
     */
    registerRooms() {
        // Get the room from default implementation
        const roomType = DefaultImpl.implementation.roomType;
        const RoomClass = this.getRoomClass(DefaultImpl);
        
        if (RoomClass) {
            this.gameServer.define(roomType, RoomClass);
            this.gameServer.define('active', RoomClass);
        } else {
            console.warn('No room class found for default implementation');
        }
    }
    
    /**
     * Helper method to get the room class from an implementation
     * @param {Object} implementation The implementation object
     * @returns {Class} The room class, or null if not found
     */
    getRoomClass(implementation) {
        if (implementation.DefaultRoom) {
            return implementation.DefaultRoom;
        } else if (implementation.ImplementationRoom) {
            return implementation.ImplementationRoom;
        }
        
        // Log what's available in the implementation for debugging
        console.log(`Available properties in implementation: ${Object.keys(implementation).join(', ')}`);
        return null;
    }
    
    /**
     * Start the server
     * @param {number} port Port to listen on
     */
    start(port = 3000) {
        this.server.listen(port, () => {
            console.log(`3D Game Platform server running on http://localhost:${port}`);
            console.log(`Active implementation: ${serverConfig.activeImplementation}`);
        });
    }
}

// Create and start server
const gameServer = new GameServer();
gameServer.start(serverConfig.port);

// Export server instance and configuration for external access
module.exports = { 
    gameServer,
    serverConfig
};  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\server.js 
===================================================== 
 
/**
 * 3D AI Game Platform
 * Entry point for the game server
 */

// Import the server module and implementation config
const { gameServer, serverConfig } = require('./index');

// Display server info
console.log('\n===== 3D AI Game Platform =====');
console.log('Server running on http://localhost:3000');
console.log('Implementation: default');

// Handle Ctrl+C to exit
process.stdin.setRawMode(true);
process.stdin.resume();
process.stdin.setEncoding('utf8');

process.stdin.on('data', (key) => {
    if (key === '\u0003') { // Ctrl+C
        process.exit();
    }
});
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\BaseEntity.js 
===================================================== 
 
const { Schema, type } = require("@colyseus/schema");

/**
 * Base entity schema for all game entities
 * This class provides common properties and methods for all entities
 */
class BaseEntity extends Schema {
    constructor() {
        super();
        this.id = "";             // Unique identifier
        this.type = "";           // Entity type (e.g., "player", "npc", "static")
        this.x = 0;               // Position X
        this.y = 0;               // Position Y 
        this.z = 0;               // Position Z
        this.rotationY = 0;       // Rotation around Y axis (yaw)
        this.value = 1;           // Generic value - meaning depends on implementation
        this.color = "#FFFFFF";   // Color in hex format
    }
}

// Register schema types
type("string")(BaseEntity.prototype, "id");
type("string")(BaseEntity.prototype, "type");
type("number")(BaseEntity.prototype, "x");
type("number")(BaseEntity.prototype, "y");
type("number")(BaseEntity.prototype, "z");
type("number")(BaseEntity.prototype, "rotationY");
type("number")(BaseEntity.prototype, "value");
type("string")(BaseEntity.prototype, "color");

module.exports = { BaseEntity };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\DefaultRoom.js 
===================================================== 
 
const { BaseRoom } = require("../BaseRoom");

/**
 * Default Room
 * Basic implementation with box players
 */
class DefaultRoom extends BaseRoom {
    /**
     * Initialize the default room implementation
     * @param {Object} options Room creation options
     */
    initializeImplementation(options) {
        console.log("Default room implementation initialized");
        
        // Update game config
        this.state.gameConfig.implementation = "default";
        
        // Everything else is handled by BaseRoom
    }
    
    /**
     * Default implementation update logic is not needed
     * BaseRoom handles all necessary functionality
     * @param {number} deltaTime Time since last update
     */
    implementationUpdate(deltaTime) {
        // Nothing to do in the default implementation
    }
    
    /**
     * Default player setup - just basic box
     * @param {Player} player The player object
     * @param {Client} client The client that joined
     * @param {Object} options Join options
     * @returns {Player} The player object
     */
    setupPlayer(player, client, options) {
        // Set player name
        player.name = options.name || client.sessionId;
        
        // Set a default color
        player.color = "#" + Math.floor(Math.random()*16777215).toString(16);
        
        return player;
    }
}

module.exports = { DefaultRoom };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\GameConfigSchema.js 
===================================================== 
 
const { Schema, type } = require("@colyseus/schema");

/**
 * Game configuration schema
 * Replaces the generic object type with a properly typed schema
 */
class GameConfigSchema extends Schema {
    constructor() {
        super();
        this.implementation = "default"; 
        this.mode = "standard";               // Game mode
        this.maxPlayers = 10;                 // Maximum number of players
        this.mapSize = 40;                    // Size of the map
    }
}

// Register schema types
type("string")(GameConfigSchema.prototype, "implementation");
type("string")(GameConfigSchema.prototype, "mode");
type("number")(GameConfigSchema.prototype, "maxPlayers");
type("number")(GameConfigSchema.prototype, "mapSize");

module.exports = { GameConfigSchema };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\GameState.js 
===================================================== 
 
const { Schema, MapSchema, type } = require("@colyseus/schema");
const { Player } = require("./Player");
const { GameConfigSchema } = require("./GameConfigSchema");
const { Structure } = require("./Structure");

/**
 * Game state schema for the entire game
 * Contains collections of all entities in the game
 */
class GameState extends Schema {
    constructor() {
        super();
        // All players in the game
        this.players = new MapSchema();
        
        // All entities in the game - can be implementation-specific
        this.entities = new MapSchema();
        
        // All structures in the game (buildings, walls, etc.)
        this.structures = new MapSchema();
        
        // Game configuration and state - using schema instead of plain object
        this.gameConfig = new GameConfigSchema();
    }
}

// Register schema types
type({ map: Player })(GameState.prototype, "players");
type({ map: Schema })(GameState.prototype, "entities");
type({ map: Structure })(GameState.prototype, "structures");
type(GameConfigSchema)(GameState.prototype, "gameConfig");

module.exports = { GameState };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\ImplementationDataSchema.js 
===================================================== 
 
const { Schema, type, MapSchema } = require("@colyseus/schema");

/**
 * Implementation data schema
 * Replaces the generic object type with a properly typed schema
 * Uses a MapSchema to allow for dynamic key-value pairs
 */
class ImplementationDataSchema extends Schema {
    constructor() {
        super();
        // Using a MapSchema to store dynamic properties for implementation-specific data
        this.properties = new MapSchema();
        
        // Common implementation properties
        this.value = 1;   // Default value
        this.color = "";  // Color value as string
    }
}

// Register schema types
type({ map: "string" })(ImplementationDataSchema.prototype, "properties");
type("number")(ImplementationDataSchema.prototype, "value");
type("string")(ImplementationDataSchema.prototype, "color");

module.exports = { ImplementationDataSchema };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\InputState.js 
===================================================== 
 
const { Schema, type } = require("@colyseus/schema");

/**
 * Input state schema for player input
 */
class InputState extends Schema {
    constructor() {
        super();
        // Initialize keys as a KeysSchema instance, not a plain object
        this.keys = new KeysSchema();
        this.mouseDelta = new MouseDeltaSchema();
        this.viewMode = "third-person"; // Default view mode - "first-person", "third-person", "free-roam"
        this.thirdPersonCameraAngle = 0; // Camera angle for third-person view
    }
}

// Define nested schemas for proper serialization
class KeysSchema extends Schema {
    constructor() {
        super();
        this.w = false;
        this.a = false;
        this.s = false;
        this.d = false;
        this.space = false;
        this.q = false;
        this.e = false;
        this.shift = false;
    }
}

class MouseDeltaSchema extends Schema {
    constructor() {
        super();
        this.x = 0;
        this.y = 0;
    }
}

// Register schema types for nested schemas
type("boolean")(KeysSchema.prototype, "w");
type("boolean")(KeysSchema.prototype, "a");
type("boolean")(KeysSchema.prototype, "s");
type("boolean")(KeysSchema.prototype, "d");
type("boolean")(KeysSchema.prototype, "space");
type("boolean")(KeysSchema.prototype, "q");
type("boolean")(KeysSchema.prototype, "e");
type("boolean")(KeysSchema.prototype, "shift");

type("number")(MouseDeltaSchema.prototype, "x");
type("number")(MouseDeltaSchema.prototype, "y");

// Register the schema types for InputState
type(KeysSchema)(InputState.prototype, "keys");
type(MouseDeltaSchema)(InputState.prototype, "mouseDelta");
type("string")(InputState.prototype, "viewMode");
type("number")(InputState.prototype, "thirdPersonCameraAngle");

module.exports = { InputState, KeysSchema, MouseDeltaSchema };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\Player.js 
===================================================== 
 
const { type, Schema } = require("@colyseus/schema");
const { BaseEntity } = require("./BaseEntity");
const { InputState } = require("./InputState");
const { ImplementationDataSchema } = require("./ImplementationDataSchema");

/**
 * Target position for RTS mode movement
 */
class MoveTarget extends Schema {
    constructor() {
        super();
        this.x = 0;
        this.z = 0;
    }
}

type("number")(MoveTarget.prototype, "x");
type("number")(MoveTarget.prototype, "z");

/**
 * Player schema for all player entities
 * Extends BaseEntity with player-specific properties
 */
class Player extends BaseEntity {
    constructor() {
        super();
        this.type = "player";      // Entity type
        this.name = "";            // Player name
        this.pitch = 0;            // Camera pitch (looking up/down)
        this.velocityY = 0;        // Vertical velocity (for physics)
        this.input = new InputState(); // Player input state
        this.moveTarget = new MoveTarget(); // Target position for RTS movement
        this.isRTSControlled = false; // Whether the player is currently being controlled by RTS commands
        
        // Implementation-specific properties can be added by subclasses
        this.implementationType = ""; // Type of implementation
        this.implementationData = new ImplementationDataSchema(); // Implementation-specific data
    }
}

// Register schema types - inherit from BaseEntity
type("string")(Player.prototype, "name");
type("number")(Player.prototype, "pitch");
type("number")(Player.prototype, "velocityY");
type(InputState)(Player.prototype, "input");
type(MoveTarget)(Player.prototype, "moveTarget");
type("boolean")(Player.prototype, "isRTSControlled");
type("string")(Player.prototype, "implementationType");
type(ImplementationDataSchema)(Player.prototype, "implementationData");

module.exports = { Player, MoveTarget };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\core\schemas\Structure.js 
===================================================== 
 
const { Schema, type } = require("@colyseus/schema");
const { BaseEntity } = require("./BaseEntity");

/**
 * Structure schema for buildings and constructions
 * Extends BaseEntity with building-specific properties
 */
class Structure extends BaseEntity {
    constructor() {
        super();
        this.type = "structure";       // Entity type
        this.structureType = "";       // Specific structure type (e.g., "building", "wall")
        this.width = 1;                // Width of structure
        this.height = 1;               // Height of structure
        this.depth = 1;                // Depth of structure
        this.health = 100;             // Health points
        this.maxHealth = 100;          // Maximum health points
        this.ownerId = "";             // ID of player who built this
    }
}

// Register schema types
type("string")(Structure.prototype, "structureType");
type("number")(Structure.prototype, "width");
type("number")(Structure.prototype, "height");
type("number")(Structure.prototype, "depth");
type("number")(Structure.prototype, "health");
type("number")(Structure.prototype, "maxHealth");
type("string")(Structure.prototype, "ownerId");

module.exports = { Structure };  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\server\implementations\default\index.js 
===================================================== 
 
/**
 * Default Implementation
 * A simple implementation with basic box players
 */

const { DefaultRoom } = require("../../core/schemas/DefaultRoom");

// Default implementation information
const implementation = {
    name: "default",
    description: "A simple implementation with basic box players",
    roomType: "default"
};

module.exports = {
    implementation,
    DefaultRoom
};  
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\memory bank\architecture.md 
===================================================== 
 
# 3D AI Game Platform - Architecture

## Overview
3D AI Game is a modular 3D web-based game platform built with Three.js and Colyseus, utilizing a client-server architecture for multiplayer functionality. Players control customizable characters and interact with a colorful 3D environment. The platform is designed to support various game implementations.

## Core Components

### 1. Server (server/core/server.js)
**Technology:** Built with Node.js and Colyseus.

**Responsibilities:**
- Manages game rooms and player connections/disconnections
- Maintains the authoritative game state
- Processes player inputs (e.g., movement, collisions)
- Broadcasts state updates to all connected clients
- Handles entity spawning and lifecycle management
- Supports dynamic implementation selection via command-line arguments or environment variables
- Validates and manages structure placement in the building system

**Key Features:**
- Room-based multiplayer with session persistence
- State synchronization using Colyseus schema
- Server-authoritative position tracking
- Dynamic entity spawning system
- Runtime implementation switching based on user selection
- Server-validated building placement system

### 2. Client Core Platform (/client/js/core)
The core platform provides foundational functionality that all game implementations can leverage.

**Key components:**
- **main.js:**
  - Entry point for client-side code
  - Loads core modules and initializes the game engine
  - Sets up default player factory

- **controls.js:**
  - Handles player movement and camera controls
  - Supports first-person, third person, and free roam view modes
  - Manages input handling for keyboard and mouse
  - Implements quaternion-based rotation for smooth camera movement

- **game-engine.js:**
  - Initializes the Three.js scene, renderer, and camera
  - Sets up player controls and world objects
  - Manages the animation loop for continuous rendering
  - Implements four distinct camera systems:
    - First-person view: Camera attached to player's head position
    - Third-person view: Camera follows behind player with intelligent rotation alignment
    - Free camera mode: Independent camera with WASD/QE movement and mouse look functionality
    - RTS view mode: Top-down strategic view with:
      - WASD for camera panning
      - Q/E for camera height adjustment
      - Click-and-drag box selection
      - Right-click movement commands
      - Visual selection rings and move markers
      - Custom cursor system
  - Handles smooth camera transitions between view modes
  - Maintains proper camera orientation with Euler angles to prevent unwanted roll
  - Implements RTS-specific features:
    - Selection system with single-click and box selection
    - Unit movement commands
    - Visual feedback (selection rings, move markers)
    - Custom cursor management
    - View-specific input handling

- **network-core.js:**
  - Establishes and maintains WebSocket connection to the server via Colyseus
  - Sends player actions to the server
  - Processes state updates from the server
  - Handles player joining/leaving events

- **Entity.js:**
  - Base class for all game entities
  - Provides core entity functionality (position, rotation, scale)
  - Defines interface for entity behaviors
  - Handles common entity lifecycle events

- **Player.js:**
  - Extends Entity for player-specific functionality
  - Manages player state and input handling
  - Provides interface for implementation-specific player behaviors

- **NPC.js:**
  - Extends Entity for non-player characters
  - Implements basic AI behaviors
  - Provides interface for implementation-specific NPC behaviors

- **EntityFactory.js:**
  - Factory pattern for creating entities
  - Registers entity types and their constructors
  - Used by both core platform and game implementations

- **collision.js:**
  - Handles collision detection and resolution
  - Provides interfaces for implementation-specific collision behaviors

- **player-ui.js:**
  - Manages common UI elements for player information
  - Provides hooks for implementation-specific UI components

### 3. Game Implementations (/client/js/implementations and /server/implementations)
Each game implementation extends the core platform with specific gameplay mechanics and visuals.

**Implementation Structure:**
- Client-side implementation code in /client/js/implementations/
- Server-side implementation code in /server/implementations/
- Each implementation folder contains its own set of entities, rooms, and behaviors

**Future Implementations:**
- Will follow similar patterns, extending the core components
- Each implementation will be contained in its own directory
- Will register custom entity factories and behaviors

### 4. Main Engine (game-engine.js)
- Initializes the Three.js scene, renderer, and camera
- Sets up player controls and world objects
- Loads the appropriate game implementation based on configuration
- Manages view modes (first-person, third person, free roam)
- Updates visual components based on server state

### 5. Networking Architecture
**Technology:** Colyseus for WebSocket-based real-time multiplayer.

**Implementation:**
- Server maintains authoritative game state using Colyseus Schema
- Client sends player actions to the server at regular intervals
- Server validates actions, updates game state, and broadcasts to all clients
- Efficient state synchronization with delta updates
- Robust player synchronization with proper sessionId handling
- Smooth interpolation of remote player movements using lerping

**Key Features:**
- Session persistence with reconnection support
- Room-based multiplayer with shared state
- Message-based communication for game events
- Schema-based state synchronization with type annotations
- Player list UI showing all connected players
- Automatic remote player creation and cleanup
- Smooth remote player movement interpolation
- Proper handling of player value updates and mesh recreation
- Resilient error handling for network disconnections
- Automatic cleanup of stale player instances

**Schema Implementation:**
- Proper MapSchema collections for players, operators, and static objects
- Type annotations for all schema properties
- Structured synchronization patterns for consistent state updates
- Robust sessionId tracking for player identification
- Proper player state management with value updates

**Player Synchronization:**
- Automatic creation of remote player instances with proper sessionId tracking
- Smooth position interpolation using Three.js lerping
- Proper cleanup of disconnected player instances
- Value-based mesh updates
- Efficient player collection management using Set data structure
- Proper separation of local and remote player handling
- Resilient error handling for edge cases

### 6. Building System
**Technology:** Three.js for rendering, Colyseus for server-side validation and synchronization.

**Implementation:**
- Server-authoritative structure placement system 
- Client-side preview with real-time validation feedback
- Built on Colyseus Schema for synchronized structure collections
- Toggle between game and building modes with keystroke (B key)
- Grid-based placement with 15 rotation increments (Q/E keys)
- Seamless operation across all camera modes

**Client Components:**
- Building mode UI overlay with structure selection menu
- Structure preview mesh with valid/invalid placement indicators
- Click-to-place functionality with server authorization
- Structure rotation controls (Q/E for 15 increments)
- Cross-camera mode compatibility (first-person, third-person, RTS)
- Interactive grid system for structure placement

**Server Components:**
- Structure schema extending BaseEntity
- Structure collection in GameState
- Server-side collision detection and validation
- Server broadcasting of structure changes to all clients
- Authoritative structure placement confirmation

**Structure Types:**
- Buildings: Base structures with customizable dimensions
- Walls: Thin structures with height/width customization
- Additional types can be added by extending the Structure schema

**Networking Flow:**
1. Client enters building mode and selects structure type
2. Client shows preview mesh at mouse pointer location
3. Client validates placement and shows green/red indicator
4. Client sends placement request to server on valid click
5. Server validates placement and checks for collisions
6. Server creates structure and broadcasts to all clients
7. All clients render the confirmed structure

**Key Features:**
- Complete cross-client synchronization of structures
- Real-time placement validation with visual feedback
- Seamless integration with all camera modes
- Full server authority for all structure placement
- Interactive preview system with structural rotation
- Grid-based placement with customizable sizing

**File Components:**
```
 server/
    core/
       BaseRoom.js      # Structure placement handling
       schemas/
           Structure.js # Structure schema definition
           GameState.js # Structure collection
 client/
    index.html           # Building UI and client logic
```

## File Structure
```
/
 package.json            # Node.js dependencies
 client/                 # Client-side code
    index.html          # Main HTML file
    css/                # Stylesheets
    js/                 # JavaScript files
        core/           # Core platform code
           main.js     # Entry point and module loader
           game-engine.js # Main game engine and rendering
           Entity.js   # Base entity class
           Player.js   # Base player class
           NPC.js      # Base NPC class
           controls.js # Camera and movement controls
           network-core.js # Networking functionality
           collision.js    # Collision detection
           EntityFactory.js # Entity creation factory
           player-ui.js    # UI components
        implementations/ # Game-specific client implementations
            default/     # Default box implementation
               DefaultPlayer.js # Simple box player
            numberblocks/  # Example implementation
                entity-sync.js # Entity synchronization
                operator.js    # Mathematical operators
                index.js       # Implementation entry point
 server/                 # Server-side code
    core/               # Core server components
       server.js       # Main server entry point
       index.js        # Core server initialization
       BaseRoom.js     # Base room implementation
       schemas/        # All schema definitions
           BaseEntity.js # Base entity schema
           DefaultRoom.js # Default room implementation
           GameState.js  # Game state schema
           Player.js     # Player schema
           InputState.js # Input state schema
           GameConfigSchema.js # Game configuration schema
    implementations/    # Server-side implementations
        default/        # Default implementation
           index.js    # Default implementation entry point
        numberblocks/   # Example implementation
            index.js    # Implementation entry point
            schemas.js  # Implementation-specific schemas
            NumberblocksRoom.js # Implementation room
 four_player_setup.html  # HTML for 4-player split-screen setup
 open_4player_direct.bat # Batch script to launch 4-player mode
 memory bank/            # Documentation and reference materials
```

## Communication Flow
1. **Initialization:**
   - Server starts and creates a game room
   - Client connects to server and joins the room
   - Server assigns a session ID and initializes player state
   - Client loads the appropriate game implementation

2. **Gameplay Loop:**
   - Client captures user inputs and sends movements that affect player character to server (movements, actions, etc.)
   - Server validates and processes inputs
   - Server updates game state
   - Server broadcasts updated state to all clients
   - Each client renders the updated game state based on its implementation

3. **Interactions:**
   - Client detects local collisions and sends interaction events to server
   - Server validates interaction and updates game state accordingly
   - Server broadcasts the updated state to all clients
   - Each client renders the interaction effects based on its implementation

## Modular Design Approach
The platform is designed with modularity in mind, allowing for different game implementations to share core functionality:

1. **Base Classes:**
   - Core Entity, Player, and NPC classes define common behavior
   - Implementation-specific classes extend these base classes

2. **Factory Pattern:**
   - EntityFactory creates appropriate entity instances based on entity type
   - New implementations register their entity types with the factory

3. **Dependency Injection:**
   - Core components are injected into implementation-specific classes
   - Allows implementations to focus on behavior rather than infrastructure

4. **Interface-Based Design:**
   - Clear interfaces define what implementations must provide
   - Core platform handles common functionality and lifecycle management

## Key Features
- **Triple View Modes:** 
  - First-person view with player model hidden
  - Third-person view with camera following player and aligning with player's facing direction
  - Free roam camera with independent movement and rotation, maintaining proper orientation
- **Camera Controls:**
  - Mouse wheel zoom for third-person view
  - Mouse-based rotation with proper Euler angle handling to prevent camera roll
  - View-specific movement and interaction behaviors
  - Seamless transitions between camera modes
- **Multiplayer Support:** Multiple players can join the same game world
- **Multi-Player Setup:** Supports a 4-player split-screen mode for local multiplayer gameplay
- **Persistence:** Session reconnection support
- **Browser Tab Synchronization:** Automatically updates game state when inactive tabs become active
- **Entity Component System:** Flexible architecture for game entity management
- **Modular Implementation System:** Support for various game types and mechanics
- **RTS View Mode:** Top-down strategic view with:
  - WASD for camera panning
  - Q/E for camera height adjustment
  - Click-and-drag box selection
  - Right-click movement commands
  - Visual selection rings and move markers
  - Custom cursor system
- **Advanced Unit Selection:** Single-click and box selection
- **Unit Movement Commands:** WASD for panning
- **Visual Feedback:** Selection rings, move markers
- **Custom Cursor:** Custom cursor system
- **Mode-Specific Input Handling:** View-specific input handling and UI elements

## Multi-Player Local Setup
The platform supports flexible local multiplayer configurations through a dynamic split-screen system:

### Screen Layout Configurations
1. **Single Player:**
   - Full screen display
   - Utilizes entire window space

2. **Two Players:**
   - Vertical split (top-bottom)
   - Equal screen space allocation
   - Clean separation with minimal gap

3. **Three Players:**
   - Top row split horizontally (left and right)
   - Bottom row left occupied, right empty
   - Maintains visual balance with empty fourth quadrant

4. **Four Players:**
   - 2x2 grid layout
   - Equal quadrants for all players
   - Minimal gaps between screens

### Implementation Details
- **Dynamic Layout System:**
  - CSS Grid-based layout management
  - Responsive to window resizing
  - Automatic adjustment based on player count
  - Clean separation between viewports

- **Technical Components:**
  ```html
  four_player_setup.html   # Handles multi-player screen layouts
  ```
  - Dynamically creates required number of game instances
  - Manages viewport organization
  - Handles implementation selection display
  - Maintains proper aspect ratios

- **Launch System:**
  ```batch
  start_game.bat          # Unified game launcher
  ```
  - Manages server startup
  - Handles implementation selection
  - Controls player count configuration
  - Launches appropriate screen layout

### Key Features
- **Flexible Configuration:** Supports 1-4 players
- **Clean Interface:** Minimal gaps between viewports
- **Implementation Awareness:** Displays current game implementation
- **Dynamic Resizing:** Maintains proper ratios on window resize
- **Efficient Resource Usage:** Only creates needed game instances
- **Seamless Integration:** Works with all game implementations

## Implementation Selection System
The platform supports multiple game implementations that can be selected at runtime:

1. **Selection Process:**
   - User selects implementation through the startup batch file
   - Selection is passed to the server via environment variables (GAME_IMPLEMENTATION)
   - Server dynamically loads the appropriate implementation based on this selection
   - Implementation identifier is displayed in the game UI

2. **Technical Components:**
   ```javascript
   // server/core/index.js
   const serverConfig = {
     // Read implementation from command line args or environment variable
     activeImplementation: process.env.GAME_IMPLEMENTATION || process.argv[2] || "default",
     port: process.env.PORT || 3000
   };
   ```

   ```batch
   # start_game.bat
   # Maps user selection to implementation name and sets environment variable
   if !IMPL_CHOICE!==1 (
     set IMPLEMENTATION=default
   ) else if !IMPL_CHOICE!==2 (
     set IMPLEMENTATION=numberblocks
   )
   # Passes the selection to the server
   set GAME_IMPLEMENTATION=!IMPLEMENTATION! && start_server.bat
   ```

3. **Available Implementations:**
   - **default:** Simple box-based characters and environment
   - **numberblocks:** Mathematical block-based gameplay

4. **Implementation Registry:**
   - Central registry in server/core/index.js maps implementation names to their module exports
   - New implementations can be added by extending this registry 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\memory bank\game design document.md 
===================================================== 
 
# 3D AI Game Platform
## Introduction
The 3D AI Game platform is a modular, web-based 3D game environment built with Three.js and Colyseus, utilizing a client-server architecture for multiplayer functionality. Players control customizable characters and interact with a colorful 3D environment. The platform is designed to support various game implementations, with Numberblocks being the first example.

## Platform Overview
This game platform allows players to navigate a 3D world with customizable characters, interact with other players and objects, and participate in various game modes. The platform's modular design enables developers to implement different themes and gameplay mechanics while maintaining the core 3D multiplayer functionality.

## Core Components

### 1. Game Engine
- Three.js for 3D rendering
- Colyseus for multiplayer functionality
- Modular entity system for extensible game objects

### 2. Player System
- Customizable player characters based on game implementation
- Support for various movement modes and camera perspectives
- Collision detection and interaction systems

### 3. Game World
- Visual Style: Configurable environment themes
- Features include platforms, ramps, hiding spots, and open areas for player interaction
- Maps encourage exploration and strategic positioning

### 4. Multiplayer Features
- Client-Server Model: Uses Colyseus for WebSocket communication
- Room-Based Gameplay: Players join game rooms with unique session IDs
- Cross-Platform Support: Play on various devices and browsers

## Implementation: Numberblocks

### Character Design
- Players are represented as Numberblocks, with a block count matching their current number
- The model dynamically adjusts as the number changes (e.g., growing from 1 block to 10 blocks)
- Size can optionally affect movement speed (larger numbers move slower)

### Game Mechanics
- **Operators**: Plus (+) and minus (-) operators spawn throughout the map
- **Collection**: Players collect operators by touching them
- **Interaction**: Operators activate upon bumping into another player
- **Number Changes**: Players' numbers change based on the operator used

### Game Modes
1. **Target Number Mode**: Reach a specific number (e.g., 100) by adding to your value
2. **Elimination Mode**: Reduce other players to zero using the minus operator
3. **Score-Based Mode**: Earn points for each operation performed

## Multiplayer Features

### Local Split-Screen Multiplayer
- Supports 2-4 players on a single device
- Screen division options based on player count
- Input management for multiple local players

### Online Multiplayer
- Connect to game servers via unique room codes or matchmaking
- Session reconnection support if temporarily disconnected
- Up to 10 players per online game room

### Player Interaction
- Core interaction mechanics defined by the specific game implementation
- Cooperative and competitive actions
- Strategic positioning and tactical play

## Technical Architecture

### Client-Side Structure
- **Main Engine**: Initializes the Three.js scene, renderer, and camera
- **Network Core**: Manages connection to the server
- **Controls**: Handles player movement and camera controls
- **Entity System**: 
  - Base Entity class for all game objects
  - Specialized entity classes (Player, NPC, etc.)
  - EntityFactory for creating various game objects

### Server-Side Structure
- Game state management
- Player connection handling
- Physics and collision processing
- Entity spawning and lifecycle management

### Modular Implementation System
- Base classes for core functionality
- Extension points for custom game logic
- Theme-specific assets and behaviors
- Pluggable game modes and rules

## User Interface (UI)
- Heads-Up Display (HUD): Shows player information and game status
- Menus: Main menu, lobby, settings
- Controls: Configurable keyboard/mouse controls

## Audio
- Background Music: Theme-appropriate music
- Sound Effects: Action-based audio feedback
- Spatial Audio: Directional sound for immersion

## Technical Considerations
- Browser-based, using WebGL for 3D rendering
- Real-time multiplayer with server-side state management
- Optimized for performance across devices




## Conclusion
The 3D AI Game platform provides a flexible foundation for creating multiplayer 3D web games with different themes and mechanics. By separating core functionality from specific implementations, developers can create new games while leveraging the existing multiplayer infrastructure, 3D rendering capabilities, and entity management system.
 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\memory bank\RULES.md 
===================================================== 
 
# 3D AI Game Platform - Rules and Guidelines

## Core Principles

1. **Modular Design**
   - All new features must follow the modular architecture
   - Implementations must extend base classes and interfaces
   - Use dependency injection for core components
   - Register new entity types with EntityFactory

2. **Camera System Rules**
   - Support all three view modes (first-person, third-person, free roam)
   - Maintain proper Euler angles to prevent camera roll
   - Implement smooth transitions between camera modes
   - Handle mouse wheel zoom for third-person view
   - Ensure proper camera orientation in all modes

3. **Networking Rules**
   - Server is always authoritative for game state
   - Use Colyseus Schema for state synchronization
   - Implement proper session persistence
   - Handle player disconnections gracefully
   - Use efficient delta updates for state changes
   - Maintain proper sessionId tracking

4. **Implementation Guidelines**
   - Place client-side code in `/client/js/implementations/[name]`
   - Place server-side code in `/server/implementations/[name]`
   - Extend base classes (Entity, Player, NPC)
   - Register custom entity factories
   - Implement required interfaces
   - Follow the established communication flow

5. **Entity Management**
   - Use EntityFactory for creating entities
   - Implement proper lifecycle management
   - Handle entity state synchronization
   - Clean up entities on destruction
   - Use proper collision detection

6. **Multiplayer Setup**
   - Support 1-4 player configurations
   - Maintain proper viewport layouts
   - Handle screen space allocation
   - Implement clean separation between viewports
   - Support dynamic resizing

7. **Code Organization**
   - Follow the established file structure
   - Keep implementation-specific code isolated
   - Use proper schema definitions
   - Maintain clear separation of concerns
   - Document new features and changes

8. **Performance Guidelines**
   - Use efficient state synchronization
   - Implement proper interpolation for smooth movement
   - Optimize network message frequency
   - Handle browser tab synchronization
   - Clean up resources when not in use

9. **UI Guidelines**
   - Use player-ui.js for common UI elements
   - Implement clear feedback for player actions
   - Show implementation identifier
   - Display connection status
   - Maintain proper player list

10. **Error Handling**
    - Implement proper error recovery
    - Handle network disconnections
    - Validate all user inputs
    - Provide clear error messages
    - Log important events

## Implementation Selection Rules

1. **Adding New Implementations**
   - Register in server/core/index.js
   - Update start_game.bat with new option
   - Provide proper documentation
   - Include test cases
   - Follow naming conventions

2. **Configuration Requirements**
   - Support environment variable configuration
   - Handle command-line arguments
   - Provide default values
   - Document configuration options
   - Support runtime switching

## Development Workflow

1. **Adding Features**
   - Create feature branch
   - Follow modular design principles
   - Write tests for new functionality
   - Document changes
   - Submit pull request

2. **Testing Requirements**
   - Test all view modes
   - Verify multiplayer functionality
   - Check network resilience
   - Validate state synchronization
   - Ensure proper cleanup

3. **Documentation**
   - Update relevant documentation
   - Add inline code comments
   - Document API changes
   - Update README if needed
   - Include usage examples

## Security Guidelines

1. **Network Security**
   - Validate all server inputs
   - Sanitize user data
   - Use proper session management
   - Implement rate limiting
   - Handle edge cases

2. **Client Security**
   - Validate local inputs
   - Handle malformed data
   - Protect against injection
   - Implement proper error boundaries
   - Use secure defaults

## Best Practices

1. **Code Style**
   - Use consistent formatting
   - Follow naming conventions
   - Write clear comments
   - Keep functions focused
   - Use proper typing

2. **Performance**
   - Optimize render loops
   - Minimize network traffic
   - Use efficient data structures
   - Implement proper caching
   - Profile critical paths

3. **Maintenance**
   - Keep dependencies updated
   - Remove unused code
   - Maintain test coverage
   - Document technical debt
   - Plan for scalability

# Development Rules and Notes

## Server Management

### Restarting the Game Server
When testing changes, you'll need to properly stop and restart the Node.js server:

# STEP 1: Kill all Node.js processes (safer and more reliable method)
taskkill /F /IM node.exe

# STEP 2: Start the server using npm
npm start

> NOTE: The previous method using `Get-Process -Name "node" -ErrorAction SilentlyContinue | Stop-Process -Force` 
> has been found to be unreliable and may cause issues.

### Directory Creation
- When creating multiple directories at once with PowerShell's `mkdir` command, you must use quotes when specifying paths with spaces or multiple directories:
  ```
  # INCORRECT (will fail):
  mkdir css js assets assets\images assets\models assets\sounds
  
  # CORRECT (individual commands):
  mkdir css
  mkdir js
  mkdir assets
  mkdir "assets\images"
  mkdir "assets\models"
  mkdir "assets\sounds"
  ```

- PowerShell's `mkdir` doesn't support multiple directory arguments like in Linux/macOS. Create directories one by one or use a loop.

## Project Structure

### Core vs. Implementation
- All core components must be kept in their respective core directories:
  - Server core: `/server/core/`
  - Client core: `/client/js/core/`
- Implementation-specific code must be in the implementations directories:
  - Server implementations: `/server/implementations/`
  - Client implementations: `/client/js/implementations/`

### Core Components Location
- The main server entry point must be in `/server/core/server.js`
- The main client entry point must be in `/client/js/core/main.js`
- All schema definitions must be in `/server/core/schemas/`
- Core room implementations must be in `/server/core/` (e.g., BaseRoom.js)

### Schema Organization
- All schemas (including implementation-specific ones) should properly extend the base schemas
- Core schemas must be in `/server/core/schemas/`
- Implementation-specific schemas should be in their respective implementation directory
- Never create schemas outside of these designated locations

## Implementation Guidelines

### Modular Design Principles
- Keep core platform code separate from specific game implementations
- Use interfaces and base classes for common functionality
- Create extension points for game-specific features
- Implement factory patterns for creating game-specific entities
- Core code must remain implementation-agnostic

### Implementation-Agnostic Code
- Core code must never refer to specific implementations by name
- Use generic terms in core code (e.g., "player" instead of specific implementation names)
- Always provide generic interfaces that implementations can extend
- Implementations should identify themselves via their "implementationType" property

### Three.js Implementation Notes

- Always include the Three.js library before your own JavaScript files in the HTML
- When testing, make sure to run a local HTTP server rather than opening the HTML file directly due to CORS restrictions with resource loading
- Use a thin BoxGeometry instead of PlaneGeometry for the ground to ensure proper lighting on both sides
- Always implement window resize handling for responsive design (update camera aspect ratio and renderer size)
- For better performance, set renderer.setPixelRatio to match the device's pixel ratio

### Browser API Considerations

- The Pointer Lock API (used by PointerLockControls) may not work in some environments, especially in embedded preview browsers or when served through certain proxies
- Always implement a fallback mechanism for critical browser APIs in case they fail
- Use try-catch blocks around browser API calls that might not be supported in all environments
- Check browser console for API-related errors when testing in different environments
- When implementing mouse controls:
  - Proper event listener management is essential (add/remove listeners appropriately)
  - Always provide visual feedback when controls are locked/unlocked
  - Ensure complete disengagement of controls when user presses ESC

### JavaScript Best Practices

- When using event handlers, store references to them for proper removal later to prevent memory leaks
- For event-based systems (like controls), implement a proper event dispatcher mechanism
- Use class-based or module patterns for complex components to keep code organized
- When dealing with 3D rotations:
  - Separate axes of rotation (yaw, pitch, roll) to prevent gimbal lock issues
  - Always clamp vertical rotation (pitch) to prevent camera flipping

### Game Implementation Guidelines
- Each game implementation should be contained in its own directory
- Game-specific logic should extend the core platform classes
- Assets specific to a game implementation should be in their own directory
- Implement the required interfaces for entity creation and behavior

## Git Workflow

- Always update documentation when making significant changes
- Keep commit messages descriptive and related to implementation changes
- Use feature branches for new game implementations or major features

## Adding New Game Implementations
- Create both client-side and server-side implementation directories
- Extend core classes for your implementation needs
- Register your implementation components with the appropriate factories
- Follow the structure established by existing implementations
- Ensure full implementation-agnostic separation between core and implementation code

## Modules Loading
- Client modules must follow the pattern established in main.js for proper loading order
- Core modules must be loaded before implementation-specific modules
- Use proper dependency management to avoid circular references

## 4-Player Local Multiplayer Setup
- The 4-player setup consists of two key files: `four_player_setup.html` and `open_4player_direct.bat`
- **Do not delete** these files as they are essential for the 4-player functionality
- When making changes that affect the client interface, test with the 4-player setup to ensure compatibility
- The 4-player setup requires Chrome to be installed on the system

### Running the 4-Player Setup
- Use the `open_4player_direct.bat` script to launch the 4-player setup
- The script automatically opens Chrome in app mode with the required HTML file
- Press F11 in the browser for fullscreen mode
- Ensure the game server is running at http://localhost:3000 before launching

### Modifying the 4-Player Setup
- If you need to modify the layout, edit the CSS grid properties in `four_player_setup.html`
- The default setup is a 22 grid with minimal spacing between the viewports
- Each viewport is an iframe that loads the game client independently
- Changes to the main client should automatically reflect in all viewports

## Always follow the architecture.md - if there is any discrepancy then stop and bring it to my attention 
 
===================================================== 
FILE: C:\Users\ksbad\OneDrive\Documents\3D-AI-GAME\memory bank\tech stack.md 
===================================================== 
 
# 3D AI Game Platform - Tech Stack

## Front-End
- **HTML5:** Provides the structure for the game, including the canvas element for 3D rendering and UI components like the heads-up display (HUD) and menus.

- **CSS3:** Styles the UI elements, such as the HUD, player stats, and overlays, ensuring they look polished and are positioned correctly over the game canvas.

- **JavaScript (ES6+):** Drives the client-side game logic, handling player input, visual rendering, and network communication.

- **Three.js:** A JavaScript library that simplifies WebGL for 3D rendering, used to create the game world, dynamic models, and environmental elements.

- **Web Audio API:** Manages audio, including sound effects for actions and background music, providing immersive audio experiences for different game implementations.

## Back-End
- **Node.js:** Server-side JavaScript runtime that hosts the game server, manages player connections, and maintains the authoritative game state.

- **Colyseus:** Framework for multiplayer game server development that handles room-based multiplayer, state synchronization, and client message processing.

- **Colyseus Schema:** Provides efficient state synchronization between server and clients with binary encoding and delta updates.

## Networking
- **WebSockets:** Underlying protocol for real-time bidirectional communication between clients and server.

- **Client-Server Architecture:** Maintains authoritative game state on the server to prevent cheating and ensure consistent gameplay.

- **Room-Based Multiplayer:** Organizes players into game rooms with shared state and scoped communication.

## Development Tools
- **Git:** Version control system to track changes and manage the project's codebase.

- **npm:** Package manager for JavaScript, used to manage dependencies and run scripts.

- **Nodemon:** Development utility that monitors server.js changes and automatically restarts the server during development.

- **ESLint:** JavaScript linter that helps maintain code quality and consistency.

## Project Organization
- **Modular Architecture:** Core platform code separated from specific game implementations to allow for extensibility.

- **Client-Server Separation:** Distinct code organization with `/client` directory for front-end and root-level server code.

- **Component-Based Design:** Separate JavaScript modules for different game systems (networking, rendering, game logic, entities).

- **Implementation Framework:** Pluggable system for creating new game themes and mechanics while reusing core platform code.

## Deployment
- **Node.js Hosting:** Server deployed on Node.js compatible hosting platforms (e.g., Heroku, AWS, DigitalOcean).

- **Static Asset Serving:** Client-side assets (HTML, CSS, JS) served by the Node.js server.

## Why This Stack?

- **Three.js:** Provides powerful 3D rendering capabilities with a manageable learning curve, ideal for creating diverse game environments and character models.

- **Colyseus:** Purpose-built for multiplayer games with efficient state synchronization and room management, simplifying networked gameplay implementation.

- **Client-Server Model:** Ensures fair gameplay by maintaining authoritative state on the server, preventing client-side cheating.

- **Node.js:** Enables JavaScript throughout the stack, reducing context switching and allowing code sharing between client and server when appropriate.

- **Modular Design:** Supports the creation of different game implementations on top of a shared core platform, maximizing code reuse and maintainability.

This tech stack supports the core functionality of the 3D AI Game platform, including the dynamic 3D rendering, multiplayer capabilities, and flexible implementation system. It provides a solid foundation for creating various game themes and mechanics while maintaining a consistent technical architecture.
 
 
